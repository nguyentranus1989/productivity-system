<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auth protection disabled temporarily -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Productivity System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* Date Filter Styles */
        .date-filter-container input[type="date"] {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .date-filter-container input[type="date"]:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .date-filter-container .btn-group {
            display: flex;
            gap: 5px;
        }

        .date-filter-container .btn-group .btn-action {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 20px;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .sidebar-header h2 {
            font-size: 1.8em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        /* Add this to your existing styles */
        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        /* Bottleneck Detection Specific Styles */
        .bottleneck-alert {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bottleneck-alert i {
            font-size: 28px;
        }

        .workflow-stations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .station-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .station-card.bottleneck {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            animation: pulse 2s infinite;
        }

        .station-card.warning {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
        }

        .station-rate {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
        }

        .queue-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .nav-item {
            display: block;
            padding: 15px 20px;
            margin: 5px 0;
            color: #b0b0b0;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            color: #667eea;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 24px;
            margin-right: 12px;
            font-size: 1.1em;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
            background: #0f0f0f;
        }
        
        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dashboard-title h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .dashboard-title p {
            color: #808080;
            margin-top: 5px;
            font-size: 1.1em;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        #currentDateTime {
            color: #808080;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .metric-card:hover::before {
            opacity: 1;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            border-color: rgba(102, 126, 234, 0.3);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .metric-icon.blue { background: rgba(102, 126, 234, 0.2); color: #667eea; }
        .metric-icon.green { background: rgba(52, 211, 153, 0.2); color: #34d399; }
        .metric-icon.purple { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .metric-icon.yellow { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #808080;
            font-size: 0.95em;
        }
        
        .metric-change {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .metric-change.positive {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }
        
        .metric-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* Department Performance */
        .department-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .department-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .department-card:hover {
            transform: scale(1.02);
            border-color: rgba(102, 126, 234, 0.3);
        }
        
        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .department-name {
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .department-score {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .department-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #808080;
            margin-top: 3px;
        }
        
        /* Live Activity Feed */
        .activity-feed {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .activity-feed h3 {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #e0e0e0;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .activity-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2em;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 3px;
        }
        
        .activity-time {
            font-size: 0.85em;
            color: #808080;
        }
        
        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #e0e0e0;
        }
        
        /* Alerts Section */
        .alerts-container {
            margin-bottom: 30px;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert-icon {
            font-size: 1.5em;
            color: #ef4444;
            margin-right: 15px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 3px;
        }
        
        .alert-message {
            font-size: 0.9em;
            color: #e0e0e0;
        }
        
        .alert-action {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .alert-action:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .metrics-grid,
            .department-grid,
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
        
        /* No Data State */
        .no-data {
            text-align: center;
            padding: 40px;
            color: #808080;
        }
        
        .no-data i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        /* Status level colors */
        .station-card.complete {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
        }

        .station-card.idle {
            background: rgba(107, 114, 128, 0.1);
            border-color: #6b7280;
        }

        .station-card.good {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.complete {
            background: #22c55e;
            color: white;
        }

        .status-badge.idle {
            background: #6b7280;
            color: white;
        }

        .status-badge.critical {
            background: #ef4444;
            color: white;
        }

        .status-badge.warning {
            background: #f59e0b;
            color: white;
        }

        .status-badge.good {
            background: #10b981;
            color: white;
        }
        /* Cost Analysis Styles */
        .cost-efficient {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .cost-warning {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
        }

        .cost-alert {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .efficiency-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .champion-card {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .champion-rank {
            font-size: 24px;
            margin-right: 15px;
        }

        .champion-info {
            flex: 1;
        }

        .champion-name {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 3px;
        }

        .champion-stats {
            font-size: 0.85em;
            color: #808080;
        }

        .champion-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #667eea;
        }
/* Mobile Scrolling Fix */
/* Mobile Scrolling Fix */
@media only screen and (max-width: 768px) {
    /* Make sidebar accessible on mobile */
    .sidebar {
        position: fixed !important;
        left: -250px !important;
        top: 0 !important;
        height: 100vh !important;
        z-index: 9999 !important;
        transition: left 0.3s ease !important;
        background: #1a1a2e !important;
    }
    .sidebar.active {
        left: 0 !important;
    }
}
    /* Add hamburger menu button for mobile */
    .mobile-menu-toggle { display: none !important; } @media only screen and (max-width: 768px) { .mobile-menu-toggle {
        display: none !important;
        position: fixed !important;
        top: 10px !important;
        left: 10px !important;
        z-index: 10000 !important;
        background: #007bff !important;
        color: white !important;
        border: none !important;
        padding: 10px 15px !important;
        border-radius: 5px !important;
        font-size: 20px !important;
    }
@media only screen and (max-width: 768px) {
    body {
        overflow: auto !important;
        overflow-x: hidden !important;
        height: auto !important;
    }
    .main-container, .container, .dashboard-container {
        height: auto !important;
        overflow: visible !important;
    }
}
/* Mobile Menu Button Fix */
.mobile-menu-toggle {
    display: none;
}

@media only screen and (max-width: 768px) {
    .mobile-menu-toggle {
        display: block !important;
        position: fixed !important;
        top: 10px !important;
        left: 10px !important;
        z-index: 10000 !important;
        background: #007bff !important;
        color: white !important;
        border: none !important;
        padding: 10px 15px !important;
        border-radius: 5px !important;
        font-size: 20px !important;
        cursor: pointer !important;
    }
}
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button (only visible on mobile) -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()" >â˜°</button>
    <!-- Mobile Menu Toggle Button (only visible on mobile) -->
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>PodFactory Manager</h2>
            <p style="color: #808080; font-size: 0.9em;">Operations Control</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="showSection('dashboard'); document.getElementById('sidebar').classList.remove('active'); return false;">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('bottleneck'); document.getElementById('sidebar').classList.remove('active'); return false;">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Bottleneck Detection</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('cost'); document.getElementById('sidebar').classList.remove('active'); return false;">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Cost Analysis</span>
            </a>
            <a href="#" class="nav-item" onclick="window.open('/intelligent-schedule.html', '_blank'); return false;">
                <i class="fas fa-calendar-alt"></i>
                <span>Intelligent Scheduling</span>
            </a>
            <a href="shop-floor.html" class="nav-item">
                <i class="fas fa-tv"></i>
                <span>Shop Floor Display</span>
            </a>
            <a href="#" class="nav-item" onclick="showEmployeeManagement()">
                <i class="fas fa-users"></i> Employees
            </a>
            <a href="employee.html" class="nav-item">
                <i class="fas fa-user"></i>
                <span>Employee Portal</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-chart-line"></i>
                <span>Analytics</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        
        <div style="position: absolute; bottom: 20px; left: 20px; right: 20px;">
            <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; text-align: center;">
                <p style="font-size: 0.9em; color: #808080; margin: 0;">Logged in as</p>
                <p style="font-weight: 600; color: #e0e0e0; margin: 5px 0 0 0;">Manager Admin</p>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h1>Operations Dashboard</h1>
                <p>Real-time productivity monitoring and team management</p>
            </div>
            <div class="header-actions">
                <div id="currentDateTime"></div>
                <!-- ADD THIS DATE FILTER SECTION -->
                <div class="date-filter-container" style="display: flex; align-items: center; gap: 10px; margin-right: 15px;">
                    <input type="date" id="startDate" class="form-control" style="background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); max-width: 150px;">
                    <span style="color: #808080;">to</span>
                    <input type="date" id="endDate" class="form-control" style="background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); max-width: 150px;">
                    <div class="btn-group">
                        <button class="btn-action btn-secondary" onclick="setDateRange('today')">Today</button>
                        <button class="btn-action btn-secondary" onclick="setDateRange('week')">Week</button>
                        <button class="btn-action btn-secondary" onclick="setDateRange('month')">Month</button>
                    </div>
                    <button class="btn-action btn-primary" onclick="applyDateFilter()">
                        <i class="fas fa-filter"></i>
                        <span>Apply</span>
                    </button>
                </div>
                <!-- END DATE FILTER SECTION -->
                <button class="btn-action btn-secondary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
                <button class="btn-action btn-primary" onclick="exportReport()">
                    <i class="fas fa-download"></i>
                    <span>Export Report</span>
                </button>
            </div>
        </div>
        
        <!-- SYSTEM STATUS BAR - COMPACT VERSION -->
        <div id="system-status-container" style="
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 20px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-top: -10px;
            margin-bottom: 15px;
        ">
            <span style="font-weight: 600; color: #808080; font-size: 0.85em;">System:</span>
            
            <!-- Connecteam Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="connecteam-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">Connecteam</span>
                <span id="connecteam-last-sync" style="font-size: 0.7em; color: #808080;">(--)</span>
            </div>
            
            <!-- PodFactory Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="podfactory-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">PodFactory</span>
                <span id="podfactory-last-sync" style="font-size: 0.7em; color: #808080;">(--)</span>
            </div>
            
            <!-- Flask Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="flask-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">Backend</span>
            </div>
            
            <!-- Database Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="database-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">Database</span>
                <span id="database-latency" style="font-size: 0.7em; color: #808080;">(--)</span>
            </div>
            
            <!-- Separator -->
            <div style="width: 1px; height: 16px; background: rgba(255,255,255,0.2); margin: 0 5px;"></div>
            
            <!-- Control Button -->
            <button onclick="openSystemControls()" style="
                padding: 4px 10px;
                background: rgba(102, 126, 234, 0.15);
                border: 1px solid rgba(102, 126, 234, 0.3);
                color: #667eea;
                border-radius: 5px;
                font-size: 0.8em;
                cursor: pointer;
            ">
                Controls
            </button>
        </div>
        
        <!-- Dashboard Section (existing content) -->
        <div id="dashboard-section" class="section-content active">
            <!-- Alerts Section -->
            <div class="alerts-container" id="alertsContainer">
                <!-- Alerts will be populated dynamically -->
            </div>
        
        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <span class="metric-change" id="activeEmployeesChange">
                        <span class="loading"></span>
                    </span>
                </div>
                <div class="metric-value" id="activeEmployees">--</div>
                <div class="metric-label">Active Employees</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon green">
                        <i class="fas fa-box"></i>
                    </div>
                    <span class="metric-change" id="itemsProcessedChange">
                        <span class="loading"></span>
                    </span>
                </div>
                <div class="metric-value" id="itemsProcessed">--</div>
                <div class="metric-label">Items Processed Today</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon purple">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span class="metric-change" id="efficiencyChange">
                        <span class="loading"></span>
                    </span>
                </div>
                <div class="metric-value" id="overallEfficiency">--%</div>
                <div class="metric-label">Overall Efficiency</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon yellow">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span class="loading" id="hoursLoading"></span>
                </div>
                <div class="metric-value" id="totalHours">--</div>
                <div class="metric-label">Total Hours Worked</div>
            </div>
        </div>
        
        <!-- Department Performance -->
        <h2 style="font-size: 1.5em; margin-bottom: 20px; color: #e0e0e0;">Department Performance</h2>
        <div class="department-grid" id="departmentGrid">
            <!-- Department cards will be populated dynamically -->
            <div class="no-data">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading department data...</p>
            </div>
        </div>
        
        <!-- Charts and Activity Feed -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Hourly Productivity Trend</h3>
                    <select class="form-select" id="chartTimeRange" style="width: auto; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2);">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="productivityChart"></canvas>
                </div>
            </div>
            
            <div class="activity-feed">
                <h3>Top Performers & Recent Activity</h3>
                <div id="activityFeed">
                    <div class="no-data">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading activity data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- This closes the dashboard-section div -->

    <!-- Bottleneck Detection Section (new) -->
    <div id="bottleneck-section" class="section-content">
        <!-- Bottleneck Alert -->
        <div id="bottleneckAlert" class="bottleneck-alert" >
            <i class="fas fa-exclamation-circle"></i>
            <div>
                <div style="font-size: 20px; font-weight: 700;" id="bottleneckMessage">Loading...</div>
                <div style="font-size: 14px; opacity: 0.9;" id="bottleneckSubtext">Analyzing workflow...</div>
            </div>
        </div>

        <!-- Workflow Stations -->
        <h2 style="font-size: 1.5em; margin-bottom: 20px; color: #e0e0e0;">Workflow Status</h2>
        <div class="workflow-stations" id="workflowStations">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Station Details Table -->
        <div class="station-table" style="margin-top: 30px;">
            <h3 style="font-size: 1.3em; margin-bottom: 15px; color: #e0e0e0;">Detailed Station Analysis</h3>
            <table style="width: 100%; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <thead>
                    <tr style="background: rgba(0,0,0,0.3);">
                        <th style="padding: 15px; text-align: left; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Station</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Workers</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Rate/Hr</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Queue</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Status</th>
                    </tr>
                </thead>
                <tbody id="stationTableBody">
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Recommendations -->
        <div class="charts-grid" style="margin-top: 30px;">
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-users"></i> Available Workers</h3>
                <div id="availableWorkers">
                    <div class="no-data">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading worker data...</p>
                    </div>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-lightbulb"></i> Recommendations</h3>
                <div id="recommendations">
                    <div class="no-data">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Analyzing workflow...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Analysis Section -->
    <div id="cost-section" class="section-content">
        <!-- Cost Overview Cards -->
        <div class="metrics-grid" style="margin-bottom: 30px;">
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="totalLaborCost">$0.00</div>
                    <div class="metric-label">Today's Labor Cost</div>
                    <div class="metric-change" id="costVsYesterday">
                        <i class="fas fa-minus"></i> --
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <i class="fas fa-box"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="avgCostPerItem">$0.00</div>
                    <div class="metric-label">Average Cost per Item (True)</div>
                    <div class="metric-subtitle" id="avgCostPerItemActive" style="color: #22c55e; font-size: 0.9em; margin-top: 4px;">
                        Active: $0.00
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="overallUtilization">0%</div>
                    <div class="metric-label">Labor Utilization</div>
                    <div class="utilization-bar" style="margin-top: 8px; width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                        <div id="utilizationProgress" class="utilization-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%); transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <div class="metric-card" style="border: 2px solid #ef4444;">
                <div class="metric-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="totalNonActiveHours" style="color: #ef4444;">0 hrs</div>
                    <div class="metric-label">Non-Active Hours</div>
                    <div class="metric-subtitle" id="nonActiveCost" style="color: #ef4444; font-size: 0.9em; margin-top: 4px;">
                        Idle Cost: $0.00
                    </div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="activeEmployeeCount">0</div>
                    <div class="metric-label">Employees Working</div>
                    <div class="metric-subtitle" id="avgHourlyRate" style="color: #808080; font-size: 0.9em; margin-top: 4px;">
                        Avg Rate: $0.00/hr
                    </div>
                </div>
            </div>
        </div>

        <!-- High Cost Alert -->
        <div id="highCostAlert" class="alert-banner" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 15px 20px; border-radius: 12px; margin-bottom: 20px;">
            <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 10px;"></i>
            <span id="highCostMessage" style="color: #ef4444;">High labor cost detected</span>
        </div>

        <!-- Employee Cost Analysis Table -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title"><i class="fas fa-users"></i> Employee Cost Analysis</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="costSortBy" style="background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <option value="name">Sort by Name</option>
                        <option value="utilization">Sort by Utilization</option>
                        <option value="cost_per_item">Sort by Cost/Item</option>
                        <option value="total_cost">Sort by Total Cost</option>
                        <option value="efficiency">Sort by Efficiency</option>
                        <option value="non_active">Sort by Idle Time</option>
                    </select>
                    <button class="btn-action btn-secondary" id="exportCostBtn" style="padding: 8px 16px;">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                </div>
            </div>
            <div style="padding: 15px 20px 10px 20px;">
                <input type="text" id="costSearchInput" placeholder="Search by name..." 
                       style="width: 100%; max-width: 400px; padding: 10px; background: rgba(255,255,255,0.05); 
                              color: #e0e0e0; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
                              font-size: 14px;" 
                       oninput="filterCostTable()">
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                            <th style="padding: 12px; text-align: left;">Employee</th>
                            <th style="padding: 12px; text-align: center;">Rate/Hr</th>
                            <th style="padding: 12px; text-align: center;">Clocked</th>
                            <th style="padding: 12px; text-align: center; color: #22c55e;">Active</th>
                            <th style="padding: 12px; text-align: center; color: #ef4444;">Non-Active</th>
                            <th style="padding: 12px; text-align: center;">Utilization</th>
                            <th style="padding: 12px; text-align: center;">Labor Cost</th>
                            <th style="padding: 12px; text-align: center;">Items</th>
                            <th style="padding: 12px; text-align: left;">Items Breakdown</th>
                            <th style="padding: 12px; text-align: center;">$/Item (True)</th>
                            <th style="padding: 12px; text-align: center; color: #22c55e;">$/Item (Active)</th>
                            
                            <th style="padding: 12px; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="costTableBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                    <tfoot style="border-top: 2px solid rgba(255,255,255,0.2);">
                        <tr style="font-weight: 600;">
                            <td style="padding: 12px;">TOTAL</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgRate">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerTotalClocked">-</td>
                            <td style="padding: 12px; text-align: center; color: #22c55e;" id="footerTotalActive">-</td>
                            <td style="padding: 12px; text-align: center; color: #ef4444;" id="footerTotalNonActive">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgUtilization">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerTotalCost">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerTotalItems">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgCostPerItem">-</td>
                            <td style="padding: 12px; text-align: center; color: #22c55e;" id="footerAvgCostPerItemActive">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgEfficiency">-</td>
                            <td style="padding: 12px; text-align: center;">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Department Cost Breakdown & Champions -->
        <div class="charts-grid" style="margin-top: 25px;">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-building"></i> Department Cost Breakdown
                </h3>
                <div id="departmentCostChart">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-trophy"></i> Cost Champions
                </h3>
                <div id="costChampions">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
    <!-- Analytics Section (placeholder) -->
    <div id="analytics-section" class="section-content">

    <!-- Intelligent Scheduling Section -->
    <div id="scheduling-section" class="section-content">
        <iframe 
            src="/intelligent-schedule.html" 
            style="width: 100%; height: calc(100vh - 100px); border: none; border-radius: 10px;"
            title="Intelligent Scheduling System">
        </iframe>
    </div>
        <div style="text-align: center; padding: 100px 20px;">
            <i class="fas fa-chart-bar" style="font-size: 4em; color: #667eea; margin-bottom: 20px;"></i>
            <h2 style="color: #e0e0e0; margin-bottom: 10px;">Analytics Dashboard</h2>
            <p style="color: #808080;">Advanced analytics features coming soon</p>
        </div>
    </div>
    <!-- Employee Management Section -->
    <div id="employee-management-section" class="section-content">
        <div style="padding: 20px;">
            <!-- Header -->
            <div class="dashboard-header" style="margin-bottom: 30px;">
                <div class="dashboard-title">
                    <h1>Employee Management</h1>
                    <p>Manage employee mappings and configurations</p>
                </div>
                <div class="header-actions">
                    <button class="btn-action btn-secondary" onclick="showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back to Dashboard</span>
                    </button>
                </div>
            </div>

            <!-- Alert Section -->
            <div id="empMgmtAlerts"></div>

            <!-- Statistics Cards -->
            <div class="metrics-grid" style="margin-bottom: 30px;">
                <div class="metric-card">
                    <div class="metric-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-value" id="totalEmployeeCount">-</div>
                    <div class="metric-label">Total Employees</div>
                </div>
                
                
                <div class="metric-card">
                    <div class="metric-icon yellow">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="metric-value" id="unmappedCount">-</div>
                    <div class="metric-label">Need Mapping</div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; padding: 0 20px;">
                <button class="btn-action btn-secondary emp-nav-link active" onclick="showEmpTab('list')">All Employees</button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('payrates')">Payrates</button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('mapping')">Email Mapping</button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('add')">Add Employee</button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('archived')">Archived</button>
            </div>

            <!-- Employee List Tab -->
            <div id="empTabList" class="emp-tab-content" style="display: block;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="empSearchInput" placeholder="Search by name, email, or ID..." onkeyup="filterEmployees()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                        <button class="btn-action btn-secondary" onclick="syncWithConnecteam()">
                            <i class="fas fa-sync"></i> Sync Connecteam
                        </button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                <th style="padding: 12px;">ID</th>
                                <th style="padding: 12px;">Name</th>
                                <th style="padding: 12px;">Email</th>
                                <th style="padding: 12px;">Connecteam ID</th>
                                <th style="padding: 12px;">PodFactory Emails</th>
                                <th style="padding: 12px;">Status</th>
                                <th style="padding: 12px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Payrates Tab -->
            <div id="empTabPayrates" class="emp-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Employee Payrates Management</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="payrateSearchInput" 
                            placeholder="Search by name..." 
                            onkeyup="filterPayrates()"
                            style="padding: 8px 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; width: 250px;">
                        <select id="payrateSortBy" onchange="sortPayrates()"
                                style="padding: 8px 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                            <option value="name">Sort by Name</option>
                            <option value="no_rate">No Rate First</option>
                            <option value="hourly_asc">Hourly: $0 â†’ $$$</option>
                            <option value="hourly_desc">Hourly: $$$ â†’ $0</option>
                        </select>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                <th style="padding: 12px;">Employee</th>
                                <th style="padding: 12px; text-align: center;">Pay Type</th>
                                <th style="padding: 12px; text-align: center;">Rate</th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="toggleHourlySort()">
                                    Hourly Equiv <i class="fas fa-sort"></i>
                                </th>
                                <th style="padding: 12px;">Notes</th>
                                <th style="padding: 12px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrateTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="payrateNoResults" style="display: none; text-align: center; padding: 40px; color: #808080;">
                    <i class="fas fa-search" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <p>No employees found matching your search</p>
                </div>
            </div>
            <!-- Email Mapping Tab -->
            <div id="empTabMapping" class="emp-tab-content" style="display: none;">
                <h3 style="margin-bottom: 20px;">Email Mapping Configuration</h3>
                <div id="unmappedEmployeesList">
                    <p style="color: #808080;">Loading unmapped employees...</p>
                </div>
            </div>

            <!-- Add Employee Tab -->
            <div id="empTabAdd" class="emp-tab-content" style="display: none;">
                <h3 style="margin-bottom: 20px;">Add New Employee</h3>
                <form id="addEmployeeForm" onsubmit="return addEmployee(event)" style="max-width: 600px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">Full Name *</label>
                        <input type="text" id="newEmpName" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">Email *</label>
                        <input type="email" id="newEmpEmail" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">Connecteam User ID</label>
                        <input type="text" id="newEmpConnecteamId" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">PodFactory Email(s) (comma-separated)</label>
                        <input type="text" id="newEmpPodFactoryEmails" placeholder="email1@podfactory.com, email2@podfactory.com" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <button type="submit" class="btn-action btn-primary">Add Employee</button>
                </form>
            </div>
            <!-- Archived Employees Tab -->
            <div id="empTabArchived" class="emp-tab-content" style="display: none;">
                <h3 style="margin-bottom: 20px;">Archived Employees</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                <th style="padding: 12px;">Name</th>
                                <th style="padding: 12px;">Email</th>
                                <th style="padding: 12px;">Archived Date</th>
                                <th style="padding: 12px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archivedTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- System Control Modal -->
    <div id="system-control-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
    ">
        <div style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(102, 126, 234, 0.3);
        ">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #e0e0e0;">
                    <span style="color: #667eea;">âš™ï¸</span> System Controls
                </h2>
                <button onclick="closeSystemControls()" style="
                    background: none;
                    border: none;
                    color: #808080;
                    font-size: 1.5em;
                    cursor: pointer;
                ">Ã—</button>
            </div>
            
            <!-- Service Controls Grid -->
            <div style="display: grid; gap: 20px;">
                
                <!-- Flask Backend Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #667eea;">Flask Backend</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div>Process: flask-backend (PM2 ID: 9)</div>
                                <div id="flask-uptime">Uptime: --</div>
                                <div id="flask-memory">Memory: --</div>
                                <div id="flask-restarts">Restarts: --</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="restartService('flask-backend')" style="
                                padding: 8px 16px;
                                background: #667eea;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ”„ Restart</button>
                            <button onclick="viewLogs('flask-backend')" style="
                                padding: 8px 16px;
                                background: rgba(255,255,255,0.1);
                                color: #e0e0e0;
                                border: 1px solid rgba(255,255,255,0.2);
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ“‹ Logs</button>
                        </div>
                    </div>
                </div>
                
                <!-- Connecteam Sync Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #34d399;">Connecteam Sync</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div id="connecteam-status-detail">Last sync: --</div>
                                <div id="connecteam-records">Records synced: --</div>
                                <div>Schedule: Every 5 minutes</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="forceSync('connecteam')" style="
                                padding: 8px 16px;
                                background: #34d399;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ”„ Sync Now</button>
                            <button onclick="clearSyncLogs('connecteam')" style="
                                padding: 8px 16px;
                                background: rgba(239, 68, 68, 0.2);
                                color: #ef4444;
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ—‘ï¸ Clear Logs</button>
                        </div>
                    </div>
                </div>
                
                <!-- PodFactory Sync Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #a855f7;">PodFactory Sync</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div id="podfactory-status-detail">Last sync: --</div>
                                <div id="podfactory-items">Items synced: --</div>
                                <div>Process: podfactory-sync (PM2 ID: 6)</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="forceSync('podfactory')" style="
                                padding: 8px 16px;
                                background: #a855f7;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ”„ Sync Now</button>
                            <button onclick="restartService('podfactory-sync')" style="
                                padding: 8px 16px;
                                background: rgba(255,255,255,0.1);
                                color: #e0e0e0;
                                border: 1px solid rgba(255,255,255,0.2);
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ”„ Restart</button>
                        </div>
                    </div>
                </div>
                
                <!-- Database Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #fbbf24;">Database Connection</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div id="db-status-detail">Status: --</div>
                                <div id="db-latency-detail">Latency: --</div>
                                <div>Location: Singapore (DigitalOcean)</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="testDatabaseConnection()" style="
                                padding: 8px 16px;
                                background: #fbbf24;
                                color: black;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ” Test</button>
                            <button onclick="resetConnectionPool()" style="
                                padding: 8px 16px;
                                background: rgba(255,255,255,0.1);
                                color: #e0e0e0;
                                border: 1px solid rgba(255,255,255,0.2);
                                border-radius: 6px;
                                cursor: pointer;
                            ">ðŸ”„ Reset Pool</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Emergency Actions -->
            <div style="
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid rgba(255,255,255,0.1);
            ">
                <h3 style="color: #ef4444; margin-bottom: 15px;">âš ï¸ Emergency Actions</h3>
                <div style="display: flex; gap: 15px;">
                    <button onclick="restartAllServices()" style="
                        padding: 10px 20px;
                        background: rgba(239, 68, 68, 0.2);
                        color: #ef4444;
                        border: 2px solid #ef4444;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">ðŸ”„ Restart All Services</button>
                    <button onclick="clearAllCaches()" style="
                        padding: 10px 20px;
                        background: rgba(251, 191, 36, 0.2);
                        color: #fbbf24;
                        border: 2px solid #fbbf24;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">ðŸ—‘ï¸ Clear All Caches</button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- This closes the main-content div -->
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
    <script src="dashboard-api.js"></script>
    <script>
        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.toggle("active");
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener("click", function(event) {
            const sidebar = document.getElementById("sidebar");
            const toggleBtn = document.querySelector(".mobile-menu-toggle");
            if (window.innerWidth <= 768 && !sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
                sidebar.classList.remove("active");
            }
        });
        let dashboardData = {};
        // Initialize API and variables
        const api = new ProductivityAPI();
        let productivityChart = null;
        let refreshInterval = null;
        let previousData = null;
        // Cost Analysis Variables
        let costData = null;
        // ============= SYSTEM HEALTH MONITORING =============
        // Cooldown tracking for restart buttons
        let restartCooldowns = {};

        // Update system health status
        async function updateSystemHealth() {
            try {
                const response = await fetch('/api/system/health', {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                if (response.ok) {
                    const health = await response.json();
                    
                    // Update Connecteam status
                    if (health.syncs && health.syncs.connecteam) {
                        const connecteam = health.syncs.connecteam;
                        updateStatusIndicator('connecteam', connecteam.status);
                        document.getElementById('connecteam-last-sync').textContent = 
                            `(${Math.round(connecteam.minutes_ago)}m ago)`;
                    }
                    
                    // Update PodFactory status
                    if (health.syncs && health.syncs.podfactory) {
                        const podfactory = health.syncs.podfactory;
                        updateStatusIndicator('podfactory', podfactory.status);
                        document.getElementById('podfactory-last-sync').textContent = 
                            `(${Math.round(podfactory.minutes_ago)}m ago)`;
                    }
                    
                    // Update Flask status
                    if (health.services && health.services['flask-backend']) {
                        const flask = health.services['flask-backend'];
                        updateStatusIndicator('flask', flask.status === 'online' ? 'healthy' : 'critical');
                    }
                    
                    // Update Database status
                    if (health.database && health.database.status === 'connected') {
                        updateStatusIndicator('database', 'healthy');
                        document.getElementById('database-latency').textContent = '(connected)';
                    }
                    
                } else {
                    // If we can't reach the health endpoint, show all as offline
                    ['connecteam', 'podfactory', 'flask', 'database'].forEach(service => {
                        updateStatusIndicator(service, 'critical');
                    });
                }
            } catch (error) {
                console.error('Error updating system health:', error);
                // Show all as unknown if we can't connect
                ['connecteam', 'podfactory', 'flask', 'database'].forEach(service => {
                    updateStatusIndicator(service, 'unknown');
                });
            }
        }

        // Update status indicator color
        function updateStatusIndicator(service, status) {
            const indicator = document.getElementById(`${service}-indicator`);
            if (indicator) {
                let color = '#6c757d'; // gray - unknown
                
                switch(status) {
                    case 'healthy':
                    case 'online':
                        color = '#22c55e'; // green
                        break;
                    case 'warning':
                        color = '#fbbf24'; // yellow
                        break;
                    case 'critical':
                    case 'offline':
                        color = '#ef4444'; // red
                        break;
                }
                
                indicator.style.background = color;
                
                // Add pulse animation for critical status
                if (status === 'critical') {
                    indicator.style.animation = 'pulse 2s infinite';
                } else {
                    indicator.style.animation = 'none';
                }
            }
        }

        // Open system controls modal
        function openSystemControls() {
            document.getElementById('system-control-modal').style.display = 'block';
            loadSystemDetails();
        }

        // Close system controls modal
        function closeSystemControls() {
            document.getElementById('system-control-modal').style.display = 'none';
        }

        // Load detailed system information
        async function loadSystemDetails() {
            try {
                // Get PM2 status
                const pm2Response = await fetch('/api/system/pm2-status', {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                if (pm2Response.ok) {
                    const data = await pm2Response.json();
                    const processes = data.processes;
                    
                    // Update Flask details
                    const flask = processes.find(p => p.name === 'flask-backend');
                    if (flask) {
                        document.getElementById('flask-uptime').textContent = 
                            `Uptime: ${formatUptime(flask.uptime)}`;
                        document.getElementById('flask-memory').textContent = 
                            `Memory: ${(flask.memory / 1024 / 1024).toFixed(1)} MB`;
                        document.getElementById('flask-restarts').textContent = 
                            `Restarts: ${flask.restarts}`;
                    }
                }
                
                // Get system health for sync details
                const healthResponse = await fetch('/api/system/health', {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                if (healthResponse.ok) {
                    const health = await healthResponse.json();
                    
                    // Update Connecteam details
                    if (health.syncs && health.syncs.connecteam) {
                        document.getElementById('connecteam-status-detail').textContent = 
                            `Last sync: ${health.syncs.connecteam.minutes_ago.toFixed(0)} minutes ago`;
                        document.getElementById('connecteam-records').textContent = 
                            `Records synced: ${health.syncs.connecteam.records || 0}`;
                    }
                    
                    // Update PodFactory details
                    if (health.syncs && health.syncs.podfactory) {
                        document.getElementById('podfactory-status-detail').textContent = 
                            `Last sync: ${health.syncs.podfactory.minutes_ago.toFixed(0)} minutes ago`;
                        document.getElementById('podfactory-items').textContent = 
                            `Items synced: ${health.syncs.podfactory.items || 0}`;
                    }
                    
                    // Update Database details
                    if (health.database) {
                        document.getElementById('db-status-detail').textContent = 
                            `Status: ${health.database.status}`;
                    }
                }
                
            } catch (error) {
                console.error('Error loading system details:', error);
            }
        }

        // Restart a service
        async function restartService(serviceName) {
            // Check cooldown
            if (restartCooldowns[serviceName]) {
                const timeLeft = Math.ceil((restartCooldowns[serviceName] - Date.now()) / 1000);
                if (timeLeft > 0) {
                    alert(`Please wait ${timeLeft} seconds before restarting again`);
                    return;
                }
            }
            
            // Double confirmation for critical services
            if (serviceName === 'flask-backend') {
                if (!confirm(`This will restart the main backend. Users may experience brief interruption. Continue?`)) {
                    return;
                }
            } else {
                if (!confirm(`Are you sure you want to restart ${serviceName}?`)) {
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/system/restart-service', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key-123'
                    },
                    body: JSON.stringify({ service: serviceName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`${serviceName} restarted successfully`);
                    // Set 30-second cooldown
                    restartCooldowns[serviceName] = Date.now() + 30000;
                    // Update status after a few seconds
                    setTimeout(() => {
                        updateSystemHealth();
                        loadSystemDetails();
                    }, 3000);
                } else {
                    alert(`Failed to restart: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Force a sync
        async function forceSync(syncType) {
            if (!confirm(`Force ${syncType} sync now?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/system/force-sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key-123'
                    },
                    body: JSON.stringify({ type: syncType })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`${syncType} sync completed successfully`);
                    updateSystemHealth();
                    loadSystemDetails();
                } else {
                    alert(`Sync failed: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Clear sync logs
        async function clearSyncLogs(syncType) {
            if (!confirm(`Clear old ${syncType} sync logs?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/system/clear-sync-logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key-123'
                    },
                    body: JSON.stringify({ type: syncType, days: 7 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                } else {
                    alert(`Failed: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Test database connection
        async function testDatabaseConnection() {
            try {
                const response = await fetch('/api/system/test-connection', {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('db-status-detail').textContent = 
                        `Status: Connected`;
                    document.getElementById('db-latency-detail').textContent = 
                        `Latency: ${data.latency_ms} ms`;
                    
                    alert(`Database connected!\nLatency: ${data.latency_ms} ms\nStatus: ${data.status}`);
                } else {
                    alert(`Connection failed: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Reset connection pool
        async function resetConnectionPool() {
            if (!confirm('Reset database connection pool?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/system/reset-connection-pool', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key-123'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Connection pool reset successfully');
                    updateSystemHealth();
                } else {
                    alert(`Failed: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Restart all services
        async function restartAllServices() {
            if (!confirm('âš ï¸ WARNING: This will restart ALL services and cause a brief outage.\n\nAre you absolutely sure?')) {
                return;
            }
            
            if (!confirm('This is your final confirmation. Restart all services?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/system/restart-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key-123'
                    },
                    body: JSON.stringify({ confirm: true })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('All services restarted. Please wait 10-15 seconds for everything to come back online.');
                    setTimeout(() => {
                        window.location.reload();
                    }, 15000);
                } else {
                    alert(`Failed: ${data.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Clear all caches
        async function clearAllCaches() {
            if (!confirm('Clear all system caches?')) {
                return;
            }
            
            alert('Cache clearing not yet implemented');
            // TODO: Implement cache clearing
        }

        // View logs (placeholder)
        function viewLogs(serviceName) {
            alert(`Log viewing for ${serviceName} not yet implemented`);
            // TODO: Implement log viewing
        }

        // Format uptime
        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else {
                return `${minutes}m`;
            }
        }

        // Add CSS animation for pulse
        if (!document.getElementById('pulse-animation')) {
            const style = document.createElement('style');
            style.id = 'pulse-animation';
            style.textContent = `
                @keyframes pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.5; }
                    100% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize health monitoring
        document.addEventListener('DOMContentLoaded', function() {
            // Initial health check
            updateSystemHealth();
            
            // Update health status every 30 seconds
            setInterval(updateSystemHealth, 30000);
            
            // Close modal when clicking outside
            document.getElementById('system-control-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSystemControls();
                }
            });
        });
        // Initialize Chart
        function initializeChart() {
            const ctx = document.getElementById('productivityChart').getContext('2d');
            productivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Items per Hour',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Target',
                        data: [],
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderDash: [5, 5],
                        tension: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#808080'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#808080'
                            }
                        }
                    }
                }
            });
        }
        
        // Load all dashboard data
        async function loadDashboardData() {
            try {
                const currentDate = dashboardData.startDate || api.getCentralDate();
                console.log('Loading data for:', currentDate);
                
                // Show loading states
                showLoadingStates();
                
                // Test each endpoint individually to find the problem
                console.log('Loading leaderboard...');
                const leaderboard = await api.getLeaderboard(currentDate);
                console.log('Leaderboard loaded:', leaderboard);
                
                console.log('Loading department stats...');
                const departmentStats = await api.getDepartmentStats(currentDate);
                console.log('Department stats loaded:', departmentStats);
                
                console.log('Loading team metrics...');
                let teamMetrics = {};
                try {
                    teamMetrics = await api.getTeamMetrics();
                    console.log('Team metrics loaded:', teamMetrics);
                } catch (error) {
                    console.error('Team metrics failed:', error);
                    // Use default values if team metrics fails
                    teamMetrics = {
                        active_employees: 0,
                        total_employees_today: 0,
                        items_today: 0,
                        overall_efficiency: 0,
                        total_hours_worked: 0,
                        vs_yesterday: 0
                    };
                }
                
                console.log('Loading recent activities...');
                const recentActivities = await api.getRecentActivities(10);
                console.log('Recent activities loaded:', recentActivities);
                
                console.log('Loading alerts...');
                const alerts = await api.getActiveAlerts();
                console.log('Alerts loaded:', alerts);
                
                // Store data
                dashboardData = {
                    leaderboard,
                    departmentStats,
                    teamMetrics,
                    recentActivities,
                    currentDate
                };
                
                // Update all sections
                console.log('Updating UI...');
                updateMetrics(leaderboard, teamMetrics);
                updateDepartmentCards(departmentStats);
                updateActivityFeed(recentActivities);
                updateAlerts(departmentStats);
                
                console.log('Loading productivity chart...');
                await updateProductivityChart();
                
                // Store for comparison
                previousData = dashboardData;
                
                console.log('Dashboard load complete!');
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorState();
            }
        }
        
        // Show loading states
        function showLoadingStates() {
            document.querySelectorAll('.metric-change').forEach(el => {
                el.innerHTML = '<span class="loading"></span>';
            });
        }
        
        // Update metrics cards
        function updateMetrics(leaderboard, teamMetrics) {
            console.log('Updating metrics with:', teamMetrics);
            
            // If teamMetrics is passed directly, use it
            if (teamMetrics && typeof teamMetrics === 'object') {
                // Active Employees
                document.getElementById('activeEmployees').textContent = 
                    teamMetrics.total_employees_today ? 
                    `${teamMetrics.active_employees}/${teamMetrics.total_employees_today}` : 
                    '0/0';
                
                // Update label
                const activeLabel = document.querySelector('#activeEmployees').nextElementSibling;
                if (activeLabel) {
                    activeLabel.textContent = 'Active Now / Worked Today';
                }
                
                // Items Processed Today (QC Passed only)
                document.getElementById('itemsProcessed').textContent = 
                    (teamMetrics.items_today || 0).toLocaleString();
                
                // Overall Efficiency
                document.getElementById('overallEfficiency').textContent = 
                    Math.round(teamMetrics.overall_efficiency || 0) + '%';
                
                // Total Hours Worked
                document.getElementById('totalHours').textContent = 
                    teamMetrics.total_hours_worked || '0';
                document.getElementById('hoursLoading').style.display = 'none';
                
                // Update change indicators
                updateMetricChange('itemsProcessedChange', teamMetrics.vs_yesterday || 0);
                updateMetricChange('efficiencyChange', 0); // No historical efficiency data yet
            } else {
                // Fallback to calculating from leaderboard
                const activeEmployees = leaderboard.filter(e => e.is_clocked_in).length;
                document.getElementById('activeEmployeeCount').textContent = activeEmployees;
                
                const totalItems = leaderboard.reduce((sum, emp) => sum + (emp.items_today || 0), 0);
                document.getElementById('itemsProcessed').textContent = totalItems.toLocaleString();
                
                document.getElementById('overallEfficiency').textContent = '0%';
                document.getElementById('totalHours').textContent = '0';
            }
        }
                
        // Calculate percentage change
        function calculateChange(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous) * 100;
        }
        
        // Update metric change indicator
        function updateMetricChange(elementId, change) {
            const element = document.getElementById(elementId);
            if (change > 0) {
                element.className = 'metric-change positive';
                element.innerHTML = `<i class="fas fa-arrow-up"></i> ${Math.abs(change).toFixed(1)}%`;
            } else if (change < 0) {
                element.className = 'metric-change negative';
                element.innerHTML = `<i class="fas fa-arrow-down"></i> ${Math.abs(change).toFixed(1)}%`;
            } else {
                element.className = 'metric-change';
                element.innerHTML = `<i class="fas fa-minus"></i> 0%`;
            }
        }
        
        // Update department cards
        // Update department cards
        function updateDepartmentCards(stats) {
            const container = document.getElementById('departmentGrid');
            
            if (!stats || stats.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-inbox"></i>
                        <p>No department data available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            stats.forEach(dept => {
                // Convert string values to numbers
                const avgItemsPerMinute = parseFloat(dept.avg_items_per_minute || dept.avg_rate || 0);
                const efficiency = parseFloat(dept.efficiency || 0);
                const vsTarget = parseFloat(dept.vs_target || 0);
                const totalItems = parseInt(dept.total_items || 0);
                const employeeCount = parseInt(dept.employee_count || 0);
                
                const card = document.createElement('div');
                card.className = 'department-card';
                card.innerHTML = `
                    <div class="department-header">
                        <div class="department-name">${getDepartmentIcon(dept.department_name || dept.name)} ${dept.department_name || dept.name}</div>
                        <div class="department-score">${Math.round(efficiency)}%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(efficiency, 100)}%"></div>
                    </div>
                    <div class="department-stats">
                        <div class="stat-item">
                            <div class="stat-value">${employeeCount}</div>
                            <div class="stat-label">Employees</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${avgItemsPerMinute.toFixed(1)}</div>
                            <div class="stat-label">Avg Items/Min</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: ${vsTarget >= 0 ? '#34d399' : '#ef4444'}">
                                ${vsTarget > 0 ? '+' : ''}${vsTarget.toFixed(0)}%
                            </div>
                            <div class="stat-label">vs Target</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Get department icon
        function getDepartmentIcon(deptName) {
            const icons = {
                'Picking': 'ðŸŽ¯',
                'Packing': 'ðŸ“¦',
                'Packing and Shipping': 'ðŸ“¦',
                'Heat Press': 'ðŸ”¥',
                'Labeling': 'ðŸ·ï¸',
                'Film Matching': 'ðŸŽ¬'
            };
            return icons[deptName] || 'ðŸ“Š';
        }
        
        // Update activity feed with clock in/out notifications
        function updateActivityFeed(activities) {
            const feed = document.getElementById('activityFeed');
            
            if (!activities || activities.length === 0) {
                feed.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>No activity data available</p>
                    </div>
                `;
                return;
            }
            
            feed.innerHTML = '';
            
            // Show recent clock in/out activities
            activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                
                let icon, color;
                if (activity.type === 'clock_in') {
                    icon = 'sign-in-alt';
                    color = 'rgba(52, 211, 153, 0.2)';
                } else if (activity.type === 'clock_out') {
                    icon = 'sign-out-alt';
                    color = 'rgba(239, 68, 68, 0.2)';
                } else {
                    icon = 'clock';
                    color = 'rgba(102, 126, 234, 0.2)';
                }
                
                item.innerHTML = `
                    <div class="activity-icon" style="background: ${color};">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.description}</div>
                        <div class="activity-time">${formatTime(activity.timestamp)}</div>
                    </div>
                `;
                feed.appendChild(item);
            });
        }
        
        // Update alerts based on department performance
        function updateAlerts(departmentStats) {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '';
            
            if (!departmentStats || departmentStats.length === 0) return;
            
            // Check for low performing departments
            departmentStats.forEach(dept => {
                const efficiency = dept.expected_rate > 0 
                    ? (dept.actual_rate / dept.expected_rate) * 100
                    : 100;
                
                if (efficiency < 75) {
                    const alert = document.createElement('div');
                    alert.className = 'alert-item';
                    alert.innerHTML = `
                        <i class="fas fa-exclamation-circle alert-icon"></i>
                        <div class="alert-content">
                            <div class="alert-title">Low Productivity Alert</div>
                            <div class="alert-message">${dept.department_name} is ${(100 - efficiency).toFixed(0)}% below target rate</div>
                        </div>
                        <a href="#" class="alert-action" onclick="viewDepartmentDetails('${dept.department_name}')">View Details</a>
                    `;
                    container.appendChild(alert);
                }
            });
            
            // Add no alerts message if none
            if (container.innerHTML === '') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #34d399;">
                        <i class="fas fa-check-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <p>All departments operating within target parameters</p>
                    </div>
                `;
            }
        }
        
        // Update productivity chart
        async function updateProductivityChart() {
            try {
                const timeRange = document.getElementById('chartTimeRange').value;
                const currentDate = api.getCentralDate();
                
                // For now, generate sample hourly data
                // In production, you'd fetch this from your API
                const hours = [];
                const data = [];
                const target = [];
                
                for (let i = 6; i <= 17; i++) {
                    hours.push(`${i}:00`);
                    data.push(Math.floor(Math.random() * 600) + 800);
                    target.push(1200);
                }
                
                productivityChart.data.labels = hours;
                productivityChart.data.datasets[0].data = data;
                productivityChart.data.datasets[1].data = target;
                productivityChart.update();
                
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }
        
        // Format time helper
        function formatTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const now = new Date();
            const diff = (now - date) / 1000 / 60; // minutes
            
            if (diff < 60) {
                return `${Math.floor(diff)} minutes ago`;
            } else if (diff < 1440) {
                return `${Math.floor(diff / 60)} hours ago`;
            } else {
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
            }
        }
        
        // View department details
        function viewDepartmentDetails(deptName) {
            console.log('View details for:', deptName);
            // Implement department details view
        }
        
        // Refresh dashboard
        function refreshDashboard() {
            console.log('Refreshing dashboard...');
            loadDashboardData();
        }
        
        // Export report
        function exportReport() {
            console.log('Exporting report...');
            // Implement report export functionality
            alert('Report export feature coming soon!');
        }
        
        // Show error state
        function showErrorState() {
            document.getElementById('alertsContainer').innerHTML = `
                <div class="alert-item">
                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                    <div class="alert-content">
                        <div class="alert-title">Connection Error</div>
                        <div class="alert-message">Unable to load dashboard data. Please check your connection and try again.</div>
                    </div>
                    <a href="#" class="alert-action" onclick="refreshDashboard()">Retry</a>
                </div>
            `;
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing manager dashboard...');
            
            // Start clock display
            const startClock = () => {
                const updateClock = () => {
                    const now = api.getCurrentCentralTime();
                    const dateStr = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const timeStr = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const clockElement = document.getElementById('currentDateTime');
                    if (clockElement) {
                        clockElement.innerHTML = `${dateStr} at ${timeStr}`;
                    }
                };
                
                // Update immediately
                updateClock();
                
                // Update every second
                setInterval(updateClock, 1000);
            };

            // Start the clock
            startClock();
            
            // Initialize date inputs with today's date
            const today = api.getCentralDate();
            console.log('Setting initial date to:', today);
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Store in dashboardData
            dashboardData.startDate = today;
            dashboardData.endDate = today;
            
            // Update the title to show today's date
            const titleElement = document.querySelector('.dashboard-title p');
            if (titleElement) {
                const dateObj = new Date(today + 'T12:00:00');  // Add time to avoid timezone issues
                titleElement.textContent = `Data for ${dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`; 
            }
            
            // Initialize chart
            initializeChart();
            
            // Load initial data
            loadDashboardData();
            
            // Set up auto-refresh every 30 seconds
            refreshInterval = setInterval(loadDashboardData, 30000);
            
            // Schedule midnight refresh
            const scheduleMiddnightRefresh = () => {
                const scheduleNext = () => {
                    const now = api.getCurrentCentralTime();
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(0, 0, 5, 0); // 5 seconds after midnight
                    
                    const msUntilMidnight = tomorrow - now;
                    
                    setTimeout(() => {
                        console.log('Midnight refresh triggered');
                        window.location.reload();
                    }, msUntilMidnight);
                };
                
                scheduleNext();
            };

            // Schedule the midnight refresh
            scheduleMiddnightRefresh();
            
            // Refresh when window gains focus
            window.addEventListener('focus', () => {
                console.log('Window focused, refreshing data...');
                loadDashboardData();
            });
            
            // Chart time range change
            document.getElementById('chartTimeRange').addEventListener('change', updateProductivityChart);
            
            // Employee Management Functions
            window.showEmployeeManagement = function() {
                showSection('employee-management');
                window.loadEmployeeManagementData();  // Add window. prefix
            };

            window.loadEmployeeManagementData = async function() {
                try {
                    console.log('Loading employee management data...');
                    
                    const response = await api.request('/dashboard/employees');
                    console.log('Response received:', response);
                    
                    if (response && response.employees) {
                        // Filter out archived employees (is_active = 0)
                        const activeEmployees = response.employees.filter(e => e.is_active === 1 || e.is_active === true);
                        console.log('Active employees found:', activeEmployees.length);
                        
                        // Update statistics
                        document.getElementById('totalEmployeeCount').textContent = activeEmployees.length;
                        
                        // Count unmapped employees
                        const unmapped = activeEmployees.filter(e => !e.connecteam_user_id || e.connecteam_user_id === '').length;
                        document.getElementById('unmappedCount').textContent = unmapped;
                        
                        // Count active today (this might need adjustment based on your logic)
                        const activeToday = activeEmployees.length;
                        document.getElementById('activeEmployeeCount').textContent = activeToday;
                        
                        // Display only active employees in table
                        window.displayEmployeeTable(activeEmployees);
                    } else {
                        console.log('No employees in response:', response);
                    }
                } catch (error) {
                    console.error('Error loading employee data:', error);
                }
            };

            window.displayEmployeeTable = function(employees) {  // Add window. prefix
            const tbody = document.getElementById('employeeTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = employees.map(emp => {
                // Split emails by comma and create formatted display
                const podfactoryEmailsDisplay = emp.podfactory_emails 
                    ? emp.podfactory_emails.split(',').map(email => 
                        `<div style="padding: 2px 0;">${email.trim()}</div>`
                    ).join('')
                    : '<span style="color: #fbbf24;">Not mapped</span>';
                
                return `
                    <tr>
                        <td style="padding: 12px;">${emp.id}</td>
                        <td style="padding: 12px;">${emp.name}</td>
                        <td style="padding: 12px;">${emp.email || '-'}</td>
                        <td style="padding: 12px;">${emp.connecteam_user_id || '<span style="color: #fbbf24;">Not mapped</span>'}</td>
                        <td style="padding: 12px;">${podfactoryEmailsDisplay}</td>
                        <td style="padding: 12px;"><span class="badge ${emp.is_active ? 'badge-success' : 'badge-danger'}" style="background: ${emp.is_active ? '#22c55e' : '#ef4444'}; padding: 4px 12px; border-radius: 12px;">${emp.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td style="padding: 12px; position: relative;">
                            <button onclick="toggleDropdown(${emp.id})" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Actions â–¼
                            </button>
                            <div id="dropdown-${emp.id}" style="display: none; position: absolute; right: 0; top: 100%; background: #2a2a2a; min-width: 120px; box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 5px; margin-top: 5px;">
                                <a href="#" onclick="editEmployee(${emp.id}); return false;" style="color: white; padding: 10px 15px; text-decoration: none; display: block; border-bottom: 1px solid rgba(255,255,255,0.1);">âœï¸ Edit</a>
                                <a href="#" onclick="mapEmployee(${emp.id}); return false;" style="color: white; padding: 10px 15px; text-decoration: none; display: block; border-bottom: 1px solid rgba(255,255,255,0.1);">ðŸ”— Map</a>
                                <a href="#" onclick="archiveEmployee(${emp.id}, '${emp.name.replace(/'/g, "\\'")}'); return false;" style="color: #ef4444; padding: 10px 15px; text-decoration: none; display: block;">ðŸ—‘ï¸ Archive</a>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        };

            // Add this function right after displayEmployeeTable
            window.toggleDropdown = function(id) {
                const dropdown = document.getElementById(`dropdown-${id}`);
                // Close all other dropdowns first
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                    if (d.id !== `dropdown-${id}`) d.style.display = 'none';
                });
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            };

            // Add this event listener to close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.matches('[onclick*="toggleDropdown"]')) {
                    document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                        d.style.display = 'none';
                    });
                }
            });


            window.showEmpTab = function(tab) {
            // Hide all tabs
            document.querySelectorAll('.emp-tab-content').forEach(t => t.style.display = 'none');
            
            // Remove active class from all buttons
            document.querySelectorAll('.emp-nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            const tabElement = document.getElementById('empTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (tabElement) {
                tabElement.style.display = 'block';
            }
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load data for the tab
            if (tab === 'payrates') {
                loadPayratesData();
            } else if (tab === 'archived') {
                loadArchivedEmployees();
            }
        };

            window.filterEmployees = function() {
                const searchText = document.getElementById('empSearchInput').value.toLowerCase();
                const rows = document.querySelectorAll('#employeeTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchText) ? '' : 'none';
                });
            };

            // Store original payrates data
            let allPayratesData = [];
            let hourlySortAsc = true;

            window.loadPayratesData = async function() {
                try {
                    const response = await api.request('/dashboard/employees/payrates');
                    if (response && response.payrates) {
                        allPayratesData = response.payrates;
                        displayFilteredPayrates();
                    }
                } catch (error) {
                    console.error('Error loading payrates:', error);
                }
            };

            window.displayFilteredPayrates = function() {
                let filtered = [...allPayratesData];
                
                // Apply search filter
                const searchText = document.getElementById('payrateSearchInput')?.value?.toLowerCase() || '';
                if (searchText) {
                    filtered = filtered.filter(emp => 
                        emp.name.toLowerCase().includes(searchText)
                    );
                }
                
                // Apply sorting
                const sortBy = document.getElementById('payrateSortBy')?.value || 'name';
                switch(sortBy) {
                    case 'name':
                        filtered.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'no_rate':
                        filtered.sort((a, b) => {
                            const aRate = parseFloat(a.pay_rate || 0);
                            const bRate = parseFloat(b.pay_rate || 0);
                            if (aRate === 0 && bRate !== 0) return -1;
                            if (aRate !== 0 && bRate === 0) return 1;
                            return a.name.localeCompare(b.name);
                        });
                        break;
                    case 'hourly_asc':
                        filtered.sort((a, b) => {
                            const aHourly = parseFloat(a.hourly_equivalent || 0);
                            const bHourly = parseFloat(b.hourly_equivalent || 0);
                            return aHourly - bHourly;
                        });
                        break;
                    case 'hourly_desc':
                        filtered.sort((a, b) => {
                            const aHourly = parseFloat(a.hourly_equivalent || 0);
                            const bHourly = parseFloat(b.hourly_equivalent || 0);
                            return bHourly - aHourly;
                        });
                        break;
                }
                
                displayPayratesTable(filtered);
            };

            window.toggleHourlySort = function() {
                hourlySortAsc = !hourlySortAsc;
                document.getElementById('payrateSortBy').value = hourlySortAsc ? 'hourly_asc' : 'hourly_desc';
                displayFilteredPayrates();
            };

            window.displayPayratesTable = function(payrates) {
                const tbody = document.getElementById('payrateTableBody');
                const noResults = document.getElementById('payrateNoResults');
                
                if (!tbody) return;
                
                if (payrates.length === 0) {
                    tbody.style.display = 'none';
                    if (noResults) noResults.style.display = 'block';
                    return;
                }
                
                tbody.style.display = '';
                if (noResults) noResults.style.display = 'none';
                
                tbody.innerHTML = payrates.map(emp => {
                    const hasNoRate = !emp.pay_rate || parseFloat(emp.pay_rate) === 0;
                    const rowStyle = hasNoRate ? 'background: rgba(239, 68, 68, 0.1);' : '';
                    const hourlyRate = parseFloat(emp.hourly_equivalent || 0);
                    const rateDisplay = hasNoRate ? 
                        '<span style="color: #ef4444; font-weight: bold;">NO RATE</span>' : 
                        `<strong style="font-size: 1.1em;">$${hourlyRate.toFixed(2)}</strong>/hr`;
                    
                    return `
                        <tr style="${rowStyle}">
                            <td style="padding: 12px; font-weight: 600;">
                                ${emp.name}
                                ${hasNoRate ? '<span style="color: #ef4444; margin-left: 10px;">âš ï¸</span>' : ''}
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <select id="paytype-${emp.id}" style="background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); padding: 5px; border-radius: 5px;">
                                    <option value="hourly" ${emp.pay_type === 'hourly' ? 'selected' : ''}>Hourly</option>
                                    <option value="salary" ${emp.pay_type === 'salary' ? 'selected' : ''}>Salary</option>
                                </select>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                $<input type="number" id="payrate-${emp.id}" value="${emp.pay_rate || 0}" 
                                    step="0.01" min="0" 
                                    style="width: 80px; background: ${hasNoRate ? 'rgba(239, 68, 68, 0.2)' : 'rgba(255,255,255,0.1)'}; color: #e0e0e0; border: 1px solid ${hasNoRate ? '#ef4444' : 'rgba(255,255,255,0.2)'}; padding: 5px; border-radius: 5px;">
                            </td>
                            <td style="padding: 12px; text-align: center; color: ${hasNoRate ? '#ef4444' : '#667eea'};">
                                ${rateDisplay}
                            </td>
                            <td style="padding: 12px;">
                                <input type="text" id="notes-${emp.id}" value="${emp.notes || ''}" 
                                    placeholder="Notes..." 
                                    style="width: 150px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); padding: 5px; border-radius: 5px;">
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="savePayrate(${emp.id})" style="padding: 5px 15px; background: ${hasNoRate ? '#ef4444' : '#22c55e'}; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    ${hasNoRate ? 'Set Rate' : 'Save'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Show count of employees without rates
                const noRateCount = payrates.filter(emp => !emp.pay_rate || parseFloat(emp.pay_rate) === 0).length;
                if (noRateCount > 0) {
                    const alertDiv = document.createElement('div');
                    alertDiv.style.cssText = 'padding: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; margin-top: 10px;';
                    alertDiv.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 10px;"></i><strong>${noRateCount} employees</strong> have no pay rate set`;
                    const container = tbody.parentElement.parentElement;
                    const existingAlert = container.querySelector('.no-rate-alert');
                    if (existingAlert) existingAlert.remove();
                    alertDiv.className = 'no-rate-alert';
                    container.appendChild(alertDiv);
                }
            };

            window.filterPayrates = function() {
                displayFilteredPayrates();
            };

            window.sortPayrates = function() {
                displayFilteredPayrates();
            };

            window.savePayrate = async function(employeeId) {
                const payType = document.getElementById(`paytype-${employeeId}`).value;
                const payRate = document.getElementById(`payrate-${employeeId}`).value;
                const notes = document.getElementById(`notes-${employeeId}`).value;
                
                try {
                    const response = await fetch(`/api/dashboard/employees/${employeeId}/payrate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({
                            pay_rate: parseFloat(payRate),
                            pay_type: payType,
                            notes: notes
                        })
                    });
                    
                    if (response.ok) {
                        // Show success feedback
                        const row = document.getElementById(`payrate-${employeeId}`).closest('tr');
                        row.style.background = 'rgba(34, 197, 94, 0.1)';
                        setTimeout(() => {
                            row.style.background = '';
                            loadPayratesData(); // Reload to show updated hourly equivalent
                        }, 1000);
                    } else {
                        alert('Error saving payrate');
                    }
                } catch (error) {
                    alert('Failed to save payrate');
                }
            };
            window.loadArchivedEmployees = async function() {
                try {
                    const response = await fetch('/api/dashboard/employees/archived', {
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        displayArchivedTable(data.archived);
                    }
                } catch (error) {
                    console.error('Error loading archived employees:', error);
                }
            };

            window.displayArchivedTable = function(archived) {
                const tbody = document.getElementById('archivedTableBody');
                if (!tbody) return;
                
                if (!archived || archived.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #808080;">No archived employees</td></tr>';
                    return;
                }
                
                tbody.innerHTML = archived.map(emp => `
                    <tr>
                        <td style="padding: 12px;">${emp.name}</td>
                        <td style="padding: 12px;">${emp.email || '-'}</td>
                        <td style="padding: 12px;">${new Date(emp.archived_at).toLocaleDateString()}</td>
                        <td style="padding: 12px;">
                            <button onclick="restoreEmployee(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')" style="padding: 5px 10px; background: #27ae60; color: white; border: none; border-radius: 5px;">Restore</button>
                        </td>
                    </tr>
                `).join('');
            };

            window.restoreEmployee = async function(id, name) {
                if (!confirm(`Restore ${name} to active employees?`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/dashboard/employees/${id}/restore`, {
                        method: 'POST',
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });
                    
                    if (response.ok) {
                        alert('Employee restored successfully');
                        loadArchivedEmployees();
                        loadEmployeeManagementData();
                    }
                } catch (error) {
                    alert('Failed to restore employee');
                }
            };

            window.archiveEmployee = async function(id, name) {
                if (!confirm(`Are you sure you want to archive ${name}? They will be hidden from all active views.`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/dashboard/employees/${id}/archive`, {
                        method: 'POST',
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Employee archived successfully');
                        loadEmployeeManagementData(); // Reload the list
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Failed to archive employee');
                }
            };

            window.editEmployee = function(id) {
                alert('Edit employee ' + id + ' - To be implemented');
            };

            window.mapEmployee = async function(id) {
                // Get employee details
                const row = Array.from(document.querySelectorAll('#employeeTableBody tr')).find(r => r.querySelector('td').textContent == id);
                const employeeName = row.querySelectorAll('td')[1].textContent;
                
                // Fetch unmapped PodFactory emails and Connecteam users
                const unmappedData = await fetch('/api/dashboard/unmapped-users', {
                    headers: {'X-API-Key': 'dev-api-key-123'}
                }).then(r => r.json());
                
                const modal = `
                    <div id="mappingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: #2a2a2a; padding: 30px; border-radius: 10px; width: 700px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="color: #e0e0e0; margin-bottom: 20px;">Map ${employeeName}</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="color: #667eea;">Select Connecteam User:</h4>
                                    <input type="text" id="connecteamSearch" placeholder="Search by name..." style="width: 100%; padding: 8px; margin-bottom: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px;" onkeyup="filterConnecteamList()">
                                    <div id="connecteamList" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; padding: 10px;">
                                        ${unmappedData.connecteam_users.map(user => `
                                            <label style="display: block; padding: 8px; cursor: pointer; color: #e0e0e0;">
                                                <input type="radio" name="connecteamUser" value="${user.connecteam_id}" data-name="${user.name}">
                                                ${user.name} (${user.connecteam_id})
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 style="color: #9b59b6;">Select PodFactory Emails:</h4>
                                    <input type="text" id="podfactorySearch" placeholder="Search emails..." style="width: 100%; padding: 8px; margin-bottom: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px;" onkeyup="filterPodfactoryList()">
                                    <div id="podfactoryList" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; padding: 10px;">
                                        ${unmappedData.podfactory_emails.map(email => `
                                            <label style="display: block; padding: 8px; cursor: pointer; color: #e0e0e0;">
                                                <input type="checkbox" name="podfactoryEmail" value="${email}">
                                                ${email}
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="document.getElementById('mappingModal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                <button onclick="saveSmartMapping(${id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Mapping</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
            };

            window.filterConnecteamList = function() {
                const search = document.getElementById('connecteamSearch').value.toLowerCase();
                document.querySelectorAll('#connecteamList label').forEach(label => {
                    label.style.display = label.textContent.toLowerCase().includes(search) ? 'block' : 'none';
                });
            };

            window.filterPodfactoryList = function() {
                const search = document.getElementById('podfactorySearch').value.toLowerCase();
                document.querySelectorAll('#podfactoryList label').forEach(label => {
                    label.style.display = label.textContent.toLowerCase().includes(search) ? 'block' : 'none';
                });
            };

            window.saveSmartMapping = async function(employeeId) {
                const connecteamUser = document.querySelector('input[name="connecteamUser"]:checked');
                const podfactoryEmails = Array.from(document.querySelectorAll('input[name="podfactoryEmail"]:checked')).map(cb => cb.value);
                
                if (!connecteamUser) {
                    alert('Please select a Connecteam user');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/dashboard/employees/${employeeId}/mapping`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({
                            connecteam_user_id: connecteamUser.value,
                            podfactory_emails: podfactoryEmails.join(',')
                        })
                    });
                    
                    if (response.ok) {
                        alert('Mapping saved successfully!');
                        document.getElementById('mappingModal').remove();
                        window.loadEmployeeManagementData();
                    } else {
                        alert('Error saving mapping');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error saving mapping');
                }
            };

            window.syncWithConnecteam = async function() {
                if (!confirm('Sync all employees from Connecteam? This may take a moment.')) return;
                
                try {
                    const response = await fetch('/api/connecteam/sync/employees', {
                        method: 'POST',
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        alert(`Sync complete! Updated: ${result.stats.updated}, Created: ${result.stats.created}`);
                        window.loadEmployeeManagementData();
                    } else {
                        alert('Sync failed');
                    }
                } catch (error) {
                    alert('Error syncing with Connecteam');
                }
            };

            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            });

            // Date filter functions - Make them globally accessible
            window.setDateRange = function(range) {
                const today = api.getCentralDate();
                const startDate = document.getElementById('startDate');
                const endDate = document.getElementById('endDate');
                
                endDate.value = today;
                
                switch(range) {
                    case 'today':
                        startDate.value = today;
                        break;
                    case 'week':
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        startDate.value = weekAgo.toISOString().split('T')[0];
                        break;
                    case 'month':
                        const monthAgo = new Date();
                        monthAgo.setDate(monthAgo.getDate() - 30);
                        startDate.value = monthAgo.toISOString().split('T')[0];
                        break;
                }
                
                // Auto-apply when using quick buttons
                applyDateFilter();
            };

            window.applyDateFilter = function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                if (startDate > endDate) {
                    alert('Start date must be before end date');
                    return;
                }
                
                console.log('Applying date filter:', startDate, 'to', endDate);
                
                // Update the dashboard title to show date range
                const titleElement = document.querySelector('.dashboard-title p');
                if (startDate === endDate) {
                    titleElement.textContent = `Data for ${new Date(startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                } else {
                    titleElement.textContent = `Data from ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}`;
                }
                
                // Store the date range
                dashboardData.startDate = startDate;
                dashboardData.endDate = endDate;
                
                // Check which section is currently active and reload its data
                const costSection = document.getElementById('cost-section');
                const bottleneckSection = document.getElementById('bottleneck-section');
                const dashboardSection = document.getElementById('dashboard-section');
                
                if (costSection && costSection.classList.contains('active')) {
                    console.log('Cost Analysis tab is active, reloading cost data...');
                    loadCostAnalysisData();  // This will now use the selected date
                } else if (bottleneckSection && bottleneckSection.classList.contains('active')) {
                    console.log('Bottleneck tab is active, reloading bottleneck data...');
                    loadBottleneckData();
                } else if (dashboardSection && dashboardSection.classList.contains('active')) {
                    console.log('Dashboard tab is active, reloading dashboard data...');
                    loadDashboardDataForDateRange(startDate, endDate);
                }
            };
            // Make showSection globally accessible
            window.showSection = function(sectionName) {
                // Hide all sections
                document.querySelectorAll('.section-content').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Remove active from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Show selected section
                const targetSection = document.getElementById(`${sectionName}-section`);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Mark nav item as active
                if (event && event.target) {
                    const navItem = event.target.closest('.nav-item');
                    if (navItem) {
                        navItem.classList.add('active');
                    }
                }
                
                // Load data if bottleneck section
                if (sectionName === 'bottleneck') {
                    loadBottleneckData();
                } else if (sectionName === 'cost') {
                    loadCostAnalysisData();  // Add this line
                }
            }
            // Modified load function for date ranges
            window.loadDashboardDataForDateRange = async function(startDate, endDate) {
                try {
                    showLoadingStates();
                    
                    // For single day, use existing endpoints
                    if (startDate === endDate) {
                        const leaderboard = await api.getLeaderboard(startDate);
                        const departmentStats = await api.getDepartmentStats(startDate);
                        let teamMetrics = {};
                        
                        try {
                            // Try to get team metrics for specific date
                            teamMetrics = await api.getTeamMetrics(startDate);
                        } catch (error) {
                            console.error('Team metrics failed:', error);
                            // Calculate from leaderboard if team metrics fails
                            const activeEmployees = leaderboard.filter(e => e.is_clocked_in).length;
                            const totalItems = leaderboard.reduce((sum, emp) => sum + (emp.items_today || 0), 0);
                            teamMetrics = {
                                active_employees: activeEmployees,
                                total_employees_today: leaderboard.length,
                                items_today: totalItems,
                                overall_efficiency: 0,
                                total_hours_worked: leaderboard.reduce((sum, emp) => {
                                    const minutes = parseInt(emp.total_minutes || 0);
                                    return sum + (minutes / 60);
                                }, 0).toFixed(1),
                                vs_yesterday: 0
                            };
                        }
                        
                        dashboardData = {
                            leaderboard,
                            departmentStats,
                            teamMetrics,
                            currentDate: startDate
                        };
                        
                        updateMetrics(leaderboard, teamMetrics);
                        updateDepartmentCards(departmentStats);
                        updateActivityFeed([]); // Clear activity feed for historical dates
                        
                        // Update alerts for historical view
                        if (startDate !== api.getCentralDate()) {
                            document.getElementById('alertsContainer').innerHTML = `
                                <div class="alert-item" style="background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.2);">
                                    <i class="fas fa-calendar-alt alert-icon" style="color: #667eea;"></i>
                                    <div class="alert-content">
                                        <div class="alert-title" style="color: #667eea;">Historical Data</div>
                                        <div class="alert-message">Viewing data for ${new Date(startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                    } else {
                        // Date range view - use new aggregated endpoint
                        try {
                            const rangeData = await api.getLeaderboardRange(startDate, endDate);
                            
                            // Update UI for range view
                            updateDateRangeView(rangeData);
                        } catch (error) {
                            console.error('Error loading date range:', error);
                            document.getElementById('alertsContainer').innerHTML = `
                                <div class="alert-item">
                                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                                    <div class="alert-content">
                                        <div class="alert-title">Error Loading Date Range</div>
                                        <div class="alert-message">Failed to load date range data. Please try again.</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                } catch (error) {
                    console.error('Error loading date range data:', error);
                    showErrorState();
                }
            };

            function updateDateRangeView(rangeData) {
                // Update the alert to show we're in comparison mode
                document.getElementById('alertsContainer').innerHTML = `
                    <div class="alert-item" style="background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.2);">
                        <i class="fas fa-chart-bar alert-icon" style="color: #667eea;"></i>
                        <div class="alert-content">
                            <div class="alert-title" style="color: #667eea;">Comparison Mode Active</div>
                            <div class="alert-message">Viewing ${rangeData.date_range.days}-day summary (${rangeData.date_range.start} to ${rangeData.date_range.end}) with live data overlay</div>
                        </div>
                    </div>
                `;
                
                // Update metrics to show BOTH current and range data
                const totalItems = rangeData.leaderboard.reduce((sum, emp) => sum + emp.total_items, 0);
                const totalDays = rangeData.date_range.days;
                const employeeCount = rangeData.leaderboard.length;
                
                // Fetch today's data for comparison
                api.getTeamMetrics().then(todayMetrics => {
                    // Active Employees - show today's active vs total in range
                    document.getElementById('activeEmployees').innerHTML = `
                        <span style="font-size: 1.8em;">${todayMetrics.active_employees}</span>
                        <span style="font-size: 0.8em; opacity: 0.7;">/${employeeCount}</span>
                    `;
                    document.querySelector('#activeEmployees').nextElementSibling.textContent = 'Active Now / Range Total';
                    
                    // Items - show today vs range average
                    const dailyAvg = Math.round(totalItems / totalDays);
                    document.getElementById('itemsProcessed').innerHTML = `
                        <span style="font-size: 1.8em;">${todayMetrics.items_today.toLocaleString()}</span>
                        <span style="font-size: 0.8em; opacity: 0.7;"> | Avg: ${dailyAvg}</span>
                    `;
                    document.querySelector('#itemsProcessed').nextElementSibling.textContent = 'Today | Daily Avg';
                    
                    // Efficiency - today vs range
                    document.getElementById('overallEfficiency').innerHTML = `
                        <span style="font-size: 1.8em;">${Math.round(todayMetrics.overall_efficiency)}%</span>
                    `;
                    document.querySelector('#overallEfficiency').nextElementSibling.textContent = 'Current Efficiency';
                    
                    // Show change indicators based on range comparison
                    const todayVsAvg = ((todayMetrics.items_today - dailyAvg) / dailyAvg) * 100;
                    updateMetricChange('itemsProcessedChange', todayVsAvg);
                });
                
                // Total hours stays as days
                document.getElementById('totalHours').textContent = totalDays;
                document.querySelector('#totalHours').nextElementSibling.textContent = 'Days in Range';
                
                // Update department grid with enhanced view
                const container = document.getElementById('departmentGrid');
                container.innerHTML = `
                    <div class="col-12">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Performance Analysis (${rangeData.date_range.start} to ${rangeData.date_range.end})</h3>
                            <div style="display: flex; gap: 10px;">
                                <span class="badge" style="background: #667eea; padding: 8px 16px; border-radius: 20px;">
                                    ${rangeData.date_range.days} Days
                                </span>
                                <span class="badge" style="background: #34d399; padding: 8px 16px; border-radius: 20px;">
                                    ${rangeData.leaderboard.length} Employees
                                </span>
                                <span class="badge" style="background: #fbbf24; padding: 8px 16px; border-radius: 20px;">
                                    ${totalItems.toLocaleString()} Total Items
                                </span>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                        <th style="padding: 12px; text-align: left;">Rank</th>
                                        <th style="padding: 12px; text-align: left;">Employee</th>
                                        <th style="padding: 12px; text-align: center;">Days</th>
                                        <th style="padding: 12px; text-align: center;">Total Items</th>
                                        <th style="padding: 12px; text-align: center;">Daily Avg</th>
                                        <th style="padding: 12px; text-align: center;">Best Day</th>
                                        <th style="padding: 12px; text-align: center;">Today</th>
                                        <th style="padding: 12px; text-align: center;">Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="rangeTableBody">
                                    ${rangeData.leaderboard.map((emp, index) => {
                                        return `
                                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                <td style="padding: 12px;">${index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : index + 1}</td>
                                                <td style="padding: 12px; font-weight: 600;">${emp.name}</td>
                                                <td style="padding: 12px; text-align: center;">${emp.days_worked}</td>
                                                <td style="padding: 12px; text-align: center; font-weight: 600; color: #667eea;">${emp.total_items.toLocaleString()}</td>
                                                <td style="padding: 12px; text-align: center;">${emp.avg_daily_items}</td>
                                                <td style="padding: 12px; text-align: center;">${emp.best_day}</td>
                                                <td style="padding: 12px; text-align: center;" id="today-${emp.id}">
                                                    <span class="loading" style="width: 15px; height: 15px;"></span>
                                                </td>
                                                <td style="padding: 12px; text-align: center;" id="trend-${emp.id}">-</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Load today's data for each employee
                loadTodayComparison(rangeData.leaderboard);
                
                // Keep the activity feed for current activities
                loadRecentActivities();
            }

            // Add these new functions right after updateDateRangeView

            // New function to load today's data for comparison
            async function loadTodayComparison(rangeLeaderboard) {
                try {
                    const todayData = await api.getLeaderboard(dashboardData.startDate || api.getCentralDate());
                    
                    rangeLeaderboard.forEach(emp => {
                        const todayEmp = todayData.find(t => t.name === emp.name);
                        const todayCell = document.getElementById(`today-${emp.id}`);
                        const trendCell = document.getElementById(`trend-${emp.id}`);
                        
                        if (todayEmp && todayCell) {
                            const todayItems = todayEmp.items_today || 0;
                            const vsAvg = ((todayItems - emp.avg_daily_items) / emp.avg_daily_items * 100).toFixed(0);
                            
                            // Update today's count
                            todayCell.innerHTML = `<strong>${todayItems}</strong>`;
                            
                            // Update trend
                            if (todayItems > emp.avg_daily_items) {
                                trendCell.innerHTML = `<span style="color: #34d399;">â†‘ ${Math.abs(vsAvg)}%</span>`;
                            } else if (todayItems < emp.avg_daily_items) {
                                trendCell.innerHTML = `<span style="color: #ef4444;">â†“ ${Math.abs(vsAvg)}%</span>`;
                            } else {
                                trendCell.innerHTML = `<span style="color: #808080;">â†’ 0%</span>`;
                            }
                            
                            // Highlight if today is their best day
                            if (todayItems > emp.best_day) {
                                todayCell.style.background = 'rgba(52, 211, 153, 0.2)';
                                todayCell.innerHTML += ' ðŸŒŸ';
                            }
                        } else if (todayCell) {
                            todayCell.innerHTML = '<span style="color: #808080;">-</span>';
                            trendCell.innerHTML = '<span style="color: #808080;">-</span>';
                        }
                    });
                } catch (error) {
                    console.error('Error loading today comparison:', error);
                }
            }

            // Load recent activities even in date range mode
            async function loadRecentActivities() {
                try {
                    const activities = await api.getRecentActivities(5);
                    const feed = document.getElementById('activityFeed');
                    if (feed && activities.length > 0) {
                        feed.innerHTML = '<h4 style="margin-bottom: 15px;">Live Activity Feed</h4>';
                        activities.forEach(activity => {
                            const item = document.createElement('div');
                            item.className = 'activity-item';
                            item.style.opacity = '0.8'; // Slightly dimmed to show it's current
                            
                            let icon = activity.type === 'clock_in' ? 'sign-in-alt' : 'sign-out-alt';
                            let color = activity.type === 'clock_in' ? 'rgba(52, 211, 153, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                            
                            item.innerHTML = `
                                <div class="activity-icon" style="background: ${color};">
                                    <i class="fas fa-${icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${activity.description}</div>
                                    <div class="activity-time">${formatTime(activity.timestamp)}</div>
                                </div>
                            `;
                            feed.appendChild(item);
                        });
                    }
                } catch (error) {
                    console.error('Error loading activities:', error);
                }
            }

            // Initialize date filters on page load
            if (document.getElementById('startDate') && document.getElementById('endDate')) {
                const today = api.getCentralDate();
                console.log('Today from API:', today);
                console.log('Current date:', new Date().toISOString().split('T')[0]);
                
                document.getElementById('startDate').value = today;
                document.getElementById('endDate').value = today;
                document.getElementById('startDate').max = today;
                document.getElementById('endDate').max = today;
            }

            // Bottleneck Detection Functions
            async function loadBottleneckData() {
                try {
                    const response = await api.request('/dashboard/bottleneck/current');
                    updateBottleneckDisplay(response);
                } catch (error) {
                    console.error('Error loading bottleneck data:', error);
                }
            }

            function updateBottleneckDisplay(data) {
                // Update alert
                    if (data.primary_bottleneck && data.primary_bottleneck.status !== 'complete') {
                    document.getElementById('bottleneckAlert').style.display = 'flex';
                    document.getElementById('bottleneckMessage').textContent = 
                        `BOTTLENECK: ${data.primary_bottleneck.station} - Queue building at ${data.primary_bottleneck.queue_growth} items/hr`;
                    document.getElementById('bottleneckSubtext').textContent = 
                        `${data.primary_bottleneck.workers} workers active`;
                } else {
                    document.getElementById('bottleneckAlert').style.display = 'none';
                }
                
                // Update workflow stations
                const stationsContainer = document.getElementById('workflowStations');
                stationsContainer.innerHTML = data.stations.map(station => {
                    let cardClass = 'station-card';
                    if (station.status_level === 'critical') cardClass += ' bottleneck';
                    else if (station.status_level === 'warning') cardClass += ' warning';
                    
                    return `
                        <div class="${cardClass}">
                            <h4>${station.name}</h4>
                            <div class="station-rate">${station.output_rate}</div>
                            <div>items/hour</div>
                            <div class="queue-status">
                                <small>Queue: ${station.estimated_queue} items</small><br>
                                <small>${station.workers} workers</small>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update table
                const tableBody = document.getElementById('stationTableBody');
                tableBody.innerHTML = data.stations.map(station => `
                    <tr>
                        <td style="padding: 15px;">${station.name}</td>
                        <td style="padding: 15px; text-align: center;">${station.workers}</td>
                        <td style="padding: 15px; text-align: center;">${station.output_rate}/hr</td>
                        <td style="padding: 15px; text-align: center;">${station.estimated_queue}</td>
                        <td style="padding: 15px; text-align: center;">
                            ${station.status_level === 'critical' ? 'ðŸš¨ Critical' : 
                              station.status_level === 'warning' ? 'âš ï¸ Warning' : 'âœ… Good'}
                        </td>
                    </tr>
                `).join('');
                
                // Update available workers
                const workersContainer = document.getElementById('availableWorkers');
                if (data.available_workers && data.available_workers.length > 0) {
                    workersContainer.innerHTML = data.available_workers.map(worker => `
                        <div style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                            <strong>${worker.name}</strong><br>
                            Currently at: ${worker.current_station}<br>
                            <small>Skills: ${worker.skills.join(', ')}</small>
                        </div>
                    `).join('');
                } else {
                    workersContainer.innerHTML = '<p style="color: #808080;">No available workers</p>';
                }
                
                // Update recommendations
                const recsContainer = document.getElementById('recommendations');
                if (data.recommendations && data.recommendations.length > 0) {
                    recsContainer.innerHTML = data.recommendations.map(rec => `
                        <div style="padding: 10px; background: rgba(102,126,234,0.1); border-radius: 8px; margin-bottom: 10px;">
                            <strong>Move ${rec.worker}</strong><br>
                            From: ${rec.from} â†’ To: ${rec.to}<br>
                            <small>${rec.reason}</small>
                        </div>
                    `).join('');
                } else {
                    recsContainer.innerHTML = '<p style="color: #808080;">System is balanced</p>';
                }
            }

            // Auto-refresh bottleneck data when on that section
            setInterval(() => {
                if (document.getElementById('bottleneck-section') && 
                    document.getElementById('bottleneck-section').classList.contains('active')) {
                    loadBottleneckData();
                }
            }, 30000); // Every 30 seconds

            // ========== COST ANALYSIS FUNCTIONS ==========

                // Load Cost Analysis Data
                async function loadCostAnalysisData() {
                    try {
                        console.log('Loading cost analysis data...');
                        
                        // Get the selected dates from the date filter
                        const startDate = dashboardData.startDate || dashboardData.startDate || document.getElementById('startDate').value || api.getCentralDate();
                        const endDate = dashboardData.endDate || dashboardData.endDate || document.getElementById('endDate').value || api.getCentralDate();
                        
                        // Fetch cost data from your API with date range
                        const response = await api.getCostAnalysis(startDate, endDate);  // Pass both dates
                        console.log('Cost analysis response for dates:', startDate, 'to', endDate, response);
                        
                        costData = response;
                        
                        // Show a notice based on whether it's a range or single day
                        const costSection = document.getElementById('cost-section');
                        
                        // Remove any existing date notice
                        const existingNotice = costSection.querySelector('.historical-notice');
                        if (existingNotice) {
                            existingNotice.remove();
                        }
                        
                        // Check if it's a date range or single day
                        if (response.date_range && response.date_range.is_range) {
                            // Date range notice
                            const dateNotice = document.createElement('div');
                            dateNotice.className = 'historical-notice alert-item';
                            dateNotice.style.cssText = 'background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.2); margin-bottom: 20px;';
                            dateNotice.innerHTML = `
                                <i class="fas fa-calendar-week alert-icon" style="color: #667eea;"></i>
                                <div class="alert-content">
                                    <div class="alert-title" style="color: #667eea;">
                                        ${response.date_range.days}-Day Cost Analysis
                                    </div>
                                    <div class="alert-message">
                                        Analyzing period from ${new Date(response.date_range.start).toLocaleDateString()} to ${new Date(response.date_range.end).toLocaleDateString()}<br>
                                        <strong>Daily Average:</strong> $${response.daily_avg_cost || '0.00'} | 
                                        <strong>Daily Items:</strong> ${response.daily_avg_items || 0} QC Passed
                                    </div>
                                </div>
                            `;
                            const firstMetric = costSection.querySelector('.metrics-grid');
                            costSection.insertBefore(dateNotice, firstMetric);
                        } else if (startDate !== api.getCentralDate()) {
                            // Single historical day notice
                            const dateNotice = document.createElement('div');
                            dateNotice.className = 'historical-notice alert-item';
                            dateNotice.style.cssText = 'background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.2); margin-bottom: 20px;';
                            dateNotice.innerHTML = `
                                <i class="fas fa-calendar-alt alert-icon" style="color: #667eea;"></i>
                                <div class="alert-content">
                                    <div class="alert-title" style="color: #667eea;">Historical Data</div>
                                    <div class="alert-message">
                                        Viewing costs for ${new Date(startDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                    </div>
                                </div>
                            `;
                            const firstMetric = costSection.querySelector('.metrics-grid');
                            costSection.insertBefore(dateNotice, firstMetric);
                        }
                        
                        // Check if we have employee data
                        if (response.employee_costs && response.employee_costs.length > 0) {
                            console.log(`Found ${response.employee_costs.length} employees`);
                            
                            // If it's a date range, show additional info
                            if (response.date_range && response.date_range.is_range) {
                                console.log(`Date range: ${response.date_range.days} days`);
                                console.log(`Total labor cost: $${response.total_labor_cost}`);
                                console.log(`Daily average cost: $${response.daily_avg_cost}`);
                            }
                        } else {
                            console.log('No employee costs data found');
                        }
                        
                        // Update all components
                        updateCostMetrics(response);
                        updateCostTable();
                        
                        // Fix the department costs error
                        if (response.department_costs) {
                            updateDepartmentCosts(response.department_costs);
                        }
                        
                        // Fix the champions error
                            if (response.top_performers) {
                                updateCostChampions(response.top_performers);
                            }
                            
                        } catch (error) {
                            console.error('Error loading cost data:', error);
                            showCostErrorState();
                        }
                    }

                    // Format items breakdown for display
                    function formatItemsBreakdown(breakdown) {
                        if (!breakdown) return '<span style="color: #999; font-style: italic; font-size: 11px;">No activities</span>';
                        
                        const activities = [
                            { key: 'picking', label: 'Picking', icon: 'ðŸŽ¯' },
                            { key: 'labeling', label: 'Labeling', icon: 'ðŸ·ï¸' },
                            { key: 'film_matching', label: 'Film', icon: 'ðŸŽ¬' },
                            { key: 'in_production', label: 'Pressing', icon: 'ðŸ”¥' },
                            { key: 'qc_passed', label: 'Shipping', icon: 'ðŸ“¦' }
                        ];
                        
                        let html = '<div style="display: flex; flex-direction: column; gap: 3px; font-size: 12px;">';
                        let hasAnyItems = false;
                        
                        activities.forEach(activity => {
                            const count = breakdown[activity.key] || 0;
                            if (count > 0) {
                                hasAnyItems = true;
                                const colors = {
                                    'picking': '#4CAF50',
                                    'labeling': '#2196F3', 
                                    'film_matching': '#FF9800',
                                    'in_production': '#9C27B0',
                                    'qc_passed': '#00BCD4'
                                };
                                html += `
                                    <div style="display: flex; align-items: center; padding: 2px 4px; background: rgba(103, 126, 234, 0.05); border-radius: 4px; border-left: 2px solid ${colors[activity.key]};">
                                        <span style="margin-right: 4px;">${activity.icon}</span>
                                        <span style="font-weight: 500; margin-right: 4px; min-width: 50px;">${activity.label}:</span>
                                        <span style="font-weight: 600; color: #e0e0e0; margin-left: auto;">${count.toLocaleString()}</span>
                                    </div>
                                `;
                            }
                        });
                        
                        if (!hasAnyItems) {
                            html += '<span style="color: #999; font-style: italic; font-size: 11px;">No activities</span>';
                        }
                        
                        html += '</div>';
                        return html;
                    }

                    // Update Cost Metrics with dual metrics
                    function updateCostMetrics(data) {
                        // Total Labor Cost
                        document.getElementById('totalLaborCost').textContent = `$${parseFloat(data.total_labor_cost || 0).toFixed(2)}`;
                    
                    // Average Cost per Item (True and Active) - now based on QC Passed items
                    document.getElementById('avgCostPerItem').textContent = `$${parseFloat(data.avg_cost_per_item || 0).toFixed(3)}`;
                    document.getElementById('avgCostPerItemActive').textContent = `Active: $${parseFloat(data.avg_cost_per_item_active || 0).toFixed(3)}`;
                    
                    // Update the label to show it's based on QC Passed
                    const costLabel = document.querySelector('#avgCostPerItem').nextElementSibling;
                    if (costLabel) {
                        costLabel.textContent = `Avg Cost per Item`;
                    }
                    
                    // Overall Utilization
                    const utilization = parseFloat(data.overall_utilization || 0);
                    document.getElementById('overallUtilization').textContent = `${utilization.toFixed(1)}%`;
                    document.getElementById('utilizationProgress').style.width = `${utilization}%`;
                    
                    // Non-Active Hours and Cost
                    document.getElementById('totalNonActiveHours').textContent = `${parseFloat(data.total_non_active_hours || 0).toFixed(1)} hrs`;
                    document.getElementById('nonActiveCost').textContent = `Idle Cost: $${parseFloat(data.total_non_active_cost || 0).toFixed(2)}`;
                    
                    // Active Employees and Average Rate
                    document.getElementById('activeEmployeeCount').textContent = data.active_employees || 0;
                    document.getElementById('avgHourlyRate').textContent = `Avg Rate: $${parseFloat(data.avg_hourly_rate || 0).toFixed(2)}/hr`;
                    
                    // Update change indicators
                    updateMetricChange('costVsYesterday', parseFloat(data.vs_yesterday_percent || 0));
                    
                    // Show QC Passed count somewhere visible
                    if (data.qc_passed_items !== undefined) {
                        // You could add a small badge or subtitle showing the QC passed count
                        const subtitle = document.getElementById('avgCostPerItemActive');
                        if (subtitle) {
                            subtitle.innerHTML = `Active: $${parseFloat(data.avg_cost_per_item_active || 0).toFixed(3)}<br><small style="opacity: 0.7;">(${data.qc_passed_items} QC Passed)</small>`;
                        }
                    }
                    
                    // Show alert if utilization is low OR cost per item is high
                    const targetCostPerItem = 1.5; // Your target
                    if (utilization < 50 || data.avg_cost_per_item > targetCostPerItem * 1.5) {
                        document.getElementById('highCostAlert').style.display = 'block';
                        
                        if (utilization < 50) {
                            document.getElementById('highCostMessage').textContent = 
                                `Low utilization (${utilization.toFixed(1)}%) - ${parseFloat(data.total_non_active_hours || 0).toFixed(1)} idle hours costing $${parseFloat(data.total_non_active_cost || 0).toFixed(2)}`;
                        } else {
                            document.getElementById('highCostMessage').textContent = 
                                `High cost per QC item ($${data.avg_cost_per_item.toFixed(3)}) - Target is $${targetCostPerItem}`;
                        }
                    } else {
                        document.getElementById('highCostAlert').style.display = 'none';
                    }
                }
                // Filter cost table by search input
                function filterCostTable() {
                    const searchInput = document.getElementById('costSearchInput');
                    const searchValue = searchInput ? searchInput.value.toLowerCase().trim() : '';
                    
                    // Get the table body
                    const tbody = document.getElementById('costTableBody');
                    if (!tbody) return;
                    
                    // Get all rows
                    const rows = tbody.querySelectorAll('tr');
                    
                    // Filter rows
                    rows.forEach(row => {
                        // Get the employee name from first cell
                        const nameCell = row.querySelector('td:first-child');
                        if (!nameCell) return;
                        
                        const name = nameCell.textContent.toLowerCase();
                        
                        // Show or hide based on search
                        if (searchValue === '' || name.includes(searchValue)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                }
                
                // Make filterCostTable available globally
                window.filterCostTable = filterCostTable;

                // Update Cost Table with all new columns
                function updateCostTable() {
                    console.log('updateCostTable called with costData:', costData);
                    
                    if (!costData) {
                        console.error('No cost data available');
                        showCostErrorState();
                        return;
                    }
                    
                    if (!costData.employee_costs) {
                        console.error('No employee_costs in costData');
                        showCostErrorState();
                        return;
                    }
                    
                    if (costData.employee_costs.length === 0) {
                        console.error('Empty employee_costs array');
                        showCostErrorState();
                        return;
                    }
                    
                    console.log('Processing', costData.employee_costs.length, 'employees');
                    
                    const sortBy = document.getElementById('costSortBy').value;
                    const tbody = document.getElementById('costTableBody');
                    
                    // Sort employees
                    let sortedEmployees = [...costData.employee_costs];
                    switch(sortBy) {
                        case 'name':
                            sortedEmployees.sort((a, b) => a.name.localeCompare(b.name));
                            break;
                        case 'utilization':
                            sortedEmployees.sort((a, b) => (b.utilization_rate || 0) - (a.utilization_rate || 0));
                            break;
                        case 'cost_per_item':
                            sortedEmployees.sort((a, b) => (a.cost_per_item || 999) - (b.cost_per_item || 999));
                            break;
                        case 'total_cost':
                            sortedEmployees.sort((a, b) => b.total_cost - a.total_cost);
                            break;
                        case 'efficiency':
                            sortedEmployees.sort((a, b) => b.efficiency - a.efficiency);
                            break;
                        case 'non_active':
                            sortedEmployees.sort((a, b) => (b.non_active_hours || 0) - (a.non_active_hours || 0));
                            break;
                    }
                    
                    // Populate table
                    tbody.innerHTML = sortedEmployees.map(emp => {
                        const nonActivePercent = (emp.non_active_hours / emp.clocked_hours * 100) || 0;
                        const nonActiveColor = nonActivePercent > 50 ? '#ef4444' : (nonActivePercent > 30 ? '#f59e0b' : '#22c55e');
                        
                        return `
                            <tr>
                                <td style="padding: 12px;">${emp.name}</td>
                                <td style="padding: 12px; text-align: center;">$${parseFloat(emp.hourly_rate || 0).toFixed(2)}</td>
                                <td style="padding: 12px; text-align: center;">${parseFloat(emp.clocked_hours || 0).toFixed(1)}</td>
                                <td style="padding: 12px; text-align: center; color: #22c55e;">${parseFloat(emp.active_hours || 0).toFixed(1)}</td>
                                <td style="padding: 12px; text-align: center; color: ${nonActiveColor}; font-weight: bold;">
                                    ${parseFloat(emp.non_active_hours || 0).toFixed(1)}
                                    <small style="opacity: 0.7;">(${nonActivePercent.toFixed(0)}%)</small>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                        <div style="width: 100px; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                                            <div style="width: ${emp.utilization_rate || 0}%; height: 100%; background: ${(emp.utilization_rate || 0) > 70 ? '#22c55e' : (emp.utilization_rate || 0) > 50 ? '#3b82f6' : '#f59e0b'};"></div>
                                        </div>
                                        <span>${parseFloat(emp.utilization_rate || 0).toFixed(1)}%</span>
                                    </div>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    $${parseFloat(emp.total_cost || 0).toFixed(2)}
                                    <div style="font-size: 0.8em; margin-top: 2px;">
                                        <span style="color: #22c55e;">Active: $${parseFloat(emp.active_cost || 0).toFixed(2)}</span><br>
                                        <span style="color: #ef4444;">Idle: $${parseFloat(emp.non_active_cost || 0).toFixed(2)}</span>
                                    </div>
                                </td>
                                <td style="padding: 12px; text-align: center;">${emp.items_processed || 0}</td>
                                <td style="padding: 12px; text-align: left;">
                                    ${formatItemsBreakdown(emp.activity_breakdown)}
                                </td>
                                <td style="padding: 12px; text-align: center;">$${parseFloat(emp.cost_per_item_true || emp.cost_per_item || 0).toFixed(3)}</td>
                                <td style="padding: 12px; text-align: center; color: #22c55e;">$${parseFloat(emp.cost_per_item_active || 0).toFixed(3)}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <span class="status-badge" style="background: ${emp.status_color || '#6b7280'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px;">
                                        ${emp.status || 'UNKNOWN'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Update footer totals
                    const totals = sortedEmployees.reduce((acc, emp) => {
                        acc.clocked += parseFloat(emp.clocked_hours || 0);
                        acc.active += parseFloat(emp.active_hours || 0);
                        acc.nonActive += parseFloat(emp.non_active_hours || 0);
                        acc.cost += parseFloat(emp.total_cost || 0);
                        acc.activeCost += parseFloat(emp.active_cost || 0);
                        acc.items += parseInt(emp.items_processed || 0);
                        acc.count++;
                        return acc;
                    }, { clocked: 0, active: 0, nonActive: 0, cost: 0, activeCost: 0, items: 0, count: 0 });

                    document.getElementById('footerAvgRate').textContent = totals.clocked > 0 ? `$${(totals.cost / totals.clocked).toFixed(2)}` : '-';
                    document.getElementById('footerTotalClocked').textContent = totals.clocked.toFixed(1);
                    document.getElementById('footerTotalActive').textContent = totals.active.toFixed(1);
                    document.getElementById('footerTotalNonActive').textContent = totals.nonActive.toFixed(1);
                    document.getElementById('footerAvgUtilization').textContent = totals.clocked > 0 ? `${(totals.active / totals.clocked * 100).toFixed(1)}%` : '-';
                    document.getElementById('footerTotalCost').textContent = `$${totals.cost.toFixed(2)}`;
                    // Show both total items and QC passed items
                    document.getElementById('footerTotalItems').innerHTML = `
                        ${totals.items.toLocaleString()}
                        <small style="display: block; opacity: 0.7; font-size: 0.8em;">
                            QC: ${costData.qc_passed_items || 'N/A'}
                        </small>
                    `;
                    // Use QC passed items for footer cost calculations too
                    const qcItems = costData.qc_passed_items || totals.items;
                    document.getElementById('footerAvgCostPerItem').textContent = qcItems > 0 ? `$${(totals.cost / qcItems).toFixed(3)}` : '-';
                    document.getElementById('footerAvgCostPerItemActive').textContent = qcItems > 0 ? `$${(totals.activeCost / qcItems).toFixed(3)}` : '-';
                    document.getElementById('footerAvgEfficiency').textContent = totals.cost > 0 ? (totals.items / totals.cost).toFixed(1) : '-';
                    }

                // Update Department Costs
                function updateDepartmentCosts(deptCosts) {
                    const container = document.getElementById('departmentCostChart');
                    
                    if (!container) {
                        console.error('Department cost container not found');
                        return;
                    }
                    
                    if (!deptCosts || deptCosts.length === 0) {
                        container.innerHTML = '<p style="color: #808080;">No department data available</p>';
                        return;
                    }
                    // Calculate total labor cost for percentage calculation
                    const totalLaborCost = parseFloat(costData.total_labor_cost) || 0;
                    
                    container.innerHTML = deptCosts.map(dept => {
                        // Convert to numbers
                        const deptTotalCost = parseFloat(dept.total_cost) || 0;
                        const itemsProcessed = parseInt(dept.items_processed) || 0;
                        const employeeCount = parseInt(dept.employee_count) || 0;
                        
                        const costPerItem = itemsProcessed > 0 ? deptTotalCost / itemsProcessed : 0;
                        const percentOfTotal = totalLaborCost > 0 ? (deptTotalCost / totalLaborCost * 100) : 0;
                        
                        return `
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${getDepartmentIcon(dept.department)} ${dept.department}</h4>
                                    <span style="font-size: 1.2em; font-weight: 700; color: #ef4444;">$${deptTotalCost.toFixed(2)}</span>
                                </div>
                                <div class="progress-bar" style="margin-bottom: 10px;">
                                    <div class="progress-fill" style="width: ${percentOfTotal}%; background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85em;">
                                    <div>
                                        <span style="color: #808080;">Employees:</span>
                                        <strong style="color: #e0e0e0;"> ${employeeCount}</strong>
                                    </div>
                                    <div>
                                        <span style="color: #808080;">Items:</span>
                                        <strong style="color: #e0e0e0;"> ${itemsProcessed}</strong>
                                    </div>
                                    <div>
                                        <span style="color: #808080;">Cost/Item:</span>
                                        <strong style="color: ${costPerItem > 0.15 ? '#ef4444' : '#22c55e'};"> $${costPerItem.toFixed(3)}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Update Cost Champions
                function updateCostChampions(champions) {
                    const container = document.getElementById('costChampions');
                    
                    if (!champions || champions.length === 0) {
                        container.innerHTML = '<p style="color: #808080;">No data available</p>';
                        return;
                    }
                    
                    container.innerHTML = champions.slice(0, 5).map((emp, index) => {
                        const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
                        
                        // Convert to numbers
                        const costPerItem = parseFloat(emp.cost_per_item) || 0;
                        const efficiency = parseFloat(emp.efficiency) || 0;
                        const itemsProcessed = parseInt(emp.items_processed) || 0;
                        
                        return `
                            <div class="champion-card">
                                <div class="champion-rank">${medals[index]}</div>
                                <div class="champion-info">
                                    <div class="champion-name">${emp.name}</div>
                                    <div class="champion-stats">
                                        ${itemsProcessed} items at 
                                        <span class="champion-value">$${costPerItem.toFixed(3)}</span>/item
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                // Export Cost Report
                function exportCostReport() {
                    if (!costData || !costData.employee_costs) {
                        alert('No data to export');
                        return;
                    }
                    
                    // Create CSV content
                    const headers = ['Employee', 'Pay Type', 'Hourly Rate', 'Hours Worked', 'Labor Cost', 'Items Processed', 'Cost per Item', 'Efficiency'];
                    const rows = costData.employee_costs.map(emp => [
                        emp.name,
                        emp.pay_type || 'hourly',
                        emp.hourly_rate.toFixed(2),
                        emp.hours_worked.toFixed(2),
                        emp.total_cost.toFixed(2),
                        emp.items_processed,
                        emp.items_processed > 0 ? (emp.total_cost / emp.items_processed).toFixed(3) : '0',
                        emp.total_cost > 0 ? (emp.items_processed / emp.total_cost).toFixed(1) : '0'
                    ]);
                    
                    // Add totals row
                    const totals = costData.employee_costs.reduce((acc, emp) => {
                        acc.hours += emp.hours_worked;
                        acc.cost += emp.total_cost;
                        acc.items += emp.items_processed;
                        return acc;
                    }, { hours: 0, cost: 0, items: 0 });
                    
                    rows.push([
                        'TOTAL',
                        '',
                        (totals.cost / totals.hours).toFixed(2),
                        totals.hours.toFixed(2),
                        totals.cost.toFixed(2),
                        totals.items,
                        totals.items > 0 ? (totals.cost / totals.items).toFixed(3) : '0',
                        totals.cost > 0 ? (totals.items / totals.cost).toFixed(1) : '0'
                    ]);
                    
                    // Create CSV
                    const csv = [
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n');
                    
                    // Download
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cost_report_${api.getCentralDate()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                }

                // Show error state
                function showCostErrorState() {
                    document.getElementById('costTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #808080;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <p>Unable to load cost data. Please check if employee pay rates are configured.</p>
                            </td>
                        </tr>
                    `;
                }
                // Auto-refresh cost data when on that section
                // Auto-refresh cost data when on that section
                setInterval(() => {
                    if (document.getElementById('cost-section') && 
                        document.getElementById('cost-section').classList.contains('active')) {
                        loadCostAnalysisData();
                    }
                }, 60000); // Every minute

                // Add event listener for cost sort dropdown
                const costSortElement = document.getElementById('costSortBy');
                if (costSortElement) {
                    costSortElement.addEventListener('change', updateCostTable);
                }

                // Add event listener for export button
                const exportBtn = document.getElementById('exportCostBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportCostReport);
                }

                });  // <-- This closes the DOMContentLoaded function
        function setDateRange(range) {
            const today = api.getCentralDate();
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            if (range === 'today') {
                startInput.value = today;
                endInput.value = today;
            } else if (range === 'week') {
                const endDate = new Date(today + 'T12:00:00');
                const startDate = new Date(endDate);
                startDate.setDate(startDate.getDate() - 7);
                startInput.value = startDate.toISOString().split('T')[0];
                endInput.value = today;
            } else if (range === 'month') {
                const endDate = new Date(today + 'T12:00:00');
                const startDate = new Date(endDate);
                startDate.setMonth(startDate.getMonth() - 1);
                startInput.value = startDate.toISOString().split('T')[0];
                endInput.value = today;
            }
        }

        function showSection(sectionName) {
            console.log('Showing section:', sectionName);
            
            // Hide all sections
            const sections = ['dashboard-section', 'cost-section', 'bottleneck-section', 'scheduling-section', 'analytics-section', 'employee-management-section'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.style.display = 'none';
                    section.classList.remove('active');
                }
            });
            
            // Show the selected section
            const selectedSection = document.getElementById(sectionName + '-section');
            if (selectedSection) {
                selectedSection.style.display = 'block';
                selectedSection.classList.add('active');
                
                // Load data for the section
                if (sectionName === 'dashboard') {
                    loadDashboardData();
                } else if (sectionName === 'cost') {
                    if (typeof loadCostAnalysisData === 'function') {
                        loadCostAnalysisData();
                    }
                } else if (sectionName === 'bottleneck') {
                    if (typeof loadBottleneckData === 'function') {
                        loadBottleneckData();
                    }
                } else if (sectionName === 'employee-management') {
                    if (typeof loadEmployeeManagementData === 'function') {
                        loadEmployeeManagementData();
                    }
                }
            }
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeNav = document.querySelector(`[onclick*="${sectionName}"]`);
            if (activeNav && activeNav.parentElement) {
                activeNav.parentElement.classList.add('active');
            }
        }
        
function applyDateFilter() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }
            
            console.log('Applying date filter:', startDate, 'to', endDate);
            
            // Update the dashboard title
            const titleElement = document.querySelector('.dashboard-title p');
            if (startDate === endDate) {
                const dateObj = new Date(startDate + 'T12:00:00');
                titleElement.textContent = `Data for ${dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            } else {
                titleElement.textContent = `Data from ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}`;
            }
            
            // Store the date range
            dashboardData.startDate = startDate;
            dashboardData.endDate = endDate;
            
            // Reload data with new date range
            loadDashboardData();
            
            // If cost analysis is active, reload it too
            const costSection = document.getElementById('cost-section');
            if (costSection && costSection.classList.contains('active')) {
                if (typeof loadCostAnalysisData === 'function') {
                    loadCostAnalysisData();
                }
            }
        }
        
        </script>
<script src="/js/auth-check.js"></script>
    </body>
    </html>