<!DOCTYPE html>
<html lang="en">
<head>
<!-- Auth protection disabled temporarily -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PodFactory Command Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/mobile-shared.css?v=20251214d">
    <link rel="stylesheet" href="css/manager.css?v=20251214d">
    <link rel="stylesheet" href="css/manager-industrial.css?v=20251214d" id="theme-css">
</head>
<body>
    <!-- Tab Loading Overlay -->
    <div id="tabLoadingOverlay" class="tab-loading-overlay">
        <div class="tab-loading-spinner"></div>
        <div class="tab-loading-text">Loading...</div>
    </div>

    <!-- Mobile Menu Toggle Button (only visible on mobile) -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()" >‚ò∞</button>
    <!-- Mobile Menu Toggle Button (only visible on mobile) -->
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-close-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        <div class="sidebar-header">
            <h2>PODFACTORY</h2>
            <p style="color: #606080; font-size: 0.7em; letter-spacing: 2px;">COMMAND CENTER</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="showSection('dashboard'); closeSidebar(); return false;">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('bottleneck'); closeSidebar(); return false;">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Bottleneck Detection</span>
            </a>
            <a href="#" class="nav-item" onclick="showSection('cost'); closeSidebar(); return false;">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Cost Analysis</span>
            </a>
            <a href="#" class="nav-item" onclick="showEmployeeManagement()">
                <i class="fas fa-users"></i> Employees
            </a>
            <a href="#" class="nav-item" onclick="window.open('/intelligent-schedule.html', '_blank'); return false;">
                <i class="fas fa-calendar-alt"></i>
                <span>Smart Schedule</span>
            </a>
            <a href="shop-floor.html" class="nav-item">
                <i class="fas fa-tv"></i>
                <span>Shop Floor Display</span>
            </a>
            <a href="employee.html" class="nav-item">
                <i class="fas fa-user"></i>
                <span>Employee Portal</span>
            </a>
            <a href="#" class="nav-item" onclick="openSettingsModal(); return false;">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        
        <div class="sidebar-user-panel">
            <div class="user-info-card">
                <p class="user-label">OPERATOR</p>
                <p class="user-name">Manager Admin</p>
                <div class="status-indicator"><span class="status-dot"></span>ONLINE</div>
            </div>
            <button onclick="logout()" class="logout-btn" style="width: 100%; margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h1>OPERATIONS MATRIX</h1>
                <p>REAL-TIME PRODUCTIVITY MONITORING // TEAM ANALYTICS</p>
            </div>
            <div class="header-actions">
                <div id="currentDateTime"></div>
                <!-- ADD THIS DATE FILTER SECTION -->
                <div class="date-filter-container" style="display: flex; align-items: center; gap: 10px; margin-right: 15px;">
                    <input type="date" id="startDate" class="form-control" style="background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); max-width: 150px;">
                    <span style="color: #808080;">to</span>
                    <input type="date" id="endDate" class="form-control" style="background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); max-width: 150px;">
                    <div class="btn-group">
                        <button class="btn-action btn-secondary" onclick="setDateRange('today')">Today</button>
                        <button class="btn-action btn-secondary" onclick="setDateRange('week')">Week</button>
                        <button class="btn-action btn-secondary" onclick="setDateRange('month')">Month</button>
                    </div>
                    <button class="btn-action btn-primary" onclick="applyDateFilter()">
                        <i class="fas fa-filter"></i>
                        <span>Apply</span>
                    </button>
                </div>
                <!-- END DATE FILTER SECTION -->
                <button class="btn-action btn-secondary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
        
        <!-- SYSTEM STATUS BAR - COMPACT VERSION -->
        <div id="system-status-container" style="
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 20px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-top: -10px;
            margin-bottom: 15px;
        ">
            <span style="font-weight: 600; color: #808080; font-size: 0.85em;">System:</span>
            
            <!-- Connecteam Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="connecteam-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">Connecteam</span>
                <span id="connecteam-last-sync" style="font-size: 0.7em; color: #808080;">(--)</span>
            </div>
            
            <!-- PodFactory Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="podfactory-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">PodFactory</span>
                <span id="podfactory-last-sync" style="font-size: 0.7em; color: #808080;">(--)</span>
            </div>
            
            <!-- Flask Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="flask-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">Backend</span>
            </div>
            
            <!-- Database Status -->
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="database-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #6c757d;"></div>
                <span style="font-size: 0.8em; color: #b0b0b0;">Database</span>
                <span id="database-latency" style="font-size: 0.7em; color: #808080;">(--)</span>
            </div>
            
            <!-- Separator -->
            <div style="width: 1px; height: 16px; background: rgba(255,255,255,0.2); margin: 0 5px;"></div>
            
            <!-- Control Button -->
            <button onclick="openSystemControls()" style="
                padding: 4px 10px;
                background: rgba(102, 126, 234, 0.15);
                border: 1px solid rgba(102, 126, 234, 0.3);
                color: #667eea;
                border-radius: 5px;
                font-size: 0.8em;
                cursor: pointer;
            ">
                Controls
            </button>
        </div>
        
        <!-- Dashboard Section (existing content) -->
        <div id="dashboard-section" class="section-content active">
            <!-- Dashboard Toolbar -->
            <div class="section-toolbar" style="display: flex; justify-content: flex-end; padding: 10px 0; margin-bottom: 10px;">
                <button id="exportDashboardBtn" class="btn-action btn-secondary" onclick="exportDashboardReport()" disabled title="Load data first">
                    <i class="fas fa-download"></i>
                    <span>Export Dashboard</span>
                </button>
            </div>
            <!-- Alerts Section -->
            <div class="alerts-container" id="alertsContainer">
                <!-- Alerts will be populated dynamically -->
            </div>
        
        <!-- Metrics Grid -->
        <div class="metrics-grid">
            <div class="metric-card clickable" onclick="showEmployeePopup()" title="Click to view all employees">
                <div class="metric-header">
                    <div class="metric-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <span class="metric-change" id="activeEmployeesChange">
                        <span class="loading"></span>
                    </span>
                </div>
                <div class="metric-value" id="activeEmployees">--</div>
                <div class="metric-label">Active Employees</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon green">
                        <i class="fas fa-box"></i>
                    </div>
                    <span class="metric-change" id="itemsProcessedChange">
                        <span class="loading"></span>
                    </span>
                </div>
                <div class="metric-value" id="itemsProcessed">--</div>
                <div class="metric-label">Items Processed Today</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon purple">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span class="metric-change" id="efficiencyChange">
                        <span class="loading"></span>
                    </span>
                </div>
                <div class="metric-value" id="overallEfficiency">--%</div>
                <div class="metric-label">Overall Efficiency</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon yellow">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span class="loading" id="hoursLoading"></span>
                </div>
                <div class="metric-value" id="totalHours">--</div>
                <div class="metric-label">Total Hours Worked</div>
            </div>
        </div>
        
        <!-- Department Performance -->
        <h2 style="font-size: 1.5em; margin-bottom: 20px; color: #e0e0e0;">Department Performance</h2>
        <div class="department-grid" id="departmentGrid">
            <!-- Department cards will be populated dynamically -->
            <div class="no-data">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading department data...</p>
            </div>
        </div>
        
        <!-- Charts and Activity Feed -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Hourly Productivity Trend</h3>
                    <select class="form-select" id="chartTimeRange" style="width: auto; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2);">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="productivityChart"></canvas>
                </div>
            </div>
            
            <div class="activity-feed">
                <h3>Clock Activity</h3>
                <div id="activityFeed">
                    <div class="no-data">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading activity data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- This closes the dashboard-section div -->

    <!-- Bottleneck Detection Section (new) -->
    <div id="bottleneck-section" class="section-content">
        <!-- Bottleneck Toolbar -->
        <div class="section-toolbar" style="display: flex; justify-content: flex-end; padding: 10px 0; margin-bottom: 10px;">
            <button id="exportBottleneckBtn" class="btn-action btn-secondary" onclick="exportBottleneckReport()" disabled title="Load data first">
                <i class="fas fa-download"></i>
                <span>Export System Health</span>
            </button>
        </div>
        <!-- Bottleneck Alert -->
        <div id="bottleneckAlert" class="bottleneck-alert" >
            <i class="fas fa-exclamation-circle"></i>
            <div>
                <div style="font-size: 20px; font-weight: 700;" id="bottleneckMessage">Loading...</div>
                <div style="font-size: 14px; opacity: 0.9;" id="bottleneckSubtext">Analyzing workflow...</div>
            </div>
        </div>

        <!-- Workflow Stations -->
        <h2 style="font-size: 1.5em; margin-bottom: 20px; color: #e0e0e0;">Workflow Status</h2>
        <div class="workflow-stations" id="workflowStations">
            <!-- Will be populated dynamically -->
        </div>

        <!-- Station Details Table -->
        <div class="station-table" style="margin-top: 30px;">
            <h3 style="font-size: 1.3em; margin-bottom: 15px; color: #e0e0e0;">Detailed Station Analysis</h3>
            <table style="width: 100%; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <thead>
                    <tr style="background: rgba(0,0,0,0.3);">
                        <th style="padding: 15px; text-align: left; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Station</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Workers</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Rate/Hr</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Queue</th>
                        <th style="padding: 15px; text-align: center; color: #808080; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Status</th>
                    </tr>
                </thead>
                <tbody id="stationTableBody">
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Recommendations -->
        <div class="charts-grid" style="margin-top: 30px;">
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-users"></i> Available Workers</h3>
                <!-- ADD THIS SEARCH BAR HERE -->
                <div style="padding: 10px 0;">
                    <input type="text" 
                        id="availableWorkersSearch" 
                        placeholder="üîç Search workers by name or station..." 
                        onkeyup="debouncedFilterAvailableWorkers(this.value)"
                        style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); 
                                color: #e0e0e0; border: 1px solid rgba(255,255,255,0.1); 
                                border-radius: 8px; font-size: 14px;">
                </div>
                
                <div id="availableWorkers">
                    <div class="no-data">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading worker data...</p>
                    </div>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title"><i class="fas fa-lightbulb"></i> Recommendations</h3>
                <div id="recommendations">
                    <div class="no-data">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Analyzing workflow...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>              

    <!-- Cost Analysis Section -->
    <div id="cost-section" class="section-content">
        <!-- Cost Toolbar -->
        <div class="section-toolbar" style="display: flex; justify-content: flex-end; padding: 10px 0; margin-bottom: 10px;">
            <button id="exportCostBtn" class="btn-action btn-secondary" disabled title="Load data first">
                <i class="fas fa-download"></i>
                <span>Export Cost Report</span>
            </button>
        </div>
        <!-- Cost Overview Cards -->
        <div class="metrics-grid" style="margin-bottom: 30px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
            <div class="metric-card" style="padding: 20px;">
                <div class="metric-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="totalLaborCost">$0.00</div>
                    <div class="metric-label">Today's Labor Cost</div>
                    <div class="metric-change" id="costVsYesterday">
                        <i class="fas fa-minus"></i> --
                    </div>
                </div>
            </div>

            <div class="metric-card" style="padding: 20px;">
                <div class="metric-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <i class="fas fa-box"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="avgCostPerItem">$0.00</div>
                    <div class="metric-label">Average Cost per Item (True)</div>
                    <div class="metric-subtitle" id="avgCostPerItemActive" style="color: #22c55e; font-size: 0.9em; margin-top: 4px;">
                        Active: $0.00
                    </div>
                </div>
            </div>

            <div class="metric-card" style="padding: 20px;">
                <div class="metric-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="overallUtilization">0%</div>
                    <div class="metric-label">Labor Utilization</div>
                    <div class="utilization-bar" style="margin-top: 8px; width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                        <div id="utilizationProgress" class="utilization-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%); transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <div class="metric-card" style="padding: 20px; border: 2px solid #ef4444;">
                <div class="metric-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="totalNonActiveHours" style="color: #ef4444;">0 hrs</div>
                    <div class="metric-label">Non-Active Hours</div>
                    <div class="metric-subtitle" id="nonActiveCost" style="color: #ef4444; font-size: 0.9em; margin-top: 4px;">
                        Idle Cost: $0.00
                    </div>
                </div>
            </div>

            <div class="metric-card" style="padding: 20px;">
                <div class="metric-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value" id="activeEmployeeCount">0</div>
                    <div class="metric-label">Employees Working</div>
                    <div class="metric-subtitle" id="avgHourlyRate" style="color: #808080; font-size: 0.9em; margin-top: 4px;">
                        Avg Rate: $0.00/hr
                    </div>
                </div>
            </div>
        </div>

        <!-- High Cost Alert -->
        <div id="highCostAlert" class="alert-banner" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 15px 20px; border-radius: 12px; margin-bottom: 20px;">
            <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 10px;"></i>
            <span id="highCostMessage" style="color: #ef4444;">High labor cost detected</span>
        </div>

        <!-- Employee Cost Analysis Table -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title"><i class="fas fa-users"></i> Employee Cost Analysis</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="costSortBy" style="background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                        <option value="name">Sort by Name</option>
                        <option value="utilization">Sort by Utilization</option>
                        <option value="cost_per_item">Sort by Cost/Item</option>
                        <option value="total_cost">Sort by Total Cost</option>
                        <option value="efficiency">Sort by Efficiency</option>
                        <option value="non_active">Sort by Idle Time</option>
                    </select>
                    <button class="btn-action btn-secondary" id="exportCostTableBtn" style="padding: 8px 16px;">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                </div>
            </div>
            <div style="padding: 15px 20px 10px 20px;">
                <input type="text" id="costSearchInput" placeholder="Search by name..." 
                       style="width: 100%; max-width: 400px; padding: 10px; background: rgba(255,255,255,0.05); 
                              color: #e0e0e0; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;
                              font-size: 14px;" 
                       oninput="filterCostTable()">
            </div>
            <div style="overflow-x: auto;">
                <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                            <th style="padding: 12px; text-align: left;">Employee</th>
                            <th style="padding: 12px; text-align: center;">Rate/Hr</th>
                            <th style="padding: 12px; text-align: center;">Clocked</th>
                            <th style="padding: 12px; text-align: center; color: #22c55e;">Active</th>
                            <th style="padding: 12px; text-align: center; color: #ef4444;">Non-Active</th>
                            <th style="padding: 12px; text-align: center;">Utilization</th>
                            <th style="padding: 12px; text-align: center;">Labor Cost</th>
                            <th style="padding: 12px; text-align: center;">Items</th>
                            <th style="padding: 12px; text-align: left;">Items Breakdown</th>
                            <th style="padding: 12px; text-align: center;">$/Item (True)</th>
                            <th style="padding: 12px; text-align: center; color: #22c55e;">$/Item (Active)</th>
                            
                            <th style="padding: 12px; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="costTableBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                    <tfoot style="border-top: 2px solid rgba(255,255,255,0.2);">
                        <tr style="font-weight: 600;">
                            <td style="padding: 12px;">TOTAL</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgRate">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerTotalClocked">-</td>
                            <td style="padding: 12px; text-align: center; color: #22c55e;" id="footerTotalActive">-</td>
                            <td style="padding: 12px; text-align: center; color: #ef4444;" id="footerTotalNonActive">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgUtilization">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerTotalCost">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerTotalItems">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgCostPerItem">-</td>
                            <td style="padding: 12px; text-align: center; color: #22c55e;" id="footerAvgCostPerItemActive">-</td>
                            <td style="padding: 12px; text-align: center;" id="footerAvgEfficiency">-</td>
                            <td style="padding: 12px; text-align: center;">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Department Cost Breakdown & Champions -->
        <div class="charts-grid" style="margin-top: 25px;">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-building"></i> Department Cost Breakdown
                </h3>
                <div id="departmentCostChart">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="fas fa-trophy"></i> Cost Champions
                </h3>
                <div id="costChampions">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
    <!-- Smart Schedule Section -->
    <div id="scheduling-section" class="section-content">
        <iframe
            src="/intelligent-schedule.html"
            style="width: 100%; height: calc(100vh - 100px); border: none; border-radius: 10px;"
            title="Smart Schedule System">
        </iframe>
    </div>
    <!-- Employee Management Section -->
    <div id="employee-management-section" class="section-content">
        <div style="padding: 20px;">
            <!-- Header -->
            <div class="dashboard-header" style="margin-bottom: 30px;">
                <div class="dashboard-title">
                    <h1>Employee Management</h1>
                    <p>Manage employee mappings and configurations</p>
                </div>
                <div class="header-actions">
                    <button class="btn-action btn-secondary" onclick="showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i>
                        <span>Back to Dashboard</span>
                    </button>
                </div>
            </div>

            <!-- Alert Section -->
            <div id="empMgmtAlerts"></div>

            <!-- Statistics Cards -->
            <div class="metrics-grid" style="margin-bottom: 30px;">
                <div class="metric-card">
                    <div class="metric-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-value" id="totalEmployeeCount">-</div>
                    <div class="metric-label">Total Employees</div>
                </div>
                
                
                <div class="metric-card" style="cursor: pointer;" onclick="showEmpTab('attention')">
                    <div class="metric-icon yellow">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="metric-value" id="needsAttentionCount">-</div>
                    <div class="metric-label">Needs Attention</div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; padding: 0 20px; flex-wrap: wrap;">
                <button class="btn-action btn-secondary emp-nav-link active" onclick="showEmpTab('list')">All Employees</button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('attention')" id="needsAttentionTab" style="position: relative;">
                    Needs Attention
                    <span id="attentionBadge" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; min-width: 20px; height: 20px; font-size: 11px; display: none; align-items: center; justify-content: center; padding: 0 5px;">0</span>
                </button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('payrates')">Payrates</button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('add')">Add Employee</button>
                <button class="btn-action btn-secondary emp-nav-link" onclick="showEmpTab('archived')">Archived</button>
            </div>

            <!-- Employee List Tab -->
            <div id="empTabList" class="emp-tab-content" style="display: block;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="empSearchInput" placeholder="Search by name, email, or ID..." onkeyup="debouncedFilterEmployees()" style="flex: 1; min-width: 200px; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                        <button class="btn-action btn-secondary" onclick="exportEmployeePins()">
                            <i class="fas fa-download"></i> Export PINs
                        </button>
                        <button class="btn-action btn-secondary" onclick="syncWithConnecteam()">
                            <i class="fas fa-sync"></i> Sync Connecteam
                        </button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                <th style="padding: 12px;">ID</th>
                                <th style="padding: 12px;">Name</th>
                                <th style="padding: 12px;">Email</th>
                                <th style="padding: 12px;">Connecteam ID</th>
                                <th style="padding: 12px;">PodFactory Emails</th>
                                <th style="padding: 12px;">Status</th>
                                <th style="padding: 12px;">PIN</th>
                                <th style="padding: 12px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                    <!-- Pagination Controls -->
                    <div id="employeePagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span id="paginationInfo" style="color: #808080; font-size: 0.9em;">Showing 1-50 of 0</span>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="changeEmployeePage(-1)" id="prevPageBtn" style="padding: 8px 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: none; border-radius: 5px; cursor: pointer;" disabled>‚Üê Prev</button>
                            <span id="pageIndicator" style="padding: 8px 12px; color: #e0e0e0;">Page 1</span>
                            <button onclick="changeEmployeePage(1)" id="nextPageBtn" style="padding: 8px 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: none; border-radius: 5px; cursor: pointer;">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Needs Attention Tab (Unified) -->
            <div id="empTabAttention" class="emp-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h3 style="margin: 0; color: #e0e0e0;">
                            <i class="fas fa-tasks" style="color: #fbbf24; margin-right: 10px;"></i>
                            Employee Issues Queue
                        </h3>
                        <p style="color: #808080; margin: 5px 0 0 0; font-size: 0.9em;">
                            Resolve employee data issues: missing Connecteam links, pending email verifications
                        </p>
                    </div>
                    <button class="btn-action btn-secondary" onclick="loadNeedsAttention()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>

                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 15px;">
                        <div style="color: #ef4444; font-size: 0.85em; margin-bottom: 5px;">
                            <i class="fas fa-unlink"></i> No Connecteam Link
                        </div>
                        <div id="noConnecteamSummary" style="color: #e0e0e0; font-size: 1.5em; font-weight: 600;">-</div>
                    </div>
                    <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 10px; padding: 15px;">
                        <div style="color: #fbbf24; font-size: 0.85em; margin-bottom: 5px;">
                            <i class="fas fa-clock"></i> Pending Verification
                        </div>
                        <div id="pendingVerifSummary" style="color: #e0e0e0; font-size: 1.5em; font-weight: 600;">-</div>
                    </div>
                    <div style="background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 10px; padding: 15px;">
                        <div style="color: #a855f7; font-size: 0.85em; margin-bottom: 5px;">
                            <i class="fas fa-box-open"></i> No PodFactory Mapping
                        </div>
                        <div id="noPodFactorySummary" style="color: #e0e0e0; font-size: 1.5em; font-weight: 600;">-</div>
                    </div>
                </div>

                <!-- No Connecteam Section -->
                <div id="noConnecteamSection" style="margin-bottom: 30px;">
                    <h4 style="color: #ef4444; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-unlink"></i> Employees Without Connecteam Link
                        <span style="font-size: 0.8em; font-weight: normal; color: #808080;">(Cannot calculate productivity hours)</span>
                    </h4>
                    <div id="noConnecteamList" style="display: grid; gap: 10px;">
                        <p style="color: #808080; text-align: center; padding: 20px;">Loading...</p>
                    </div>
                </div>

                <!-- Pending Verifications Section -->
                <div id="pendingVerifSection" style="margin-bottom: 30px;">
                    <h4 style="color: #fbbf24; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-clock"></i> Pending Email Verifications
                        <span style="font-size: 0.8em; font-weight: normal; color: #808080;">(Auto-matched, needs approval)</span>
                    </h4>
                    <div id="pendingVerificationList" style="display: grid; gap: 15px;">
                        <p style="color: #808080; text-align: center; padding: 20px;">Loading...</p>
                    </div>
                </div>

                <!-- No PodFactory Mapping Section -->
                <div id="noPodFactorySection" style="margin-bottom: 30px; display: none;">
                    <h4 style="color: #a855f7; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-box-open"></i> Employees Without PodFactory Mapping
                        <span style="font-size: 0.8em; font-weight: normal; color: #808080;">(Cannot track production data)</span>
                    </h4>
                    <div id="noPodFactoryList" style="display: grid; gap: 10px;">
                        <p style="color: #808080; text-align: center; padding: 20px;">Loading...</p>
                    </div>
                </div>

                <!-- All Clear State -->
                <div id="allClearState" style="display: none; text-align: center; padding: 60px 20px; background: rgba(34, 197, 94, 0.1); border-radius: 12px; border: 1px dashed rgba(34, 197, 94, 0.3);">
                    <i class="fas fa-check-circle" style="font-size: 4em; color: #22c55e; margin-bottom: 20px;"></i>
                    <h3 style="color: #22c55e; margin-bottom: 10px;">All Clear!</h3>
                    <p style="color: #808080;">No employee issues need attention</p>
                </div>
            </div>

            <!-- Payrates Tab -->
            <div id="empTabPayrates" class="emp-tab-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Employee Payrates</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="payrateSearchInput"
                            placeholder="Search by name..."
                            onkeyup="debouncedFilterPayrates()"
                            style="padding: 8px 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; width: 250px;">
                        <select id="payrateSortBy" onchange="sortPayrates()"
                                style="padding: 8px 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                            <option value="name">Sort by Name</option>
                            <option value="not_set">Not Set First</option>
                            <option value="hourly_asc">Hourly: Low ‚Üí High</option>
                            <option value="hourly_desc">Hourly: High ‚Üí Low</option>
                        </select>
                    </div>
                </div>
                <!-- Help text -->
                <div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 0.9em;">
                    <i class="fas fa-info-circle" style="color: #667eea; margin-right: 8px;"></i>
                    <strong>Hourly:</strong> Enter $/hour directly. <strong>Salary:</strong> Enter $/month (converts to hourly at 26 days √ó 8 hrs).
                    Click <span style="background: #667eea; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">Edit</span> to modify, then <span style="background: #22c55e; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">Save</span>.
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                <th style="padding: 12px; text-align: left;">Employee</th>
                                <th style="padding: 12px; text-align: center;">Type</th>
                                <th style="padding: 12px; text-align: center;">Rate</th>
                                <th style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="toggleHourlySort()">
                                    Hourly <i class="fas fa-sort" style="opacity: 0.5;"></i>
                                </th>
                                <th style="padding: 12px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrateTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="payrateNoResults" style="display: none; text-align: center; padding: 40px; color: #808080;">
                    <i class="fas fa-search" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <p>No employees found matching your search</p>
                </div>
            </div>

            <!-- Add Employee Tab -->
            <div id="empTabAdd" class="emp-tab-content" style="display: none;">
                <h3 style="margin-bottom: 20px;">Add New Employee</h3>
                <form id="addEmployeeForm" onsubmit="return addEmployee(event)" style="max-width: 600px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">Full Name *</label>
                        <input type="text" id="newEmpName" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">Email *</label>
                        <input type="email" id="newEmpEmail" required style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">Connecteam User ID</label>
                        <input type="text" id="newEmpConnecteamId" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0e0e0;">PodFactory Email(s) (comma-separated)</label>
                        <input type="text" id="newEmpPodFactoryEmails" placeholder="email1@podfactory.com, email2@podfactory.com" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                    </div>
                    <button type="submit" class="btn-action btn-primary">Add Employee</button>
                </form>
            </div>
            <!-- Archived Employees Tab -->
            <div id="empTabArchived" class="emp-tab-content" style="display: none;">
                <h3 style="margin-bottom: 20px;">Archived Employees</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                <th style="padding: 12px;">Name</th>
                                <th style="padding: 12px;">Email</th>
                                <th style="padding: 12px;">Archived Date</th>
                                <th style="padding: 12px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archivedTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 10001;
        backdrop-filter: blur(4px);
    " onclick="if(event.target === this) closeSettingsModal()">
        <div style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #18181b;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 1px solid #3f3f46;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        ">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #3f3f46;">
                <h2 style="margin: 0; color: #fafafa; font-size: 20px; font-weight: 600;">
                    <i class="fas fa-cog" style="color: #8b5cf6; margin-right: 10px;"></i>Settings
                </h2>
                <button onclick="closeSettingsModal()" style="
                    background: none;
                    border: none;
                    color: #71717a;
                    font-size: 1.5em;
                    cursor: pointer;
                    padding: 0;
                    line-height: 1;
                ">&times;</button>
            </div>

            <!-- Theme Section -->
            <div style="margin-bottom: 24px;">
                <h3 style="margin: 0 0 16px 0; color: #a1a1aa; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                    Theme
                </h3>
                <div id="theme-options" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <!-- Original Theme -->
                    <button class="theme-option-btn" data-theme="original" onclick="selectTheme('original')" style="
                        background: #27272a;
                        border: 2px solid #3f3f46;
                        border-radius: 12px;
                        padding: 16px 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                    ">
                        <div style="
                            width: 100%;
                            height: 60px;
                            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                            border-radius: 8px;
                            margin-bottom: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <div style="width: 20px; height: 20px; background: #667eea; border-radius: 4px;"></div>
                        </div>
                        <span style="color: #fafafa; font-size: 13px; font-weight: 500;">Original</span>
                        <div class="theme-active-indicator" style="display: none; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                    </button>

                    <!-- Cyberpunk Theme -->
                    <button class="theme-option-btn" data-theme="cyberpunk" onclick="selectTheme('cyberpunk')" style="
                        background: #27272a;
                        border: 2px solid #3f3f46;
                        border-radius: 12px;
                        padding: 16px 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                    ">
                        <div style="
                            width: 100%;
                            height: 60px;
                            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
                            border-radius: 8px;
                            margin-bottom: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <div style="width: 16px; height: 16px; background: #00f5ff; border-radius: 2px; box-shadow: 0 0 10px #00f5ff;"></div>
                            <div style="width: 16px; height: 16px; background: #ff00ff; border-radius: 2px; box-shadow: 0 0 10px #ff00ff;"></div>
                        </div>
                        <span style="color: #fafafa; font-size: 13px; font-weight: 500;">Cyberpunk</span>
                        <div class="theme-active-indicator" style="display: none; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                    </button>

                    <!-- Executive Theme -->
                    <button class="theme-option-btn" data-theme="executive" onclick="selectTheme('executive')" style="
                        background: #27272a;
                        border: 2px solid #3f3f46;
                        border-radius: 12px;
                        padding: 16px 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                    ">
                        <div style="
                            width: 100%;
                            height: 60px;
                            background: linear-gradient(135deg, #09090b 0%, #18181b 100%);
                            border-radius: 8px;
                            margin-bottom: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); border-radius: 4px;"></div>
                        </div>
                        <span style="color: #fafafa; font-size: 13px; font-weight: 500;">Executive</span>
                        <div class="theme-active-indicator" style="display: none; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                    </button>

                    <!-- Industrial Theme -->
                    <button class="theme-option-btn" data-theme="industrial" onclick="selectTheme('industrial')" style="
                        background: #27272a;
                        border: 2px solid #3f3f46;
                        border-radius: 12px;
                        padding: 16px 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                    ">
                        <div style="
                            width: 100%;
                            height: 60px;
                            background: linear-gradient(135deg, #0f1419 0%, #1a1f26 100%);
                            border-radius: 8px;
                            margin-bottom: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 4px;
                        ">
                            <div style="width: 16px; height: 16px; background: #f59e0b; border-radius: 2px; box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);"></div>
                            <div style="width: 16px; height: 16px; background: #fbbf24; border-radius: 2px; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);"></div>
                        </div>
                        <span style="color: #fafafa; font-size: 13px; font-weight: 500;">Industrial</span>
                        <div class="theme-active-indicator" style="display: none; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></div>
                    </button>
                </div>
            </div>

            <!-- Info Text -->
            <p style="margin: 0; color: #71717a; font-size: 12px; text-align: center;">
                Theme preference is saved to your browser
            </p>
        </div>
    </div>

    <!-- System Control Modal -->
    <div id="system-control-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
    ">
        <div style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(102, 126, 234, 0.3);
        ">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #e0e0e0;">
                    <span style="color: #667eea;">‚öôÔ∏è</span> System Controls
                </h2>
                <button onclick="closeSystemControls()" style="
                    background: none;
                    border: none;
                    color: #808080;
                    font-size: 1.5em;
                    cursor: pointer;
                ">√ó</button>
            </div>
            
            <!-- Service Controls Grid -->
            <div style="display: grid; gap: 20px;">
                
                <!-- Flask Backend Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #667eea;">Flask Backend</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div>Process: flask-backend (PM2 ID: 9)</div>
                                <div id="flask-uptime">Uptime: --</div>
                                <div id="flask-memory">Memory: --</div>
                                <div id="flask-restarts">Restarts: --</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="restartService('flask-backend')" style="
                                padding: 8px 16px;
                                background: #667eea;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">üîÑ Restart</button>
                            <button onclick="viewLogs('flask-backend')" style="
                                padding: 8px 16px;
                                background: rgba(255,255,255,0.1);
                                color: #e0e0e0;
                                border: 1px solid rgba(255,255,255,0.2);
                                border-radius: 6px;
                                cursor: pointer;
                            ">üìã Logs</button>
                        </div>
                    </div>
                </div>
                
                <!-- Connecteam Sync Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #34d399;">Connecteam Sync</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div id="connecteam-status-detail">Last sync: --</div>
                                <div id="connecteam-records">Records synced: --</div>
                                <div>Schedule: Every 5 minutes</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="forceSync('connecteam')" style="
                                padding: 8px 16px;
                                background: #34d399;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">üîÑ Sync Now</button>
                            <button onclick="clearSyncLogs('connecteam')" style="
                                padding: 8px 16px;
                                background: rgba(239, 68, 68, 0.2);
                                color: #ef4444;
                                border: 1px solid rgba(239, 68, 68, 0.3);
                                border-radius: 6px;
                                cursor: pointer;
                            ">üóëÔ∏è Clear Logs</button>
                        </div>
                    </div>
                </div>
                
                <!-- PodFactory Sync Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #a855f7;">PodFactory Sync</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div id="podfactory-status-detail">Last sync: --</div>
                                <div id="podfactory-items">Items synced: --</div>
                                <div>Process: podfactory-sync (PM2 ID: 6)</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="forceSync('podfactory')" style="
                                padding: 8px 16px;
                                background: #a855f7;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">üîÑ Sync Now</button>
                            <button onclick="restartService('podfactory-sync')" style="
                                padding: 8px 16px;
                                background: rgba(255,255,255,0.1);
                                color: #e0e0e0;
                                border: 1px solid rgba(255,255,255,0.2);
                                border-radius: 6px;
                                cursor: pointer;
                            ">üîÑ Restart</button>
                        </div>
                    </div>
                </div>
                
                <!-- Database Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #fbbf24;">Database Connection</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div id="db-status-detail">Status: --</div>
                                <div id="db-latency-detail">Latency: --</div>
                                <div>Location: Singapore (DigitalOcean)</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="testDatabaseConnection()" style="
                                padding: 8px 16px;
                                background: #fbbf24;
                                color: black;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">üîç Test</button>
                            <button onclick="resetConnectionPool()" style="
                                padding: 8px 16px;
                                background: rgba(255,255,255,0.1);
                                color: #e0e0e0;
                                border: 1px solid rgba(255,255,255,0.2);
                                border-radius: 6px;
                                cursor: pointer;
                            ">üîÑ Reset Pool</button>
                        </div>
                    </div>
                </div>

                <!-- Data Maintenance Control -->
                <div style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 10px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #06b6d4;">Data Maintenance</h3>
                            <div style="color: #808080; font-size: 0.9em;">
                                <div>Recalculate derived data when values become stale</div>
                                <div>Tables: daily_scores, clock_times, employee_status</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="openRecalculationModal()" style="
                                padding: 8px 16px;
                                background: #06b6d4;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                            ">üîß Recalculate</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Actions -->
            <div style="
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid rgba(255,255,255,0.1);
            ">
                <h3 style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Emergency Actions</h3>
                <div style="display: flex; gap: 15px;">
                    <button onclick="restartAllServices()" style="
                        padding: 10px 20px;
                        background: rgba(239, 68, 68, 0.2);
                        color: #ef4444;
                        border: 2px solid #ef4444;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">üîÑ Restart All Services</button>
                    <button onclick="clearAllCaches()" style="
                        padding: 10px 20px;
                        background: rgba(251, 191, 36, 0.2);
                        color: #fbbf24;
                        border: 2px solid #fbbf24;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                    ">üóëÔ∏è Clear All Caches</button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- This closes the main-content div -->

    <!-- Employee Popup Modal -->
    <div id="employee-popup-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10001; align-items: center; justify-content: center;" onclick="hideEmployeePopup(event)">
        <div class="employee-popup" style="background: #1a1a2e; border-radius: 16px; width: 650px; max-width: 95%; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(99,102,241,0.3);" onclick="event.stopPropagation()">
            <div style="background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%); padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: #fff; font-size: 18px; display: flex; align-items: center; gap: 10px; margin: 0;">
                    <i class="fas fa-users"></i> Today's Employees
                    <span id="popupEmployeeCount" style="background: #6366f1; padding: 4px 12px; border-radius: 20px; font-size: 13px;">0 employees</span>
                </h3>
                <button onclick="hideEmployeePopup()" style="background: none; border: none; color: #9ca3af; font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            <div style="padding: 15px 20px; background: #252540; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative;">
                <input type="text" id="employeeSearchInput" placeholder="Search by name..." oninput="filterPopupEmployees()" style="width: 100%; padding: 12px 15px; border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; background: #1a1a2e; color: #fff; font-size: 14px;">
            </div>
            <div id="employeePopupList" style="max-height: 55vh; overflow-y: auto; padding: 10px 0;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; padding: 40px; color: #9ca3af;">
                    <span class="loading"></span> Loading employees...
                </div>
            </div>
        </div>
    </div>

    <!-- Data Recalculation Modal -->
    <div id="recalc-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 10002; align-items: center; justify-content: center;" onclick="closeRecalculationModal(event)">
        <div style="background: #1a1a2e; border-radius: 16px; width: 550px; max-width: 95%; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(6,182,212,0.3);" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #0891b2 0%, #164e63 100%); padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: #fff; font-size: 18px; display: flex; align-items: center; gap: 10px; margin: 0;">
                    üîß Data Recalculation
                </h3>
                <button onclick="closeRecalculationModal()" style="background: none; border: none; color: #9ca3af; font-size: 28px; cursor: pointer;">&times;</button>
            </div>

            <!-- Modal Body -->
            <div style="padding: 25px;">
                <!-- Date Range Selection -->
                <div id="recalc-form" style="display: block;">
                    <div style="margin-bottom: 20px;">
                        <label style="color: #e0e0e0; display: block; margin-bottom: 8px; font-weight: 500;">Date Range</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="color: #808080; font-size: 0.85em; display: block; margin-bottom: 4px;">Start Date</label>
                                <input type="date" id="recalc-start-date" onchange="updateRecalcEstimate()" style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    background: #252540;
                                    border: 1px solid rgba(255,255,255,0.15);
                                    border-radius: 8px;
                                    color: #fff;
                                    font-size: 14px;
                                ">
                            </div>
                            <div style="flex: 1;">
                                <label style="color: #808080; font-size: 0.85em; display: block; margin-bottom: 4px;">End Date</label>
                                <input type="date" id="recalc-end-date" onchange="updateRecalcEstimate()" style="
                                    width: 100%;
                                    padding: 10px 12px;
                                    background: #252540;
                                    border: 1px solid rgba(255,255,255,0.15);
                                    border-radius: 8px;
                                    color: #fff;
                                    font-size: 14px;
                                ">
                            </div>
                        </div>
                    </div>

                    <!-- Estimate Display -->
                    <div id="recalc-estimate" style="display: none; margin-bottom: 20px; background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 8px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #fbbf24; font-weight: 500; margin-bottom: 5px;">Estimated Time</div>
                                <div id="recalc-estimate-time" style="color: #e0e0e0; font-size: 1.2em; font-weight: 600;">--</div>
                            </div>
                            <div style="text-align: right; color: #9ca3af; font-size: 0.85em;">
                                <div id="recalc-estimate-days">-- days</div>
                                <div id="recalc-estimate-records">-- records</div>
                            </div>
                        </div>
                    </div>

                    <!-- What will be recalculated -->
                    <div style="margin-bottom: 20px; background: rgba(6,182,212,0.1); border: 1px solid rgba(6,182,212,0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #06b6d4; font-weight: 500; margin-bottom: 10px;">What will be recalculated:</div>
                        <ul style="color: #9ca3af; margin: 0; padding-left: 20px; font-size: 0.9em; line-height: 1.8;">
                            <li>clock_times.total_minutes (from clock_in/out)</li>
                            <li>daily_scores.clocked_minutes (from clock_times)</li>
                            <li>daily_scores.active_minutes (from activity_logs)</li>
                            <li>daily_scores.items_processed (from activity_logs)</li>
                            <li>daily_scores.efficiency_rate (derived)</li>
                            <li>employee_current_status (live status)</li>
                        </ul>
                    </div>

                    <button onclick="startRecalculation()" style="
                        width: 100%;
                        padding: 12px;
                        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Start Recalculation</button>
                </div>

                <!-- Progress Display -->
                <div id="recalc-progress" style="display: none;">
                    <!-- Current Stage -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div class="recalc-spinner" style="
                            width: 50px;
                            height: 50px;
                            border: 4px solid rgba(6,182,212,0.2);
                            border-top-color: #06b6d4;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 15px;
                        "></div>
                        <div id="recalc-current-stage" style="color: #06b6d4; font-size: 1.1em; font-weight: 500;">Initializing...</div>
                    </div>

                    <!-- Progress Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #808080; font-size: 0.9em;">Progress</span>
                            <span id="recalc-percent" style="color: #06b6d4; font-weight: 600;">0%</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 12px; overflow: hidden;">
                            <div id="recalc-progress-bar" style="background: linear-gradient(90deg, #06b6d4, #22d3ee); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.85em; color: #808080;">
                            <span>Elapsed: <span id="recalc-elapsed" style="color: #e0e0e0;">0s</span></span>
                            <span>Stage <span id="recalc-stage-num">0</span>/6</span>
                        </div>
                    </div>

                    <!-- Stage List -->
                    <div id="recalc-stages" style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px;">
                        <div class="recalc-stage" data-stage="1" data-id="clock_times.total_minutes" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; color: #808080;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="stage-icon">‚óã</span>
                                <span>clock_times.total_minutes</span>
                            </div>
                            <span class="stage-time" style="font-size: 0.85em;"></span>
                        </div>
                        <div class="recalc-stage" data-stage="2" data-id="daily_scores.clocked_minutes" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; color: #808080;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="stage-icon">‚óã</span>
                                <span>daily_scores.clocked_minutes</span>
                            </div>
                            <span class="stage-time" style="font-size: 0.85em;"></span>
                        </div>
                        <div class="recalc-stage" data-stage="3" data-id="daily_scores.active_minutes" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; color: #808080;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="stage-icon">‚óã</span>
                                <span>daily_scores.active_minutes</span>
                            </div>
                            <span class="stage-time" style="font-size: 0.85em;"></span>
                        </div>
                        <div class="recalc-stage" data-stage="4" data-id="daily_scores.items_processed" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; color: #808080;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="stage-icon">‚óã</span>
                                <span>daily_scores.items_processed</span>
                            </div>
                            <span class="stage-time" style="font-size: 0.85em;"></span>
                        </div>
                        <div class="recalc-stage" data-stage="5" data-id="daily_scores.efficiency_rate" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; color: #808080;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="stage-icon">‚óã</span>
                                <span>daily_scores.efficiency_rate</span>
                            </div>
                            <span class="stage-time" style="font-size: 0.85em;"></span>
                        </div>
                        <div class="recalc-stage" data-stage="6" data-id="employee_current_status" style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; color: #808080;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="stage-icon">‚óã</span>
                                <span>employee_current_status</span>
                            </div>
                            <span class="stage-time" style="font-size: 0.85em;"></span>
                        </div>
                    </div>

                    <!-- Results (shown when complete) -->
                    <div id="recalc-results" style="display: none; margin-top: 20px; background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #10b981; font-weight: 500; margin-bottom: 10px;">‚úì Recalculation Complete</div>
                        <div id="recalc-results-content" style="color: #9ca3af; font-size: 0.9em;"></div>
                    </div>

                    <!-- Error (shown on failure) -->
                    <div id="recalc-error" style="display: none; margin-top: 20px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #ef4444; font-weight: 500; margin-bottom: 10px;">‚úï Error</div>
                        <div id="recalc-error-content" style="color: #9ca3af; font-size: 0.9em;"></div>
                    </div>

                    <!-- Close button (shown when complete/error) -->
                    <button id="recalc-close-btn" onclick="closeRecalculationModal()" style="
                        display: none;
                        width: 100%;
                        margin-top: 20px;
                        padding: 12px;
                        background: rgba(255,255,255,0.1);
                        color: #e0e0e0;
                        border: 1px solid rgba(255,255,255,0.2);
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                    ">Close</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
    <script src="dashboard-api.js"></script>
    <script src="js/theme-switcher.js"></script>
    <script>
        // API base for inline fetch calls (uses same logic as dashboard-api.js)
        const API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:5000' : '';

        // ============= API RESPONSE CACHE =============
        // Cache for unmapped-users (5-minute TTL)
        const apiCache = {
            unmappedUsers: { data: null, timestamp: 0 }
        };
        const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

        async function getUnmappedUsers(forceRefresh = false) {
            const now = Date.now();
            if (!forceRefresh && apiCache.unmappedUsers.data && (now - apiCache.unmappedUsers.timestamp) < CACHE_TTL) {
                return apiCache.unmappedUsers.data;
            }
            const data = await fetch(`${API_BASE}/api/dashboard/unmapped-users`, {
                headers: {'X-API-Key': 'dev-api-key-123'}
            }).then(r => r.json());
            apiCache.unmappedUsers = { data, timestamp: now };
            return data;
        }

        // Invalidate cache when mappings change
        function invalidateUnmappedUsersCache() {
            apiCache.unmappedUsers.timestamp = 0;
        }

        // ============= DEBOUNCE UTILITY =============
        function debounce(fn, delay = 300) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // Debounced search handlers (300ms delay reduces CPU thrashing)
        const debouncedFilterEmployees = debounce(() => filterEmployees(), 300);
        const debouncedFilterPayrates = debounce(() => filterPayrates(), 300);
        const debouncedFilterAvailableWorkers = debounce((val) => filterAvailableWorkers(val), 300);

        // ============= LOADING OVERLAY UTILITY =============
        function showLoadingOverlay(message = 'Loading...') {
            // Remove any existing overlay
            const existing = document.getElementById('loadingOverlay');
            if (existing) existing.remove();

            // Close any open modals first
            ['pinModal', 'mappingModal', 'manualMappingModal', 'podFactoryMappingModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal) modal.remove();
            });

            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 999999; display: flex; align-items: center; justify-content: center;';
            overlay.innerHTML = `
                <div style="background: #2a2a2a; padding: 30px 50px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #6366f1; display: block; margin-bottom: 15px;"></i>
                    <div style="color: #e0e0e0; font-size: 1.1em;">${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        }

        // ============= EMPLOYEE TABLE PAGINATION =============
        const employeePagination = {
            currentPage: 1,
            pageSize: 50,
            allEmployees: [],
            filteredEmployees: []
        };

        window.changeEmployeePage = function(delta) {
            const newPage = employeePagination.currentPage + delta;
            const totalPages = Math.ceil(employeePagination.filteredEmployees.length / employeePagination.pageSize);
            if (newPage >= 1 && newPage <= totalPages) {
                employeePagination.currentPage = newPage;
                renderEmployeePage();
            }
        };

        function renderEmployeePage() {
            const { currentPage, pageSize, filteredEmployees } = employeePagination;
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageEmployees = filteredEmployees.slice(start, end);
            const totalPages = Math.ceil(filteredEmployees.length / pageSize) || 1;

            // Render current page
            window.renderEmployeeRows(pageEmployees);

            // Update pagination UI
            document.getElementById('paginationInfo').textContent =
                `Showing ${start + 1}-${Math.min(end, filteredEmployees.length)} of ${filteredEmployees.length}`;
            document.getElementById('pageIndicator').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        }

        // ============= SETTINGS & THEME SYSTEM =============
        // Open settings modal
        function openSettingsModal() {
            document.getElementById('settings-modal').style.display = 'block';
            updateThemeSelection();
        }

        // Close settings modal
        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // Update theme selection UI
        function updateThemeSelection() {
            const currentTheme = localStorage.getItem('selectedTheme') || 'cyberpunk';
            document.querySelectorAll('.theme-option-btn').forEach(btn => {
                const isActive = btn.dataset.theme === currentTheme;
                btn.style.borderColor = isActive ? '#8b5cf6' : '#3f3f46';
                btn.querySelector('.theme-active-indicator').style.display = isActive ? 'block' : 'none';
            });
        }

        // Select and apply theme
        function selectTheme(themeName) {
            const themeLink = document.getElementById('theme-css');
            const themeCssMap = {
                'original': 'css/manager.css',
                'cyberpunk': 'css/manager-cyberpunk.css',
                'executive': 'css/manager-executive.css',
                'industrial': 'css/manager-industrial.css'
            };

            if (themeCssMap[themeName]) {
                themeLink.href = themeCssMap[themeName];
                localStorage.setItem('selectedTheme', themeName);
                updateThemeSelection();
            }
        }

        // Initialize theme on page load (default: industrial)
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'industrial';
            selectTheme(savedTheme);
        });

        // ============= NOTIFICATION & MODAL SYSTEM =============
        // Toast notification function
        function showNotification(message, type = 'info') {
            const colors = {
                success: { bg: '#10b981', icon: '‚úì' },
                error: { bg: '#ef4444', icon: '‚úï' },
                warning: { bg: '#f59e0b', icon: '‚ö†' },
                info: { bg: '#667eea', icon: '‚Ñπ' }
            };
            const config = colors[type] || colors.info;

            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.innerHTML = `
                <span style="font-size: 18px; margin-right: 10px;">${config.icon}</span>
                <span>${message}</span>
            `;
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: ${config.bg};
                color: white;
                padding: 16px 24px;
                border-radius: 10px;
                box-shadow: 0 8px 30px rgba(0,0,0,0.4);
                z-index: 99999;
                display: flex;
                align-items: center;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
                max-width: 400px;
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Custom confirm modal (replaces browser confirm)
        function showConfirmModal(title, message, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.id = 'customConfirmModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 99998; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #1e1e1e; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; width: 420px; max-width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                        <h3 style="color: #e0e0e0; margin: 0 0 15px 0; font-size: 1.3em;">${title}</h3>
                        <p style="color: #a0a0a0; margin: 0 0 25px 0; line-height: 1.6;">${message}</p>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button id="confirmCancel" style="padding: 10px 24px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                            <button id="confirmOk" style="padding: 10px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('confirmOk').onclick = () => { modal.remove(); if(onConfirm) onConfirm(); };
            document.getElementById('confirmCancel').onclick = () => { modal.remove(); if(onCancel) onCancel(); };
        }

        // Loading modal for async operations
        let loadingProgress = 0;
        let loadingInterval = null;

        function showLoadingModal(message) {
            loadingProgress = 0;
            const modal = document.createElement('div');
            modal.id = 'loadingModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 99998; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #2a2a2a; padding: 30px 40px; border-radius: 12px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; min-width: 280px;">
                        <button onclick="hideLoadingModal()" style="position: absolute; top: 10px; right: 12px; background: none; border: none; color: #808080; font-size: 1.4em; cursor: pointer; padding: 5px; line-height: 1;">&times;</button>
                        <i class="fas fa-spinner fa-spin" style="font-size: 2.5em; color: #667eea;"></i>
                        <p style="color: #e0e0e0; margin: 15px 0 12px 0; font-size: 1.1em;">${message}</p>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; height: 6px; overflow: hidden; margin-top: 10px;">
                            <div id="loadingProgressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                        </div>
                        <p id="loadingPercent" style="color: #808080; font-size: 0.85em; margin: 8px 0 0 0;">0%</p>
                        <p style="color: #606060; font-size: 0.75em; margin: 10px 0 0 0;">Press ESC to cancel</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Simulate progress (accelerates near end)
            loadingInterval = setInterval(() => {
                if (loadingProgress < 90) {
                    loadingProgress += Math.random() * 15;
                    if (loadingProgress > 90) loadingProgress = 90;
                    updateLoadingProgress(loadingProgress);
                }
            }, 200);

            // ESC key to close
            modal._escHandler = (e) => { if (e.key === 'Escape') hideLoadingModal(); };
            document.addEventListener('keydown', modal._escHandler);

            return modal;
        }

        function updateLoadingProgress(percent) {
            const bar = document.getElementById('loadingProgressBar');
            const text = document.getElementById('loadingPercent');
            if (bar) bar.style.width = percent + '%';
            if (text) text.textContent = Math.round(percent) + '%';
        }

        function hideLoadingModal() {
            if (loadingInterval) { clearInterval(loadingInterval); loadingInterval = null; }
            const modal = document.getElementById('loadingModal');
            if (modal) {
                if (modal._escHandler) document.removeEventListener('keydown', modal._escHandler);
                // Complete the progress bar before closing
                updateLoadingProgress(100);
                setTimeout(() => modal.remove(), 150);
            }
        }

        // Add CSS animations
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
            @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
            @keyframes spin { to { transform: rotate(360deg); } }
        `;
        document.head.appendChild(styleSheet);

        // Mobile sidebar toggle function
        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.getElementById("sidebarOverlay");
            sidebar.classList.toggle("active");
            if (overlay) {
                overlay.classList.toggle("active");
            }
        }

        // Close sidebar (for nav item clicks)
        function closeSidebar() {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.getElementById("sidebarOverlay");
            if (sidebar) sidebar.classList.remove("active");
            if (overlay) overlay.classList.remove("active");
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener("click", function(event) {
            const sidebar = document.getElementById("sidebar");
            const overlay = document.getElementById("sidebarOverlay");
            const toggleBtn = document.querySelector(".mobile-menu-toggle");
            const bottomNavMore = event.target.closest('.mobile-bottom-nav__item');
            if (window.innerWidth <= 768 && !sidebar.contains(event.target) && !toggleBtn.contains(event.target) && !bottomNavMore) {
                sidebar.classList.remove("active");
                if (overlay) overlay.classList.remove("active");
            }
        });

        // ============= EMPLOYEE POPUP FUNCTIONS =============
        let popupEmployeesData = []; // Store fetched data for filtering

        async function showEmployeePopup() {
            const overlay = document.getElementById('employee-popup-overlay');
            const listContainer = document.getElementById('employeePopupList');
            const searchInput = document.getElementById('employeeSearchInput');

            if (!overlay) return;

            // Show popup with loading state
            overlay.style.display = 'flex';
            searchInput.value = '';
            listContainer.innerHTML = '<div class="popup-loading"><span class="loading"></span> Loading employees...</div>';

            try {
                // Fetch today's clock times
                const response = await fetch(`${API_BASE}/api/dashboard/clock-times/today`, {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                const data = await response.json();
                // API returns array directly or object with clock_times
                popupEmployeesData = Array.isArray(data) ? data : (data.clock_times || []);

                renderPopupEmployees(popupEmployeesData);
            } catch (error) {
                console.error('Error loading employees:', error);
                listContainer.innerHTML = '<div class="popup-no-results"><i class="fas fa-exclamation-triangle"></i>Error loading employees</div>';
            }
        }

        function hideEmployeePopup(event) {
            if (!event || event.target === document.getElementById('employee-popup-overlay')) {
                document.getElementById('employee-popup-overlay').style.display = 'none';
            }
        }

        function renderPopupEmployees(employees) {
            const listContainer = document.getElementById('employeePopupList');
            const countSpan = document.getElementById('popupEmployeeCount');

            if (!employees || employees.length === 0) {
                listContainer.innerHTML = '<div class="popup-no-results"><i class="fas fa-users-slash"></i>No employees clocked in today</div>';
                countSpan.textContent = '0 employees';
                return;
            }

            // Sort: clocked-in first, then by clock_in time
            employees.sort((a, b) => {
                if (a.is_clocked_in !== b.is_clocked_in) return b.is_clocked_in - a.is_clocked_in;
                return new Date(b.clock_in) - new Date(a.clock_in);
            });

            countSpan.textContent = `${employees.length} employee${employees.length !== 1 ? 's' : ''}`;

            listContainer.innerHTML = employees.map(emp => {
                const name = emp.employee_name || emp.name || 'Unknown';
                const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const isClockedIn = emp.is_clocked_in || !emp.clock_out;
                const statusClass = isClockedIn ? 'popup-status-clocked-in' : 'popup-status-clocked-out';
                const statusText = isClockedIn ? 'Clocked In' : 'Clocked Out';

                // Format time worked
                const totalMinutes = parseFloat(emp.total_minutes || 0);
                const hours = Math.floor(totalMinutes / 60);
                const mins = Math.round(totalMinutes % 60);
                const timeWorked = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

                // Format clock times (convert from UTC to display)
                const clockIn = emp.clock_in ? new Date(emp.clock_in).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';
                const clockOut = emp.clock_out ? new Date(emp.clock_out).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';

                // Items processed info
                const itemsInfo = emp.items_processed ? `${emp.items_processed} items` : '';

                const statusStyle = isClockedIn
                    ? 'background: rgba(52,211,153,0.15); color: #34d399; border: 1px solid rgba(52,211,153,0.4);'
                    : 'background: rgba(107,114,128,0.15); color: #9ca3af; border: 1px solid rgba(107,114,128,0.4);';

                return `
                    <div class="popup-employee-item" data-name="${name.toLowerCase()}" data-dept="${itemsInfo.toLowerCase()}" style="display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); gap: 15px;">
                        <div style="width: 42px; height: 42px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #fff; font-size: 14px;">${initials}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #fff; margin-bottom: 3px;">${name}</div>
                            <div style="font-size: 12px; color: #9ca3af;">${itemsInfo || 'No activity'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: #34d399; font-size: 14px;">${timeWorked}</div>
                            <div style="font-size: 11px; margin-top: 2px;">
                                <div style="color: #34d399;">In: ${clockIn}</div>
                                ${clockOut ? `<div style="color: #f87171;">Out: ${clockOut}</div>` : ''}
                            </div>
                        </div>
                        <span style="padding: 5px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; ${statusStyle}">${statusText}</span>
                    </div>
                `;
            }).join('');
        }

        function filterPopupEmployees() {
            const searchTerm = document.getElementById('employeeSearchInput').value.toLowerCase();
            const items = document.querySelectorAll('.popup-employee-item');
            const countSpan = document.getElementById('popupEmployeeCount');
            let visibleCount = 0;

            items.forEach(item => {
                const name = item.getAttribute('data-name') || '';
                const dept = item.getAttribute('data-dept') || '';

                if (name.includes(searchTerm) || dept.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            countSpan.textContent = `${visibleCount} employee${visibleCount !== 1 ? 's' : ''}`;
        }

        // Close popup with ESC key
        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('employee-popup-overlay');
            if (e.key === 'Escape' && overlay && overlay.style.display === 'flex') {
                hideEmployeePopup();
            }
        });

        let dashboardData = {};
        // Initialize API and variables
        const api = new ProductivityAPI();
        let productivityChart = null;
        let refreshInterval = null;
        let previousData = null;
        // Cost Analysis Variables
        let costData = null;

        // ============= TAB VISIBILITY HANDLING =============
        // Only refresh data when tab is visible to reduce server load
        let isTabVisible = !document.hidden;

        document.addEventListener('visibilitychange', () => {
            isTabVisible = !document.hidden;
            // Note: Auto-refresh on visibility change disabled to reduce API calls
            // Data will refresh via 60-second interval instead
        });

        // Helper to check if should refresh
        function shouldRefresh() {
            return isTabVisible;
        }

        // ============= SYSTEM HEALTH MONITORING =============
        // Cooldown tracking for restart buttons
        let restartCooldowns = {};

        // Update system health status
        async function updateSystemHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/system/health`, {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                if (response.ok) {
                    const health = await response.json();
                    
                    // Update Connecteam status
                    if (health.syncs && health.syncs.connecteam) {
                        const connecteam = health.syncs.connecteam;
                        updateStatusIndicator('connecteam', connecteam.status);
                        document.getElementById('connecteam-last-sync').textContent = 
                            `(${Math.round(connecteam.minutes_ago)}m ago)`;
                    }
                    
                    // Update PodFactory status
                    if (health.syncs && health.syncs.podfactory) {
                        const podfactory = health.syncs.podfactory;
                        updateStatusIndicator('podfactory', podfactory.status);
                        document.getElementById('podfactory-last-sync').textContent = 
                            `(${Math.round(podfactory.minutes_ago)}m ago)`;
                    }
                    
                    // Update Flask status
                    if (health.services && health.services['flask-backend']) {
                        const flask = health.services['flask-backend'];
                        updateStatusIndicator('flask', flask.status === 'online' ? 'healthy' : 'critical');
                    }
                    
                    // Update Database status
                    if (health.database && health.database.status === 'connected') {
                        updateStatusIndicator('database', 'healthy');
                        document.getElementById('database-latency').textContent = '(connected)';
                    }
                    
                } else {
                    // If we can't reach the health endpoint, show all as offline
                    ['connecteam', 'podfactory', 'flask', 'database'].forEach(service => {
                        updateStatusIndicator(service, 'critical');
                    });
                }
            } catch (error) {
                console.error('Error updating system health:', error);
                // Show all as unknown if we can't connect
                ['connecteam', 'podfactory', 'flask', 'database'].forEach(service => {
                    updateStatusIndicator(service, 'unknown');
                });
            }
        }

        // Update status indicator color
        function updateStatusIndicator(service, status) {
            const indicator = document.getElementById(`${service}-indicator`);
            if (indicator) {
                let color = '#6c757d'; // gray - unknown
                
                switch(status) {
                    case 'healthy':
                    case 'online':
                        color = '#22c55e'; // green
                        break;
                    case 'warning':
                        color = '#fbbf24'; // yellow
                        break;
                    case 'critical':
                    case 'offline':
                        color = '#ef4444'; // red
                        break;
                }
                
                indicator.style.background = color;
                
                // Add pulse animation for critical status
                if (status === 'critical') {
                    indicator.style.animation = 'pulse 2s infinite';
                } else {
                    indicator.style.animation = 'none';
                }
            }
        }

        // Open system controls modal
        function openSystemControls() {
            document.getElementById('system-control-modal').style.display = 'block';
            loadSystemDetails();
        }

        // Close system controls modal
        function closeSystemControls() {
            document.getElementById('system-control-modal').style.display = 'none';
        }

        // Load detailed system information
        async function loadSystemDetails() {
            try {
                // Get PM2 status
                const pm2Response = await fetch(`${API_BASE}/api/system/pm2-status`, {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                if (pm2Response.ok) {
                    const data = await pm2Response.json();
                    const processes = data.processes;
                    
                    // Update Flask details
                    const flask = processes.find(p => p.name === 'flask-backend');
                    if (flask) {
                        document.getElementById('flask-uptime').textContent = 
                            `Uptime: ${formatUptime(flask.uptime)}`;
                        document.getElementById('flask-memory').textContent = 
                            `Memory: ${(flask.memory / 1024 / 1024).toFixed(1)} MB`;
                        document.getElementById('flask-restarts').textContent = 
                            `Restarts: ${flask.restarts}`;
                    }
                }
                
                // Get system health for sync details
                const healthResponse = await fetch(`${API_BASE}/api/system/health`, {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                if (healthResponse.ok) {
                    const health = await healthResponse.json();
                    
                    // Update Connecteam details
                    if (health.syncs && health.syncs.connecteam) {
                        document.getElementById('connecteam-status-detail').textContent = 
                            `Last sync: ${health.syncs.connecteam.minutes_ago.toFixed(0)} minutes ago`;
                        document.getElementById('connecteam-records').textContent = 
                            `Records synced: ${health.syncs.connecteam.records || 0}`;
                    }
                    
                    // Update PodFactory details
                    if (health.syncs && health.syncs.podfactory) {
                        document.getElementById('podfactory-status-detail').textContent = 
                            `Last sync: ${health.syncs.podfactory.minutes_ago.toFixed(0)} minutes ago`;
                        document.getElementById('podfactory-items').textContent = 
                            `Items synced: ${health.syncs.podfactory.items || 0}`;
                    }
                    
                    // Update Database details
                    if (health.database) {
                        document.getElementById('db-status-detail').textContent = 
                            `Status: ${health.database.status}`;
                    }
                }
                
            } catch (error) {
                console.error('Error loading system details:', error);
            }
        }

        // Restart a service
        function restartService(serviceName) {
            // Check cooldown
            if (restartCooldowns[serviceName]) {
                const timeLeft = Math.ceil((restartCooldowns[serviceName] - Date.now()) / 1000);
                if (timeLeft > 0) {
                    showNotification(`Please wait ${timeLeft}s before restarting again`, 'warning');
                    return;
                }
            }

            // Custom confirm dialog
            const title = serviceName === 'flask-backend' ? '‚ö†Ô∏è Restart Backend' : 'Restart Service';
            const message = serviceName === 'flask-backend'
                ? 'This will restart the main backend. Users may experience brief interruption. Continue?'
                : `Are you sure you want to restart ${serviceName}?`;

            showConfirmModal(title, message, async () => {
                showLoadingModal(`Restarting ${serviceName}...`);
                try {
                    const response = await fetch(`${API_BASE}/api/system/restart-service`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({ service: serviceName })
                    });

                    const data = await response.json();
                    hideLoadingModal();

                    if (data.success) {
                        showNotification(`${serviceName} restarted successfully`, 'success');
                        // Set 30-second cooldown
                        restartCooldowns[serviceName] = Date.now() + 30000;
                        // Update status after a few seconds
                        setTimeout(() => {
                            updateSystemHealth();
                            loadSystemDetails();
                        }, 3000);
                    } else {
                        showNotification(`Failed: ${data.message || data.error}`, 'error');
                    }
                } catch (error) {
                    hideLoadingModal();
                    showNotification(`Error: ${error.message}`, 'error');
                }
            });
        }

        // Force a sync
        function forceSync(syncType) {
            showConfirmModal('Force Sync', `Force ${syncType} sync now?`, async () => {
                showLoadingModal(`Syncing ${syncType}...`);
                try {
                    const response = await fetch(`${API_BASE}/api/system/force-sync`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({ type: syncType })
                    });

                    const data = await response.json();
                    hideLoadingModal();

                    if (data.success) {
                        showNotification(`${syncType} sync completed`, 'success');
                        updateSystemHealth();
                        loadSystemDetails();
                    } else {
                        showNotification(`Sync failed: ${data.error}`, 'error');
                    }
                } catch (error) {
                    hideLoadingModal();
                    showNotification(`Error: ${error.message}`, 'error');
                }
            });
        }

        // Clear sync logs
        function clearSyncLogs(syncType) {
            showConfirmModal('Clear Logs', `Clear old ${syncType} sync logs?`, async () => {
                showLoadingModal(`Clearing ${syncType} logs...`);
                try {
                    const response = await fetch(`${API_BASE}/api/system/clear-sync-logs`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({ type: syncType, days: 7 })
                    });

                    const data = await response.json();
                    hideLoadingModal();

                    if (data.success) {
                        showNotification(data.message || 'Done', 'success');
                    } else {
                        showNotification(`Failed: ${data.error}`, 'error');
                    }
                } catch (error) {
                    hideLoadingModal();
                    showNotification(`Error: ${error.message}`, 'error');
                }
            });
        }

        // Test database connection
        async function testDatabaseConnection() {
            showLoadingModal('Testing database connection...');
            try {
                const response = await fetch(`${API_BASE}/api/system/test-connection`, {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });
                
                const data = await response.json();
                hideLoadingModal();
                
                if (data.success) {
                    document.getElementById('db-status-detail').textContent = 
                        `Status: Connected`;
                    document.getElementById('db-latency-detail').textContent = 
                        `Latency: ${data.latency_ms} ms`;
                    
                    showNotification(`Database connected! Latency: ${data.latency_ms}ms`, 'success');
                } else {
                    showNotification(`Connection failed: ${data.error}`, 'error');
                }
            } catch (error) {
                hideLoadingModal();
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        // Reset connection pool
        function resetConnectionPool() {
            showConfirmModal('Reset Pool', 'Reset database connection pool?', async () => {
                showLoadingModal("Resetting connection pool...");
                try {
                    const response = await fetch(`${API_BASE}/api/system/reset-connection-pool`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        }
                    });

                    const data = await response.json();
                    hideLoadingModal();

                    if (data.success) {
                        showNotification('Connection pool reset', 'success');
                        updateSystemHealth();
                    } else {
                        showNotification(`Failed: ${data.error}`, 'error');
                    }
                } catch (error) {
                    hideLoadingModal();
                    showNotification(`Error: ${error.message}`, 'error');
                }
            });
        }

        // Restart all services
        function restartAllServices() {
            showConfirmModal('‚ö†Ô∏è Warning', 'This will restart ALL services and cause a brief outage. Are you absolutely sure?', () => {
                showConfirmModal('Final Confirmation', 'This is your final confirmation. Restart all services?', async () => {
                    showLoadingModal('Restarting all services...');
                    try {
                        const response = await fetch(`${API_BASE}/api/system/restart-all`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-Key': 'dev-api-key-123'
                            },
                            body: JSON.stringify({ confirm: true })
                        });

                        const data = await response.json();
                        hideLoadingModal();

                        if (data.success) {
                            showNotification('All services restarted. Page will reload in 15 seconds.', 'success');
                            setTimeout(() => {
                                window.location.reload();
                            }, 15000);
                        } else {
                            showNotification(`Failed: ${data.error}`, 'error');
                        }
                    } catch (error) {
                        hideLoadingModal();
                        showNotification(`Error: ${error.message}`, 'error');
                    }
                });
            });
        }

        // Clear all caches
        function clearAllCaches() {
            showConfirmModal('Clear Caches', 'Clear all system caches?', () => {
                showNotification('Cache clearing not yet implemented', 'warning');
                // TODO: Implement cache clearing
            });
        }

        // View logs - fetches and displays real logs in a modal
        async function viewLogs(serviceName) {
            showLoadingModal(`Loading ${serviceName} logs...`);
            try {
                const response = await fetch(`${API_BASE}/api/system/logs/${serviceName}`, {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });

                const data = await response.json();
                hideLoadingModal();

                if (!data.success) {
                    showNotification(data.error || 'Failed to load logs', 'error');
                    return;
                }

                // Build logs display HTML
                let logsHtml = '';
                if (serviceName === 'connecteam') {
                    logsHtml = data.logs.map(log => `
                        <div style="padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85em;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="color: ${log.status === 'success' ? '#10b981' : '#ef4444'};">${log.status}</span>
                                <span style="color: #808080;">${new Date(log.timestamp).toLocaleString()}</span>
                            </div>
                            <div style="color: #a0a0a0;">Type: ${log.type} | Records: ${log.records || 0}</div>
                            ${log.error ? `<div style="color: #ef4444; margin-top: 4px;">Error: ${log.error}</div>` : ''}
                        </div>
                    `).join('');
                } else if (serviceName === 'podfactory') {
                    logsHtml = data.logs.map(log => `
                        <div style="padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85em;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="color: #10b981;">${log.date}</span>
                                <span style="color: #667eea;">${log.items} items</span>
                            </div>
                            <div style="color: #a0a0a0;">First: ${new Date(log.first).toLocaleTimeString()} | Last: ${new Date(log.last).toLocaleTimeString()}</div>
                        </div>
                    `).join('');
                } else {
                    logsHtml = data.logs.map(log => `
                        <div style="padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85em;">
                            <pre style="margin: 0; color: #e0e0e0; white-space: pre-wrap;">${JSON.stringify(log, null, 2)}</pre>
                        </div>
                    `).join('');
                }

                // Show logs in modal
                const modal = document.createElement('div');
                modal.id = 'logsModal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 99998; display: flex; align-items: center; justify-content: center;">
                        <div style="background: #1e1e1e; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; width: 600px; max-width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: #e0e0e0;">${serviceName.charAt(0).toUpperCase() + serviceName.slice(1)} Logs</h3>
                                <button onclick="document.getElementById('logsModal').remove()" style="background: none; border: none; color: #808080; font-size: 1.5em; cursor: pointer;">&times;</button>
                            </div>
                            <div style="flex: 1; overflow-y: auto; max-height: 60vh;">
                                ${logsHtml || '<div style="padding: 20px; color: #808080; text-align: center;">No logs found</div>'}
                            </div>
                            <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); text-align: right;">
                                <button onclick="document.getElementById('logsModal').remove()" style="padding: 8px 20px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // ESC key to close
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        document.getElementById('logsModal')?.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);

            } catch (error) {
                hideLoadingModal();
                showNotification(`Error loading logs: ${error.message}`, 'error');
            }
        }

        // ============= DATA RECALCULATION FUNCTIONS =============
        let recalcJobId = null;
        let recalcPollInterval = null;

        function openRecalculationModal() {
            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recalc-start-date').value = today;
            document.getElementById('recalc-end-date').value = today;

            // Reset modal state
            document.getElementById('recalc-form').style.display = 'block';
            document.getElementById('recalc-progress').style.display = 'none';
            document.getElementById('recalc-results').style.display = 'none';
            document.getElementById('recalc-error').style.display = 'none';
            document.getElementById('recalc-close-btn').style.display = 'none';
            document.getElementById('recalc-estimate').style.display = 'none';

            // Reset stage icons and times
            document.querySelectorAll('.recalc-stage').forEach(stage => {
                stage.style.color = '#808080';
                stage.querySelector('.stage-icon').textContent = '‚óã';
                stage.querySelector('.stage-time').textContent = '';
            });

            // Show modal
            const overlay = document.getElementById('recalc-modal-overlay');
            overlay.style.display = 'flex';

            // Close system controls modal if open
            closeSystemControls();

            // Get initial estimate
            updateRecalcEstimate();
        }

        async function updateRecalcEstimate() {
            const startDate = document.getElementById('recalc-start-date').value;
            const endDate = document.getElementById('recalc-end-date').value;

            if (!startDate || !endDate || startDate > endDate) {
                document.getElementById('recalc-estimate').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/system/recalculate/estimate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key-123'
                    },
                    body: JSON.stringify({ start_date: startDate, end_date: endDate })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('recalc-estimate').style.display = 'block';
                    document.getElementById('recalc-estimate-time').textContent = data.estimated_display;
                    document.getElementById('recalc-estimate-days').textContent = `${data.days} day${data.days > 1 ? 's' : ''}`;
                    document.getElementById('recalc-estimate-records').textContent =
                        `${data.daily_scores_count} scores, ${data.activity_logs_count.toLocaleString()} activities`;
                }
            } catch (error) {
                console.error('Estimate error:', error);
            }
        }

        function closeRecalculationModal(event) {
            if (event && event.target !== event.currentTarget) return;

            // Stop polling if running
            if (recalcPollInterval) {
                clearInterval(recalcPollInterval);
                recalcPollInterval = null;
            }

            document.getElementById('recalc-modal-overlay').style.display = 'none';
        }

        async function startRecalculation() {
            const startDate = document.getElementById('recalc-start-date').value;
            const endDate = document.getElementById('recalc-end-date').value;

            if (!startDate || !endDate) {
                showNotification('Please select both start and end dates', 'warning');
                return;
            }

            if (startDate > endDate) {
                showNotification('Start date must be before end date', 'warning');
                return;
            }

            // Switch to progress view
            document.getElementById('recalc-form').style.display = 'none';
            document.getElementById('recalc-progress').style.display = 'block';
            document.getElementById('recalc-current-stage').textContent = 'Starting recalculation...';
            document.getElementById('recalc-progress-bar').style.width = '0%';
            document.getElementById('recalc-percent').textContent = '0%';

            try {
                const response = await fetch(`${API_BASE}/api/system/recalculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key-123'
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const data = await response.json();

                if (data.success) {
                    recalcJobId = data.job_id;
                    // Start polling for status
                    recalcPollInterval = setInterval(pollRecalculationStatus, 1000);
                } else {
                    showRecalcError(data.error || 'Failed to start recalculation');
                }
            } catch (error) {
                showRecalcError(`Network error: ${error.message}`);
            }
        }

        async function pollRecalculationStatus() {
            if (!recalcJobId) return;

            try {
                const response = await fetch(`${API_BASE}/api/system/recalculate/status/${recalcJobId}`, {
                    headers: { 'X-API-Key': 'dev-api-key-123' }
                });

                const data = await response.json();

                if (!data.success) {
                    showRecalcError(data.error || 'Failed to get status');
                    return;
                }

                // Update progress bar
                const progress = data.progress_percent || 0;
                document.getElementById('recalc-progress-bar').style.width = `${progress}%`;
                document.getElementById('recalc-percent').textContent = `${Math.round(progress)}%`;

                // Update elapsed time
                if (data.elapsed_seconds) {
                    document.getElementById('recalc-elapsed').textContent = formatElapsedTime(data.elapsed_seconds);
                }

                // Update stage number
                document.getElementById('recalc-stage-num').textContent = data.current_stage || 0;

                // Update current stage name
                if (data.stage_name) {
                    document.getElementById('recalc-current-stage').textContent = data.stage_name;
                }

                // Update stage icons and timings
                const stageTimings = data.stage_timings || {};
                document.querySelectorAll('.recalc-stage').forEach(stageEl => {
                    const stageNum = parseInt(stageEl.dataset.stage);
                    const stageId = stageEl.dataset.id;
                    const stageIcon = stageEl.querySelector('.stage-icon');
                    const stageTime = stageEl.querySelector('.stage-time');

                    if (stageTimings[stageId]) {
                        // Stage completed
                        stageEl.style.color = '#10b981';
                        stageIcon.textContent = '‚úì';
                        const timing = stageTimings[stageId];
                        stageTime.textContent = `${timing.elapsed_seconds}s`;
                    } else if (stageNum === data.current_stage && data.status === 'running') {
                        // Current stage
                        stageEl.style.color = '#06b6d4';
                        stageIcon.textContent = '‚óè';
                        stageTime.textContent = '';
                    }
                });

                // Check if complete
                if (data.status === 'completed') {
                    clearInterval(recalcPollInterval);
                    recalcPollInterval = null;

                    // Hide spinner
                    document.querySelector('.recalc-spinner').style.display = 'none';
                    document.getElementById('recalc-current-stage').textContent = 'Complete!';
                    document.getElementById('recalc-current-stage').style.color = '#10b981';

                    // Show results with total time
                    document.getElementById('recalc-results').style.display = 'block';
                    let resultsHtml = `<div style="margin-bottom: 10px;">Total time: <strong>${formatElapsedTime(data.total_elapsed_seconds)}</strong></div>`;
                    resultsHtml += '<div style="font-size: 0.85em;">';
                    if (data.stage_timings) {
                        for (const [stageId, timing] of Object.entries(data.stage_timings)) {
                            resultsHtml += `<div style="display: flex; justify-content: space-between; padding: 3px 0;">
                                <span>${stageId}</span>
                                <span>${timing.elapsed_seconds}s (${timing.records} records)</span>
                            </div>`;
                        }
                    }
                    resultsHtml += '</div>';
                    document.getElementById('recalc-results-content').innerHTML = resultsHtml;

                    // Show close button
                    document.getElementById('recalc-close-btn').style.display = 'block';

                    showNotification('Data recalculation completed successfully!', 'success');
                } else if (data.status === 'error') {
                    clearInterval(recalcPollInterval);
                    recalcPollInterval = null;
                    showRecalcError(data.error || 'Recalculation failed');
                }

            } catch (error) {
                console.error('Poll error:', error);
                // Don't stop polling on network hiccups
            }
        }

        function formatElapsedTime(seconds) {
            if (seconds < 60) return `${Math.round(seconds)}s`;
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return `${mins}m ${secs}s`;
        }

        function showRecalcError(message) {
            if (recalcPollInterval) {
                clearInterval(recalcPollInterval);
                recalcPollInterval = null;
            }

            // Hide spinner
            document.querySelector('.recalc-spinner').style.display = 'none';
            document.getElementById('recalc-current-stage').textContent = 'Failed';
            document.getElementById('recalc-current-stage').style.color = '#ef4444';

            // Show error
            document.getElementById('recalc-error').style.display = 'block';
            document.getElementById('recalc-error-content').textContent = message;

            // Show close button
            document.getElementById('recalc-close-btn').style.display = 'block';

            showNotification('Recalculation failed: ' + message, 'error');
        }

        // ESC key to close recalculation modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeRecalculationModal();
            }
        });

        // Format uptime
        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days}d ${hours % 24}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else {
                return `${minutes}m`;
            }
        }

        // Add CSS animation for pulse
        if (!document.getElementById('pulse-animation')) {
            const style = document.createElement('style');
            style.id = 'pulse-animation';
            style.textContent = `
                @keyframes pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.5; }
                    100% { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize health monitoring
        document.addEventListener('DOMContentLoaded', function() {
            // Initial health check
            updateSystemHealth();

            // Update health status every 60 seconds (only when tab visible)
            setInterval(() => {
                if (shouldRefresh()) updateSystemHealth();
            }, 60000);
            
            // Close modal when clicking outside
            document.getElementById('system-control-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSystemControls();
                }
            });
        });
        // Initialize Chart
        function initializeChart() {
            const ctx = document.getElementById('productivityChart').getContext('2d');
            productivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Items per Hour',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Target',
                        data: [],
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderDash: [5, 5],
                        tension: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#808080'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#808080'
                            }
                        }
                    }
                }
            });
        }
        
        // Debounce and lock tracking for loadDashboardData
        let lastDashboardLoad = 0;
        let dashboardLoadInProgress = false;
        let dashboardLoadCount = 0;
        const DASHBOARD_DEBOUNCE_MS = 30000; // Minimum 30 seconds between loads

        // Load all dashboard data (debounced + locked)
        async function loadDashboardData() {
            const caller = new Error().stack.split('\n')[2]?.trim() || 'unknown';
            console.log(`[DEBUG] loadDashboardData called from: ${caller}`);

            // Prevent concurrent calls
            if (dashboardLoadInProgress) {
                console.log('[DEBUG] Dashboard load already in progress, skipping');
                return;
            }

            // Prevent rapid consecutive calls
            const now = Date.now();
            const timeSinceLast = now - lastDashboardLoad;
            if (timeSinceLast < DASHBOARD_DEBOUNCE_MS) {
                console.log(`[DEBUG] Dashboard load debounced (${Math.round(timeSinceLast/1000)}s < ${DASHBOARD_DEBOUNCE_MS/1000}s)`);
                return;
            }

            dashboardLoadCount++;
            console.log(`[DEBUG] Dashboard load #${dashboardLoadCount} starting (${Math.round(timeSinceLast/1000)}s since last)`);

            dashboardLoadInProgress = true;
            lastDashboardLoad = now;

            try {
                const currentDate = dashboardData.startDate || api.getCentralDate();
                console.log('Loading data for:', currentDate);
                
                // Show loading states
                showLoadingStates();

                // Parallel API calls (70-80% faster than sequential)
                const [leaderboard, departmentStats, teamMetricsResult, recentActivities, alerts] = await Promise.all([
                    api.getLeaderboard(currentDate),
                    api.getDepartmentStats(currentDate),
                    api.getTeamMetrics().catch(err => {
                        console.error('Team metrics failed:', err);
                        return { active_employees: 0, total_employees_today: 0, items_today: 0, overall_efficiency: 0, total_hours_worked: 0, vs_yesterday: 0 };
                    }),
                    api.getRecentActivities(10),
                    api.getActiveAlerts()
                ]);
                const teamMetrics = teamMetricsResult;
                
                // Store data
                dashboardData = {
                    leaderboard,
                    departmentStats,
                    teamMetrics,
                    recentActivities,
                    currentDate
                };
                
                // Update all sections
                console.log('Updating UI...');
                updateMetrics(leaderboard, teamMetrics);
                updateDepartmentCards(departmentStats);
                updateActivityFeed(recentActivities);
                updateAlerts(departmentStats);
                
                console.log('Loading productivity chart...');
                await updateProductivityChart();
                
                // Store for comparison
                previousData = dashboardData;
                
                console.log('Dashboard load complete!');

                // Enable export button
                const exportBtn = document.getElementById('exportDashboardBtn');
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.title = 'Export dashboard data to CSV';
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorState();
            } finally {
                dashboardLoadInProgress = false;
            }
        }

        // Show loading states
        function showLoadingStates() {
            document.querySelectorAll('.metric-change').forEach(el => {
                el.innerHTML = '<span class="loading"></span>';
            });
        }
        
        // Update metrics cards
        function updateMetrics(leaderboard, teamMetrics) {
            console.log('Updating metrics with:', teamMetrics);
            
            // If teamMetrics is passed directly, use it
            if (teamMetrics && typeof teamMetrics === 'object') {
                // Active Employees
                document.getElementById('activeEmployees').textContent = 
                    teamMetrics.total_employees_today ? 
                    `${teamMetrics.active_employees}/${teamMetrics.total_employees_today}` : 
                    '0/0';
                
                // Update label
                const activeLabel = document.querySelector('#activeEmployees').nextElementSibling;
                if (activeLabel) {
                    activeLabel.textContent = 'Active Now / Worked Today';
                }
                
                // Items Processed Today (QC Passed only)
                document.getElementById('itemsProcessed').textContent = 
                    (teamMetrics.items_today || 0).toLocaleString();
                
                // Overall Efficiency
                document.getElementById('overallEfficiency').textContent = 
                    Math.round(teamMetrics.overall_efficiency || 0) + '%';
                
                // Total Hours Worked
                document.getElementById('totalHours').textContent = 
                    teamMetrics.total_hours_worked || '0';
                document.getElementById('hoursLoading').style.display = 'none';
                
                // Update change indicators
                updateMetricChange('itemsProcessedChange', teamMetrics.vs_yesterday || 0);
                updateMetricChange('efficiencyChange', 0); // No historical efficiency data yet
            } else {
                // Fallback to calculating from leaderboard
                const activeEmployees = leaderboard.filter(e => e.is_clocked_in).length;
                document.getElementById('activeEmployeeCount').textContent = activeEmployees;
                
                const totalItems = leaderboard.reduce((sum, emp) => sum + (emp.items_today || 0), 0);
                document.getElementById('itemsProcessed').textContent = totalItems.toLocaleString();
                
                document.getElementById('overallEfficiency').textContent = '0%';
                document.getElementById('totalHours').textContent = '0';
            }
        }
                
        // Calculate percentage change
        function calculateChange(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous) * 100;
        }
        
        // Update metric change indicator
        function updateMetricChange(elementId, change) {
            const element = document.getElementById(elementId);
            if (change > 0) {
                element.className = 'metric-change positive';
                element.innerHTML = `<i class="fas fa-arrow-up"></i> ${Math.abs(change).toFixed(1)}%`;
            } else if (change < 0) {
                element.className = 'metric-change negative';
                element.innerHTML = `<i class="fas fa-arrow-down"></i> ${Math.abs(change).toFixed(1)}%`;
            } else {
                element.className = 'metric-change';
                element.innerHTML = `<i class="fas fa-minus"></i> 0%`;
            }
        }
        
        // Update department cards
        // Update department cards
        function updateDepartmentCards(stats) {
            const container = document.getElementById('departmentGrid');
            
            if (!stats || stats.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-inbox"></i>
                        <p>No department data available</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            stats.forEach(dept => {
                // Convert string values to numbers
                const avgItemsPerMinute = parseFloat(dept.avg_items_per_minute || dept.avg_rate || 0);
                const efficiency = parseFloat(dept.efficiency || 0);
                const vsTarget = parseFloat(dept.vs_target || 0);
                const targetRate = parseFloat(dept.target_rate || 15);
                const totalItems = parseInt(dept.total_items || 0);
                const employeeCount = parseInt(dept.employee_count || 0);
                
                const card = document.createElement('div');
                card.className = 'department-card';
                card.innerHTML = `
                    <div class="department-header">
                        <div class="department-name">${getDepartmentIcon(dept.department_name || dept.name)} ${dept.department_name || dept.name}</div>
                        <div class="department-score">${Math.round(efficiency)}%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(efficiency, 100)}%"></div>
                    </div>
                    <div class="department-stats">
                        <div class="stat-item">
                            <div class="stat-value">${employeeCount}</div>
                            <div class="stat-label">Employees</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${avgItemsPerMinute.toFixed(1)}</div>
                            <div class="stat-label">
                                Avg Items/Min (Target: <span class="target-value" data-dept="${dept.department_name || dept.name}">${targetRate}</span>
                                <i class="fas fa-pencil-alt edit-target-btn" onclick="editDepartmentTarget('${dept.department_name || dept.name}', ${targetRate})" title="Edit target rate"></i>)
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: ${vsTarget >= 0 ? '#34d399' : '#ef4444'}">
                                ${vsTarget > 0 ? '+' : ''}${vsTarget.toFixed(0)}%
                            </div>
                            <div class="stat-label">vs Target</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Get department icon
        function getDepartmentIcon(deptName) {
            const icons = {
                'Picking': 'üéØ',
                'Packing': 'üì¶',
                'Packing and Shipping': 'üì¶',
                'Heat Press': 'üî•',
                'Labeling': 'üè∑Ô∏è',
                'Film Matching': 'üé¨'
            };
            return icons[deptName] || 'üìä';
        }

        // Edit department target rate
        async function editDepartmentTarget(deptName, currentRate) {
            const newRate = prompt(`Edit target rate for ${deptName}:\n(items per minute per person)`, currentRate);

            if (newRate === null) return; // Cancelled

            const rate = parseFloat(newRate);
            if (isNaN(rate) || rate <= 0) {
                await alertDialog('Invalid Input', 'Please enter a valid positive number');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/dashboard/departments/targets/${encodeURIComponent(deptName)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({ target_rate_per_person: rate })
                });

                if (response.ok) {
                    // Update the displayed value
                    const targetSpan = document.querySelector(`.target-value[data-dept="${deptName}"]`);
                    if (targetSpan) targetSpan.textContent = rate;

                    // Reload department data to update calculations
                    const departmentStats = await api.getDepartmentStats();
                    updateDepartmentCards(departmentStats);

                    showNotification(`Target for ${deptName} updated to ${rate} items/min/person`, 'success');
                } else {
                    const error = await response.json();
                    await alertDialog('Error', 'Error updating target: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating department target:', error);
                await alertDialog('Error', 'Error updating target: ' + error.message);
            }
        }

        // Update activity feed with clock in/out notifications
        function updateActivityFeed(activities) {
            const feed = document.getElementById('activityFeed');
            
            if (!activities || activities.length === 0) {
                feed.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>No activity data available</p>
                    </div>
                `;
                return;
            }
            
            feed.innerHTML = '';
            
            // Show recent clock in/out activities
            activities.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item';
                
                let icon, color;
                if (activity.type === 'clock_in') {
                    icon = 'sign-in-alt';
                    color = 'rgba(52, 211, 153, 0.2)';
                } else if (activity.type === 'clock_out') {
                    icon = 'sign-out-alt';
                    color = 'rgba(239, 68, 68, 0.2)';
                } else {
                    icon = 'clock';
                    color = 'rgba(102, 126, 234, 0.2)';
                }
                
                item.innerHTML = `
                    <div class="activity-icon" style="background: ${color};">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.description}</div>
                        <div class="activity-time">${formatTime(activity.timestamp)}</div>
                    </div>
                `;
                feed.appendChild(item);
            });
        }
        
        // Update alerts based on department performance
        function updateAlerts(departmentStats) {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '';
            
            if (!departmentStats || departmentStats.length === 0) return;
            
            // Check for low performing departments
            departmentStats.forEach(dept => {
                const efficiency = dept.expected_rate > 0 
                    ? (dept.actual_rate / dept.expected_rate) * 100
                    : 100;
                
                if (efficiency < 75) {
                    const alert = document.createElement('div');
                    alert.className = 'alert-item';
                    alert.innerHTML = `
                        <i class="fas fa-exclamation-circle alert-icon"></i>
                        <div class="alert-content">
                            <div class="alert-title">Low Productivity Alert</div>
                            <div class="alert-message">${dept.department_name} is ${(100 - efficiency).toFixed(0)}% below target rate</div>
                        </div>
                        <a href="#" class="alert-action" onclick="viewDepartmentDetails('${dept.department_name}')">View Details</a>
                    `;
                    container.appendChild(alert);
                }
            });
            
            // Add no alerts message if none
            if (container.innerHTML === '') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #34d399;">
                        <i class="fas fa-check-circle" style="font-size: 2em; margin-bottom: 10px;"></i>
                        <p>All departments operating within target parameters</p>
                    </div>
                `;
            }
        }
        
        // Update productivity chart
        async function updateProductivityChart() {
            try {
                const timeRange = document.getElementById('chartTimeRange').value;
                const currentDate = api.getCentralDate();
                
                // For now, generate sample hourly data
                // In production, you'd fetch this from your API
                const hours = [];
                const data = [];
                const target = [];
                
                for (let i = 6; i <= 17; i++) {
                    hours.push(`${i}:00`);
                    data.push(Math.floor(Math.random() * 600) + 800);
                    target.push(1200);
                }
                
                productivityChart.data.labels = hours;
                productivityChart.data.datasets[0].data = data;
                productivityChart.data.datasets[1].data = target;
                productivityChart.update();
                
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }
        
        // Format time helper
        function formatTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const now = new Date();
            const diff = (now - date) / 1000 / 60; // minutes
            
            if (diff < 60) {
                return `${Math.floor(diff)} minutes ago`;
            } else if (diff < 1440) {
                return `${Math.floor(diff / 60)} hours ago`;
            } else {
                return date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
            }
        }
        
        // View department details
        function viewDepartmentDetails(deptName) {
            console.log('View details for:', deptName);
            // Implement department details view
        }
        
        // Refresh dashboard
        function refreshDashboard() {
            console.log('Refreshing dashboard...');
            loadDashboardData();
        }
        
        // Export report - context-aware based on active tab
        async function exportReport() {
            // Detect which section is active
            const activeSection = document.querySelector('.section-content.active');
            if (!activeSection) {
                await alertDialog('Export', 'No section active');
                return;
            }

            const sectionId = activeSection.id;
            console.log('Exporting report for section:', sectionId);

            if (sectionId === 'cost-section') {
                // Cost Analysis tab - trigger the dedicated cost export
                if (typeof exportCostReport === 'function') {
                    exportCostReport();
                } else {
                    await alertDialog('Export', 'Cost export not available. Please load Cost Analysis data first.');
                }
            } else if (sectionId === 'dashboard-section') {
                // Dashboard tab - export leaderboard + metrics
                exportDashboardReport();
            } else if (sectionId === 'bottleneck-section') {
                // Bottleneck tab - export system health
                exportBottleneckReport();
            } else {
                await alertDialog('Export', `Export not implemented for: ${sectionId}`);
            }
        }

        // Export Dashboard data (summary metrics + department performance)
        async function exportDashboardReport() {
            // Check if we have data
            if (!dashboardData || !dashboardData.leaderboard) {
                await alertDialog('Export', 'No dashboard data to export. Please wait for data to load.');
                return;
            }

            const rows = [];
            const date = dashboardData.currentDate || api.getCentralDate();

            // ===== SECTION 1: DAILY SUMMARY =====
            rows.push(['DAILY SUMMARY REPORT']);
            rows.push(['Generated', new Date().toLocaleString()]);
            rows.push([]);

            // Get values from DOM (they're already calculated and displayed)
            const activeEmployees = document.getElementById('activeEmployees')?.textContent || '0';
            const itemsProcessed = document.getElementById('itemsProcessed')?.textContent || '0';
            const overallEfficiency = document.getElementById('overallEfficiency')?.textContent || '0%';
            const totalHours = document.getElementById('totalHours')?.textContent || '0';
            const itemsChange = document.getElementById('itemsProcessedChange')?.textContent?.trim() || '-';

            rows.push(['Metric', 'Value']);
            rows.push(['Date', date]);
            rows.push(['Active / Worked Today', activeEmployees]);
            rows.push(['Items Processed Today', itemsProcessed]);
            rows.push(['vs Yesterday', itemsChange]);
            rows.push(['Overall Efficiency', overallEfficiency]);
            rows.push(['Total Hours Worked', totalHours]);

            // ===== SECTION 2: DEPARTMENT PERFORMANCE =====
            rows.push([]);
            rows.push(['DEPARTMENT PERFORMANCE']);
            rows.push(['Department', 'Efficiency %', 'Employees', 'Avg Items/Min', 'Target', 'vs Target']);

            // Get department data from the rendered cards
            const deptCards = document.querySelectorAll('.department-card');
            if (deptCards.length > 0) {
                deptCards.forEach(card => {
                    const name = card.querySelector('.department-name')?.textContent?.trim() || '';
                    const efficiency = card.querySelector('.department-score')?.textContent?.trim() || '';

                    // Get stat values (Employees, Avg Items/Min, vs Target)
                    const statItems = card.querySelectorAll('.stat-item');
                    let employees = '', avgRate = '', target = '', vsTarget = '';

                    statItems.forEach(stat => {
                        const label = stat.querySelector('.stat-label')?.textContent?.toLowerCase() || '';
                        const value = stat.querySelector('.stat-value')?.textContent?.trim() || '';

                        if (label.includes('employee')) {
                            employees = value;
                        } else if (label.includes('items/min')) {
                            avgRate = value;
                            // Extract target from label text
                            const targetMatch = label.match(/target:\s*([\d.]+)/i);
                            if (targetMatch) target = targetMatch[1];
                        } else if (label.includes('target')) {
                            vsTarget = value;
                        }
                    });

                    if (name) {
                        rows.push([name, efficiency, employees, avgRate, target, vsTarget]);
                    }
                });
            } else {
                // Fallback: Use stored departmentStats data
                const deptStats = dashboardData.departmentStats || [];
                if (Array.isArray(deptStats)) {
                    deptStats.forEach(dept => {
                        rows.push([
                            dept.department_name || dept.name || '',
                            dept.efficiency ? `${Math.round(dept.efficiency)}%` : '',
                            dept.employee_count || '',
                            (dept.avg_items_per_minute || dept.avg_rate || 0).toFixed(1),
                            dept.target_rate || '',
                            dept.vs_target ? `${dept.vs_target.toFixed(0)}%` : ''
                        ]);
                    });
                }
            }

            // Build CSV
            const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            downloadCSV(csv, `dashboard_summary_${date}.csv`);
        }

        // Export Bottleneck/System Health data
        async function exportBottleneckReport() {
            // Get station data from the table
            const tableBody = document.getElementById('stationTableBody');
            if (!tableBody || !tableBody.children.length) {
                await alertDialog('Export', 'No bottleneck data to export. Please load data first.');
                return;
            }

            const headers = ['Station', 'Workers', 'Rate/Hr', 'Queue', 'Status'];
            const rows = [];

            // Extract data from station table
            const tableRows = tableBody.querySelectorAll('tr');
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    rows.push([
                        cells[0]?.textContent?.trim() || '',
                        cells[1]?.textContent?.trim() || '',
                        cells[2]?.textContent?.trim() || '',
                        cells[3]?.textContent?.trim() || '',
                        cells[4]?.textContent?.trim() || ''
                    ]);
                }
            });

            if (rows.length === 0) {
                await alertDialog('Export', 'No station data to export');
                return;
            }

            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            downloadCSV(csv, `bottleneck_report_${api.getCentralDate()}.csv`);
        }

        // Helper function to download CSV
        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Show error state
        function showErrorState() {
            document.getElementById('alertsContainer').innerHTML = `
                <div class="alert-item">
                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                    <div class="alert-content">
                        <div class="alert-title">Connection Error</div>
                        <div class="alert-message">Unable to load dashboard data. Please check your connection and try again.</div>
                    </div>
                    <a href="#" class="alert-action" onclick="refreshDashboard()">Retry</a>
                </div>
            `;
        }

        // Filter Available Workers function
        window.filterAvailableWorkers = function(searchValue) {
            const searchTerm = searchValue.toLowerCase().trim();
            const workersContainer = document.getElementById('availableWorkers');
            
            // Check if container has actual worker data
            if (workersContainer.innerHTML.includes('no-data') || workersContainer.innerHTML.includes('spinner')) {
                return;
            }
            
            // Get all station groups
            const stationGroups = workersContainer.querySelectorAll('.station-group');
            
            stationGroups.forEach(group => {
                // Get all worker divs within this station group
                const workerDivs = group.querySelectorAll('[style*="padding: 8px"]');
                let visibleInGroup = 0;
                
                workerDivs.forEach(workerDiv => {
                    const workerText = workerDiv.textContent.toLowerCase();
                    
                    // Check if search term matches
                    if (searchTerm === '' || workerText.includes(searchTerm)) {
                        workerDiv.style.display = '';
                        visibleInGroup++;
                    } else {
                        workerDiv.style.display = 'none';
                    }
                });
                
                // Hide the entire station group if no workers match
                if (visibleInGroup === 0 && searchTerm !== '') {
                    group.style.display = 'none';
                } else {
                    group.style.display = '';
                    // Update the count badge
                    const countBadge = group.querySelector('[style*="rgba(102,126,234,0.2)"]');
                    if (countBadge && searchTerm !== '') {
                        countBadge.textContent = visibleInGroup;
                    }
                }
            });
            
            // Check if any results are visible
            const visibleGroups = Array.from(stationGroups).filter(g => g.style.display !== 'none');
            
            // Remove any existing no results message
            const existingNoResults = document.getElementById('noSearchResults');
            if (existingNoResults) {
                existingNoResults.remove();
            }
            
            // Show no results message if needed
            if (visibleGroups.length === 0 && searchTerm !== '') {
                const noResultsDiv = document.createElement('div');
                noResultsDiv.id = 'noSearchResults';
                noResultsDiv.style.cssText = 'text-align: center; padding: 20px; color: #808080;';
                noResultsDiv.innerHTML = `<i class="fas fa-search"></i><p>No workers found matching "${searchTerm}"</p>`;
                workersContainer.appendChild(noResultsDiv);
            }
        };
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing manager dashboard...');
            
            // Start clock display
            const startClock = () => {
                const updateClock = () => {
                    const now = api.getCurrentCentralTime();
                    const dateStr = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const timeStr = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    
                    const clockElement = document.getElementById('currentDateTime');
                    if (clockElement) {
                        clockElement.innerHTML = `${dateStr} at ${timeStr}`;
                    }
                };
                
                // Update immediately
                updateClock();
                
                // Update every second
                setInterval(updateClock, 1000);
            };

            // Start the clock
            startClock();
            
            // Initialize date inputs with today's date
            const today = api.getCentralDate();
            console.log('Setting initial date to:', today);
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Store in dashboardData
            dashboardData.startDate = today;
            dashboardData.endDate = today;
            
            // Update the title to show today's date
            const titleElement = document.querySelector('.dashboard-title p');
            if (titleElement) {
                const dateObj = new Date(today + 'T12:00:00');  // Add time to avoid timezone issues
                titleElement.textContent = `Data for ${dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`; 
            }
            
            // Initialize chart
            initializeChart();

            // Restore saved tab or load dashboard (deferred to ensure functions are defined)
            setTimeout(() => {
                const savedTab = localStorage.getItem('managerActiveTab');
                if (savedTab && savedTab !== 'dashboard') {
                    if (savedTab === 'employee-management') {
                        window.showEmployeeManagement();
                    } else {
                        window.showSection(savedTab);
                    }
                } else {
                    // Load dashboard as default
                    loadDashboardData();
                }
            }, 0);
            
            // Set up auto-refresh every 2 minutes (only when tab visible)
            refreshInterval = setInterval(() => {
                if (shouldRefresh()) loadDashboardData();
            }, 120000); // 120 seconds = 2 minutes
            
            // Schedule midnight refresh
            const scheduleMiddnightRefresh = () => {
                const scheduleNext = () => {
                    const now = api.getCurrentCentralTime();
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(0, 0, 5, 0); // 5 seconds after midnight
                    
                    const msUntilMidnight = tomorrow - now;
                    
                    setTimeout(() => {
                        console.log('Midnight refresh triggered');
                        window.location.reload();
                    }, msUntilMidnight);
                };
                
                scheduleNext();
            };

            // Schedule the midnight refresh
            scheduleMiddnightRefresh();

            // Note: Window focus refresh removed - visibilitychange handler already handles this

            // Chart time range change
            document.getElementById('chartTimeRange').addEventListener('change', updateProductivityChart);
            
            // Employee Management Functions
            window.showEmployeeManagement = function() {
                localStorage.setItem('managerActiveTab', 'employee-management');
                showSection('employee-management');
                window.loadEmployeeManagementData();
            };

            window.loadEmployeeManagementData = async function() {
                try {
                    console.log('Loading employee management data...');

                    // Load employees and PIN data in parallel
                    const [response, pinResponse] = await Promise.all([
                        api.request('/dashboard/employees'),
                        fetch(`${API_BASE}/api/admin/employees`, { headers: { 'X-API-Key': 'dev-api-key-123' } }).then(r => r.json())
                    ]);
                    console.log('Response received:', response);

                    if (response && response.employees) {
                        // Create PIN lookup map by employee ID
                        const pinMap = {};
                        if (pinResponse && pinResponse.employees) {
                            pinResponse.employees.forEach(emp => {
                                pinMap[emp.id] = { has_pin: emp.has_pin, pin_plain: emp.pin_plain };
                            });
                        }

                        // Filter out archived employees and merge PIN data
                        const activeEmployees = response.employees
                            .filter(e => e.is_active === 1 || e.is_active === true)
                            .map(emp => ({
                                ...emp,
                                has_pin: pinMap[emp.id]?.has_pin || 0,
                                pin_plain: pinMap[emp.id]?.pin_plain || null
                            }));
                        console.log('Active employees found:', activeEmployees.length);

                        // Update statistics
                        document.getElementById('totalEmployeeCount').textContent = activeEmployees.length;

                        // Display only active employees in table
                        window.displayEmployeeTable(activeEmployees);
                    } else {
                        console.log('No employees in response:', response);
                    }

                    // Load needs-attention count
                    try {
                        const attentionResponse = await api.request('/dashboard/employees/needs-attention');
                        if (attentionResponse.success) {
                            const count = attentionResponse.summary.total_attention_needed;
                            document.getElementById('needsAttentionCount').textContent = count;

                            // Update badge
                            const badge = document.getElementById('attentionBadge');
                            if (count > 0) {
                                badge.textContent = count;
                                badge.style.display = 'flex';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    } catch (e) {
                        console.error('Error loading needs-attention count:', e);
                    }
                } catch (error) {
                    console.error('Error loading employee data:', error);
                }
            };

            window.displayEmployeeTable = function(employees) {
                // Store all employees and reset pagination
                employeePagination.allEmployees = employees;
                employeePagination.filteredEmployees = employees;
                employeePagination.currentPage = 1;
                renderEmployeePage();
            };

            // Render only the rows (used by pagination)
            window.renderEmployeeRows = function(employees) {
                const tbody = document.getElementById('employeeTableBody');
                if (!tbody) return;

                tbody.innerHTML = employees.map(emp => {
                    const podfactoryEmailsDisplay = emp.podfactory_emails
                        ? emp.podfactory_emails.split(',').map(email =>
                            `<div style="padding: 2px 0;">${email.trim()}</div>`
                        ).join('')
                        : '<span style="color: #fbbf24;">Not mapped</span>';

                    // PIN status display: NOT SET | View (has plain) | Reset (no plain)
                    let pinDisplay;
                    if (!emp.has_pin) {
                        pinDisplay = `<span style="color: #fbbf24; background: rgba(251,191,36,0.15); padding: 4px 10px; border-radius: 12px; font-size: 12px;">NOT SET</span>`;
                    } else if (emp.pin_plain) {
                        pinDisplay = `<button onclick="viewEmployeePin(${emp.id}, '${emp.name.replace(/'/g, "\\'")}', '${emp.pin_plain}')" style="padding: 4px 12px; background: #6366f1; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 12px;">View</button>`;
                    } else {
                        pinDisplay = `<button onclick="resetEmployeePin(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')" style="padding: 4px 12px; background: #f59e0b; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 12px;" title="Legacy PIN - reset to view">Reset</button>`;
                    }

                    return `
                        <tr>
                            <td style="padding: 12px;">${emp.id}</td>
                            <td style="padding: 12px;">${emp.name}</td>
                            <td style="padding: 12px;">${emp.email || '-'}</td>
                            <td style="padding: 12px;">${emp.connecteam_user_id || '<span style="color: #fbbf24;">Not mapped</span>'}</td>
                            <td style="padding: 12px;">${podfactoryEmailsDisplay}</td>
                            <td style="padding: 12px;"><span class="badge ${emp.is_active ? 'badge-success' : 'badge-danger'}" style="background: ${emp.is_active ? '#22c55e' : '#ef4444'}; padding: 4px 12px; border-radius: 12px;">${emp.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td style="padding: 12px;">${pinDisplay}</td>
                            <td style="padding: 12px; position: relative;">
                                <button onclick="toggleDropdown(${emp.id})" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Actions ‚ñº
                                </button>
                                <div id="dropdown-${emp.id}" style="display: none; position: absolute; right: 0; top: 100%; background: #2a2a2a; min-width: 120px; box-shadow: 0px 8px 16px rgba(0,0,0,0.2); z-index: 1000; border-radius: 5px; margin-top: 5px;">
                                    <a href="#" onclick="mapEmployee(${emp.id}); return false;" style="color: white; padding: 10px 15px; text-decoration: none; display: block; border-bottom: 1px solid rgba(255,255,255,0.1);">üîó Map</a>
                                    <a href="#" onclick="openSetPinModal(${emp.id}, '${emp.name.replace(/'/g, "\\'")}'); return false;" style="color: white; padding: 10px 15px; text-decoration: none; display: block; border-bottom: 1px solid rgba(255,255,255,0.1);">üîë PIN</a>
                                    <a href="#" onclick="archiveEmployee(${emp.id}, '${emp.name.replace(/'/g, "\\'")}'); return false;" style="color: #ef4444; padding: 10px 15px; text-decoration: none; display: block;">üóëÔ∏è Archive</a>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            };

            // Add this function right after displayEmployeeTable
            window.toggleDropdown = function(id) {
                const dropdown = document.getElementById(`dropdown-${id}`);
                // Close all other dropdowns first
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                    if (d.id !== `dropdown-${id}`) d.style.display = 'none';
                });
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            };

            // Add this event listener to close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.matches('[onclick*="toggleDropdown"]')) {
                    document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                        d.style.display = 'none';
                    });
                }
            });


            window.showEmpTab = function(tab) {
            // Hide all tabs
            document.querySelectorAll('.emp-tab-content').forEach(t => t.style.display = 'none');

            // Remove active class from all buttons
            document.querySelectorAll('.emp-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected tab
            const tabElement = document.getElementById('empTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            if (tabElement) {
                tabElement.style.display = 'block';
            }

            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Load data for the tab
            if (tab === 'payrates') {
                loadPayratesData();
            } else if (tab === 'archived') {
                loadArchivedEmployees();
            } else if (tab === 'attention') {
                loadNeedsAttention();
            }
        };

        // ============= UNIFIED NEEDS ATTENTION FUNCTIONS =============

        // Store employee list for reassignment dropdown
        let allEmployeesList = [];

        window.loadNeedsAttention = async function() {
            const noConnecteamList = document.getElementById('noConnecteamList');
            const pendingList = document.getElementById('pendingVerificationList');
            const noPodFactoryList = document.getElementById('noPodFactoryList');
            const allClearState = document.getElementById('allClearState');
            const noConnecteamSection = document.getElementById('noConnecteamSection');
            const pendingSection = document.getElementById('pendingVerifSection');
            const noPodFactorySection = document.getElementById('noPodFactorySection');
            const badge = document.getElementById('attentionBadge');

            try {
                const response = await api.request('/dashboard/employees/needs-attention');

                if (response.success) {
                    const { no_connecteam, pending_verification, no_podfactory, summary } = response;

                    // Update summary counts
                    document.getElementById('noConnecteamSummary').textContent = summary.no_connecteam_count;
                    document.getElementById('pendingVerifSummary').textContent = summary.pending_verification_count;
                    document.getElementById('noPodFactorySummary').textContent = summary.no_podfactory_count || 0;
                    document.getElementById('needsAttentionCount').textContent = summary.total_attention_needed;

                    // Update badge
                    if (summary.total_attention_needed > 0) {
                        badge.textContent = summary.total_attention_needed;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }

                    // Load employee list for reassignment
                    const empResponse = await api.request('/dashboard/employees');
                    if (empResponse.success) {
                        allEmployeesList = empResponse.employees.filter(e => e.is_active === 1);
                    }

                    // Render No Connecteam list
                    if (no_connecteam.length > 0) {
                        noConnecteamSection.style.display = 'block';
                        noConnecteamList.innerHTML = no_connecteam.map(emp => renderNoConnecteamCard(emp)).join('');
                    } else {
                        noConnecteamSection.style.display = 'none';
                    }

                    // Render Pending Verifications
                    if (pending_verification.length > 0) {
                        pendingSection.style.display = 'block';
                        pendingList.innerHTML = pending_verification.map(item => renderPendingCard(item)).join('');
                    } else {
                        pendingSection.style.display = 'none';
                    }

                    // Render No PodFactory Mapping list
                    if (no_podfactory && no_podfactory.length > 0) {
                        noPodFactorySection.style.display = 'block';
                        noPodFactoryList.innerHTML = no_podfactory.map(emp => renderNoPodFactoryCard(emp)).join('');
                    } else {
                        noPodFactorySection.style.display = 'none';
                    }

                    // Show all clear if nothing needs attention
                    if (summary.total_attention_needed === 0) {
                        allClearState.style.display = 'block';
                        noConnecteamSection.style.display = 'none';
                        pendingSection.style.display = 'none';
                        noPodFactorySection.style.display = 'none';
                    } else {
                        allClearState.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading needs attention:', error);
                noConnecteamList.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading data</p>';
            }
        };

        function renderNoConnecteamCard(emp) {
            const isSystem = emp.is_system_account;
            const borderColor = isSystem ? 'rgba(107, 114, 128, 0.3)' : 'rgba(239, 68, 68, 0.3)';
            const bgColor = isSystem ? 'rgba(107, 114, 128, 0.1)' : 'rgba(239, 68, 68, 0.05)';

            return `
                <div style="
                    background: ${bgColor};
                    border: 1px solid ${borderColor};
                    border-radius: 10px;
                    padding: 15px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 15px;
                    flex-wrap: wrap;
                ">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <span style="color: #e0e0e0; font-weight: 600;">${emp.name}</span>
                            ${isSystem ? '<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em;">System Account</span>' : ''}
                        </div>
                        <div style="color: #808080; font-size: 0.85em;">
                            ${emp.email || 'No email'}
                            ${emp.podfactory_emails ? `| PodFactory: ${emp.podfactory_emails.split(',').length} email(s)` : ''}
                        </div>
                        <div style="color: #808080; font-size: 0.8em; margin-top: 3px;">
                            ${emp.recent_activity_count || 0} activities (30 days)
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="openSmartMapping(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')"
                                class="btn-action btn-primary" style="padding: 8px 12px; font-size: 0.85em;">
                            <i class="fas fa-link"></i> Link to Connecteam
                        </button>
                        <button onclick="openSetPinModal(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')"
                                class="btn-action btn-secondary" style="padding: 8px 12px; font-size: 0.85em; background: rgba(99, 102, 241, 0.2);">
                            <i class="fas fa-key"></i> PIN
                        </button>
                        <button onclick="markAsContractor(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')"
                                class="btn-action btn-secondary" style="padding: 8px 12px; font-size: 0.85em;">
                            <i class="fas fa-user-tie"></i> Mark Contractor
                        </button>
                        <button onclick="archiveEmployee(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')"
                                class="btn-action btn-secondary" style="padding: 8px 12px; font-size: 0.85em; background: rgba(107, 114, 128, 0.2);">
                            <i class="fas fa-archive"></i> Archive
                        </button>
                    </div>
                </div>
            `;
        }

        function renderNoPodFactoryCard(emp) {
            return `
                <div style="
                    background: rgba(168, 85, 247, 0.05);
                    border: 1px solid rgba(168, 85, 247, 0.3);
                    border-radius: 10px;
                    padding: 15px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 15px;
                    flex-wrap: wrap;
                ">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <span style="color: #e0e0e0; font-weight: 600;">${emp.name}</span>
                            <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em;">
                                <i class="fas fa-check"></i> Connecteam Linked
                            </span>
                        </div>
                        <div style="color: #808080; font-size: 0.85em;">
                            ${emp.email || 'No email'} | Connecteam ID: ${emp.connecteam_user_id}
                        </div>
                        <div style="color: #808080; font-size: 0.8em; margin-top: 3px;">
                            ${emp.recent_clock_count || 0} clock-ins (7 days)
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="openPodFactoryMapping(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')"
                                class="btn-action btn-primary" style="padding: 8px 12px; font-size: 0.85em; background: rgba(168, 85, 247, 0.8);">
                            <i class="fas fa-box-open"></i> Add PodFactory Email
                        </button>
                        <button onclick="openSetPinModal(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')"
                                class="btn-action btn-secondary" style="padding: 8px 12px; font-size: 0.85em; background: rgba(99, 102, 241, 0.2);">
                            <i class="fas fa-key"></i> PIN
                        </button>
                    </div>
                </div>
            `;
        }

        // Open modal to add PodFactory email mapping for an employee
        window.openPodFactoryMapping = async function(employeeId, employeeName) {
            // Show loading modal first
            const loadingModal = `
                <div id="podFactoryMappingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #2a2a2a; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; text-align: center;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #a855f7;"></i>
                        <p style="color: #e0e0e0; margin-top: 15px;">Searching PodFactory for "${employeeName}"...</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingModal);

            // Fetch real email suggestions from PodFactory database
            let suggestions = [];
            try {
                const response = await fetch(`${API_BASE_URL}/dashboard/podfactory/suggest-emails?name=${encodeURIComponent(employeeName)}`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const data = await response.json();
                if (data.success && data.emails) {
                    suggestions = data.emails;
                }
            } catch (e) {
                console.error('Failed to fetch suggestions:', e);
            }

            // Generate fallback suggestion based on name pattern
            const nameParts = employeeName.toLowerCase().split(' ').filter(p => p);
            const fallbackEmail = nameParts.length >= 2
                ? `${nameParts[0]}.${nameParts.slice(1).join('.')}shp@colorecommerce.us`
                : `${nameParts[0]}shp@colorecommerce.us`;

            // Build suggestion buttons HTML
            let suggestionsHtml = '';
            if (suggestions.length > 0) {
                suggestionsHtml = `
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #22c55e; font-size: 0.85em; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> Found in PodFactory (click to select):
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${suggestions.map(s => `
                                <button onclick="document.getElementById('podFactoryEmailInput').value='${s.email}'"
                                        style="text-align: left; padding: 10px; background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 5px; cursor: pointer; color: #e0e0e0;">
                                    <strong>${s.email}</strong>
                                    <span style="color: #808080; font-size: 0.85em; margin-left: 10px;">${s.name || ''}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                suggestionsHtml = `
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #ef4444; font-size: 0.85em;">
                            <i class="fas fa-exclamation-triangle"></i> No matching email found in PodFactory (last 30 days)
                        </div>
                        <div style="color: #808080; font-size: 0.8em; margin-top: 5px;">
                            Suggested pattern: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">${fallbackEmail}</code>
                        </div>
                    </div>
                `;
            }

            // Replace with full modal
            document.getElementById('podFactoryMappingModal').remove();
            const modal = `
                <div id="podFactoryMappingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #2a2a2a; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%;">
                        <h3 style="color: #e0e0e0; margin-bottom: 20px;">
                            <i class="fas fa-box-open" style="color: #a855f7;"></i> Map PodFactory Email for "${employeeName}"
                        </h3>

                        ${suggestionsHtml}

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #e0e0e0;">
                                PodFactory Email Address:
                            </label>
                            <input type="email" id="podFactoryEmailInput"
                                   value="${suggestions.length > 0 ? suggestions[0].email : fallbackEmail}"
                                   placeholder="email@colorecommerce.us"
                                   style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 1em;">
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="document.getElementById('podFactoryMappingModal').remove()"
                                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="savePodFactoryMapping(${employeeId}, '${employeeName.replace(/'/g, "\\'")}')"
                                    style="padding: 10px 20px; background: #a855f7; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-save"></i> Save Mapping
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        };

        // Save PodFactory email mapping
        window.savePodFactoryMapping = async function(employeeId, employeeName) {
            const email = document.getElementById('podFactoryEmailInput').value.trim();

            if (!email) {
                await alertDialog('Invalid Input', 'Please enter a PodFactory email address');
                return;
            }

            if (!email.includes('@')) {
                await alertDialog('Invalid Input', 'Please enter a valid email address');
                return;
            }

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                const response = await api.request('/dashboard/employees/create-mapping', {
                    method: 'POST',
                    body: JSON.stringify({
                        employee_id: employeeId,
                        podfactory_email: email,
                        podfactory_name: employeeName,
                        is_verified: true
                    })
                });

                if (response.success) {
                    document.getElementById('podFactoryMappingModal').remove();
                    await alertDialog('Success', `PodFactory email mapped for ${employeeName}`);
                    loadNeedsAttention();
                    loadEmployeeManagementData();
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    await alertDialog('Error', response.error || 'Failed to save mapping');
                }
            } catch (error) {
                console.error('Error saving PodFactory mapping:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                await alertDialog('Error', 'Error saving mapping: ' + error.message);
            }
        };

        window.markAsContractor = async function(employeeId, employeeName) {
            const confirmed = await confirmDialog('Mark as Contractor', `Mark "${employeeName}" as a contractor? This will exempt them from Connecteam time tracking.`);
            if (!confirmed) return;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await api.request(`/dashboard/employees/${employeeId}/mark-contractor`, {
                    method: 'POST',
                    body: JSON.stringify({ is_contractor: true })
                });

                if (response.success) {
                    showNotification(`${employeeName} marked as contractor`, 'success');
                    loadNeedsAttention();
                    loadEmployeeManagementData();
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showNotification(response.error || 'Failed to mark as contractor', 'error');
                }
            } catch (error) {
                console.error('Error marking contractor:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showNotification('Error marking contractor', 'error');
            }
        };

        // ============= PENDING VERIFICATION FUNCTIONS =============

        window.loadPendingVerifications = async function() {
            const container = document.getElementById('pendingVerificationList');
            const emptyState = document.getElementById('noPendingState');

            try {
                const response = await api.request('/dashboard/employees/pending-verification');

                if (response.success && response.pending.length > 0) {
                    emptyState.style.display = 'none';
                    container.style.display = 'grid';

                    // Load employee list for reassignment
                    const empResponse = await api.request('/dashboard/employees');
                    if (empResponse.success) {
                        allEmployeesList = empResponse.employees.filter(e => e.is_active === 1);
                    }

                    // Render pending cards
                    container.innerHTML = response.pending.map(item => renderPendingCard(item)).join('');
                } else {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading pending verifications:', error);
                container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Error loading pending verifications</p>';
            }
        };

        function renderPendingCard(item) {
            const namesMatch = item.employee_name.toLowerCase().trim() === (item.podfactory_name || '').toLowerCase().trim();
            const matchIndicator = namesMatch
                ? '<span style="color: #22c55e; font-size: 0.85em;"><i class="fas fa-check-circle"></i> Names match</span>'
                : '<span style="color: #fbbf24; font-size: 0.85em;"><i class="fas fa-exclamation-triangle"></i> Names differ</span>';

            return `
                <div class="pending-card" style="
                    background: rgba(255,255,255,0.03);
                    border: 1px solid ${namesMatch ? 'rgba(34, 197, 94, 0.3)' : 'rgba(251, 191, 36, 0.3)'};
                    border-radius: 12px;
                    padding: 20px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px; flex-wrap: wrap;">
                        <!-- Left: Mapping Info -->
                        <div style="flex: 1; min-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2em;">
                                    ${item.employee_name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase()}
                                </div>
                                <div>
                                    <div style="color: #e0e0e0; font-weight: 600; font-size: 1.1em;">${item.employee_name}</div>
                                    <div style="color: #808080; font-size: 0.85em;">Employee ID: ${item.employee_id}</div>
                                </div>
                            </div>

                            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 0.9em;">
                                    <span style="color: #808080;">PodFactory Email:</span>
                                    <span style="color: #667eea; font-weight: 500;">${item.podfactory_email}</span>

                                    <span style="color: #808080;">PodFactory Name:</span>
                                    <span style="color: #e0e0e0;">${item.podfactory_name || 'N/A'}</span>

                                    <span style="color: #808080;">Match Score:</span>
                                    <span style="color: ${item.similarity_score >= 0.9 ? '#22c55e' : item.similarity_score >= 0.7 ? '#fbbf24' : '#ef4444'};">
                                        ${(item.similarity_score * 100).toFixed(0)}%
                                    </span>

                                    <span style="color: #808080;">Recent Activity:</span>
                                    <span style="color: #e0e0e0;">${item.recent_activity_count} logs (7 days)</span>
                                </div>
                            </div>

                            ${matchIndicator}
                        </div>

                        <!-- Right: Actions -->
                        <div style="display: flex; flex-direction: column; gap: 10px; min-width: 200px;">
                            <button onclick="approveMapping(${item.mapping_id})" class="btn-action btn-primary" style="width: 100%;">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button onclick="rejectMapping(${item.mapping_id})" class="btn-action btn-secondary" style="width: 100%; background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5);">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <div style="position: relative;">
                                <select onchange="reassignMapping(${item.mapping_id}, this.value)" style="
                                    width: 100%;
                                    padding: 10px;
                                    background: rgba(255,255,255,0.1);
                                    color: #e0e0e0;
                                    border: 1px solid rgba(255,255,255,0.2);
                                    border-radius: 8px;
                                    cursor: pointer;
                                ">
                                    <option value="">Reassign to...</option>
                                    ${allEmployeesList.map(emp =>
                                        `<option value="${emp.id}" ${emp.id === item.employee_id ? 'disabled' : ''}>${emp.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.approveMapping = async function(mappingId) {
            const confirmed = await confirmDialog('Approve Mapping', 'Approve this email mapping?');
            if (!confirmed) return;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await api.request(`/dashboard/employees/mapping/${mappingId}/verify`, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'approve', verified_by: 'manager' })
                });

                if (response.success) {
                    showNotification('Mapping approved', 'success');
                    loadPendingVerifications();
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showNotification(response.error || 'Failed to approve', 'error');
                }
            } catch (error) {
                console.error('Error approving mapping:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showNotification('Error approving mapping', 'error');
            }
        };

        window.rejectMapping = async function(mappingId) {
            const confirmed = await confirmDialog('Reject Mapping', 'Reject this mapping? The email will need to be re-mapped manually.');
            if (!confirmed) return;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await api.request(`/dashboard/employees/mapping/${mappingId}/verify`, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'reject', verified_by: 'manager' })
                });

                if (response.success) {
                    showNotification('Mapping rejected', 'success');
                    loadPendingVerifications();
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showNotification(response.error || 'Failed to reject', 'error');
                }
            } catch (error) {
                console.error('Error rejecting mapping:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showNotification('Error rejecting mapping', 'error');
            }
        };

        window.reassignMapping = async function(mappingId, newEmployeeId) {
            if (!newEmployeeId) return;

            const emp = allEmployeesList.find(e => e.id == newEmployeeId);
            const confirmed = await confirmDialog('Reassign Mapping', `Reassign this email to ${emp?.name || 'selected employee'}?`);
            if (!confirmed) {
                event.target.value = '';
                return;
            }

            showLoadingOverlay('Reassigning...');

            try {
                const response = await api.request(`/dashboard/employees/mapping/${mappingId}/reassign`, {
                    method: 'POST',
                    body: JSON.stringify({ employee_id: parseInt(newEmployeeId), verified_by: 'manager' })
                });

                hideLoadingOverlay();
                if (response.success) {
                    showNotification('Mapping reassigned successfully', 'success');
                    loadPendingVerifications();
                } else {
                    showNotification(response.error || 'Failed to reassign', 'error');
                }
            } catch (error) {
                hideLoadingOverlay();
                console.error('Error reassigning mapping:', error);
                showNotification('Error reassigning mapping', 'error');
            }
        };


        // Store all employees for dropdown
        let allEmployeesForMapping = [];

        // Load mapping recommendations
        window.loadMappingRecommendations = async function() {
            const container = document.getElementById('mappingRecommendationsList');
            const emptyState = document.getElementById('noMappingsState');
            const summaryEl = document.getElementById('unmappedCountText');

            try {
                const response = await api.request('/dashboard/employees/mapping-recommendations');

                if (!response.success) {
                    container.innerHTML = '<p style="color: #ef4444; text-align: center;">Failed to load recommendations</p>';
                    return;
                }

                allEmployeesForMapping = response.all_employees || [];
                summaryEl.textContent = response.unmapped_count;

                if (response.recommendations.length === 0) {
                    container.style.display = 'none';
                    emptyState.style.display = 'block';
                    document.getElementById('unmappedSummary').style.display = 'none';
                    return;
                }

                container.style.display = 'grid';
                emptyState.style.display = 'none';

                container.innerHTML = response.recommendations.map((rec, idx) => {
                    const hasRecommendations = rec.recommended_matches && rec.recommended_matches.length > 0;
                    const topMatch = hasRecommendations ? rec.recommended_matches[0] : null;

                    return `
                        <div class="mapping-card" style="background: rgba(30, 30, 35, 0.9); border: 1px solid rgba(155, 89, 182, 0.3); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                                <!-- PodFactory User Info -->
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <i class="fas fa-user" style="color: #9b59b6; font-size: 1.2em;"></i>
                                        <span style="color: #e0e0e0; font-weight: 600; font-size: 1.1em;">${rec.podfactory_name || 'Unknown'}</span>
                                    </div>
                                    <div style="color: #808080; font-size: 0.9em; margin-bottom: 5px;">
                                        <i class="fas fa-envelope" style="margin-right: 5px;"></i> ${rec.podfactory_email}
                                    </div>
                                    <div style="color: #808080; font-size: 0.85em;">
                                        <i class="fas fa-briefcase" style="margin-right: 5px;"></i> ${rec.podfactory_role || 'N/A'}
                                        <span style="margin-left: 10px;"><i class="fas fa-chart-bar" style="margin-right: 5px;"></i> ${rec.activity_count} activities</span>
                                    </div>
                                </div>

                                <!-- Recommendation -->
                                <div style="flex: 1; text-align: right;">
                                    ${hasRecommendations ? `
                                        <div style="margin-bottom: 10px;">
                                            <span style="color: #808080; font-size: 0.85em;">Best Match:</span>
                                            <div style="color: #22c55e; font-weight: 600;">${topMatch.employee_name}</div>
                                            <div style="display: inline-block; padding: 2px 8px; background: ${topMatch.similarity_score >= 0.8 ? 'rgba(34, 197, 94, 0.2)' : topMatch.similarity_score >= 0.6 ? 'rgba(251, 191, 36, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; border-radius: 12px; font-size: 0.8em; color: ${topMatch.similarity_score >= 0.8 ? '#22c55e' : topMatch.similarity_score >= 0.6 ? '#fbbf24' : '#ef4444'};">
                                                ${Math.round(topMatch.similarity_score * 100)}% match
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="color: #fbbf24; font-size: 0.9em;">
                                            <i class="fas fa-exclamation-triangle"></i> No automatic matches found
                                        </div>
                                    `}
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                                ${hasRecommendations ? `
                                    <button onclick="applyRecommendedMapping('${rec.podfactory_email}', '${rec.podfactory_name || ''}', ${topMatch.employee_id}, '${topMatch.employee_name}')"
                                            class="btn-action btn-primary" style="padding: 8px 16px; font-size: 0.9em;">
                                        <i class="fas fa-check"></i> Apply Match
                                    </button>
                                ` : ''}
                                <button onclick="showManualMappingModal('${rec.podfactory_email}', '${rec.podfactory_name || ''}')"
                                        class="btn-action btn-secondary" style="padding: 8px 16px; font-size: 0.9em;">
                                    <i class="fas fa-search"></i> Choose Manually
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading mapping recommendations:', error);
                container.innerHTML = '<p style="color: #ef4444; text-align: center;">Error loading recommendations</p>';
            }
        };

        // Apply recommended mapping
        window.applyRecommendedMapping = async function(pfEmail, pfName, employeeId, employeeName) {
            const confirmed = await confirmDialog('Apply Mapping', `Map "${pfName || pfEmail}" to employee "${employeeName}"?`);
            if (!confirmed) return;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const response = await api.request('/dashboard/employees/create-mapping', {
                    method: 'POST',
                    body: JSON.stringify({
                        employee_id: employeeId,
                        podfactory_email: pfEmail,
                        podfactory_name: pfName,
                        verified_by: 'manager'
                    })
                });

                if (response.success) {
                    showNotification('Mapping created successfully', 'success');
                    loadMappingRecommendations();
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showNotification(response.error || 'Failed to create mapping', 'error');
                }
            } catch (error) {
                console.error('Error creating mapping:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showNotification('Error creating mapping', 'error');
            }
        };

        // Show manual mapping modal
        window.showManualMappingModal = function(pfEmail, pfName) {
            const employeeOptions = allEmployeesForMapping.map(emp =>
                `<option value="${emp.id}">${emp.name}</option>`
            ).join('');

            const modal = `
                <div id="manualMappingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%;">
                        <h3 style="color: #e0e0e0; margin-bottom: 20px;">
                            <i class="fas fa-link" style="color: #9b59b6; margin-right: 10px;"></i>
                            Manual Mapping
                        </h3>

                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(155, 89, 182, 0.1); border-radius: 8px;">
                            <div style="color: #808080; font-size: 0.85em;">PodFactory User:</div>
                            <div style="color: #e0e0e0; font-weight: 600;">${pfName || pfEmail}</div>
                            <div style="color: #808080; font-size: 0.9em;">${pfEmail}</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; color: #e0e0e0;">Select Employee:</label>
                            <select id="manualMappingEmployee" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                                <option value="">-- Select an employee --</option>
                                ${employeeOptions}
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="document.getElementById('manualMappingModal').remove()" class="btn-action btn-secondary">
                                Cancel
                            </button>
                            <button onclick="submitManualMapping('${pfEmail}', '${pfName}')" class="btn-action btn-primary">
                                <i class="fas fa-check"></i> Create Mapping
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        };

        // Submit manual mapping
        window.submitManualMapping = async function(pfEmail, pfName) {
            const employeeId = document.getElementById('manualMappingEmployee').value;
            if (!employeeId) {
                showNotification('Please select an employee', 'error');
                return;
            }

            const employeeName = document.getElementById('manualMappingEmployee').selectedOptions[0].text;

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            btn.disabled = true;

            try {
                const response = await api.request('/dashboard/employees/create-mapping', {
                    method: 'POST',
                    body: JSON.stringify({
                        employee_id: parseInt(employeeId),
                        podfactory_email: pfEmail,
                        podfactory_name: pfName,
                        verified_by: 'manager'
                    })
                });

                if (response.success) {
                    document.getElementById('manualMappingModal').remove();
                    showNotification('Mapping created successfully', 'success');
                    loadMappingRecommendations();
                } else {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    showNotification(response.error || 'Failed to create mapping', 'error');
                }
            } catch (error) {
                console.error('Error creating mapping:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showNotification('Error creating mapping', 'error');
            }
        };

            window.filterEmployees = function() {
                const searchText = document.getElementById('empSearchInput').value.toLowerCase();
                // Filter from all employees, not DOM
                employeePagination.filteredEmployees = employeePagination.allEmployees.filter(emp => {
                    const searchFields = [
                        emp.id?.toString(),
                        emp.name,
                        emp.email,
                        emp.connecteam_user_id,
                        emp.podfactory_emails
                    ].filter(Boolean).join(' ').toLowerCase();
                    return searchFields.includes(searchText);
                });
                employeePagination.currentPage = 1; // Reset to first page
                renderEmployeePage();
            };

            // Store original payrates data
            let allPayratesData = [];
            let hourlySortAsc = true;

            window.loadPayratesData = async function() {
                try {
                    const response = await api.request('/dashboard/employees/payrates');
                    if (response && response.payrates) {
                        allPayratesData = response.payrates;
                        displayFilteredPayrates();
                    }
                } catch (error) {
                    console.error('Error loading payrates:', error);
                }
            };

            window.displayFilteredPayrates = function() {
                let filtered = [...allPayratesData];
                
                // Apply search filter
                const searchText = document.getElementById('payrateSearchInput')?.value?.toLowerCase() || '';
                if (searchText) {
                    filtered = filtered.filter(emp => 
                        emp.name.toLowerCase().includes(searchText)
                    );
                }
                
                // Apply sorting
                const sortBy = document.getElementById('payrateSortBy')?.value || 'name';
                switch(sortBy) {
                    case 'name':
                        filtered.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'not_set':
                        // Sort by: not set first (hourly_equivalent is null), then by name
                        filtered.sort((a, b) => {
                            const aNotSet = a.hourly_equivalent === null;
                            const bNotSet = b.hourly_equivalent === null;
                            if (aNotSet && !bNotSet) return -1;
                            if (!aNotSet && bNotSet) return 1;
                            return a.name.localeCompare(b.name);
                        });
                        break;
                    case 'hourly_asc':
                        filtered.sort((a, b) => {
                            const aHourly = parseFloat(a.hourly_equivalent || a.pay_rate || 13);
                            const bHourly = parseFloat(b.hourly_equivalent || b.pay_rate || 13);
                            return aHourly - bHourly;
                        });
                        break;
                    case 'hourly_desc':
                        filtered.sort((a, b) => {
                            const aHourly = parseFloat(a.hourly_equivalent || a.pay_rate || 13);
                            const bHourly = parseFloat(b.hourly_equivalent || b.pay_rate || 13);
                            return bHourly - aHourly;
                        });
                        break;
                }
                
                displayPayratesTable(filtered);
            };

            window.toggleHourlySort = function() {
                hourlySortAsc = !hourlySortAsc;
                document.getElementById('payrateSortBy').value = hourlySortAsc ? 'hourly_asc' : 'hourly_desc';
                displayFilteredPayrates();
            };

            window.displayPayratesTable = function(payrates) {
                const tbody = document.getElementById('payrateTableBody');
                const noResults = document.getElementById('payrateNoResults');

                if (!tbody) return;

                if (payrates.length === 0) {
                    tbody.style.display = 'none';
                    if (noResults) noResults.style.display = 'block';
                    return;
                }

                tbody.style.display = '';
                if (noResults) noResults.style.display = 'none';

                tbody.innerHTML = payrates.map(emp => {
                    // Check if rate is not set (no record in employee_payrates table)
                    const isNotSet = emp.hourly_equivalent === null;
                    const payRate = parseFloat(emp.pay_rate) || 13;
                    const hourlyRate = emp.pay_type === 'salary' ? payRate / 26 / 8 : payRate;
                    const displayHourly = emp.hourly_equivalent !== null ? parseFloat(emp.hourly_equivalent) : hourlyRate;

                    const rowStyle = isNotSet ? 'background: rgba(251, 191, 36, 0.1);' : '';
                    const typeLabel = emp.pay_type === 'salary' ? 'Salary' : 'Hourly';
                    const rateLabel = emp.pay_type === 'salary' ? `$${payRate.toLocaleString()}/mo` : `$${payRate.toFixed(2)}/hr`;

                    return `
                        <tr id="payrate-row-${emp.id}" style="${rowStyle}">
                            <td style="padding: 12px; font-weight: 500;">
                                ${emp.name}
                                ${isNotSet ? '<span style="color: #fbbf24; margin-left: 8px; font-size: 0.8em;">(default $13)</span>' : ''}
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span id="paytype-display-${emp.id}">${typeLabel}</span>
                                <select id="paytype-edit-${emp.id}" style="display: none; background: #1a1a2e; color: #e0e0e0; border: 1px solid #667eea; padding: 6px 10px; border-radius: 6px;">
                                    <option value="hourly" ${emp.pay_type === 'hourly' ? 'selected' : ''}>Hourly</option>
                                    <option value="salary" ${emp.pay_type === 'salary' ? 'selected' : ''}>Salary</option>
                                </select>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span id="payrate-display-${emp.id}" style="font-weight: 600; color: ${isNotSet ? '#fbbf24' : '#e0e0e0'};">${rateLabel}</span>
                                <div id="payrate-edit-${emp.id}" style="display: none;">
                                    <input type="number" id="payrate-input-${emp.id}" value="${payRate}"
                                        step="0.01" min="0"
                                        style="width: 100px; background: #1a1a2e; color: #e0e0e0; border: 1px solid #667eea; padding: 6px 10px; border-radius: 6px; text-align: right;">
                                    <span id="payrate-unit-${emp.id}" style="margin-left: 4px; color: #808080;">${emp.pay_type === 'salary' ? '/mo' : '/hr'}</span>
                                </div>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="font-size: 1.1em; font-weight: 600; color: #667eea;">$${displayHourly.toFixed(2)}</span>
                                <span style="color: #808080; font-size: 0.85em;">/hr</span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button id="edit-btn-${emp.id}" onclick="enterEditMode(${emp.id})"
                                    style="padding: 6px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px;">
                                    Edit
                                </button>
                                <button id="save-btn-${emp.id}" onclick="savePayrate(${emp.id})"
                                    style="display: none; padding: 6px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 5px;">
                                    Save
                                </button>
                                <button id="cancel-btn-${emp.id}" onclick="cancelEditMode(${emp.id})"
                                    style="display: none; padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Cancel
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Show count of employees without rates set
                const notSetCount = payrates.filter(emp => emp.hourly_equivalent === null).length;
                const container = tbody.parentElement.parentElement;
                const existingAlert = container.querySelector('.no-rate-alert');
                if (existingAlert) existingAlert.remove();

                if (notSetCount > 0) {
                    const alertDiv = document.createElement('div');
                    alertDiv.style.cssText = 'padding: 12px; background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 8px; margin-top: 15px;';
                    alertDiv.innerHTML = `<i class="fas fa-info-circle" style="color: #fbbf24; margin-right: 10px;"></i><strong>${notSetCount} employees</strong> using default rate ($13/hr). Click Edit to set their actual rate.`;
                    alertDiv.className = 'no-rate-alert';
                    container.appendChild(alertDiv);
                }
            };

            // Enter edit mode for a payrate row
            window.enterEditMode = function(empId) {
                // Hide display elements, show edit elements
                document.getElementById(`paytype-display-${empId}`).style.display = 'none';
                document.getElementById(`paytype-edit-${empId}`).style.display = 'inline-block';
                document.getElementById(`payrate-display-${empId}`).style.display = 'none';
                document.getElementById(`payrate-edit-${empId}`).style.display = 'inline-block';
                document.getElementById(`edit-btn-${empId}`).style.display = 'none';
                document.getElementById(`save-btn-${empId}`).style.display = 'inline-block';
                document.getElementById(`cancel-btn-${empId}`).style.display = 'inline-block';

                // Update unit label when type changes
                document.getElementById(`paytype-edit-${empId}`).onchange = function() {
                    const unit = this.value === 'salary' ? '/mo' : '/hr';
                    document.getElementById(`payrate-unit-${empId}`).textContent = unit;
                };

                // Highlight the row
                document.getElementById(`payrate-row-${empId}`).style.background = 'rgba(102, 126, 234, 0.15)';
            };

            // Cancel edit mode
            window.cancelEditMode = function(empId) {
                loadPayratesData(); // Reload to reset values
            };

            window.filterPayrates = function() {
                displayFilteredPayrates();
            };

            window.sortPayrates = function() {
                displayFilteredPayrates();
            };

            window.savePayrate = async function(employeeId) {
                const payType = document.getElementById(`paytype-edit-${employeeId}`).value;
                const payRate = document.getElementById(`payrate-input-${employeeId}`).value;

                // Disable save button and show loading
                const saveBtn = document.getElementById(`save-btn-${employeeId}`);
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                try {
                    const response = await fetch(`${API_BASE}/api/dashboard/employees/${employeeId}/payrate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({
                            pay_rate: parseFloat(payRate),
                            pay_type: payType,
                            notes: ''
                        })
                    });

                    if (response.ok) {
                        // Show success feedback
                        const row = document.getElementById(`payrate-row-${employeeId}`);
                        row.style.background = 'rgba(34, 197, 94, 0.2)';
                        saveBtn.textContent = 'Saved!';
                        saveBtn.style.background = '#16a34a';
                        setTimeout(() => {
                            loadPayratesData(); // Reload to show updated values
                        }, 800);
                    } else {
                        await alertDialog('Error', 'Error saving payrate');
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save';
                    }
                } catch (error) {
                    await alertDialog('Error', 'Failed to save payrate');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            };
            window.loadArchivedEmployees = async function() {
                try {
                    const response = await fetch(`${API_BASE}/api/dashboard/employees/archived`, {
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        displayArchivedTable(data.archived);
                    }
                } catch (error) {
                    console.error('Error loading archived employees:', error);
                }
            };

            window.displayArchivedTable = function(archived) {
                const tbody = document.getElementById('archivedTableBody');
                if (!tbody) return;
                
                if (!archived || archived.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #808080;">No archived employees</td></tr>';
                    return;
                }
                
                tbody.innerHTML = archived.map(emp => `
                    <tr>
                        <td style="padding: 12px;">${emp.name}</td>
                        <td style="padding: 12px;">${emp.email || '-'}</td>
                        <td style="padding: 12px;">${new Date(emp.archived_at).toLocaleDateString()}</td>
                        <td style="padding: 12px;">
                            <button onclick="restoreEmployee(${emp.id}, '${emp.name.replace(/'/g, "\\'")}')" style="padding: 5px 10px; background: #27ae60; color: white; border: none; border-radius: 5px;">Restore</button>
                        </td>
                    </tr>
                `).join('');
            };

            window.restoreEmployee = async function(id, name) {
                const confirmed = await confirmDialog('Restore Employee', `Restore ${name} to active employees?`);
                if (!confirmed) return;

                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
                btn.disabled = true;

                try {
                    const response = await fetch(`${API_BASE}/api/dashboard/employees/${id}/restore`, {
                        method: 'POST',
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });

                    if (response.ok) {
                        await alertDialog('Success', 'Employee restored successfully');
                        loadArchivedEmployees();
                        loadEmployeeManagementData();
                    } else {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    await alertDialog('Error', 'Failed to restore employee');
                }
            };

            window.archiveEmployee = async function(id, name) {
                const confirmed = await confirmDialog('Archive Employee', `Are you sure you want to archive ${name}? They will be hidden from all active views.`, { type: 'warning' });
                if (!confirmed) return;

                // Close dropdown and show loading overlay
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => d.style.display = 'none');
                showLoadingOverlay('Archiving employee...');

                try {
                    const response = await fetch(`${API_BASE}/api/dashboard/employees/${id}/archive`, {
                        method: 'POST',
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });

                    const data = await response.json();
                    hideLoadingOverlay();
                    if (data.success) {
                        await alertDialog('Success', 'Employee archived successfully');
                        loadEmployeeManagementData();
                    } else {
                        await alertDialog('Error', 'Error: ' + data.error);
                    }
                } catch (error) {
                    hideLoadingOverlay();
                    await alertDialog('Error', 'Failed to archive employee');
                }
            };

            // ============================================
            // PIN MANAGEMENT
            // ============================================

            // View employee PIN (quick view from table)
            window.viewEmployeePin = function(employeeId, employeeName, pin) {
                const modal = document.createElement('div');
                modal.id = 'viewPinModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                modal.innerHTML = `
                    <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; width: 350px; max-width: 90%; text-align: center;">
                        <h3 style="color: #e0e0e0; margin-bottom: 10px;">
                            <i class="fas fa-key" style="color: #6366f1;"></i> PIN for ${employeeName}
                        </h3>
                        <div style="font-size: 36px; font-family: monospace; font-weight: bold; letter-spacing: 8px; padding: 20px; background: rgba(99,102,241,0.1); border-radius: 8px; color: #6366f1; margin: 20px 0;">
                            ${pin || 'N/A'}
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                            <button onclick="document.getElementById('viewPinModal').remove(); openSetPinModal(${employeeId}, '${employeeName.replace(/'/g, "\\'")}');" style="padding: 10px 20px; background: #4b5563; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-edit"></i> Manage
                            </button>
                            <button onclick="document.getElementById('viewPinModal').remove();" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            };

            window.openSetPinModal = function(employeeId, employeeName) {
                const modal = `
                    <div id="pinModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: #2a2a2a; padding: 30px; border-radius: 12px; width: 400px; max-width: 90%;">
                            <h3 style="color: #e0e0e0; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-key" style="color: #6366f1;"></i>
                                Set PIN for ${employeeName}
                            </h3>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; color: #a0a0a0; font-size: 0.9em;">
                                    PIN (4-6 digits) - Leave empty for auto-generated
                                </label>
                                <input type="password" id="pinInput" maxlength="6" pattern="[0-9]*" inputmode="numeric"
                                       placeholder="Enter PIN or leave empty"
                                       style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 1.1em; text-align: center; letter-spacing: 8px;">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="document.getElementById('pinModal').remove()"
                                        style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    Cancel
                                </button>
                                <button onclick="setEmployeePin(${employeeId}, '${employeeName.replace(/'/g, "\\'")}')"
                                        style="flex: 1; padding: 12px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-check"></i> Set PIN
                                </button>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <button onclick="resetEmployeePin(${employeeId}, '${employeeName.replace(/'/g, "\\'")}')"
                                        style="width: 100%; padding: 10px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-sync-alt"></i> Reset to Random PIN
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
                document.getElementById('pinInput').focus();
            };

            window.setEmployeePin = async function(employeeId, employeeName) {
                const pin = document.getElementById('pinInput').value;

                // Validate PIN if provided
                if (pin && !/^\d{4,6}$/.test(pin)) {
                    await alertDialog('Invalid PIN', 'PIN must be 4-6 digits');
                    return;
                }

                // Show loading state
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting...';
                btn.disabled = true;

                try {
                    const body = pin ? { pin } : {};
                    const response = await fetch(`${API_BASE}/api/admin/employees/${employeeId}/set-pin`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify(body)
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('pinModal').remove();
                        showPinSlip(employeeName, data.pin);
                    } else {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        await alertDialog('Error', data.error || 'Failed to set PIN');
                    }
                } catch (error) {
                    console.error('Error setting PIN:', error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    await alertDialog('Error', 'Failed to set PIN: ' + error.message);
                }
            };

            window.resetEmployeePin = async function(employeeId, employeeName) {
                // Close PIN modal FIRST before showing confirmation
                const pinModal = document.getElementById('pinModal');
                if (pinModal) pinModal.remove();

                const confirmed = await confirmDialog('Reset PIN', `Reset PIN for ${employeeName}? A new random PIN will be generated.`);
                if (!confirmed) return;

                // Show loading overlay
                showLoadingOverlay('Generating new PIN...');

                try {
                    const response = await fetch(`${API_BASE}/api/admin/employees/${employeeId}/reset-pin`, {
                        method: 'POST',
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });

                    const data = await response.json();
                    hideLoadingOverlay();
                    if (data.success) {
                        showPinSlip(employeeName, data.pin);
                    } else {
                        await alertDialog('Error', data.error || 'Failed to reset PIN');
                    }
                } catch (error) {
                    console.error('Error resetting PIN:', error);
                    hideLoadingOverlay();
                    await alertDialog('Error', 'Failed to reset PIN: ' + error.message);
                }
            };

            window.showPinSlip = function(employeeName, pin) {
                const modal = `
                    <div id="pinSlipModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center;">
                        <div style="background: #2a2a2a; padding: 40px; border-radius: 12px; width: 320px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="color: #a0a0a0; font-size: 0.85em; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">
                                Employee PIN Slip
                            </div>
                            <div style="color: #e0e0e0; font-size: 1.2em; font-weight: 600; margin-bottom: 20px;">
                                ${employeeName}
                            </div>
                            <div style="background: rgba(99, 102, 241, 0.15); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(99, 102, 241, 0.3);">
                                <div style="color: #a0a0a0; font-size: 0.8em; margin-bottom: 5px;">PIN</div>
                                <div style="font-family: monospace; font-size: 2.5em; font-weight: 700; color: #6366f1; letter-spacing: 8px;">
                                    ${pin}
                                </div>
                            </div>
                            <div style="color: #f59e0b; font-size: 0.8em; margin-bottom: 20px;">
                                ‚ö†Ô∏è This PIN will only be shown once!
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="printPinSlip('${employeeName}', '${pin}')"
                                        style="flex: 1; padding: 12px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-print"></i> Print
                                </button>
                                <button onclick="document.getElementById('pinSlipModal').remove()"
                                        style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
            }

            window.printPinSlip = function(employeeName, pin) {
                const printWindow = window.open('', '_blank', 'width=400,height=400');
                if (!printWindow) {
                    alertDialog('Popup Blocked', 'Please allow popups for this site to print the PIN slip.');
                    return;
                }
                printWindow.document.write(`
                    <html>
                    <head><title>PIN Slip - ${employeeName}</title></head>
                    <body style="font-family: Arial, sans-serif; padding: 40px; text-align: center;">
                        <h3 style="color: #666; margin-bottom: 5px;">EMPLOYEE PIN SLIP</h3>
                        <h2 style="margin: 10px 0;">${employeeName}</h2>
                        <div style="font-size: 48px; font-family: monospace; font-weight: bold; letter-spacing: 10px; padding: 20px; background: #f0f0f0; margin: 20px 0;">
                            ${pin}
                        </div>
                        <p style="color: #999; font-size: 12px;">Keep this PIN secure. Do not share with others.</p>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            }

            window.editEmployee = async function(id) {
                await alertDialog('Coming Soon', 'Edit employee ' + id + ' - To be implemented');
            };

            window.mapEmployee = async function(id) {
                // Get employee details
                const row = Array.from(document.querySelectorAll('#employeeTableBody tr')).find(r => r.querySelector('td').textContent == id);
                const employeeName = row.querySelectorAll('td')[1].textContent;

                // Fetch unmapped PodFactory emails and Connecteam users (cached)
                const unmappedData = await getUnmappedUsers();
                
                const modal = `
                    <div id="mappingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: #2a2a2a; padding: 30px; border-radius: 10px; width: 700px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="color: #e0e0e0; margin-bottom: 20px;">Map ${employeeName}</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="color: #667eea;">Select Connecteam User:</h4>
                                    <input type="text" id="connecteamSearch" placeholder="Search by name..." style="width: 100%; padding: 8px; margin-bottom: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px;" onkeyup="filterConnecteamList()">
                                    <div id="connecteamList" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; padding: 10px;">
                                        ${unmappedData.connecteam_users.map(user => `
                                            <label style="display: block; padding: 8px; cursor: pointer; color: #e0e0e0;">
                                                <input type="radio" name="connecteamUser" value="${user.connecteam_id}" data-name="${user.name}">
                                                ${user.name} (${user.connecteam_id})
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 style="color: #9b59b6;">Select PodFactory Emails:</h4>
                                    <input type="text" id="podfactorySearch" placeholder="Search emails..." style="width: 100%; padding: 8px; margin-bottom: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px;" onkeyup="filterPodfactoryList()">
                                    <div id="podfactoryList" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; padding: 10px;">
                                        ${unmappedData.podfactory_emails.map(email => `
                                            <label style="display: block; padding: 8px; cursor: pointer; color: #e0e0e0;">
                                                <input type="checkbox" name="podfactoryEmail" value="${email}">
                                                ${email}
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="document.getElementById('mappingModal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                                <button onclick="saveSmartMapping(${id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Mapping</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
            };

            // Helper function to calculate name similarity (Dice coefficient)
            function calculateNameSimilarity(name1, name2) {
                const normalize = (s) => s.toLowerCase().replace(/[^a-z\s]/g, '').trim();
                const n1 = normalize(name1);
                const n2 = normalize(name2);

                if (n1 === n2) return 1.0;
                if (n1.includes(n2) || n2.includes(n1)) return 0.9;

                // Dice coefficient for bigrams
                const getBigrams = (s) => {
                    const bigrams = new Set();
                    for (let i = 0; i < s.length - 1; i++) {
                        bigrams.add(s.substring(i, i + 2));
                    }
                    return bigrams;
                };

                const bigrams1 = getBigrams(n1);
                const bigrams2 = getBigrams(n2);
                let intersection = 0;
                bigrams1.forEach(b => { if (bigrams2.has(b)) intersection++; });

                return (2 * intersection) / (bigrams1.size + bigrams2.size) || 0;
            }

            // Smart mapping modal with name recommendations
            window.openSmartMapping = async function(employeeId, employeeName) {
                // Fetch Connecteam users (cached)
                const unmappedData = await getUnmappedUsers();

                // Calculate similarity scores and sort
                const usersWithScores = unmappedData.connecteam_users.map(user => ({
                    ...user,
                    similarity: calculateNameSimilarity(employeeName, user.name)
                })).sort((a, b) => b.similarity - a.similarity);

                // Find best match - always show top match with confidence level
                const bestMatch = usersWithScores[0];
                const hasBestMatch = bestMatch && usersWithScores.length > 0;

                // Determine confidence level and styling
                const getConfidenceInfo = (similarity) => {
                    if (similarity >= 0.5) return { label: 'HIGH CONFIDENCE', color: '#28a745', bgColor: 'rgba(40, 167, 69, 0.15)', borderColor: 'rgba(40, 167, 69, 0.4)' };
                    if (similarity >= 0.2) return { label: 'POSSIBLE MATCH', color: '#ffc107', bgColor: 'rgba(255, 193, 7, 0.15)', borderColor: 'rgba(255, 193, 7, 0.4)' };
                    return { label: 'BEST AVAILABLE', color: '#6c757d', bgColor: 'rgba(108, 117, 125, 0.15)', borderColor: 'rgba(108, 117, 125, 0.4)' };
                };
                const confidence = bestMatch ? getConfidenceInfo(bestMatch.similarity) : null;

                const modal = `
                    <div id="smartMappingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: #2a2a2a; padding: 30px; border-radius: 10px; width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="color: #e0e0e0; margin-bottom: 10px;">
                                <i class="fas fa-link" style="color: #667eea;"></i> Link "${employeeName}" to Connecteam
                            </h3>

                            ${hasBestMatch ? `
                                <div style="background: ${confidence.bgColor}; border: 1px solid ${confidence.borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="background: ${confidence.color}; color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600;">
                                            ${confidence.label}
                                        </span>
                                        <span style="color: #a0a0a0; font-size: 0.85em;">
                                            ${Math.round(bestMatch.similarity * 100)}% match
                                        </span>
                                    </div>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #e0e0e0;">
                                        <input type="radio" name="connecteamUserSmart" value="${bestMatch.connecteam_id}" checked style="width: 18px; height: 18px;">
                                        <span style="font-size: 1.1em; font-weight: 500;">${bestMatch.name}</span>
                                        <span style="color: #808080; font-size: 0.9em;">(ID: ${bestMatch.connecteam_id})</span>
                                    </label>
                                </div>
                            ` : ''}

                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #667eea; margin-bottom: 10px;">
                                    ${hasBestMatch ? 'Or choose a different user:' : 'Select Connecteam User:'}
                                </h4>
                                <input type="text" id="smartConnecteamSearch" placeholder="Search by name..."
                                       style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; margin-bottom: 10px;"
                                       onkeyup="filterSmartConnecteamList()">
                                <div id="smartConnecteamList" style="max-height: 250px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px;">
                                    ${usersWithScores.slice(hasBestMatch ? 1 : 0).map(user => `
                                        <label style="display: flex; justify-content: space-between; align-items: center; padding: 10px; cursor: pointer; color: #e0e0e0; border-bottom: 1px solid rgba(255,255,255,0.1);" class="connecteam-option">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <input type="radio" name="connecteamUserSmart" value="${user.connecteam_id}">
                                                <span>${user.name}</span>
                                            </div>
                                            <span style="color: #808080; font-size: 0.85em;">${Math.round(user.similarity * 100)}%</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button onclick="document.getElementById('smartMappingModal').remove()"
                                        style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Cancel
                                </button>
                                <button onclick="saveSmartMappingConnecteam(${employeeId})"
                                        style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">
                                    <i class="fas fa-check"></i> Link to Connecteam
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
            };

            window.filterSmartConnecteamList = function() {
                const search = document.getElementById('smartConnecteamSearch').value.toLowerCase();
                document.querySelectorAll('#smartConnecteamList label').forEach(label => {
                    label.style.display = label.textContent.toLowerCase().includes(search) ? 'flex' : 'none';
                });
            };

            window.saveSmartMappingConnecteam = async function(employeeId) {
                const selected = document.querySelector('input[name="connecteamUserSmart"]:checked');

                if (!selected) {
                    await alertDialog('Selection Required', 'Please select a Connecteam user');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/dashboard/employees/${employeeId}/mapping`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({
                            connecteam_user_id: selected.value
                        })
                    });

                    if (response.ok) {
                        invalidateUnmappedUsersCache(); // Clear cache after mapping change
                        await alertDialog('Success', 'Employee linked to Connecteam successfully!');
                        document.getElementById('smartMappingModal').remove();
                        loadNeedsAttention();
                        loadEmployeeManagementData();
                    } else {
                        await alertDialog('Error', 'Failed to link employee');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    await alertDialog('Error', 'Error linking employee: ' + error.message);
                }
            };

            window.filterConnecteamList = function() {
                const search = document.getElementById('connecteamSearch').value.toLowerCase();
                document.querySelectorAll('#connecteamList label').forEach(label => {
                    label.style.display = label.textContent.toLowerCase().includes(search) ? 'block' : 'none';
                });
            };

            window.filterPodfactoryList = function() {
                const search = document.getElementById('podfactorySearch').value.toLowerCase();
                document.querySelectorAll('#podfactoryList label').forEach(label => {
                    label.style.display = label.textContent.toLowerCase().includes(search) ? 'block' : 'none';
                });
            };

            window.saveSmartMapping = async function(employeeId) {
                const connecteamUser = document.querySelector('input[name="connecteamUser"]:checked');
                const podfactoryEmails = Array.from(document.querySelectorAll('input[name="podfactoryEmail"]:checked')).map(cb => cb.value);

                if (!connecteamUser) {
                    await alertDialog('Selection Required', 'Please select a Connecteam user');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/dashboard/employees/${employeeId}/mapping`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({
                            connecteam_user_id: connecteamUser.value,
                            podfactory_emails: podfactoryEmails.join(',')
                        })
                    });

                    if (response.ok) {
                        invalidateUnmappedUsersCache(); // Clear cache after mapping change
                        await alertDialog('Success', 'Mapping saved successfully!');
                        document.getElementById('mappingModal').remove();
                        window.loadEmployeeManagementData();
                    } else {
                        await alertDialog('Error', 'Error saving mapping');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    await alertDialog('Error', 'Error saving mapping');
                }
            };

            window.exportEmployeePins = async function() {
                showLoadingOverlay('Exporting employee PINs...');

                try {
                    const response = await fetch(`${API_BASE}/api/admin/employees/export-pins`, {
                        headers: { 'X-API-Key': 'dev-api-key-123' }
                    });

                    hideLoadingOverlay();

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `employee_pins_${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                        showNotification('PINs exported successfully', 'success');
                    } else {
                        await alertDialog('Error', 'Failed to export PINs');
                    }
                } catch (error) {
                    hideLoadingOverlay();
                    console.error('Export error:', error);
                    await alertDialog('Error', 'Error exporting PINs: ' + error.message);
                }
            };

            window.syncWithConnecteam = async function() {
                const confirmed = await confirmDialog('Sync Connecteam', 'Sync all employees from Connecteam? This may take a moment.');
                if (!confirmed) return;

                showLoadingOverlay('Syncing with Connecteam...');

                try {
                    const response = await fetch(`${API_BASE}/api/connecteam/sync/employees`, {
                        method: 'POST',
                        headers: {'X-API-Key': 'dev-api-key-123'}
                    });

                    hideLoadingOverlay();
                    if (response.ok) {
                        const result = await response.json();
                        await alertDialog('Sync Complete', `Updated: ${result.stats.updated}, Created: ${result.stats.created}`);
                        window.loadEmployeeManagementData();
                    } else {
                        await alertDialog('Error', 'Sync failed');
                    }
                } catch (error) {
                    hideLoadingOverlay();
                    await alertDialog('Error', 'Error syncing with Connecteam');
                }
            };

            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
            });

            // Date filter functions - Make them globally accessible
            window.setDateRange = function(range) {
                const today = api.getCentralDate();
                const startDate = document.getElementById('startDate');
                const endDate = document.getElementById('endDate');
                
                endDate.value = today;
                
                switch(range) {
                    case 'today':
                        startDate.value = today;
                        break;
                    case 'week':
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        startDate.value = weekAgo.toISOString().split('T')[0];
                        break;
                    case 'month':
                        const monthAgo = new Date();
                        monthAgo.setDate(monthAgo.getDate() - 30);
                        startDate.value = monthAgo.toISOString().split('T')[0];
                        break;
                }
                
                // Auto-apply when using quick buttons
                applyDateFilter();
            };

            window.applyDateFilter = async function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (!startDate || !endDate) {
                    await alertDialog('Invalid Date Range', 'Please select both start and end dates');
                    return;
                }

                if (startDate > endDate) {
                    await alertDialog('Invalid Date Range', 'Start date must be before end date');
                    return;
                }
                
                console.log('Applying date filter:', startDate, 'to', endDate);
                
                // Update the dashboard title to show date range
                const titleElement = document.querySelector('.dashboard-title p');
                if (startDate === endDate) {
                    titleElement.textContent = `Data for ${new Date(startDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
                } else {
                    titleElement.textContent = `Data from ${new Date(startDate + 'T12:00:00').toLocaleDateString()} to ${new Date(endDate + 'T12:00:00').toLocaleDateString()}`;
                }
                
                // Store the date range
                dashboardData.startDate = startDate;
                dashboardData.endDate = endDate;
                
                // Check which section is currently active and reload its data
                const costSection = document.getElementById('cost-section');
                const bottleneckSection = document.getElementById('bottleneck-section');
                const dashboardSection = document.getElementById('dashboard-section');
                
                if (costSection && costSection.classList.contains('active')) {
                    console.log('Cost Analysis tab is active, reloading cost data...');
                    loadCostAnalysisData();  // This will now use the selected date
                } else if (bottleneckSection && bottleneckSection.classList.contains('active')) {
                    console.log('Bottleneck tab is active, reloading bottleneck data...');
                    loadBottleneckData();
                } else if (dashboardSection && dashboardSection.classList.contains('active')) {
                    console.log('Dashboard tab is active, reloading dashboard data...');
                    loadDashboardDataForDateRange(startDate, endDate);
                }
            };
            // Tab loading helpers
            function showTabLoading(text = 'Loading...') {
                const overlay = document.getElementById('tabLoadingOverlay');
                if (overlay) {
                    overlay.querySelector('.tab-loading-text').textContent = text;
                    overlay.classList.add('active');
                }
            }

            function hideTabLoading() {
                const overlay = document.getElementById('tabLoadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                }
            }

            // Make showSection globally accessible
            window.showSection = function(sectionName) {
                // Save current tab to localStorage
                localStorage.setItem('managerActiveTab', sectionName);

                // Show loading spinner
                const sectionLabels = {
                    'dashboard': 'Loading Dashboard...',
                    'bottleneck': 'Analyzing Bottlenecks...',
                    'cost': 'Loading Cost Analysis...'
                };
                showTabLoading(sectionLabels[sectionName] || 'Loading...');

                // Hide all sections
                document.querySelectorAll('.section-content').forEach(section => {
                    section.classList.remove('active');
                });

                // Remove active from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Show selected section
                const targetSection = document.getElementById(`${sectionName}-section`);
                if (targetSection) {
                    targetSection.classList.add('active');
                }

                // Mark nav item as active (find by section name or use event.target)
                const navSectionMap = {
                    'dashboard': 0,
                    'bottleneck': 1,
                    'cost': 2,
                    'employee-management': 3
                };
                const sidebarNavItems = document.querySelectorAll('.sidebar .nav-item');
                if (navSectionMap[sectionName] !== undefined && sidebarNavItems[navSectionMap[sectionName]]) {
                    sidebarNavItems[navSectionMap[sectionName]].classList.add('active');
                } else if (event && event.target) {
                    const navItem = event.target.closest('.nav-item');
                    if (navItem) {
                        navItem.classList.add('active');
                    }
                }

                // Update mobile bottom nav active state
                document.querySelectorAll('.mobile-bottom-nav__item').forEach(item => {
                    item.classList.remove('active');
                });
                const sectionMap = { 'dashboard': 0, 'bottleneck': 1, 'cost': 2 };
                const bottomNavItems = document.querySelectorAll('.mobile-bottom-nav__item');
                if (sectionMap[sectionName] !== undefined && bottomNavItems[sectionMap[sectionName]]) {
                    bottomNavItems[sectionMap[sectionName]].classList.add('active');
                }

                // Load data based on section (with loading spinner)
                if (sectionName === 'bottleneck') {
                    loadBottleneckData().finally(() => hideTabLoading());
                } else if (sectionName === 'cost') {
                    loadCostAnalysisData().finally(() => hideTabLoading());
                } else {
                    // For dashboard, hide after a short delay
                    setTimeout(() => hideTabLoading(), 300);
                }
            }
            // Modified load function for date ranges
            window.loadDashboardDataForDateRange = async function(startDate, endDate) {
                try {
                    showLoadingStates();
                    
                    // For single day, use existing endpoints
                    if (startDate === endDate) {
                        const leaderboard = await api.getLeaderboard(startDate);
                        const departmentStats = await api.getDepartmentStats(startDate);
                        let teamMetrics = {};
                        
                        try {
                            // Try to get team metrics for specific date
                            teamMetrics = await api.getTeamMetrics(startDate);
                        } catch (error) {
                            console.error('Team metrics failed:', error);
                            // Calculate from leaderboard if team metrics fails
                            const activeEmployees = leaderboard.filter(e => e.is_clocked_in).length;
                            const totalItems = leaderboard.reduce((sum, emp) => sum + (emp.items_today || 0), 0);
                            teamMetrics = {
                                active_employees: activeEmployees,
                                total_employees_today: leaderboard.length,
                                items_today: totalItems,
                                overall_efficiency: 0,
                                total_hours_worked: leaderboard.reduce((sum, emp) => {
                                    const minutes = parseInt(emp.total_minutes || 0);
                                    return sum + (minutes / 60);
                                }, 0).toFixed(1),
                                vs_yesterday: 0
                            };
                        }
                        
                        dashboardData = {
                            leaderboard,
                            departmentStats,
                            teamMetrics,
                            currentDate: startDate
                        };
                        
                        updateMetrics(leaderboard, teamMetrics);
                        updateDepartmentCards(departmentStats);
                        updateActivityFeed([]); // Clear activity feed for historical dates
                        
                        // Update alerts for historical view
                        if (startDate !== api.getCentralDate()) {
                            document.getElementById('alertsContainer').innerHTML = `
                                <div class="alert-item" style="background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.2);">
                                    <i class="fas fa-calendar-alt alert-icon" style="color: #667eea;"></i>
                                    <div class="alert-content">
                                        <div class="alert-title" style="color: #667eea;">Historical Data</div>
                                        <div class="alert-message">Viewing data for ${new Date(startDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                    } else {
                        // Date range view - use new aggregated endpoint
                        try {
                            const rangeData = await api.getLeaderboardRange(startDate, endDate);
                            
                            // Update UI for range view
                            updateDateRangeView(rangeData);
                        } catch (error) {
                            console.error('Error loading date range:', error);
                            document.getElementById('alertsContainer').innerHTML = `
                                <div class="alert-item">
                                    <i class="fas fa-exclamation-triangle alert-icon"></i>
                                    <div class="alert-content">
                                        <div class="alert-title">Error Loading Date Range</div>
                                        <div class="alert-message">Failed to load date range data. Please try again.</div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                } catch (error) {
                    console.error('Error loading date range data:', error);
                    showErrorState();
                }
            };

            function updateDateRangeView(rangeData) {
                const summary = rangeData.summary || {};
                const totalDays = rangeData.date_range.days;

                // Update the alert to show date range mode (no live overlay)
                document.getElementById('alertsContainer').innerHTML = `
                    <div class="alert-item" style="background: rgba(102, 126, 234, 0.1); border-color: rgba(102, 126, 234, 0.2);">
                        <i class="fas fa-calendar-alt alert-icon" style="color: #667eea;"></i>
                        <div class="alert-content">
                            <div class="alert-title" style="color: #667eea;">Date Range Summary</div>
                            <div class="alert-message">Viewing ${totalDays}-day summary (${new Date(rangeData.date_range.start + 'T12:00:00').toLocaleDateString()} to ${new Date(rangeData.date_range.end + 'T12:00:00').toLocaleDateString()})</div>
                        </div>
                    </div>
                `;

                // Card 1: Avg employees/day / Total employees (clocked in)
                document.getElementById('activeEmployees').innerHTML = `
                    <span style="font-size: 1.8em;">${summary.avg_employees_per_day || 0}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">/${summary.total_employees || 0}</span>
                `;
                document.querySelector('#activeEmployees').nextElementSibling.textContent = 'Avg/Day / Total Employees';
                // Hide change indicator
                const empChange = document.getElementById('activeEmployeesChange');
                if (empChange) empChange.style.display = 'none';

                // Card 2: Avg items/day / Total QC passed items
                document.getElementById('itemsProcessed').innerHTML = `
                    <span style="font-size: 1.8em;">${(summary.avg_items_per_day || 0).toLocaleString()}</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">/${(summary.total_items || 0).toLocaleString()}</span>
                `;
                document.querySelector('#itemsProcessed').nextElementSibling.textContent = 'Avg/Day / Total Items';
                // Hide change indicator
                const itemsChange = document.getElementById('itemsProcessedChange');
                if (itemsChange) itemsChange.style.display = 'none';

                // Card 3: Avg efficiency during range
                document.getElementById('overallEfficiency').innerHTML = `
                    <span style="font-size: 1.8em;">${summary.avg_efficiency || 0}%</span>
                `;
                document.querySelector('#overallEfficiency').nextElementSibling.textContent = 'Avg Efficiency';
                // Hide change indicator
                const effChange = document.getElementById('overallEfficiencyChange');
                if (effChange) effChange.style.display = 'none';

                // Card 4: Days in range
                document.getElementById('totalHours').textContent = totalDays;
                document.querySelector('#totalHours').nextElementSibling.textContent = 'Days in Range';
                // Hide change indicator
                const hoursChange = document.getElementById('totalHoursChange');
                if (hoursChange) hoursChange.style.display = 'none';
                
                // Update department grid with enhanced view
                const container = document.getElementById('departmentGrid');
                container.innerHTML = `
                    <div class="col-12">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Performance Analysis (${rangeData.date_range.start} to ${rangeData.date_range.end})</h3>
                            <div style="display: flex; gap: 10px;">
                                <span class="badge" style="background: #667eea; padding: 8px 16px; border-radius: 20px;">
                                    ${rangeData.date_range.days} Days
                                </span>
                                <span class="badge" style="background: #34d399; padding: 8px 16px; border-radius: 20px;">
                                    ${rangeData.leaderboard.length} Employees
                                </span>
                                <span class="badge" style="background: #fbbf24; padding: 8px 16px; border-radius: 20px;">
                                    ${(summary.total_items || 0).toLocaleString()} Total Items
                                </span>
                            </div>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; color: #e0e0e0; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid rgba(255,255,255,0.2);">
                                        <th style="padding: 12px; text-align: left;">Rank</th>
                                        <th style="padding: 12px; text-align: left;">Employee</th>
                                        <th style="padding: 12px; text-align: center;">Days</th>
                                        <th style="padding: 12px; text-align: center;">Total Items</th>
                                        <th style="padding: 12px; text-align: center;">Daily Avg</th>
                                        <th style="padding: 12px; text-align: center;">Best Day</th>
                                        <th style="padding: 12px; text-align: center;">Today</th>
                                        <th style="padding: 12px; text-align: center;">Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="rangeTableBody">
                                    ${rangeData.leaderboard.map((emp, index) => {
                                        return `
                                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                <td style="padding: 12px;">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : index + 1}</td>
                                                <td style="padding: 12px; font-weight: 600;">${emp.name}</td>
                                                <td style="padding: 12px; text-align: center;">${emp.days_worked}</td>
                                                <td style="padding: 12px; text-align: center; font-weight: 600; color: #667eea;">${emp.total_items.toLocaleString()}</td>
                                                <td style="padding: 12px; text-align: center;">${emp.avg_daily_items}</td>
                                                <td style="padding: 12px; text-align: center;">${emp.best_day}</td>
                                                <td style="padding: 12px; text-align: center;" id="today-${emp.id}">
                                                    <span class="loading" style="width: 15px; height: 15px;"></span>
                                                </td>
                                                <td style="padding: 12px; text-align: center;" id="trend-${emp.id}">-</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Load today's data for each employee
                loadTodayComparison(rangeData.leaderboard);
                
                // Keep the activity feed for current activities
                loadRecentActivities();
            }

            // Add these new functions right after updateDateRangeView

            // New function to load today's data for comparison
            async function loadTodayComparison(rangeLeaderboard) {
                try {
                    const todayData = await api.getLeaderboard(dashboardData.startDate || api.getCentralDate());
                    
                    rangeLeaderboard.forEach(emp => {
                        const todayEmp = todayData.find(t => t.name === emp.name);
                        const todayCell = document.getElementById(`today-${emp.id}`);
                        const trendCell = document.getElementById(`trend-${emp.id}`);
                        
                        if (todayEmp && todayCell) {
                            const todayItems = todayEmp.items_today || 0;
                            const vsAvg = ((todayItems - emp.avg_daily_items) / emp.avg_daily_items * 100).toFixed(0);
                            
                            // Update today's count
                            todayCell.innerHTML = `<strong>${todayItems}</strong>`;
                            
                            // Update trend
                            if (todayItems > emp.avg_daily_items) {
                                trendCell.innerHTML = `<span style="color: #34d399;">‚Üë ${Math.abs(vsAvg)}%</span>`;
                            } else if (todayItems < emp.avg_daily_items) {
                                trendCell.innerHTML = `<span style="color: #ef4444;">‚Üì ${Math.abs(vsAvg)}%</span>`;
                            } else {
                                trendCell.innerHTML = `<span style="color: #808080;">‚Üí 0%</span>`;
                            }
                            
                            // Highlight if today is their best day
                            if (todayItems > emp.best_day) {
                                todayCell.style.background = 'rgba(52, 211, 153, 0.2)';
                                todayCell.innerHTML += ' üåü';
                            }
                        } else if (todayCell) {
                            todayCell.innerHTML = '<span style="color: #808080;">-</span>';
                            trendCell.innerHTML = '<span style="color: #808080;">-</span>';
                        }
                    });
                } catch (error) {
                    console.error('Error loading today comparison:', error);
                }
            }

            // Load recent activities even in date range mode
            async function loadRecentActivities() {
                try {
                    const activities = await api.getRecentActivities(5);
                    const feed = document.getElementById('activityFeed');
                    if (feed && activities.length > 0) {
                        feed.innerHTML = '<h4 style="margin-bottom: 15px;">Live Activity Feed</h4>';
                        activities.forEach(activity => {
                            const item = document.createElement('div');
                            item.className = 'activity-item';
                            item.style.opacity = '0.8'; // Slightly dimmed to show it's current
                            
                            let icon = activity.type === 'clock_in' ? 'sign-in-alt' : 'sign-out-alt';
                            let color = activity.type === 'clock_in' ? 'rgba(52, 211, 153, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                            
                            item.innerHTML = `
                                <div class="activity-icon" style="background: ${color};">
                                    <i class="fas fa-${icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${activity.description}</div>
                                    <div class="activity-time">${formatTime(activity.timestamp)}</div>
                                </div>
                            `;
                            feed.appendChild(item);
                        });
                    }
                } catch (error) {
                    console.error('Error loading activities:', error);
                }
            }

            // Initialize date filters on page load
            if (document.getElementById('startDate') && document.getElementById('endDate')) {
                const today = api.getCentralDate();
                console.log('Today from API:', today);
                console.log('Current date:', new Date().toISOString().split('T')[0]);
                
                document.getElementById('startDate').value = today;
                document.getElementById('endDate').value = today;
                document.getElementById('startDate').max = today;
                document.getElementById('endDate').max = today;
            }

            // Bottleneck Detection Functions
            async function loadBottleneckData() {
                try {
                    const response = await api.request('/dashboard/bottleneck/current');
                    updateBottleneckDisplay(response);

                    // Enable export button
                    const exportBtn = document.getElementById('exportBottleneckBtn');
                    if (exportBtn) {
                        exportBtn.disabled = false;
                        exportBtn.title = 'Export system health data to CSV';
                    }
                } catch (error) {
                    console.error('Error loading bottleneck data:', error);
                }
            }

            function updateBottleneckDisplay(data) {
                // Update alert
                if (data.primary_bottleneck && data.primary_bottleneck.status !== 'complete') {
                    document.getElementById('bottleneckAlert').style.display = 'flex';
                    document.getElementById('bottleneckMessage').textContent = 
                        `BOTTLENECK: ${data.primary_bottleneck.station} - Queue building at ${data.primary_bottleneck.queue_growth} items/hr`;
                    document.getElementById('bottleneckSubtext').textContent = 
                        `${data.primary_bottleneck.workers} workers active`;
                } else {
                    document.getElementById('bottleneckAlert').style.display = 'none';
                }
                
                // Update workflow stations
                const stationsContainer = document.getElementById('workflowStations');
                stationsContainer.innerHTML = data.stations.map(station => {
                    let cardClass = 'station-card';
                    if (station.status_level === 'critical') cardClass += ' bottleneck';
                    else if (station.status_level === 'warning') cardClass += ' warning';
                    
                    return `
                        <div class="${cardClass}">
                            <h4>${station.name}</h4>
                            <div class="station-rate">${station.output_rate}</div>
                            <div>items/hour</div>
                            <div class="queue-status">
                                <small>Queue: ${station.estimated_queue} items</small><br>
                                <small>${station.workers} workers</small>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update table
                const tableBody = document.getElementById('stationTableBody');
                tableBody.innerHTML = data.stations.map(station => `
                    <tr>
                        <td style="padding: 15px;">${station.name}</td>
                        <td style="padding: 15px; text-align: center;">${station.workers}</td>
                        <td style="padding: 15px; text-align: center;">${station.output_rate}/hr</td>
                        <td style="padding: 15px; text-align: center;">${station.estimated_queue}</td>
                        <td style="padding: 15px; text-align: center;">
                            ${station.status_level === 'critical' ? 'üö® Critical' : 
                            station.status_level === 'warning' ? '‚ö†Ô∏è Warning' : '‚úÖ Good'}
                        </td>
                    </tr>
                `).join('');
                
                // Update available workers - GROUPED BY STATION
                const workersContainer = document.getElementById('availableWorkers');
                if (data.available_workers && data.available_workers.length > 0) {
                    // Group workers by station
                    const workersByStation = {};
                    
                    data.available_workers.forEach(worker => {
                        // Normalize station names
                        let station = worker.current_station;
                        if (station === 'QC Passed') {
                            station = 'Shipping';
                        }
                        if (station === 'In Production') {
                            station = 'Heat Press';
                        }
                        station = station || 'Unknown';
                        
                        if (!workersByStation[station]) {
                            workersByStation[station] = [];
                        }
                        workersByStation[station].push(worker);
                    });
                    
                    // Build grouped HTML
                    let html = '';
                    const stationIcons = {
                        'Shipping': 'üì¶',
                        'Heat Press': 'üî•',
                        'Picking': 'üéØ',
                        'Labeling': 'üè∑Ô∏è',
                        'Film Matching': 'üé¨',
                        'Unknown': '‚ùì'
                    };
                    
                    // Define station order
                    const stationOrder = ['Shipping', 'Heat Press', 'Picking', 'Labeling', 'Film Matching', 'Unknown'];
                    
                    // Sort stations by defined order
                    const sortedStations = Object.keys(workersByStation).sort((a, b) => {
                        const indexA = stationOrder.indexOf(a);
                        const indexB = stationOrder.indexOf(b);
                        return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                    });
                    
                    for (const station of sortedStations) {
                        const workers = workersByStation[station];
                        const icon = stationIcons[station] || 'üìç';
                        
                        html += `
                            <div class="station-group" style="margin-bottom: 15px; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer;" 
                                    onclick="toggleStationGroup('${station}')">
                                    <span style="font-size: 20px; margin-right: 10px;">${icon}</span>
                                    <strong style="flex: 1;">${station}</strong>
                                    <span style="background: rgba(102,126,234,0.2); padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 10px;">${workers.length}</span>
                                    <span id="arrow-${station}" style="transition: transform 0.2s;">‚ñº</span>
                                </div>
                                <div id="station-workers-${station}" style="padding-left: 10px; display: block;">
                                    ${workers.map(worker => `
                                        <div style="padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                            <strong>${worker.name}</strong><br>
                                            <small style="color: #808080;">üìç Currently at: ${station === 'Unknown' ? 'Unknown' : station}</small>
                                            ${worker.skills && worker.skills.length > 0 ? `<br><small style="color: #667eea;">Skills: ${worker.skills.join(', ')}</small>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    workersContainer.innerHTML = html;
                } else {
                    workersContainer.innerHTML = '<p style="color: #808080;">No available workers</p>';
                }
                // Update recommendations with action buttons
                const recsContainer = document.getElementById('recommendations');
                if (data.recommendations && data.recommendations.length > 0) {
                    recsContainer.innerHTML = data.recommendations.map(rec => `
                        <div style="padding: 10px; background: rgba(102,126,234,0.1); border-radius: 8px; margin-bottom: 10px;">
                            <strong>Move ${rec.worker}</strong><br>
                            From: ${rec.from} ‚Üí To: ${rec.to}<br>
                            <small>${rec.reason}</small><br>
                            <button onclick="executeReassignment('${rec.worker}', '${rec.from}', '${rec.to}')" 
                                    style="margin-top: 8px; padding: 5px 12px; background: #667eea; color: white; 
                                        border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                Execute Move
                            </button>
                        </div>
                    `).join('');
                } else {
                    recsContainer.innerHTML = '<p style="color: #808080;">System is balanced</p>';
                }
            }
            // Toggle station group visibility
            window.toggleStationGroup = function(station) {
                const element = document.getElementById(`station-workers-${station}`);
                const arrow = document.getElementById(`arrow-${station}`);
                if (element) {
                    if (element.style.display === 'none') {
                        element.style.display = 'block';
                        arrow.style.transform = 'rotate(0deg)';
                    } else {
                        element.style.display = 'none';
                        arrow.style.transform = 'rotate(-90deg)';
                    }
                }
            };
            // Add this reassign function right after updateBottleneckDisplay
            window.reassignWorker = async function(workerName, currentStation, newStation) {
                const confirmed = await confirmDialog('Reassign Worker', `Move ${workerName} from ${currentStation} to ${newStation}?`);
                if (!confirmed) return;
                executeReassignment(workerName, currentStation, newStation);
            };

            // Add the execute reassignment function
            window.executeReassignment = async function(workerName, fromStation, toStation) {
                try {
                    const response = await fetch(`${API_BASE}/api/dashboard/reassign-worker`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dev-api-key-123'
                        },
                        body: JSON.stringify({
                            worker_name: workerName,
                            from_station: fromStation,
                            to_station: toStation,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        await alertDialog('Success', `${workerName} reassigned to ${toStation}`);
                        loadBottleneckData();
                    } else {
                        await alertDialog('Error', 'Failed to reassign worker');
                    }
                } catch (error) {
                    console.error('Error reassigning worker:', error);
                    await alertDialog('Error', 'Error reassigning worker');
                }
            };

            // Auto-refresh bottleneck data when on that section (only when tab visible)
            setInterval(() => {
                if (shouldRefresh() &&
                    document.getElementById('bottleneck-section') &&
                    document.getElementById('bottleneck-section').classList.contains('active')) {
                    loadBottleneckData();
                }
            }, 60000); // Every 60 seconds
            // ========== COST ANALYSIS FUNCTIONS ==========
                let costAnalysisRequestId = 0;  // Track request to ignore stale responses

                // Load Cost Analysis Data
                async function loadCostAnalysisData() {
                    try {
                        console.log('Loading cost analysis data...');

                        // Get the selected dates from the date filter
                        const startDate = dashboardData.startDate || document.getElementById('startDate').value || api.getCentralDate();
                        const endDate = dashboardData.endDate || document.getElementById('endDate').value || api.getCentralDate();

                        // Track this request to ignore stale responses
                        const thisRequestId = ++costAnalysisRequestId;

                        // Fetch cost data from your API with date range
                        const response = await api.getCostAnalysis(startDate, endDate);  // Pass both dates

                        // Ignore if a newer request was made while we were waiting
                        if (thisRequestId !== costAnalysisRequestId) {
                            console.log('Ignoring stale cost analysis response for:', startDate, '(superseded by newer request)');
                            return;
                        }

                        console.log('Cost analysis response for dates:', startDate, 'to', endDate, response);

                        costData = response;
                        
                        // Show a notice based on whether it's a range or single day
                        const costSection = document.getElementById('cost-section');
                        
                        // Remove any existing date notice
                        const existingNotice = costSection.querySelector('.historical-notice');
                        if (existingNotice) {
                            existingNotice.remove();
                        }
                        
                        // Check if it's a date range or single day
                        if (response.date_range && response.date_range.is_range) {
                            // Date range notice
                            const dateNotice = document.createElement('div');
                            dateNotice.className = 'historical-notice alert-item';
                            dateNotice.style.cssText = 'background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.2); margin-bottom: 20px;';
                            dateNotice.innerHTML = `
                                <i class="fas fa-calendar-week alert-icon" style="color: #667eea;"></i>
                                <div class="alert-content">
                                    <div class="alert-title" style="color: #667eea;">
                                        ${response.date_range.days}-Day Cost Analysis
                                    </div>
                                    <div class="alert-message">
                                        Analyzing period from ${new Date(response.date_range.start + 'T12:00:00').toLocaleDateString()} to ${new Date(response.date_range.end + 'T12:00:00').toLocaleDateString()}<br>
                                        <strong>Daily Average:</strong> $${response.daily_avg_cost || '0.00'} | 
                                        <strong>Daily Items:</strong> ${response.daily_avg_items || 0} QC Passed
                                    </div>
                                </div>
                            `;
                            const firstMetric = costSection.querySelector('.metrics-grid');
                            costSection.insertBefore(dateNotice, firstMetric);
                        } else if (startDate !== api.getCentralDate()) {
                            // Single historical day notice
                            const dateNotice = document.createElement('div');
                            dateNotice.className = 'historical-notice alert-item';
                            dateNotice.style.cssText = 'background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.2); margin-bottom: 20px;';
                            dateNotice.innerHTML = `
                                <i class="fas fa-calendar-alt alert-icon" style="color: #667eea;"></i>
                                <div class="alert-content">
                                    <div class="alert-title" style="color: #667eea;">Historical Data</div>
                                    <div class="alert-message">
                                        Viewing costs for ${new Date(startDate + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                    </div>
                                </div>
                            `;
                            const firstMetric = costSection.querySelector('.metrics-grid');
                            costSection.insertBefore(dateNotice, firstMetric);
                        }
                        
                        // Check if we have employee data
                        if (response.employee_costs && response.employee_costs.length > 0) {
                            console.log(`Found ${response.employee_costs.length} employees`);
                            
                            // If it's a date range, show additional info
                            if (response.date_range && response.date_range.is_range) {
                                console.log(`Date range: ${response.date_range.days} days`);
                                console.log(`Total labor cost: $${response.total_labor_cost}`);
                                console.log(`Daily average cost: $${response.daily_avg_cost}`);
                            }
                        } else {
                            console.log('No employee costs data found');
                        }
                        
                        // Update all components
                        updateCostMetrics(response);
                        updateCostTable();
                        
                        // Fix the department costs error
                        if (response.department_costs) {
                            updateDepartmentCosts(response.department_costs);
                        }
                        
                        // Fix the champions error
                            if (response.top_performers) {
                                updateCostChampions(response.top_performers);
                            }

                            // Enable export button
                            const exportBtn = document.getElementById('exportCostBtn');
                            if (exportBtn) {
                                exportBtn.disabled = false;
                                exportBtn.title = 'Export cost data to CSV';
                            }

                        } catch (error) {
                            console.error('Error loading cost data:', error);
                            showCostErrorState();
                        }
                    }

                    // Format items breakdown for display
                    function formatItemsBreakdown(breakdown) {
                        if (!breakdown) return '<span style="color: #999; font-style: italic; font-size: 11px;">No activities</span>';
                        
                        const activities = [
                            { key: 'picking', label: 'Picking', icon: 'üéØ' },
                            { key: 'labeling', label: 'Labeling', icon: 'üè∑Ô∏è' },
                            { key: 'film_matching', label: 'Film', icon: 'üé¨' },
                            { key: 'in_production', label: 'Pressing', icon: 'üî•' },
                            { key: 'qc_passed', label: 'Shipping', icon: 'üì¶' }
                        ];
                        
                        let html = '<div style="display: flex; flex-direction: column; gap: 3px; font-size: 12px;">';
                        let hasAnyItems = false;
                        
                        activities.forEach(activity => {
                            const count = breakdown[activity.key] || 0;
                            if (count > 0) {
                                hasAnyItems = true;
                                const colors = {
                                    'picking': '#4CAF50',
                                    'labeling': '#2196F3', 
                                    'film_matching': '#FF9800',
                                    'in_production': '#9C27B0',
                                    'qc_passed': '#00BCD4'
                                };
                                html += `
                                    <div style="display: flex; align-items: center; padding: 2px 4px; background: rgba(103, 126, 234, 0.05); border-radius: 4px; border-left: 2px solid ${colors[activity.key]};">
                                        <span style="margin-right: 4px;">${activity.icon}</span>
                                        <span style="font-weight: 500; margin-right: 4px; min-width: 50px;">${activity.label}:</span>
                                        <span style="font-weight: 600; color: #e0e0e0; margin-left: auto;">${count.toLocaleString()}</span>
                                    </div>
                                `;
                            }
                        });
                        
                        if (!hasAnyItems) {
                            html += '<span style="color: #999; font-style: italic; font-size: 11px;">No activities</span>';
                        }
                        
                        html += '</div>';
                        return html;
                    }

                    // Update Cost Metrics with dual metrics
                    function updateCostMetrics(data) {
                        // Total Labor Cost
                        document.getElementById('totalLaborCost').textContent = `$${parseFloat(data.total_labor_cost || 0).toFixed(2)}`;
                    
                    // Average Cost per Item (True and Active) - now based on QC Passed items
                    document.getElementById('avgCostPerItem').textContent = `$${parseFloat(data.avg_cost_per_item || 0).toFixed(3)}`;
                    document.getElementById('avgCostPerItemActive').textContent = `Active: $${parseFloat(data.avg_cost_per_item_active || 0).toFixed(3)}`;
                    
                    // Update the label to show it's based on QC Passed
                    const costLabel = document.querySelector('#avgCostPerItem').nextElementSibling;
                    if (costLabel) {
                        costLabel.textContent = `Avg Cost per Item`;
                    }
                    
                    // Overall Utilization
                    const utilization = parseFloat(data.overall_utilization || 0);
                    document.getElementById('overallUtilization').textContent = `${utilization.toFixed(1)}%`;
                    document.getElementById('utilizationProgress').style.width = `${utilization}%`;
                    
                    // Non-Active Hours and Cost
                    document.getElementById('totalNonActiveHours').textContent = `${parseFloat(data.total_non_active_hours || 0).toFixed(1)} hrs`;
                    document.getElementById('nonActiveCost').textContent = `Idle Cost: $${parseFloat(data.total_non_active_cost || 0).toFixed(2)}`;
                    
                    // Active Employees and Average Rate
                    document.getElementById('activeEmployeeCount').textContent = data.active_employees || 0;
                    document.getElementById('avgHourlyRate').textContent = `Avg Rate: $${parseFloat(data.avg_hourly_rate || 0).toFixed(2)}/hr`;
                    
                    // Update change indicators
                    updateMetricChange('costVsYesterday', parseFloat(data.vs_yesterday_percent || 0));
                    
                    // Show QC Passed count somewhere visible
                    if (data.qc_passed_items !== undefined) {
                        // You could add a small badge or subtitle showing the QC passed count
                        const subtitle = document.getElementById('avgCostPerItemActive');
                        if (subtitle) {
                            subtitle.innerHTML = `Active: $${parseFloat(data.avg_cost_per_item_active || 0).toFixed(3)}<br><small style="opacity: 0.7;">(${data.qc_passed_items} QC Passed)</small>`;
                        }
                    }
                    
                    // Show alert if utilization is low OR cost per item is high
                    const targetCostPerItem = 1.5; // Your target
                    if (utilization < 50 || data.avg_cost_per_item > targetCostPerItem * 1.5) {
                        document.getElementById('highCostAlert').style.display = 'block';
                        
                        if (utilization < 50) {
                            document.getElementById('highCostMessage').textContent = 
                                `Low utilization (${utilization.toFixed(1)}%) - ${parseFloat(data.total_non_active_hours || 0).toFixed(1)} idle hours costing $${parseFloat(data.total_non_active_cost || 0).toFixed(2)}`;
                        } else {
                            document.getElementById('highCostMessage').textContent = 
                                `High cost per QC item ($${data.avg_cost_per_item.toFixed(3)}) - Target is $${targetCostPerItem}`;
                        }
                    } else {
                        document.getElementById('highCostAlert').style.display = 'none';
                    }
                }
                // Filter cost table by search input
                function filterCostTable() {
                    const searchInput = document.getElementById('costSearchInput');
                    const searchValue = searchInput ? searchInput.value.toLowerCase().trim() : '';
                    
                    // Get the table body
                    const tbody = document.getElementById('costTableBody');
                    if (!tbody) return;
                    
                    // Get all rows
                    const rows = tbody.querySelectorAll('tr');
                    
                    // Filter rows
                    rows.forEach(row => {
                        // Get the employee name from first cell
                        const nameCell = row.querySelector('td:first-child');
                        if (!nameCell) return;
                        
                        const name = nameCell.textContent.toLowerCase();
                        
                        // Show or hide based on search
                        if (searchValue === '' || name.includes(searchValue)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                }
                
                // Make filterCostTable available globally
                window.filterCostTable = filterCostTable;

                // Update Cost Table with all new columns
                function updateCostTable() {
                    console.log('updateCostTable called with costData:', costData);
                    
                    if (!costData) {
                        console.error('No cost data available');
                        showCostErrorState();
                        return;
                    }
                    
                    if (!costData.employee_costs) {
                        console.error('No employee_costs in costData');
                        showCostErrorState();
                        return;
                    }
                    
                    if (costData.employee_costs.length === 0) {
                        console.error('Empty employee_costs array');
                        showCostErrorState();
                        return;
                    }
                    
                    console.log('Processing', costData.employee_costs.length, 'employees');
                    
                    const sortBy = document.getElementById('costSortBy').value;
                    const tbody = document.getElementById('costTableBody');
                    
                    // Sort employees
                    let sortedEmployees = [...costData.employee_costs];
                    switch(sortBy) {
                        case 'name':
                            sortedEmployees.sort((a, b) => a.name.localeCompare(b.name));
                            break;
                        case 'utilization':
                            sortedEmployees.sort((a, b) => (b.utilization_rate || 0) - (a.utilization_rate || 0));
                            break;
                        case 'cost_per_item':
                            sortedEmployees.sort((a, b) => (a.cost_per_item || 999) - (b.cost_per_item || 999));
                            break;
                        case 'total_cost':
                            sortedEmployees.sort((a, b) => b.total_cost - a.total_cost);
                            break;
                        case 'efficiency':
                            sortedEmployees.sort((a, b) => b.efficiency - a.efficiency);
                            break;
                        case 'non_active':
                            sortedEmployees.sort((a, b) => (b.non_active_hours || 0) - (a.non_active_hours || 0));
                            break;
                    }
                    
                    // Check if single day (show clock times tooltip)
                    const isSingleDay = costData.date_range && !costData.date_range.is_range;

                    // Populate table
                    tbody.innerHTML = sortedEmployees.map(emp => {
                        const nonActivePercent = (emp.non_active_hours / emp.clocked_hours * 100) || 0;
                        const nonActiveColor = nonActivePercent > 50 ? '#ef4444' : (nonActivePercent > 30 ? '#f59e0b' : '#22c55e');

                        // Build clock times tooltip for single day view
                        let clockTimesHtml = '';
                        if (isSingleDay && emp.clock_times && emp.clock_times.length > 0) {
                            const tooltipLines = emp.clock_times.map(ct =>
                                `${ct.clock_in} - ${ct.clock_out} (${Math.floor(ct.minutes/60)}h ${ct.minutes%60}m)`
                            ).join('&#10;');
                            clockTimesHtml = `
                                <td style="padding: 12px; text-align: center; cursor: help; position: relative;" class="clock-times-cell" title="${tooltipLines}">
                                    ${parseFloat(emp.clocked_hours || 0).toFixed(1)}
                                    <i class="fas fa-clock" style="font-size: 10px; opacity: 0.5; margin-left: 4px;"></i>
                                </td>`;
                        } else {
                            clockTimesHtml = `<td style="padding: 12px; text-align: center;">${parseFloat(emp.clocked_hours || 0).toFixed(1)}</td>`;
                        }

                        return `
                            <tr>
                                <td style="padding: 12px;">${emp.name}</td>
                                <td style="padding: 12px; text-align: center;">$${parseFloat(emp.hourly_rate || 0).toFixed(2)}</td>
                                ${clockTimesHtml}
                                <td style="padding: 12px; text-align: center; color: #22c55e;">${parseFloat(emp.active_hours || 0).toFixed(1)}</td>
                                <td style="padding: 12px; text-align: center; color: ${nonActiveColor}; font-weight: bold;">
                                    ${parseFloat(emp.non_active_hours || 0).toFixed(1)}
                                    <small style="opacity: 0.7;">(${nonActivePercent.toFixed(0)}%)</small>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                                        <div style="width: 100px; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                                            <div style="width: ${emp.utilization_rate || 0}%; height: 100%; background: ${(emp.utilization_rate || 0) > 70 ? '#22c55e' : (emp.utilization_rate || 0) > 50 ? '#3b82f6' : '#f59e0b'};"></div>
                                        </div>
                                        <span>${parseFloat(emp.utilization_rate || 0).toFixed(1)}%</span>
                                    </div>
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    $${parseFloat(emp.total_cost || 0).toFixed(2)}
                                    <div style="font-size: 0.8em; margin-top: 2px;">
                                        <span style="color: #22c55e;">Active: $${parseFloat(emp.active_cost || 0).toFixed(2)}</span><br>
                                        <span style="color: #ef4444;">Idle: $${parseFloat(emp.non_active_cost || 0).toFixed(2)}</span>
                                    </div>
                                </td>
                                <td style="padding: 12px; text-align: center;">${emp.items_processed || 0}</td>
                                <td style="padding: 12px; text-align: left;">
                                    ${formatItemsBreakdown(emp.activity_breakdown)}
                                </td>
                                <td style="padding: 12px; text-align: center;">$${parseFloat(emp.cost_per_item_true || emp.cost_per_item || 0).toFixed(3)}</td>
                                <td style="padding: 12px; text-align: center; color: #22c55e;">$${parseFloat(emp.cost_per_item_active || 0).toFixed(3)}</td>
                                <td style="padding: 12px; text-align: center;">
                                    <span class="status-badge" style="background: ${emp.status_color || '#6b7280'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px;">
                                        ${emp.status || 'UNKNOWN'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Update footer totals
                    const totals = sortedEmployees.reduce((acc, emp) => {
                        acc.clocked += parseFloat(emp.clocked_hours || 0);
                        acc.active += parseFloat(emp.active_hours || 0);
                        acc.nonActive += parseFloat(emp.non_active_hours || 0);
                        acc.cost += parseFloat(emp.total_cost || 0);
                        acc.activeCost += parseFloat(emp.active_cost || 0);
                        acc.items += parseInt(emp.items_processed || 0);
                        acc.count++;
                        return acc;
                    }, { clocked: 0, active: 0, nonActive: 0, cost: 0, activeCost: 0, items: 0, count: 0 });

                    document.getElementById('footerAvgRate').textContent = totals.clocked > 0 ? `$${(totals.cost / totals.clocked).toFixed(2)}` : '-';
                    document.getElementById('footerTotalClocked').textContent = totals.clocked.toFixed(1);
                    document.getElementById('footerTotalActive').textContent = totals.active.toFixed(1);
                    document.getElementById('footerTotalNonActive').textContent = totals.nonActive.toFixed(1);
                    document.getElementById('footerAvgUtilization').textContent = totals.clocked > 0 ? `${(totals.active / totals.clocked * 100).toFixed(1)}%` : '-';
                    document.getElementById('footerTotalCost').textContent = `$${totals.cost.toFixed(2)}`;
                    // Show both total items and QC passed items
                    document.getElementById('footerTotalItems').innerHTML = `
                        ${totals.items.toLocaleString()}
                        <small style="display: block; opacity: 0.7; font-size: 0.8em;">
                            QC: ${costData.qc_passed_items || 'N/A'}
                        </small>
                    `;
                    // Use QC passed items for footer cost calculations too
                    const qcItems = costData.qc_passed_items || totals.items;
                    document.getElementById('footerAvgCostPerItem').textContent = qcItems > 0 ? `$${(totals.cost / qcItems).toFixed(3)}` : '-';
                    document.getElementById('footerAvgCostPerItemActive').textContent = qcItems > 0 ? `$${(totals.activeCost / qcItems).toFixed(3)}` : '-';
                    document.getElementById('footerAvgEfficiency').textContent = totals.cost > 0 ? (totals.items / totals.cost).toFixed(1) : '-';
                    }

                // Update Department Costs
                function updateDepartmentCosts(deptCosts) {
                    const container = document.getElementById('departmentCostChart');
                    
                    if (!container) {
                        console.error('Department cost container not found');
                        return;
                    }
                    
                    if (!deptCosts || deptCosts.length === 0) {
                        container.innerHTML = '<p style="color: #808080;">No department data available</p>';
                        return;
                    }
                    // Calculate total labor cost for percentage calculation
                    const totalLaborCost = parseFloat(costData.total_labor_cost) || 0;
                    
                    container.innerHTML = deptCosts.map(dept => {
                        // Convert to numbers
                        const deptTotalCost = parseFloat(dept.total_cost) || 0;
                        const itemsProcessed = parseInt(dept.items_processed) || 0;
                        const employeeCount = parseInt(dept.employee_count) || 0;
                        
                        const costPerItem = itemsProcessed > 0 ? deptTotalCost / itemsProcessed : 0;
                        const percentOfTotal = totalLaborCost > 0 ? (deptTotalCost / totalLaborCost * 100) : 0;
                        
                        return `
                            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${getDepartmentIcon(dept.department)} ${dept.department}</h4>
                                    <span style="font-size: 1.2em; font-weight: 700; color: #ef4444;">$${deptTotalCost.toFixed(2)}</span>
                                </div>
                                <div class="progress-bar" style="margin-bottom: 10px;">
                                    <div class="progress-fill" style="width: ${percentOfTotal}%; background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85em;">
                                    <div>
                                        <span style="color: #808080;">Employees:</span>
                                        <strong style="color: #e0e0e0;"> ${employeeCount}</strong>
                                    </div>
                                    <div>
                                        <span style="color: #808080;">Items:</span>
                                        <strong style="color: #e0e0e0;"> ${itemsProcessed}</strong>
                                    </div>
                                    <div>
                                        <span style="color: #808080;">Cost/Item:</span>
                                        <strong style="color: ${costPerItem > 0.15 ? '#ef4444' : '#22c55e'};"> $${costPerItem.toFixed(3)}</strong>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Update Cost Champions
                function updateCostChampions(champions) {
                    const container = document.getElementById('costChampions');
                    
                    if (!champions || champions.length === 0) {
                        container.innerHTML = '<p style="color: #808080;">No data available</p>';
                        return;
                    }
                    
                    container.innerHTML = champions.slice(0, 5).map((emp, index) => {
                        const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                        
                        // Convert to numbers
                        const costPerItem = parseFloat(emp.cost_per_item) || 0;
                        const efficiency = parseFloat(emp.efficiency) || 0;
                        const itemsProcessed = parseInt(emp.items_processed) || 0;
                        
                        return `
                            <div class="champion-card">
                                <div class="champion-rank">${medals[index]}</div>
                                <div class="champion-info">
                                    <div class="champion-name">${emp.name}</div>
                                    <div class="champion-stats">
                                        ${itemsProcessed} items at 
                                        <span class="champion-value">$${costPerItem.toFixed(3)}</span>/item
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                // Export Cost Report
                async function exportCostReport() {
                    if (!costData || !costData.employee_costs) {
                        await alertDialog('Export', 'No data to export');
                        return;
                    }

                    // Create CSV content with all cost analysis fields
                    const headers = [
                        'Employee', 'Pay Type', 'Hourly Rate',
                        'Clocked Hours', 'Active Hours', 'Non-Active Hours',
                        'Total Cost', 'Active Cost', 'Non-Active Cost',
                        'Utilization %', 'Items Processed', 'Cost per Item',
                        'Picking', 'Labeling', 'Film Matching', 'In Production', 'QC Passed'
                    ];
                    const rows = costData.employee_costs.map(emp => {
                        const breakdown = emp.activity_breakdown || {};
                        return [
                            emp.name,
                            emp.pay_type || 'hourly',
                            parseFloat(emp.hourly_rate || 0).toFixed(2),
                            parseFloat(emp.clocked_hours || 0).toFixed(2),
                            parseFloat(emp.active_hours || 0).toFixed(2),
                            parseFloat(emp.non_active_hours || 0).toFixed(2),
                            parseFloat(emp.total_cost || 0).toFixed(2),
                            parseFloat(emp.active_cost || 0).toFixed(2),
                            parseFloat(emp.non_active_cost || 0).toFixed(2),
                            parseFloat(emp.utilization_rate || 0).toFixed(1),
                            emp.items_processed || 0,
                            emp.items_processed > 0 ? (parseFloat(emp.total_cost) / emp.items_processed).toFixed(3) : '0',
                            breakdown.picking || 0,
                            breakdown.labeling || 0,
                            breakdown.film_matching || 0,
                            breakdown.in_production || 0,
                            breakdown.qc_passed || 0
                        ];
                    });

                    // Add totals row
                    const totals = costData.employee_costs.reduce((acc, emp) => {
                        acc.clocked += parseFloat(emp.clocked_hours || 0);
                        acc.active += parseFloat(emp.active_hours || 0);
                        acc.nonActive += parseFloat(emp.non_active_hours || 0);
                        acc.cost += parseFloat(emp.total_cost || 0);
                        acc.activeCost += parseFloat(emp.active_cost || 0);
                        acc.nonActiveCost += parseFloat(emp.non_active_cost || 0);
                        acc.items += parseInt(emp.items_processed || 0);
                        const b = emp.activity_breakdown || {};
                        acc.picking += parseInt(b.picking || 0);
                        acc.labeling += parseInt(b.labeling || 0);
                        acc.filmMatching += parseInt(b.film_matching || 0);
                        acc.inProduction += parseInt(b.in_production || 0);
                        acc.qcPassed += parseInt(b.qc_passed || 0);
                        return acc;
                    }, { clocked: 0, active: 0, nonActive: 0, cost: 0, activeCost: 0, nonActiveCost: 0, items: 0, picking: 0, labeling: 0, filmMatching: 0, inProduction: 0, qcPassed: 0 });
                    
                    const utilization = totals.clocked > 0 ? (totals.active / totals.clocked * 100) : 0;
                    rows.push([
                        'TOTAL',
                        '',
                        totals.clocked > 0 ? (totals.cost / totals.clocked).toFixed(2) : '0',
                        totals.clocked.toFixed(2),
                        totals.active.toFixed(2),
                        totals.nonActive.toFixed(2),
                        totals.cost.toFixed(2),
                        totals.activeCost.toFixed(2),
                        totals.nonActiveCost.toFixed(2),
                        utilization.toFixed(1),
                        totals.items,
                        totals.items > 0 ? (totals.cost / totals.items).toFixed(3) : '0',
                        totals.picking,
                        totals.labeling,
                        totals.filmMatching,
                        totals.inProduction,
                        totals.qcPassed
                    ]);
                    
                    // Create CSV
                    const csv = [
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n');
                    
                    // Download with date range in filename
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const dateRange = costData.date_range;
                    const filename = dateRange && dateRange.start !== dateRange.end
                        ? `cost_report_${dateRange.start}_to_${dateRange.end}.csv`
                        : `cost_report_${dateRange ? dateRange.start : api.getCentralDate()}.csv`;
                    a.download = filename;
                    a.click();
                    window.URL.revokeObjectURL(url);
                }

                // Show error state
                function showCostErrorState() {
                    document.getElementById('costTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #808080;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 10px;"></i>
                                <p>Unable to load cost data. Please check if employee pay rates are configured.</p>
                            </td>
                        </tr>
                    `;
                }

                // Add event listener for cost sort dropdown
                const costSortElement = document.getElementById('costSortBy');
                if (costSortElement) {
                    costSortElement.addEventListener('change', updateCostTable);
                }

                // Add event listeners for export buttons
                const exportBtn = document.getElementById('exportCostBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', exportCostReport);
                }

                // Also wire up the table section export button
                const exportTableBtn = document.getElementById('exportCostTableBtn');
                if (exportTableBtn) {
                    exportTableBtn.addEventListener('click', exportCostReport);
                }

                // Expose to global scope for any onclick handlers
                window.exportCostReport = exportCostReport;

                });  // <-- This closes the DOMContentLoaded function

        // NOTE: setDateRange, showSection, applyDateFilter are defined as window.*
        // functions earlier in this file (around lines 3904-3974). Do NOT duplicate here.

        </script>
<!-- Mobile Bottom Navigation -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
    <a href="#" class="mobile-bottom-nav__item active" onclick="showSection('dashboard'); closeSidebar(); return false;">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
    </a>
    <a href="#" class="mobile-bottom-nav__item" onclick="showSection('bottleneck'); closeSidebar(); return false;">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Bottleneck</span>
    </a>
    <a href="#" class="mobile-bottom-nav__item" onclick="showSection('cost'); closeSidebar(); return false;">
        <i class="fas fa-dollar-sign"></i>
        <span>Cost</span>
    </a>
    <a href="#" class="mobile-bottom-nav__item" onclick="toggleSidebar(); return false;">
        <i class="fas fa-bars"></i>
        <span>More</span>
    </a>
</nav>

<script src="shared-ui.js"></script>
<script src="/js/auth-check.js"></script>
    </body>
    </html>