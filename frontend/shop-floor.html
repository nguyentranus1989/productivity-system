<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRODUCTIVITY ARENA - Live Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           PRODUCTIVITY ARENA - ESPORTS GAMING THEME
           Shop Floor TV Display
           Dark purple/blue with neon accents
        ============================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Core Gaming Colors */
            --bg-dark: #0a0a12;
            --bg-panel: #12121f;
            --bg-card: rgba(20, 20, 40, 0.8);
            --bg-card-glow: rgba(30, 30, 60, 0.9);

            /* Neon Accents */
            --neon-pink: #ff2d95;
            --neon-cyan: #00f0ff;
            --neon-purple: #a855f7;
            --neon-blue: #3b82f6;
            --neon-green: #22c55e;
            --neon-yellow: #fbbf24;
            --neon-orange: #f97316;
            --neon-red: #ef4444;

            /* Rank Colors */
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;

            /* Text */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.75);
            --text-muted: rgba(255, 255, 255, 0.5);

            /* Gradients */
            --gradient-pink-cyan: linear-gradient(135deg, var(--neon-pink) 0%, var(--neon-cyan) 100%);
            --gradient-purple-blue: linear-gradient(135deg, var(--neon-purple) 0%, var(--neon-blue) 100%);
            --gradient-fire: linear-gradient(135deg, var(--neon-orange) 0%, var(--neon-red) 100%);

            /* Shadows/Glows */
            --glow-pink: 0 0 30px rgba(255, 45, 149, 0.5);
            --glow-cyan: 0 0 30px rgba(0, 240, 255, 0.5);
            --glow-purple: 0 0 30px rgba(168, 85, 247, 0.5);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            line-height: 1.3;
        }

        /* === ANIMATED BACKGROUND === */
        .bg-animation {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse at 10% 20%, rgba(255, 45, 149, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 80%, rgba(0, 240, 255, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(168, 85, 247, 0.08) 0%, transparent 60%);
            animation: bgPulse 6s ease-in-out infinite;
        }

        .bg-animation::after {
            content: '';
            position: absolute;
            inset: 0;
            background:
                linear-gradient(90deg, transparent 49.5%, rgba(255, 45, 149, 0.03) 50%, transparent 50.5%),
                linear-gradient(0deg, transparent 49.5%, rgba(0, 240, 255, 0.03) 50%, transparent 50.5%);
            background-size: 60px 60px;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        /* Floating particles */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--neon-cyan);
            border-radius: 50%;
            animation: particleFloat 10s linear infinite;
            opacity: 0.6;
        }

        @keyframes particleFloat {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-10vh) rotate(720deg); opacity: 0; }
        }

        /* === HEADER === */
        .header {
            background: linear-gradient(180deg, var(--bg-panel) 0%, rgba(18, 18, 31, 0.95) 100%);
            border-bottom: 2px solid;
            border-image: var(--gradient-pink-cyan) 1;
            padding: 16px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-pink-cyan);
            box-shadow: var(--glow-pink);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            font-size: 3rem;
            animation: logoGlow 2s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% {
                filter: drop-shadow(0 0 10px var(--neon-pink));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 25px var(--neon-cyan));
                transform: scale(1.1);
            }
        }

        .header-title h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: var(--gradient-pink-cyan);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(255, 45, 149, 0.3);
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--neon-red);
            border-radius: 20px;
            padding: 6px 16px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--neon-red);
            animation: livePulse 1.5s ease-in-out infinite;
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: var(--neon-red);
            border-radius: 50%;
            animation: dotPulse 1s ease-in-out infinite;
        }

        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        @keyframes livePulse {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); }
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .datetime {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--neon-cyan);
            text-shadow: 0 0 15px rgba(0, 240, 255, 0.4);
        }

        .active-count {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .active-count strong {
            color: var(--neon-green);
            font-weight: 700;
        }

        /* === MAIN LAYOUT === */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 420px;
            grid-template-rows: auto 1fr;  /* Battle=auto, Rankings=fill */
            gap: 24px;
            padding: 24px 40px;
            height: calc(100vh - 85px - 70px);
            overflow: hidden;
        }

        /* === VS BATTLE SECTION === */
        .battle-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 10px;
        }

        .battle-card {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .battle-card.leader {
            border-color: var(--gold);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
        }

        .battle-card.leader::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: rotateBorder 4s linear infinite;
        }

        @keyframes rotateBorder {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .battle-card.challenger {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
        }

        .battle-rank {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .battle-rank.gold {
            animation: goldShine 2s ease-in-out infinite;
        }

        @keyframes goldShine {
            0%, 100% {
                filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
                transform: scale(1.1);
            }
        }

        .battle-info {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .battle-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .battle-stats {
            display: flex;
            gap: 24px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .battle-stats span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .battle-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            font-weight: 900;
            position: relative;
            z-index: 1;
        }

        .battle-score.gold {
            color: var(--gold);
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .battle-score.cyan {
            color: var(--neon-cyan);
            text-shadow: 0 0 30px rgba(0, 240, 255, 0.5);
        }

        /* VS Divider */
        .vs-divider {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .vs-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            background: var(--gradient-fire);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: vsFlash 1s ease-in-out infinite;
        }

        @keyframes vsFlash {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
        }

        .gap-indicator {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
            color: var(--neon-orange);
            font-weight: 600;
            text-align: center;
            animation: gapPulse 2s ease-in-out infinite;
        }

        @keyframes gapPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* === LEADERBOARD === */
        .leaderboard-section {
            background: var(--bg-card);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 24px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            min-height: 0;  /* Allow flex child to scroll */
            max-height: 100%;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .section-header h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--neon-purple);
            text-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }

        .refresh-timer {
            font-size: 0.9rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-timer.active {
            color: var(--neon-cyan);
        }

        .leaderboard-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
            min-height: 0;  /* Critical for flex scrolling */
        }

        .leaderboard-list::-webkit-scrollbar {
            width: 6px;
        }

        .leaderboard-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb {
            background: var(--neon-purple);
            border-radius: 3px;
        }

        /* === PLAYER CARD === */
        .player-card {
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.6) 0%, rgba(20, 20, 40, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 60px 1fr auto;
            gap: 16px;
            align-items: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .player-card:hover {
            transform: translateX(8px);
            border-color: var(--neon-purple);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }

        .player-card.rank-up {
            animation: rankUpFlash 0.8s ease;
        }

        @keyframes rankUpFlash {
            0% { background: rgba(34, 197, 94, 0.3); }
            100% { background: linear-gradient(135deg, rgba(30, 30, 60, 0.6) 0%, rgba(20, 20, 40, 0.8) 100%); }
        }

        .player-card.active-player {
            border-color: var(--neon-green);
        }

        .player-card.active-player::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
        }

        .player-rank {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
        }

        .player-rank.rank-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.1) 100%);
            color: var(--gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            font-size: 2rem;
        }

        .player-rank.rank-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3) 0%, rgba(192, 192, 192, 0.1) 100%);
            color: var(--silver);
            font-size: 1.8rem;
        }

        .player-rank.rank-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3) 0%, rgba(205, 127, 50, 0.1) 100%);
            color: var(--bronze);
            font-size: 1.8rem;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0;
        }

        .player-name {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .player-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .player-breakdown {
            font-size: 0.9rem;
            color: var(--text-secondary, #94a3b8);
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        .battle-breakdown {
            font-size: 0.85rem;
            color: var(--text-secondary, #94a3b8);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            text-align: center;
            line-height: 1.5;
            font-weight: 500;
        }

        .stat-working {
            color: var(--neon-green);
            font-weight: 600;
        }

        .stat-offline {
            color: var(--text-muted);
        }

        /* XP Bar */
        .xp-bar-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        .xp-bar {
            height: 100%;
            background: var(--gradient-purple-blue);
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
            transition: width 0.5s ease;
        }

        .player-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--neon-cyan);
            text-shadow: 0 0 20px rgba(0, 240, 255, 0.4);
        }

        /* === RIGHT PANEL === */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Total Score Card */
        .total-card {
            background: var(--bg-card);
            border: 2px solid var(--neon-pink);
            border-radius: 24px;
            padding: 28px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--glow-pink);
        }

        .total-card::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 45, 149, 0.1), transparent);
            animation: rotateBorder 6s linear infinite;
        }

        .total-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--neon-pink);
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .total-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: 900;
            background: var(--gradient-pink-cyan);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            position: relative;
            z-index: 1;
            animation: scoreGlow 2s ease-in-out infinite;
        }

        @keyframes scoreGlow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 20px rgba(255, 45, 149, 0.3)); }
            50% { filter: brightness(1.2) drop-shadow(0 0 40px rgba(0, 240, 255, 0.5)); }
        }

        .total-goal {
            font-size: 1rem;
            color: var(--text-muted);
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }

        /* Department Battle */
        .dept-battle {
            background: var(--bg-card);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            padding: 24px;
            flex: 1;
        }

        .dept-battle h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            color: var(--neon-yellow);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dept-race {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .dept-item {
            position: relative;
        }

        .dept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .dept-name {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dept-name.leading {
            color: var(--neon-green);
        }

        .dept-score {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .dept-bar-container {
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .dept-bar {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
        }

        .dept-bar.qc { background: var(--gradient-purple-blue); }
        .dept-bar.picking { background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan)); }
        .dept-bar.labeling { background: var(--gradient-fire); }

        .dept-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
            animation: barShine 2s ease-in-out infinite;
        }

        @keyframes barShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-box {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-4px);
        }

        .stat-box-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-box-value.cyan { color: var(--neon-cyan); }
        .stat-box-value.green { color: var(--neon-green); }
        .stat-box-value.pink { color: var(--neon-pink); }
        .stat-box-value.yellow { color: var(--neon-yellow); }

        .stat-box-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* === ACHIEVEMENT TICKER === */
        .achievement-ticker {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(180deg, rgba(18, 18, 31, 0.95) 0%, var(--bg-panel) 100%);
            border-top: 2px solid;
            border-image: var(--gradient-purple-blue) 1;
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .ticker-track {
            display: flex;
            animation: tickerScroll 50s linear infinite;
            white-space: nowrap;
        }

        .ticker-track:hover {
            animation-play-state: paused;
        }

        @keyframes tickerScroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 50px;
            font-size: 1.15rem;
            color: var(--text-primary);
        }

        .ticker-icon {
            font-size: 1.5rem;
            animation: iconBounce 1s ease-in-out infinite;
        }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .ticker-highlight {
            color: var(--neon-cyan);
            font-weight: 700;
        }

        /* === ACHIEVEMENT POPUP === */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.98) 0%, rgba(20, 20, 40, 0.98) 100%);
            border: 3px solid var(--neon-yellow);
            border-radius: 24px;
            padding: 40px 60px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 0 60px rgba(251, 191, 36, 0.5);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .achievement-icon {
            font-size: 5rem;
            margin-bottom: 16px;
            animation: achievementBounce 0.5s ease-out;
        }

        @keyframes achievementBounce {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .achievement-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.4rem;
            color: var(--neon-yellow);
            margin-bottom: 12px;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .achievement-desc {
            font-size: 1.3rem;
            color: var(--text-secondary);
        }

        .achievement-name {
            color: var(--neon-cyan);
            font-weight: 700;
        }

        /* === COMBO STREAK === */
        .combo-display {
            position: fixed;
            top: 120px;
            right: 40px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(249, 115, 22, 0.9) 100%);
            border-radius: 16px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
            transform: translateX(150%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .combo-display.show {
            transform: translateX(0);
        }

        .combo-fire {
            font-size: 2rem;
            animation: fireFlicker 0.3s ease-in-out infinite;
        }

        @keyframes fireFlicker {
            0%, 100% { transform: scale(1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .combo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 800;
        }

        .combo-number {
            font-size: 2rem;
            color: var(--text-primary);
        }

        .combo-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* === LOADING STATE === */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            gap: 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--neon-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        /* === ERROR STATE === */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            gap: 16px;
        }

        .error-icon {
            font-size: 4rem;
        }

        .error-message {
            font-size: 1.2rem;
            color: var(--neon-red);
        }

        .error-retry {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--neon-red);
            color: var(--neon-red);
            padding: 12px 32px;
            border-radius: 12px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .error-retry:hover {
            background: rgba(239, 68, 68, 0.4);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        /* === RESPONSIVE === */
        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 1fr 360px;
                gap: 20px;
                padding: 20px 30px;
            }

            .header-title h1 {
                font-size: 2.2rem;
            }

            .battle-card {
                padding: 20px;
            }

            .battle-name {
                font-size: 1.6rem;
            }

            .battle-score {
                font-size: 2.8rem;
            }

            .total-value {
                font-size: 4rem;
            }
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .battle-section {
                grid-column: 1;
            }

            .right-panel {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }

            .total-card {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 900px) {
            body {
                overflow: auto;
            }

            .header {
                flex-direction: column;
                gap: 16px;
                padding: 16px 20px;
            }

            .header-info {
                align-items: center;
            }

            .main-container {
                padding: 16px 20px;
                height: auto;
            }

            .battle-section {
                grid-template-columns: 1fr;
            }

            .vs-divider {
                padding: 16px 0;
            }

            .right-panel {
                grid-template-columns: 1fr;
            }

            .combo-display {
                top: auto;
                bottom: 80px;
                right: 16px;
            }
        }

        /* Mobile phone styles */
        @media (max-width: 600px) {
            .header {
                padding: 12px 16px;
                gap: 12px;
            }

            .header-title h1 {
                font-size: 1.2rem;
                letter-spacing: 2px;
            }

            .main-container {
                padding: 12px 16px;
                gap: 12px;
            }

            .battle-card {
                padding: 16px;
            }

            .battle-card .player-name {
                font-size: 1.1rem;
            }

            .battle-card .player-score {
                font-size: 2.5rem;
            }

            .player-breakdown {
                font-size: 0.8rem;
            }

            .battle-breakdown {
                font-size: 0.75rem;
            }

            .rankings-card {
                padding: 16px;
            }

            .player-card {
                padding: 12px;
            }

            .player-card .player-name {
                font-size: 0.95rem;
            }

            .player-card .player-score {
                font-size: 1.5rem;
            }

            .player-card .player-breakdown {
                font-size: 0.75rem;
            }

            .exit-btn, .settings-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .exit-btn {
                right: 64px;
            }

            .settings-btn {
                right: 16px;
            }
        }
    </style>
    <!-- Theme Override CSS (loaded dynamically) -->
    <link rel="stylesheet" href="" id="theme-override-css">
    <style>
        /* Settings Button */
        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-btn:hover {
            background: var(--bg-card);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }
        /* Exit Button */
        .exit-btn {
            position: fixed;
            bottom: 20px;
            right: 76px;
            width: 48px;
            height: 48px;
            background: var(--bg-panel);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .exit-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        /* Theme Modal */
        .theme-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        .theme-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .theme-modal h3 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        .theme-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .theme-option {
            padding: 14px 16px;
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .theme-option:hover {
            border-color: var(--neon-cyan);
        }
        .theme-option.active {
            border-color: var(--neon-cyan);
            background: rgba(0, 240, 255, 0.1);
        }
        .theme-dot {
            width: 24px;
            height: 24px;
            border-radius: 6px;
        }
        .theme-dot.original { background: linear-gradient(135deg, #ff2d95, #00f0ff); }
        .theme-dot.cyberpunk { background: linear-gradient(135deg, #00f5ff, #ff00ff); }
        .theme-dot.executive { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animation" id="bgAnimation"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-title">
            <span class="logo-icon">&#127918;</span>
            <h1>PRODUCTIVITY ARENA</h1>
            <div class="live-badge">
                <span class="live-dot"></span>
                LIVE
            </div>
        </div>
        <div class="header-info">
            <div class="datetime" id="datetime">Loading...</div>
            <div class="active-count">
                <strong id="activeCount">--</strong> Champions Online
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- VS Battle Section -->
        <section class="battle-section" id="battleSection">
            <!-- Leader Card -->
            <div class="battle-card leader" id="leaderCard">
                <div class="battle-rank gold" id="leaderRank">&#129351;</div>
                <div class="battle-info">
                    <div class="battle-name" id="leaderName">Loading...</div>
                    <div class="battle-stats">
                        <span id="leaderItems">&#128230; -- items</span>
                        <span id="leaderRate">&#9889; --/min</span>
                    </div>
                    <div class="battle-breakdown" id="leaderBreakdown"></div>
                </div>
                <div class="battle-score gold" id="leaderScore">--</div>
            </div>

            <!-- VS Divider -->
            <div class="vs-divider">
                <div class="vs-text">VS</div>
                <div class="gap-indicator" id="gapIndicator">-- pts gap</div>
            </div>

            <!-- Challenger Card -->
            <div class="battle-card challenger" id="challengerCard">
                <div class="battle-rank" id="challengerRank">&#129352;</div>
                <div class="battle-info">
                    <div class="battle-name" id="challengerName">Loading...</div>
                    <div class="battle-stats">
                        <span id="challengerItems">&#128230; -- items</span>
                        <span id="challengerRate">&#9889; --/min</span>
                    </div>
                    <div class="battle-breakdown" id="challengerBreakdown"></div>
                </div>
                <div class="battle-score cyan" id="challengerScore">--</div>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section class="leaderboard-section">
            <div class="section-header">
                <h2>&#127942; RANKINGS</h2>
                <div class="refresh-timer" id="refreshTimer">
                    <span>&#8634;</span>
                    <span id="countdown">30s</span>
                </div>
            </div>
            <div class="leaderboard-list" id="leaderboardList">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">LOADING RANKINGS...</div>
                </div>
            </div>
        </section>

        <!-- Right Panel -->
        <aside class="right-panel">
            <!-- Total Items Card -->
            <div class="total-card">
                <div class="total-label">&#127919; TEAM POWER</div>
                <div class="total-value" id="totalItems">--</div>
                <div class="total-goal" id="totalGoal">Goal: -- items</div>
            </div>

            <!-- Department Battle -->
            <div class="dept-battle">
                <h3>&#9876;&#65039; DEPARTMENT WAR</h3>
                <div class="dept-race" id="deptRace">
                    <div class="loading-state" style="padding: 20px;">
                        <div class="loading-spinner" style="width: 40px; height: 40px;"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-box">
                    <div class="stat-box-value cyan" id="statActive">--</div>
                    <div class="stat-box-label">Active / Total</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value green" id="statVsYesterday">--</div>
                    <div class="stat-box-label">vs Yesterday</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value pink" id="statHours">--</div>
                    <div class="stat-box-label">Total Hours</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value yellow" id="statTopRate">--</div>
                    <div class="stat-box-label">Top Rate/min</div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Combo Streak Display -->
    <div class="combo-display" id="comboDisplay">
        <span class="combo-fire">&#128293;</span>
        <div class="combo-text">
            <div class="combo-number" id="comboNumber">15</div>
            <div class="combo-label">COMBO STREAK!</div>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon" id="achievementIcon">&#127942;</div>
        <div class="achievement-title" id="achievementTitle">ACHIEVEMENT!</div>
        <div class="achievement-desc" id="achievementDesc">
            <span class="achievement-name">Player</span> earned a badge!
        </div>
    </div>

    <!-- Achievement Ticker -->
    <div class="achievement-ticker">
        <div class="ticker-track" id="tickerTrack">
            <div class="ticker-item">
                <span class="ticker-icon">&#128170;</span>
                <span>Loading achievements...</span>
            </div>
        </div>
    </div>

    <!-- API Script -->
    <script src="dashboard-api.js"></script>

    <!-- Arena Controller -->
    <script>
        /**
         * PRODUCTIVITY ARENA CONTROLLER
         * Gaming-themed shop floor display
         */
        class ArenaController {
            constructor() {
                this.api = new ProductivityAPI();
                this.updateInterval = null;
                this.clockInterval = null;
                this.countdownInterval = null;
                this.previousData = [];
                this.achievements = [];
                this.isUpdating = false;
                this.countdown = 30;

                this.config = {
                    updateIntervalMs: 30000,
                    clockIntervalMs: 1000,
                    maxPlayers: 100,  // Show all clocked-in employees
                    achievementDuration: 4000,
                    comboDuration: 5000
                };

                // Achievement definitions
                this.achievementTypes = [
                    { icon: '&#128293;', title: 'SPEED DEMON!', trigger: 'fastest' },
                    { icon: '&#128170;', title: 'IRON MAN!', trigger: 'longest' },
                    { icon: '&#127942;', title: 'CHAMPION!', trigger: 'top_score' },
                    { icon: '&#9889;', title: 'LIGHTNING!', trigger: 'rate_up' },
                    { icon: '&#11088;', title: 'RISING STAR!', trigger: 'rank_up' }
                ];
            }

            async init() {
                console.log('[Arena] Initializing Productivity Arena...');

                try {
                    this.createParticles();
                    this.startClock();
                    this.startCountdown();
                    await this.loadAllData();
                    this.startAutoRefresh();
                    this.scheduleMidnightRefresh();

                    console.log('[Arena] Arena is LIVE!');
                } catch (error) {
                    console.error('[Arena] Init failed:', error);
                    this.showError('Failed to initialize arena');
                }
            }

            // === BACKGROUND PARTICLES ===
            createParticles() {
                const bg = document.getElementById('bgAnimation');
                if (!bg) return;

                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.animationDelay = `${Math.random() * 10}s`;
                    particle.style.animationDuration = `${8 + Math.random() * 6}s`;

                    const colors = ['#ff2d95', '#00f0ff', '#a855f7', '#22c55e'];
                    particle.style.background = colors[Math.floor(Math.random() * colors.length)];

                    bg.appendChild(particle);
                }
            }

            // === CLOCK ===
            startClock() {
                const updateClock = () => {
                    const now = this.api.getCurrentCentralTime();
                    const dateStr = now.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    const timeStr = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });

                    const el = document.getElementById('datetime');
                    if (el) el.textContent = `${dateStr} | ${timeStr}`;
                };

                updateClock();
                this.clockInterval = setInterval(updateClock, this.config.clockIntervalMs);
            }

            // === COUNTDOWN ===
            startCountdown() {
                const updateCountdown = () => {
                    this.countdown--;
                    if (this.countdown <= 0) this.countdown = 30;

                    const el = document.getElementById('countdown');
                    if (el) el.textContent = `${this.countdown}s`;

                    const timer = document.getElementById('refreshTimer');
                    if (timer) {
                        timer.className = this.countdown <= 5 ? 'refresh-timer active' : 'refresh-timer';
                    }
                };

                this.countdownInterval = setInterval(updateCountdown, 1000);
            }

            // === DATA LOADING ===
            async loadAllData() {
                if (this.isUpdating) return;
                this.isUpdating = true;
                this.countdown = 30;

                try {
                    const [leaderboard, teamMetrics, deptStats, achievements] = await Promise.allSettled([
                        this.api.getLeaderboard(),
                        this.api.getTeamMetrics(),
                        this.api.getDepartmentStats(),
                        this.api.getAchievementTicker()
                    ]);

                    if (leaderboard.status === 'fulfilled') {
                        this.updateBattle(leaderboard.value);
                        this.updateLeaderboard(leaderboard.value);
                    }

                    if (teamMetrics.status === 'fulfilled') {
                        this.updateTeamStats(teamMetrics.value);
                    }

                    if (deptStats.status === 'fulfilled') {
                        this.updateDepartmentBattle(deptStats.value);
                    }

                    if (achievements.status === 'fulfilled') {
                        this.updateTicker(achievements.value);
                    }

                } catch (error) {
                    console.error('[Arena] Load error:', error);
                } finally {
                    this.isUpdating = false;
                }
            }

            // === VS BATTLE ===
            updateBattle(employees) {
                if (!Array.isArray(employees) || employees.length < 2) {
                    return;
                }

                const leader = employees[0];
                const challenger = employees[1];

                // Leader
                document.getElementById('leaderName').textContent = this.escapeHtml(leader.name);
                document.getElementById('leaderScore').textContent = Math.round(leader.score || 0);
                document.getElementById('leaderItems').innerHTML = `&#128230; ${leader.items_today || 0} items`;
                document.getElementById('leaderRate').innerHTML = `&#9889; ${leader.items_per_minute || 0}/min`;

                // Challenger
                document.getElementById('challengerName').textContent = this.escapeHtml(challenger.name);
                document.getElementById('challengerScore').textContent = Math.round(challenger.score || 0);
                document.getElementById('challengerItems').innerHTML = `&#128230; ${challenger.items_today || 0} items`;
                document.getElementById('challengerRate').innerHTML = `&#9889; ${challenger.items_per_minute || 0}/min`;

                // Activity breakdowns
                const leaderBreakdown = document.getElementById('leaderBreakdown');
                const challengerBreakdown = document.getElementById('challengerBreakdown');
                if (leaderBreakdown) {
                    leaderBreakdown.innerHTML = leader.activity_breakdown || '';
                }
                if (challengerBreakdown) {
                    challengerBreakdown.innerHTML = challenger.activity_breakdown || '';
                }

                // Gap indicator
                const gap = Math.round((leader.score || 0) - (challenger.score || 0));
                const gapEl = document.getElementById('gapIndicator');
                if (gapEl) {
                    if (gap <= 10) {
                        gapEl.textContent = `${challenger.name.split(' ')[0]} IS CLOSING IN!`;
                        gapEl.style.color = 'var(--neon-red)';
                        gapEl.style.animation = 'gapPulse 0.5s ease-in-out infinite';
                    } else {
                        gapEl.textContent = `${gap} pts gap`;
                        gapEl.style.color = 'var(--neon-orange)';
                        gapEl.style.animation = 'gapPulse 2s ease-in-out infinite';
                    }
                }

                // Check for position changes
                this.checkPositionChanges(employees);
            }

            // === LEADERBOARD ===
            updateLeaderboard(employees) {
                const container = document.getElementById('leaderboardList');
                if (!container || !Array.isArray(employees)) return;

                // Update active count
                const activeCount = employees.filter(e => e.is_clocked_in).length;
                const activeEl = document.getElementById('activeCount');
                if (activeEl) activeEl.textContent = activeCount;

                if (employees.length === 0) {
                    container.innerHTML = `
                        <div class="loading-state">
                            <div style="font-size: 4rem; opacity: 0.5;">&#128564;</div>
                            <div class="loading-text">NO PLAYERS ONLINE</div>
                        </div>
                    `;
                    return;
                }

                // Skip first 2 (shown in battle section)
                const displayList = employees.slice(2, this.config.maxPlayers);

                const html = displayList.map((emp, index) => {
                    const rank = emp.rank || (index + 3);
                    const rankClass = rank === 3 ? 'rank-3' : '';
                    const rankDisplay = rank === 3 ? '&#129353;' : rank;

                    const isActive = emp.is_clocked_in;
                    const activeClass = isActive ? 'active-player' : '';
                    const statusClass = isActive ? 'stat-working' : 'stat-offline';
                    const statusIcon = isActive ? '&#128994;' : '&#9898;';
                    const statusText = isActive ? 'ONLINE' : 'OFFLINE';

                    const score = Math.round(emp.score || 0);
                    const progress = Math.min(emp.progress || 0, 100);

                    // Check for rank changes
                    const prevEmp = this.previousData.find(p => p.name === emp.name);
                    const rankUpClass = prevEmp && prevEmp.rank > rank ? 'rank-up' : '';

                    // Activity breakdown (station details)
                    const breakdown = emp.activity_breakdown || '';

                    return `
                        <div class="player-card ${activeClass} ${rankUpClass}">
                            <div class="player-rank ${rankClass}">${rankDisplay}</div>
                            <div class="player-info">
                                <div class="player-name">${this.escapeHtml(emp.name)}</div>
                                <div class="player-stats">
                                    <span class="${statusClass}">${statusIcon} ${statusText}</span>
                                    <span>&#128230; ${emp.items_today || 0}</span>
                                    <span>&#9889; ${emp.items_per_minute || 0}/min</span>
                                </div>
                                ${breakdown ? `<div class="player-breakdown">${breakdown}</div>` : ''}
                            </div>
                            <div class="player-score">${score}</div>
                            <div class="xp-bar-container">
                                <div class="xp-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
                this.previousData = [...employees];
            }

            // === TEAM STATS ===
            updateTeamStats(stats) {
                if (!stats) return;

                // Total items
                const totalItems = stats.items_finished || stats.items_today || 0;
                const totalEl = document.getElementById('totalItems');
                if (totalEl) totalEl.textContent = totalItems.toLocaleString();

                const goalEl = document.getElementById('totalGoal');
                if (goalEl) goalEl.textContent = `Goal: ${(stats.daily_goal || 20000).toLocaleString()} items`;

                // Active / Total
                const activeEl = document.getElementById('statActive');
                if (activeEl) {
                    const total = stats.total_employees || stats.total_employees_today || 0;
                    activeEl.textContent = `${stats.active_employees || 0}/${total}`;
                }

                // vs Yesterday
                const vsEl = document.getElementById('statVsYesterday');
                if (vsEl) {
                    const vs = stats.vs_yesterday || 0;
                    vsEl.innerHTML = vs >= 0 ? `&#9650; ${Math.abs(vs)}%` : `&#9660; ${Math.abs(vs)}%`;
                    vsEl.className = vs >= 0 ? 'stat-box-value green' : 'stat-box-value pink';
                }

                // Hours
                const hoursEl = document.getElementById('statHours');
                if (hoursEl) hoursEl.textContent = stats.total_hours_worked || '0';

                // Top rate
                if (this.previousData.length > 0) {
                    const topRate = Math.max(...this.previousData.map(e => parseFloat(e.items_per_minute) || 0));
                    const rateEl = document.getElementById('statTopRate');
                    if (rateEl) rateEl.textContent = topRate.toFixed(1);
                }
            }

            // === DEPARTMENT BATTLE ===
            updateDepartmentBattle(depts) {
                const container = document.getElementById('deptRace');
                if (!container || !Array.isArray(depts)) return;

                // Sort by items and get top 3
                const sorted = [...depts].sort((a, b) => (b.total_items || 0) - (a.total_items || 0)).slice(0, 3);
                const maxItems = Math.max(...sorted.map(d => d.total_items || 0), 1);

                const deptColors = {
                    'QC': 'qc',
                    'Picking': 'picking',
                    'Labeling': 'labeling',
                    'default': 'qc'
                };

                const deptIcons = {
                    'QC': '&#128270;',
                    'Picking': '&#128230;',
                    'Labeling': '&#127991;',
                    'default': '&#9889;'
                };

                const html = sorted.map((dept, index) => {
                    const name = dept.department_name || dept.name || 'Unknown';
                    const items = dept.total_items || 0;
                    const percent = Math.round((items / maxItems) * 100);
                    const colorClass = deptColors[name] || deptColors['default'];
                    const icon = deptIcons[name] || deptIcons['default'];
                    const isLeading = index === 0;

                    return `
                        <div class="dept-item">
                            <div class="dept-header">
                                <span class="dept-name ${isLeading ? 'leading' : ''}">
                                    ${icon} ${this.escapeHtml(name)}
                                    ${isLeading ? '&#128081;' : ''}
                                </span>
                                <span class="dept-score">${items.toLocaleString()}</span>
                            </div>
                            <div class="dept-bar-container">
                                <div class="dept-bar ${colorClass}" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            // === ACHIEVEMENT TICKER ===
            updateTicker(achievements) {
                const track = document.getElementById('tickerTrack');
                if (!track) return;

                const items = Array.isArray(achievements) && achievements.length > 0
                    ? achievements
                    : [
                        '&#128170; TEAM POWER ACTIVATED!',
                        '&#9889; Every item counts towards VICTORY!',
                        '&#127942; Champions are made on the floor!',
                        '&#128293; Keep the streak alive!'
                    ];

                const icons = ['&#127942;', '&#127941;', '&#11088;', '&#128170;', '&#127881;', '&#127919;', '&#128293;', '&#9889;'];

                const tickerHTML = items.map((text, i) => {
                    const icon = icons[i % icons.length];
                    return `
                        <div class="ticker-item">
                            <span class="ticker-icon">${icon}</span>
                            <span>${text}</span>
                        </div>
                    `;
                }).join('');

                track.innerHTML = tickerHTML + tickerHTML;
            }

            // === POSITION CHANGES & ACHIEVEMENTS ===
            checkPositionChanges(newData) {
                if (this.previousData.length === 0) return;

                // Check for rank-up achievements
                newData.forEach((emp, newIndex) => {
                    const prevEmp = this.previousData.find(p => p.name === emp.name);
                    if (prevEmp) {
                        const oldRank = this.previousData.indexOf(prevEmp);
                        if (newIndex < oldRank && newIndex <= 2) {
                            this.showAchievement('&#11088;', 'RISING STAR!', `${emp.name} moved to #${newIndex + 1}!`);
                        }
                    }
                });

                // Random achievement for engagement (10% chance)
                if (Math.random() < 0.1 && newData.length > 0) {
                    const randomPlayer = newData[Math.floor(Math.random() * Math.min(5, newData.length))];
                    const achievements = [
                        { icon: '&#128293;', title: 'ON FIRE!', desc: `${randomPlayer.name} is crushing it!` },
                        { icon: '&#128170;', title: 'POWER UP!', desc: `${randomPlayer.name} gained momentum!` },
                        { icon: '&#9889;', title: 'LIGHTNING FAST!', desc: `${randomPlayer.name} is unstoppable!` }
                    ];
                    const achievement = achievements[Math.floor(Math.random() * achievements.length)];
                    this.showAchievement(achievement.icon, achievement.title, achievement.desc);
                }
            }

            // === ACHIEVEMENT POPUP ===
            showAchievement(icon, title, desc) {
                const popup = document.getElementById('achievementPopup');
                const iconEl = document.getElementById('achievementIcon');
                const titleEl = document.getElementById('achievementTitle');
                const descEl = document.getElementById('achievementDesc');

                if (!popup || !iconEl || !titleEl || !descEl) return;

                iconEl.innerHTML = icon;
                titleEl.textContent = title;
                descEl.innerHTML = desc;

                popup.classList.add('show');

                setTimeout(() => {
                    popup.classList.remove('show');
                }, this.config.achievementDuration);
            }

            // === COMBO DISPLAY ===
            showCombo(count) {
                const combo = document.getElementById('comboDisplay');
                const number = document.getElementById('comboNumber');

                if (!combo || !number) return;

                number.textContent = count;
                combo.classList.add('show');

                setTimeout(() => {
                    combo.classList.remove('show');
                }, this.config.comboDuration);
            }

            // === AUTO REFRESH ===
            startAutoRefresh() {
                if (this.updateInterval) clearInterval(this.updateInterval);

                this.updateInterval = setInterval(() => {
                    console.log('[Arena] Auto-refresh triggered');
                    this.loadAllData();
                }, this.config.updateIntervalMs);

                window.addEventListener('focus', () => {
                    console.log('[Arena] Window focus - refreshing');
                    this.loadAllData();
                });
            }

            scheduleMidnightRefresh() {
                const now = this.api.getCurrentCentralTime();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 5, 0);

                const msUntilMidnight = tomorrow - now;

                setTimeout(() => {
                    console.log('[Arena] Midnight refresh - reloading');
                    window.location.reload();
                }, msUntilMidnight);

                console.log(`[Arena] Midnight refresh in ${Math.round(msUntilMidnight / 1000 / 60)} min`);
            }

            // === ERROR HANDLING ===
            showError(message) {
                const container = document.getElementById('leaderboardList');
                if (container) {
                    container.innerHTML = `
                        <div class="error-state">
                            <div class="error-icon">&#9888;</div>
                            <div class="error-message">${this.escapeHtml(message)}</div>
                            <button class="error-retry" onclick="arena.loadAllData()">RETRY</button>
                        </div>
                    `;
                }
            }

            // === UTILITIES ===
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            destroy() {
                if (this.updateInterval) clearInterval(this.updateInterval);
                if (this.clockInterval) clearInterval(this.clockInterval);
                if (this.countdownInterval) clearInterval(this.countdownInterval);
                console.log('[Arena] Controller destroyed');
            }
        }

        // === INITIALIZE ===
        let arena;

        document.addEventListener('DOMContentLoaded', () => {
            arena = new ArenaController();
            arena.init();

            window.addEventListener('beforeunload', () => {
                if (arena) arena.destroy();
            });
        });
    </script>

    <!-- Exit Button -->
    <button class="exit-btn" onclick="exitShopFloor()" title="Exit to Login">
        &#9211;
    </button>

    <!-- Settings Button -->
    <button class="settings-btn" onclick="openThemeModal()" title="Theme Settings">
        &#9881;
    </button>

    <!-- Theme Modal -->
    <div class="theme-modal" id="themeModal" onclick="if(event.target === this) closeThemeModal()">
        <div class="theme-modal-content">
            <button class="close-modal" onclick="closeThemeModal()">&times;</button>
            <h3>&#127912; Select Theme</h3>
            <div class="theme-options">
                <button class="theme-option" data-theme="original" onclick="selectShopFloorTheme('original')">
                    <span class="theme-dot original"></span>
                    Original
                </button>
                <button class="theme-option" data-theme="cyberpunk" onclick="selectShopFloorTheme('cyberpunk')">
                    <span class="theme-dot cyberpunk"></span>
                    Cyberpunk
                </button>
                <button class="theme-option" data-theme="executive" onclick="selectShopFloorTheme('executive')">
                    <span class="theme-dot executive"></span>
                    Executive
                </button>
            </div>
        </div>
    </div>

    <script>
        // Exit shop floor - clear token and redirect to login
        function exitShopFloor() {
            localStorage.removeItem('shopfloorToken');
            localStorage.removeItem('shopfloorExpiry');
            sessionStorage.removeItem('shopfloorToken');
            window.location.href = '/login.html';
        }
    </script>

    <script>
        // Theme switching for shop floor
        const THEME_CSS_MAP = {
            'original': '',
            'cyberpunk': 'css/shop-floor-cyberpunk.css',
            'executive': 'css/shop-floor-executive.css'
        };

        function openThemeModal() {
            document.getElementById('themeModal').style.display = 'block';
            updateShopFloorThemeUI();
        }

        function closeThemeModal() {
            document.getElementById('themeModal').style.display = 'none';
        }

        function updateShopFloorThemeUI() {
            const currentTheme = localStorage.getItem('selectedTheme') || 'original';
            document.querySelectorAll('.theme-option').forEach(btn => {
                const isActive = btn.dataset.theme === currentTheme;
                btn.classList.toggle('active', isActive);
            });
        }

        function selectShopFloorTheme(themeName) {
            const themeLink = document.getElementById('theme-override-css');
            const cssUrl = THEME_CSS_MAP[themeName];

            if (cssUrl) {
                themeLink.href = cssUrl;
            } else {
                themeLink.href = '';
            }

            localStorage.setItem('selectedTheme', themeName);
            updateShopFloorThemeUI();
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'original';
            selectShopFloorTheme(savedTheme);
        });
    </script>
</body>
</html>
