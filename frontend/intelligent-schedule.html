<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduling | PodFactory</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ============================================
           INDUSTRIAL DASHBOARD - Amber Theme
           Station-Based Scheduling Interface
           ============================================ */

        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-card: #1e252e;
            --bg-elevated: #262d38;
            --bg-hover: #2d3748;

            --accent-primary: #f59e0b;
            --accent-secondary: #fbbf24;
            --accent-glow: rgba(245, 158, 11, 0.15);

            --success: #22c55e;
            --success-muted: rgba(34, 197, 94, 0.15);
            --warning: #f59e0b;
            --warning-muted: rgba(245, 158, 11, 0.15);
            --danger: #ef4444;
            --danger-muted: rgba(239, 68, 68, 0.15);
            --info: #3b82f6;
            --info-muted: rgba(59, 130, 246, 0.15);

            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;

            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-accent: rgba(245, 158, 11, 0.3);

            --font-ui: 'DM Sans', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 0;
        }

        /* ============================================
           HEADER
           ============================================ */
        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo-mark {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .header-btn {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: var(--font-ui);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .header-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--border-accent);
        }

        .header-btn.primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #000;
            font-weight: 600;
        }

        .header-btn.primary:hover {
            background: var(--accent-secondary);
        }

        /* ============================================
           MAIN LAYOUT - 3 Panel
           ============================================ */
        .main-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            max-width: 1800px;
            margin: 0 auto;
            padding: var(--space-lg);
            gap: var(--space-lg);
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 70px);
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar { display: none; }
        }

        /* ============================================
           SIDEBAR - Employee Pool
           ============================================ */
        .sidebar {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            height: fit-content;
            position: sticky;
            top: 90px;
        }

        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .sidebar-search {
            width: 100%;
            padding: var(--space-sm);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-ui);
            font-size: 0.875rem;
            margin-bottom: var(--space-md);
        }

        .sidebar-search:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .employee-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            max-height: 500px;
            overflow-y: auto;
        }

        .employee-chip {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
        }

        .employee-chip:hover {
            background: var(--bg-hover);
            border-color: var(--border-accent);
        }

        .employee-chip.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .employee-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-glow);
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .employee-name {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .employee-hours {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .employee-hours.warning {
            color: var(--warning);
        }

        .employee-hours.danger {
            color: var(--danger);
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        /* Week Navigation */
        .week-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .nav-btn {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: var(--bg-elevated);
            color: var(--accent-primary);
            border-color: var(--border-accent);
        }

        .week-title {
            font-family: var(--font-mono);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 200px;
            text-align: center;
        }

        .week-actions {
            display: flex;
            gap: var(--space-sm);
        }

        /* Prediction Banner */
        .prediction-banner {
            background: var(--info-muted);
            border: 1px solid var(--info);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .prediction-banner i {
            font-size: 1.25rem;
            color: var(--info);
        }

        .prediction-text strong {
            color: var(--text-primary);
        }

        .prediction-text span {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* ============================================
           SCHEDULE GRID - Station Based
           ============================================ */
        .schedule-container {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 160px repeat(7, 1fr);
            min-width: 900px;
        }

        /* Header Row */
        .grid-header {
            display: contents;
        }

        .grid-header-cell {
            background: var(--bg-secondary);
            padding: var(--space-md);
            text-align: center;
            border-bottom: 1px solid var(--border-subtle);
            border-right: 1px solid var(--border-subtle);
        }

        .grid-header-cell:last-child {
            border-right: none;
        }

        .day-name {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
        }

        .day-date {
            font-family: var(--font-mono);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .day-today .day-date {
            color: var(--accent-primary);
        }

        /* Station Rows */
        .station-row {
            display: contents;
        }

        .station-label {
            background: var(--bg-elevated);
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-subtle);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .station-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .station-name i {
            color: var(--accent-primary);
            width: 16px;
        }

        .station-coverage {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            width: fit-content;
        }

        .station-coverage.good {
            background: var(--success-muted);
            color: var(--success);
        }

        .station-coverage.warning {
            background: var(--warning-muted);
            color: var(--warning);
        }

        .station-coverage.danger {
            background: var(--danger-muted);
            color: var(--danger);
        }

        /* Day Cells */
        .day-cell {
            background: var(--bg-card);
            padding: var(--space-sm);
            border-bottom: 1px solid var(--border-subtle);
            border-right: 1px solid var(--border-subtle);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            transition: background 0.2s ease;
        }

        .day-cell:last-child {
            border-right: none;
        }

        .day-cell.drag-over {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
        }

        .day-cell.invalid-drop {
            background: var(--danger-muted);
            border-color: var(--danger);
        }

        /* Shift Cards */
        .shift-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .shift-card:hover {
            border-color: var(--border-accent);
            background: var(--bg-hover);
        }

        .shift-card.dragging {
            opacity: 0.5;
            border: 2px dashed var(--accent-primary);
            cursor: grabbing;
        }

        /* Allow dropping on day-cell by making children not block the drop */
        body.is-dragging .day-cell .shift-card {
            pointer-events: none;
        }
        body.is-dragging .day-cell .shift-card.dragging {
            pointer-events: auto;
        }

        .shift-card[draggable="true"] {
            cursor: grab;
        }

        .shift-card .employee-name {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .shift-card .shift-time {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--accent-primary);
        }

        .shift-card .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 18px;
            height: 18px;
            background: var(--danger-muted);
            border: none;
            border-radius: 50%;
            color: var(--danger);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
        }

        .shift-card:hover .remove-btn {
            display: flex;
        }

        /* Empty Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.75rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .drop-zone.drag-over {
            border-color: var(--accent-primary);
            background: var(--accent-glow);
            color: var(--accent-primary);
        }

        /* ============================================
           TIME-OFF TAB
           ============================================ */
        .tabs-nav {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-lg);
        }

        .tab-btn {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-family: var(--font-ui);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .tab-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--accent-glow);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .tab-badge {
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Time-off Cards */
        .timeoff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--space-md);
        }

        .timeoff-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-md);
        }

        .timeoff-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .timeoff-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeoff-icon.vacation { background: var(--info-muted); color: var(--info); }
        .timeoff-icon.sick { background: var(--danger-muted); color: var(--danger); }
        .timeoff-icon.personal { background: rgba(168, 85, 247, 0.15); color: #a855f7; }

        .timeoff-info h4 { font-size: 0.9rem; color: var(--text-primary); }
        .timeoff-info span { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .timeoff-dates {
            background: var(--bg-card);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .timeoff-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .btn-approve {
            flex: 1;
            padding: var(--space-sm);
            background: var(--success);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-reject {
            padding: var(--space-sm);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--danger);
            cursor: pointer;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: var(--space-lg);
            right: var(--space-lg);
            z-index: 1000;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-color: var(--success); }
        .toast.success i { color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast.error i { color: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .loading-text {
            margin-top: var(--space-md);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Custom Dialog Modal */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .dialog-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .dialog-box {
            background: var(--bg-card);
            border: 1px solid var(--border-accent);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 420px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }
        .dialog-overlay.active .dialog-box {
            transform: scale(1);
        }
        .dialog-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-md);
            font-size: 1.5rem;
        }
        .dialog-icon.warning {
            background: var(--warning-muted);
            color: var(--warning);
        }
        .dialog-icon.danger {
            background: var(--danger-muted);
            color: var(--danger);
        }
        .dialog-icon.info {
            background: var(--info-muted);
            color: var(--info);
        }
        .dialog-title {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: var(--space-sm);
        }
        .dialog-message {
            color: var(--text-secondary);
            text-align: center;
            white-space: pre-line;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
        }
        .dialog-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
            justify-content: center;
        }
        .dialog-btn {
            padding: 0.6rem 1.5rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 0.9rem;
        }
        .dialog-btn.cancel {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }
        .dialog-btn.cancel:hover {
            background: var(--bg-hover);
        }
        .dialog-btn.confirm {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        .dialog-btn.confirm:hover {
            background: var(--accent-secondary);
        }
        .dialog-btn.danger {
            background: var(--danger);
            color: white;
        }
        .dialog-btn.danger:hover {
            filter: brightness(1.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--bg-hover); }

        /* ============================================
           EDIT SHIFT MODAL
           ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            padding: var(--space-lg);
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--danger-muted);
            color: var(--danger);
            border-color: var(--danger);
        }

        .form-group {
            margin-bottom: var(--space-md);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }

        .form-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }

        .modal-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-lg);
        }

        .modal-btn {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-family: var(--font-ui);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.secondary {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .modal-btn.secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-btn.primary {
            background: var(--accent-primary);
            border: 1px solid var(--accent-primary);
            color: #000;
        }

        .modal-btn.primary:hover {
            background: var(--accent-secondary);
        }

        .shift-info {
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .shift-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
        }

        .shift-info-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .shift-info-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* ============================================
           MOBILE OPTIMIZATION
           ============================================ */

        /* Mobile Menu Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 200;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-primary);
            font-size: 18px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            transition: all 0.2s ease;
        }

        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 149;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Sidebar Close Button */
        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .sidebar-close-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }

        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
            display: none;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }

        .mobile-bottom-nav__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 10px;
            gap: 4px;
            padding: 8px 12px;
            min-width: 64px;
            min-height: 44px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .mobile-bottom-nav__item i {
            font-size: 20px;
        }

        .mobile-bottom-nav__item.active {
            color: var(--accent-primary);
            background: var(--accent-glow);
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .mobile-menu-toggle {
                display: flex !important;
            }

            .mobile-bottom-nav {
                display: flex;
            }

            body {
                padding-bottom: 60px;
            }

            .sidebar {
                position: fixed !important;
                left: -100% !important;
                top: 0 !important;
                width: 280px !important;
                height: 100vh !important;
                z-index: 150 !important;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
                display: block !important;
            }

            .sidebar.active {
                left: 0 !important;
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5) !important;
            }

            .sidebar-close-btn {
                display: flex;
            }

            .main-layout {
                grid-template-columns: 1fr !important;
            }

            .app-header {
                padding-left: 60px;
            }

            .header-content {
                padding: var(--space-sm) var(--space-md);
                padding-left: 50px;
            }

            .header-actions {
                gap: var(--space-xs);
            }

            .header-btn span {
                display: none;
            }

            .header-btn {
                padding: var(--space-sm);
            }

            /* Schedule Grid Mobile */
            .schedule-grid {
                min-width: 100% !important;
            }

            .day-column {
                min-width: 100px !important;
            }

            /* Touch targets */
            .shift-card {
                min-height: 44px;
            }

            .btn, button {
                min-height: 44px;
            }

            /* Main content padding */
            .main-content {
                padding: var(--space-md) !important;
            }
        }

        @media (max-width: 768px) {
            .schedule-header {
                flex-direction: column;
                gap: var(--space-md);
                align-items: stretch;
            }

            .week-nav {
                justify-content: center;
            }

            .header-actions-group {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Custom Dialog Modal -->
    <div id="dialogOverlay" class="dialog-overlay">
        <div class="dialog-box">
            <div id="dialogIcon" class="dialog-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div id="dialogTitle" class="dialog-title">Confirm Action</div>
            <div id="dialogMessage" class="dialog-message">Are you sure?</div>
            <div id="dialogButtons" class="dialog-buttons">
                <button class="dialog-btn cancel" onclick="resolveDialog(false)">Cancel</button>
                <button class="dialog-btn confirm" onclick="resolveDialog(true)">Confirm</button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="app-header">
        <div class="header-content">
            <a href="manager.html" class="logo">
                <div class="logo-mark"><i class="fas fa-chart-line"></i></div>
                PodFactory
            </a>
            <span id="scheduleStatus" style="padding: 0.5rem 1rem; border-radius: 6px; background: rgba(255,255,255,0.1); font-size: 0.875rem;">
                <i class="fas fa-circle" style="color:var(--text-muted)"></i> Not Saved
            </span>
            <div class="header-actions">
                <button class="header-btn" onclick="openTemplateModal()">
                    <i class="fas fa-copy"></i>
                    Templates
                </button>
                <button class="header-btn" onclick="autoFillSchedule()">
                    <i class="fas fa-magic"></i>
                    Auto-Fill
                </button>
                <button class="header-btn" onclick="clearSchedule()" style="background:var(--danger);">
                    <i class="fas fa-trash-alt"></i>
                    Clear
                </button>
                <button class="header-btn" onclick="saveDraft()">
                    <i class="fas fa-save"></i>
                    Save Draft
                </button>
                <button class="header-btn" onclick="publishSchedule()" style="background:var(--success);color:white;">
                    <i class="fas fa-paper-plane"></i>
                    Publish
                </button>
                <button class="header-btn" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i>
                    Export PDF
                </button>
                <a href="manager.html" class="header-btn">
                    <i class="fas fa-arrow-left"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="main-layout">
        <!-- SIDEBAR - Employee Pool -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close-btn" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
            <div class="sidebar-title">
                <i class="fas fa-users"></i>
                Employees
            </div>
            <input type="text" class="sidebar-search" placeholder="Search..." oninput="filterEmployees(this.value)">
            <div class="employee-list" id="employeeList">
                <!-- Loaded dynamically -->
            </div>
        </aside>

        <!-- Sidebar Overlay (for mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- Tabs -->
            <nav class="tabs-nav">
                <button class="tab-btn active" data-tab="schedule">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule
                </button>
                <button class="tab-btn" data-tab="timeoff">
                    <i class="fas fa-umbrella-beach"></i>
                    Time-Off
                    <span class="tab-badge" id="timeoffBadge" style="display:none;">0</span>
                </button>
            </nav>

            <!-- SCHEDULE TAB -->
            <div class="tab-content active" id="tab-schedule">
                <!-- Week Header -->
                <div class="week-header">
                    <div class="week-nav">
                        <button class="nav-btn" onclick="changeWeek(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="week-title" id="weekTitle">Dec 16 - 22, 2025</span>
                        <button class="nav-btn" onclick="changeWeek(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="week-actions">
                        <button class="header-btn" onclick="goToToday()">
                            <i class="fas fa-calendar-day"></i>
                            Today
                        </button>
                    </div>
                </div>

                <!-- Prediction Banner -->
                <div class="prediction-banner">
                    <i class="fas fa-robot"></i>
                    <div class="prediction-text">
                        <strong id="predictionOrders">~350 orders predicted this week</strong><br>
                        <span id="predictionStaff">Recommended: 8-10 staff members</span>
                    </div>
                </div>

                <!-- Schedule Grid -->
                <div class="schedule-container" style="overflow-x: auto;">
                    <div class="schedule-grid" id="scheduleGrid">
                        <!-- Built dynamically -->
                    </div>
                </div>
            </div>

            <!-- TIME-OFF TAB -->
            <div class="tab-content" id="tab-timeoff">
                <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                    <i class="fas fa-clock"></i> Pending Requests
                </h3>
                <div class="timeoff-grid" id="timeoffGrid">
                    <!-- Loaded dynamically -->
                </div>

                <h3 style="color: var(--text-primary); margin: 2rem 0 1rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <i class="fas fa-history"></i> Decision History
                </h3>
                <div style="display:flex;gap:1rem;margin-bottom:1rem;align-items:center;">
                    <input type="text" id="historySearch" placeholder="Search by name..."
                           oninput="filterHistory()"
                           style="flex:1;max-width:250px;padding:0.5rem 0.75rem;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-elevated);color:var(--text-primary);font-size:0.85rem;">
                    <select id="historyStatusFilter" onchange="filterHistory()"
                            style="padding:0.5rem 0.75rem;border:1px solid var(--border-color);border-radius:var(--radius-sm);background:var(--bg-elevated);color:var(--text-primary);font-size:0.85rem;">
                        <option value="all">All Status</option>
                        <option value="approved">Approved</option>
                        <option value="denied">Denied</option>
                    </select>
                    <span id="historyCount" style="color:var(--text-muted);font-size:0.8rem;"></span>
                </div>
                <div id="timeoffHistory">
                    <!-- Loaded dynamically -->
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Edit Shift Modal -->
    <div class="modal-overlay" id="editShiftModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Edit Shift</h3>
                <button class="modal-close" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="shift-info">
                <div class="shift-info-row">
                    <span class="shift-info-label">Employee</span>
                    <span class="shift-info-value" id="modalEmployeeName">-</span>
                </div>
                <div class="shift-info-row">
                    <span class="shift-info-label">Station</span>
                    <span class="shift-info-value" id="modalStation">-</span>
                </div>
                <div class="shift-info-row">
                    <span class="shift-info-label">Date</span>
                    <span class="shift-info-value" id="modalDate">-</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Start Time</label>
                    <input type="time" class="form-input" id="modalStartTime" value="06:00">
                </div>
                <div class="form-group">
                    <label class="form-label">End Time</label>
                    <input type="time" class="form-input" id="modalEndTime" value="14:30">
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveShiftEdit()">
                    <i class="fas fa-check"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- CONFLICT MODAL -->
    <div class="modal-overlay" id="conflictModal" onclick="closeConflictModal()">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Time-Off Conflicts</h3>
                <button class="modal-close" onclick="closeConflictModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">These employees have approved time-off on scheduled days:</p>
            <div id="conflictList" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeConflictModal()">Cancel</button>
                <button class="modal-btn primary" onclick="applyAutoFillWithConflicts()">
                    <i class="fas fa-check"></i> Apply Anyway (Skip Conflicts)
                </button>
            </div>
        </div>
    </div>

    <!-- TEMPLATE MODAL -->
    <div class="modal-overlay" id="templateModal" onclick="closeTemplateModal()">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-copy"></i> Schedule Templates</h3>
                <button class="modal-close" onclick="closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div style="margin-bottom: 1rem;">
                <label class="form-label">Save Current Schedule as Template</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" class="form-input" id="templateName" placeholder="Template name...">
                    <button class="modal-btn primary" onclick="saveTemplate()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>

            <hr style="border-color: var(--border-color); margin: 1rem 0;">

            <label class="form-label">Load Template</label>
            <div id="templateList" style="max-height: 250px; overflow-y: auto;"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_BASE = 'http://127.0.0.1:5000/api';
        let currentWeekStart = getMonday(new Date());
        let employees = [];
        let schedule = {}; // { 'heat_press': { '2025-12-16': [{employee_id, name, time}] } }
        let editingShift = null; // Track which shift is being edited
        let approvedTimeOff = {}; // { employee_id: ['2025-12-16', '2025-12-17'] }
        let pendingTimeOff = {}; // { employee_id: ['2025-12-16', '2025-12-17'] } - pending requests
        let pendingAutoFill = null; // Store pending auto-fill for conflict resolution

        // Nickname mapping for template name resolution (edit here to add more)
        const NICKNAME_MAP = {
            'hiep': 'hoang',
            'gaby': 'gabrielle', 'gabby': 'gabrielle',
            'vinnie': 'vincent', 'vinny': 'vincent',
            'nicole': 'nichole', 'nicky': 'nichole',
            'krstal': 'kristal', 'crystal': 'kristal',
            'mike': 'michael', 'mikey': 'michael',
            'rob': 'roberto', 'bob': 'roberto',
            'chris': 'cristal', 'kris': 'kristal',
            'eddie': 'eduardo', 'ed': 'eduardo',
            'nate': 'nathan', 'nat': 'nathan',
            'andy': 'andrea', 'andi': 'andrea',
            'fan': 'fannie', 'fanny': 'fannie',
            'vic': 'vicente', 'vince': 'vincent'
        };

        // Station Configuration
        const STATIONS = [
            { id: 'heat_press', name: 'Heat Press', icon: 'fa-fire', needed: 2 },
            { id: 'qc', name: 'QC', icon: 'fa-check-double', needed: 2 },
            { id: 'film', name: 'Film', icon: 'fa-film', needed: 1 },
            { id: 'picking', name: 'Picking', icon: 'fa-hand-pointer', needed: 1 },
            { id: 'labeling', name: 'Labeling', icon: 'fa-tags', needed: 1 }
        ];

        // ============================================
        // UTILITIES
        // ============================================
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }

        function formatDate(date) {
            // Use local time components to avoid UTC timezone shift
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function formatTime(time) {
            if (!time) return '6:00';
            // Convert 24h to 12h format or just return clean format
            const [h, m] = time.split(':');
            return `${h}:${m || '00'}`;
        }

        function getStationName(stationId) {
            const station = STATIONS.find(s => s.id === stationId);
            return station ? station.name : stationId;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Loading overlay functions
        function showLoading(text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            overlay.querySelector('.loading-text').textContent = text;
            overlay.classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Custom dialog functions (replaces browser confirm/alert)
        let dialogResolve = null;

        function showDialog({ title, message, type = 'warning', confirmText = 'Confirm', cancelText = 'Cancel', showCancel = true, danger = false }) {
            return new Promise((resolve) => {
                dialogResolve = resolve;
                const overlay = document.getElementById('dialogOverlay');
                const iconEl = document.getElementById('dialogIcon');
                const titleEl = document.getElementById('dialogTitle');
                const msgEl = document.getElementById('dialogMessage');
                const buttonsEl = document.getElementById('dialogButtons');

                // Set icon based on type
                const icons = {
                    warning: 'fa-exclamation-triangle',
                    danger: 'fa-trash-alt',
                    info: 'fa-info-circle',
                    question: 'fa-question-circle'
                };
                iconEl.className = `dialog-icon ${type}`;
                iconEl.innerHTML = `<i class="fas ${icons[type] || icons.warning}"></i>`;

                titleEl.textContent = title;
                msgEl.textContent = message;

                // Build buttons
                const confirmClass = danger ? 'dialog-btn danger' : 'dialog-btn confirm';
                if (showCancel) {
                    buttonsEl.innerHTML = `
                        <button class="dialog-btn cancel" onclick="resolveDialog(false)">${cancelText}</button>
                        <button class="${confirmClass}" onclick="resolveDialog(true)">${confirmText}</button>
                    `;
                } else {
                    buttonsEl.innerHTML = `
                        <button class="dialog-btn confirm" onclick="resolveDialog(true)">${confirmText}</button>
                    `;
                }

                overlay.classList.add('active');
            });
        }

        function resolveDialog(result) {
            document.getElementById('dialogOverlay').classList.remove('active');
            if (dialogResolve) {
                dialogResolve(result);
                dialogResolve = null;
            }
        }

        // Shorthand helpers
        async function confirmDialog(title, message, options = {}) {
            return showDialog({ title, message, type: 'warning', ...options });
        }

        async function alertDialog(title, message, options = {}) {
            return showDialog({ title, message, type: 'info', showCancel: false, confirmText: 'OK', ...options });
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');

                if (btn.dataset.tab === 'timeoff') loadTimeOffRequests();
            });
        });

        // ============================================
        // WEEK NAVIGATION
        // ============================================
        async function changeWeek(delta) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            updateWeekDisplay();
            schedule = {}; // Clear current schedule
            await loadPublishedSchedule(); // Load from DB for new week
            buildScheduleGrid();
            renderEmployeeList(); // Refresh time-off badges for new week
        }

        async function goToToday() {
            currentWeekStart = getMonday(new Date());
            updateWeekDisplay();
            schedule = {}; // Clear current schedule
            await loadPublishedSchedule(); // Load from DB
            buildScheduleGrid();
            renderEmployeeList(); // Refresh time-off badges for new week
        }

        function updateWeekDisplay() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            document.getElementById('weekTitle').textContent =
                `${formatDisplayDate(currentWeekStart)} - ${formatDisplayDate(endDate)}, ${endDate.getFullYear()}`;
        }

        // ============================================
        // LOAD EMPLOYEES
        // ============================================
        async function loadEmployees() {
            try {
                const response = await fetch(`${API_BASE}/schedule/employees/all`);
                if (response.ok) {
                    const data = await response.json();
                    employees = data.employees || [];
                }
            } catch (error) {
                // Fallback sample data
                employees = [
                    { id: 1, name: 'Alex Johnson', hours: 32 },
                    { id: 2, name: 'Maria Garcia', hours: 28 },
                    { id: 3, name: 'John Smith', hours: 40 },
                    { id: 4, name: 'Sarah Wilson', hours: 24 },
                    { id: 5, name: 'Mike Brown', hours: 36 },
                    { id: 6, name: 'Emily Davis', hours: 20 }
                ];
            }
            renderEmployeeList();
        }

        function renderEmployeeList(filter = '') {
            const list = document.getElementById('employeeList');
            const filtered = employees.filter(e =>
                e.name.toLowerCase().includes(filter.toLowerCase())
            );

            // Get current week dates
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(formatDate(d));
            }

            list.innerHTML = filtered.map(emp => {
                const hoursClass = emp.hours >= 40 ? 'danger' : emp.hours >= 32 ? 'warning' : '';

                // Check time-off status for this week
                const hasApprovedThisWeek = weekDates.some(d => isEmployeeOnTimeOff(emp.id, d));
                const hasPendingThisWeek = weekDates.some(d => isEmployeePendingTimeOff(emp.id, d));

                let badge = '';
                let tooltip = '';
                if (hasApprovedThisWeek) {
                    badge = '<span style="position:absolute;top:-2px;right:-2px;width:10px;height:10px;background:#ef4444;border-radius:50%;border:2px solid var(--bg-card);" title="Approved time-off this week"></span>';
                    tooltip = 'Approved OFF';
                } else if (hasPendingThisWeek) {
                    badge = '<span style="position:absolute;top:-2px;right:-2px;width:10px;height:10px;background:#f59e0b;border-radius:50%;border:2px solid var(--bg-card);" title="Pending time-off request"></span>';
                    tooltip = 'Pending request';
                }

                return `
                    <div class="employee-chip" draggable="true"
                         data-id="${emp.id}" data-name="${emp.name}"
                         ondragstart="handleDragStart(event)"
                         ondragend="handleDragEnd(event)"
                         ${tooltip ? `title="${tooltip}"` : ''}>
                        <div class="employee-avatar" style="position:relative;">
                            ${getInitials(emp.name)}
                            ${badge}
                        </div>
                        <span class="employee-name">${emp.name}</span>
                        <span class="employee-hours ${hoursClass}">${emp.hours || 0}h</span>
                    </div>
                `;
            }).join('');
        }

        function filterEmployees(query) {
            renderEmployeeList(query);
        }

        // Get total shift count across all stations/dates (used by save/publish/clear)
        function getShiftCount() {
            return Object.values(schedule).reduce((total, dates) =>
                total + Object.values(dates).reduce((t, shifts) => t + shifts.length, 0), 0
            );
        }

        // Update only time-off badges without full re-render (P7 optimization)
        function updateTimeOffBadges() {
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(formatDate(d));
            }

            document.querySelectorAll('.employee-chip').forEach(chip => {
                const empId = parseInt(chip.dataset.id);
                const avatar = chip.querySelector('.employee-avatar');
                if (!avatar) return;

                // Remove existing badge
                const existingBadge = avatar.querySelector('span[style*="position:absolute"]');
                if (existingBadge) existingBadge.remove();

                // Check time-off status
                const hasApproved = weekDates.some(d => isEmployeeOnTimeOff(empId, d));
                const hasPending = weekDates.some(d => isEmployeePendingTimeOff(empId, d));

                if (hasApproved) {
                    avatar.insertAdjacentHTML('beforeend', '<span style="position:absolute;top:-2px;right:-2px;width:10px;height:10px;background:#ef4444;border-radius:50%;border:2px solid var(--bg-card);" title="Approved time-off this week"></span>');
                    chip.title = 'Approved OFF';
                } else if (hasPending) {
                    avatar.insertAdjacentHTML('beforeend', '<span style="position:absolute;top:-2px;right:-2px;width:10px;height:10px;background:#f59e0b;border-radius:50%;border:2px solid var(--bg-card);" title="Pending time-off request"></span>');
                    chip.title = 'Pending request';
                } else {
                    chip.title = '';
                }
            });
        }

        // ============================================
        // BUILD SCHEDULE GRID
        // ============================================
        function buildScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            let html = '';

            // Header Row
            html += '<div class="grid-header">';
            html += '<div class="grid-header-cell"><span style="font-size:0.75rem;color:var(--text-muted);">STATION</span></div>';

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const isToday = date.getTime() === today.getTime();
                html += `
                    <div class="grid-header-cell ${isToday ? 'day-today' : ''}">
                        <div class="day-name">${days[i]}</div>
                        <div class="day-date">${date.getDate()}</div>
                    </div>
                `;
            }
            html += '</div>';

            // Station Rows
            STATIONS.forEach(station => {
                html += '<div class="station-row">';

                // Station Label
                const coverage = getStationCoverage(station.id);
                const coverageClass = coverage >= station.needed ? 'good' :
                                     coverage >= station.needed * 0.5 ? 'warning' : 'danger';
                html += `
                    <div class="station-label">
                        <div class="station-name">
                            <i class="fas ${station.icon}"></i>
                            ${station.name}
                        </div>
                        <div class="station-coverage ${coverageClass}">
                            Need ${station.needed}/day
                        </div>
                    </div>
                `;

                // Day Cells
                for (let i = 0; i < 7; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + i);
                    const dateStr = formatDate(date);
                    const shifts = getShiftsForCell(station.id, dateStr);

                    html += `
                        <div class="day-cell"
                             data-station="${station.id}"
                             data-date="${dateStr}"
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)"
                             ondrop="handleDrop(event)">
                            ${shifts.map(s => {
                                const safeName = s.name.replace(/'/g, "\\'");
                                return `
                                <div class="shift-card" data-employee-id="${s.employee_id}"
                                     data-employee-name="${s.name.replace(/"/g, '&quot;')}"
                                     draggable="true"
                                     ondragstart="handleShiftDragStart(event, '${station.id}', '${dateStr}', ${s.employee_id}, '${safeName}')"
                                     ondragend="handleDragEnd(event)"
                                     onclick="openEditModal('${station.id}', '${dateStr}', ${s.employee_id})">
                                    <div class="employee-name">${s.name}</div>
                                    <div class="shift-time">${formatTime(s.start_time)} - ${formatTime(s.end_time)}</div>
                                    <button class="remove-btn" onclick="event.stopPropagation(); removeShift('${station.id}', '${dateStr}', ${s.employee_id})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>`;
                            }).join('')}
                            ${shifts.length === 0 ? '<div class="drop-zone">Drop here</div>' : ''}
                        </div>
                    `;
                }

                html += '</div>';
            });

            grid.innerHTML = html;
        }

        function getStationCoverage(stationId) {
            if (!schedule[stationId]) return 0;
            const dates = Object.keys(schedule[stationId]);
            if (dates.length === 0) return 0;
            const total = dates.reduce((sum, date) => sum + (schedule[stationId][date]?.length || 0), 0);
            return Math.round(total / Math.max(dates.length, 1));
        }

        function getShiftsForCell(stationId, dateStr) {
            return schedule[stationId]?.[dateStr] || [];
        }

        // Render HTML content for a single cell (P3 optimization)
        function renderCellContent(stationId, dateStr) {
            const shifts = getShiftsForCell(stationId, dateStr);
            if (shifts.length === 0) {
                return '<div class="drop-zone">Drop here</div>';
            }
            return shifts.map(s => {
                const safeName = s.name.replace(/'/g, "\\'");
                return `
                <div class="shift-card" data-employee-id="${s.employee_id}"
                     data-employee-name="${s.name.replace(/"/g, '&quot;')}"
                     draggable="true"
                     ondragstart="handleShiftDragStart(event, '${stationId}', '${dateStr}', ${s.employee_id}, '${safeName}')"
                     ondragend="handleDragEnd(event)"
                     onclick="openEditModal('${stationId}', '${dateStr}', ${s.employee_id})">
                    <div class="employee-name">${s.name}</div>
                    <div class="shift-time">${formatTime(s.start_time)} - ${formatTime(s.end_time)}</div>
                    <button class="remove-btn" onclick="event.stopPropagation(); removeShift('${stationId}', '${dateStr}', ${s.employee_id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>`;
            }).join('');
        }

        // Update a single cell without rebuilding entire grid (P3 optimization)
        function updateCell(stationId, dateStr) {
            const cell = document.querySelector(`.day-cell[data-station="${stationId}"][data-date="${dateStr}"]`);
            if (cell) {
                cell.innerHTML = renderCellContent(stationId, dateStr);
            }
        }

        // ============================================
        // DRAG AND DROP
        // ============================================
        let draggedEmployee = null;
        let dragSource = null; // Tracks where drag started (for moving between stations)

        // Drag from sidebar (employee pool)
        function handleDragStart(e) {
            draggedEmployee = {
                id: parseInt(e.target.dataset.id),
                name: e.target.dataset.name
            };
            dragSource = null; // From sidebar, not from schedule
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        // Drag from schedule grid (existing shift)
        function handleShiftDragStart(e, stationId, dateStr, employeeId, employeeName) {
            e.stopPropagation();
            draggedEmployee = {
                id: employeeId,
                name: employeeName
            };
            dragSource = { station: stationId, date: dateStr }; // From schedule
            e.target.classList.add('dragging');
            document.body.classList.add('is-dragging'); // Enable drop zones
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', employeeId); // Required for Firefox
            console.log('Drag started:', employeeName, 'from', stationId, dateStr);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.body.classList.remove('is-dragging');
            draggedEmployee = null;
            dragSource = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');

            const stationId = e.currentTarget.dataset.station;
            const dateStr = e.currentTarget.dataset.date;

            // Check for conflicts (but allow same-day station moves)
            if (draggedEmployee) {
                const isMovingOnSameDay = dragSource && dragSource.date === dateStr;
                const isDifferentStation = !dragSource || dragSource.station !== stationId;

                if (isEmployeeScheduled(draggedEmployee.id, dateStr) && !isMovingOnSameDay) {
                    e.currentTarget.classList.add('invalid-drop');
                    e.currentTarget.classList.remove('drag-over');
                }
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
            e.currentTarget.classList.remove('invalid-drop');
        }

        async function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            e.currentTarget.classList.remove('invalid-drop');

            console.log('Drop event:', draggedEmployee, 'dragSource:', dragSource);
            if (!draggedEmployee) {
                console.warn('No draggedEmployee - drop ignored');
                return;
            }

            // Save values before any async operations
            const employee = { ...draggedEmployee };
            const source = dragSource ? { ...dragSource } : null;
            const targetStation = e.currentTarget.dataset.station;
            const targetDate = e.currentTarget.dataset.date;

            // Moving within schedule (station-to-station)
            if (source) {
                // Same cell - do nothing
                if (source.station === targetStation && source.date === targetDate) {
                    return;
                }

                // Moving to different day - check time-off and conflicts
                if (source.date !== targetDate) {
                    if (isEmployeeOnTimeOff(employee.id, targetDate)) {
                        showToast(`${employee.name} has approved time-off on this day`, 'error');
                        return;
                    }
                    if (isEmployeeScheduled(employee.id, targetDate)) {
                        showToast(`${employee.name} is already scheduled on this day`, 'error');
                        return;
                    }
                    const hasPending = isEmployeePendingTimeOff(employee.id, targetDate);
                    if (hasPending) {
                        const confirmed = await confirmDialog('Pending Time-Off', `${employee.name} has a PENDING time-off request for this day.\n\nMove anyway?`, { confirmText: 'Move Anyway' });
                        if (!confirmed) return;
                    }
                }

                // Get shift data before removing
                const oldShift = schedule[source.station]?.[source.date]?.find(s => s.employee_id === employee.id);
                const shiftTimes = oldShift ? { start_time: oldShift.start_time, end_time: oldShift.end_time } : { start_time: '06:00', end_time: '14:30' };

                // Remove from source (without triggering status update)
                if (schedule[source.station]?.[source.date]) {
                    schedule[source.station][source.date] = schedule[source.station][source.date].filter(
                        s => s.employee_id !== employee.id
                    );
                }

                // Add to target
                if (!schedule[targetStation]) schedule[targetStation] = {};
                if (!schedule[targetStation][targetDate]) schedule[targetStation][targetDate] = [];
                schedule[targetStation][targetDate].push({
                    employee_id: employee.id,
                    name: employee.name,
                    ...shiftTimes
                });

                // Mark as unsaved
                scheduleStatus = 'unsaved';
                updateStatusIndicator();
                // P3: Update both source and target cells
                updateCell(source.station, source.date);
                updateCell(targetStation, targetDate);

                showToast(`${employee.name} moved to ${getStationName(targetStation)}`);
                return;
            }

            // Adding from sidebar (existing behavior)
            if (isEmployeeOnTimeOff(employee.id, targetDate)) {
                showToast(`${employee.name} has approved time-off on this day`, 'error');
                return;
            }

            const hasPending = isEmployeePendingTimeOff(employee.id, targetDate);
            if (hasPending) {
                const confirmed = await confirmDialog('Pending Time-Off', `${employee.name} has a PENDING time-off request for this day.\n\nSchedule anyway?`, { confirmText: 'Schedule Anyway' });
                if (!confirmed) return;
            }

            if (isEmployeeScheduled(employee.id, targetDate)) {
                showToast(`${employee.name} is already scheduled on this day`, 'error');
                return;
            }

            addShift(targetStation, targetDate, employee);
            updateCell(targetStation, targetDate); // P3: targeted update
            showToast(`${employee.name} added${hasPending ? ' (pending request!)' : ''}`);
        }

        // Helper to get station display name
        function getStationName(stationId) {
            const station = STATIONS.find(s => s.id === stationId);
            return station ? station.name : stationId;
        }

        // Check if employee has approved time-off on a date
        function isEmployeeOnTimeOff(employeeId, dateStr) {
            const empId = parseInt(employeeId); // Ensure integer for object key lookup
            const dates = approvedTimeOff[empId] || [];
            return dates.includes(dateStr);
        }

        // Check if employee has PENDING time-off on a date
        function isEmployeePendingTimeOff(employeeId, dateStr) {
            const empId = parseInt(employeeId); // Ensure integer for object key lookup
            const dates = pendingTimeOff[empId] || [];
            return dates.includes(dateStr);
        }

        // Helper to parse time-off dates from request
        // Use dates array if provided (specific non-consecutive days), else generate range
        function parseTimeOffDates(req) {
            if (req.dates && req.dates.length > 0) {
                return req.dates; // Specific dates selected
            }
            // Fallback: generate range from start_date to end_date
            const dates = [];
            const start = new Date(req.start_date + 'T00:00:00');
            const end = new Date(req.end_date + 'T00:00:00');
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(formatDate(new Date(d)));
            }
            return dates;
        }

        // Load approved AND pending time-off
        async function loadApprovedTimeOff() {
            try {
                // Load approved
                const approvedRes = await fetch(`${API_BASE}/manager/time-off/approved`);
                if (approvedRes.ok) {
                    const data = await approvedRes.json();
                    approvedTimeOff = {};
                    (data.time_off || []).forEach(req => {
                        const empId = req.employee_id;
                        if (!approvedTimeOff[empId]) approvedTimeOff[empId] = [];
                        approvedTimeOff[empId].push(...parseTimeOffDates(req));
                    });
                }

                // Load pending
                const pendingRes = await fetch(`${API_BASE}/manager/time-off/pending`);
                if (pendingRes.ok) {
                    const data = await pendingRes.json();
                    pendingTimeOff = {};
                    (data.requests || []).forEach(req => {
                        const empId = req.employee_id;
                        if (!pendingTimeOff[empId]) pendingTimeOff[empId] = [];
                        pendingTimeOff[empId].push(...parseTimeOffDates(req));
                    });
                }

                // Update only badges, not full re-render (P7 optimization)
                updateTimeOffBadges();
            } catch (error) {
                console.log('Could not load time-off data');
            }
        }

        function isEmployeeScheduled(employeeId, dateStr) {
            for (const station of Object.keys(schedule)) {
                const shifts = schedule[station]?.[dateStr] || [];
                if (shifts.some(s => s.employee_id === employeeId)) {
                    return true;
                }
            }
            return false;
        }

        function addShift(stationId, dateStr, employee) {
            if (!schedule[stationId]) schedule[stationId] = {};
            if (!schedule[stationId][dateStr]) schedule[stationId][dateStr] = [];

            schedule[stationId][dateStr].push({
                employee_id: employee.id,
                name: employee.name,
                start_time: '06:00',
                end_time: '14:30'
            });

            // Mark as unsaved when modified
            scheduleStatus = 'unsaved';
            updateStatusIndicator();
        }

        function removeShift(stationId, dateStr, employeeId) {
            if (schedule[stationId]?.[dateStr]) {
                schedule[stationId][dateStr] = schedule[stationId][dateStr].filter(
                    s => s.employee_id !== employeeId
                );
                updateCell(stationId, dateStr); // P3: targeted update instead of full rebuild
                showToast('Shift removed');

                // Mark as unsaved when modified
                scheduleStatus = 'unsaved';
                updateStatusIndicator();
            }
        }

        // ============================================
        // EDIT SHIFT MODAL
        // ============================================
        function openEditModal(stationId, dateStr, employeeId) {
            const shifts = schedule[stationId]?.[dateStr] || [];
            const shift = shifts.find(s => s.employee_id === employeeId);

            if (!shift) return;

            editingShift = { stationId, dateStr, employeeId };

            // Populate modal
            document.getElementById('modalEmployeeName').textContent = shift.name;
            document.getElementById('modalStation').textContent = getStationName(stationId);
            document.getElementById('modalDate').textContent = dateStr;
            document.getElementById('modalStartTime').value = shift.start_time || '06:00';
            document.getElementById('modalEndTime').value = shift.end_time || '14:30';

            // Show modal
            document.getElementById('editShiftModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editShiftModal').classList.remove('active');
            editingShift = null;
        }

        function closeModal(event) {
            if (event.target === event.currentTarget) {
                closeEditModal();
            }
        }

        function saveShiftEdit() {
            if (!editingShift) return;

            const { stationId, dateStr, employeeId } = editingShift;
            const shifts = schedule[stationId]?.[dateStr] || [];
            const shift = shifts.find(s => s.employee_id === employeeId);

            if (shift) {
                shift.start_time = document.getElementById('modalStartTime').value;
                shift.end_time = document.getElementById('modalEndTime').value;

                updateCell(stationId, dateStr); // P3: targeted update
                showToast('Shift time updated');
            }

            closeEditModal();
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
                closeConflictModal();
                closeTemplateModal();
            }
        });

        // ============================================
        // AUTO-FILL SCHEDULE (with conflict detection)
        // ============================================
        function autoFillSchedule() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                days.push(formatDate(date));
            }

            // Build proposed assignments and check for conflicts
            const proposed = [];
            const approvedConflicts = [];
            const pendingWarnings = [];
            const tempHours = {}; // Track hours during planning

            employees.forEach(emp => {
                tempHours[emp.id] = emp.hours || 0;
            });

            STATIONS.forEach(station => {
                days.forEach(dateStr => {
                    const currentShifts = getShiftsForCell(station.id, dateStr);
                    const needed = station.needed - currentShifts.length;

                    if (needed > 0) {
                        // Find available employees (not already scheduled, under 40h)
                        const available = employees.filter(emp =>
                            !isEmployeeScheduled(emp.id, dateStr) &&
                            tempHours[emp.id] < 40 &&
                            !proposed.some(p => p.employee_id === emp.id && p.date === dateStr)
                        );

                        // Categorize by time-off status
                        const withApproved = available.filter(emp => isEmployeeOnTimeOff(emp.id, dateStr));
                        const withPending = available.filter(emp => !isEmployeeOnTimeOff(emp.id, dateStr) && isEmployeePendingTimeOff(emp.id, dateStr));
                        const fullyAvailable = available.filter(emp => !isEmployeeOnTimeOff(emp.id, dateStr) && !isEmployeePendingTimeOff(emp.id, dateStr));

                        // Priority: 1) Fully available, 2) Pending (with warning), 3) Approved (conflict)
                        let assigned = 0;

                        // First: assign fully available employees
                        for (let i = 0; i < Math.min(needed - assigned, fullyAvailable.length); i++) {
                            proposed.push({
                                station: station.id,
                                date: dateStr,
                                employee_id: fullyAvailable[i].id,
                                name: fullyAvailable[i].name,
                                hasConflict: false
                            });
                            tempHours[fullyAvailable[i].id] += 8;
                            assigned++;
                        }

                        // Second: if still need more, use pending time-off employees (with warning)
                        const stillNeeded = needed - assigned;
                        if (stillNeeded > 0 && withPending.length > 0) {
                            for (let i = 0; i < Math.min(stillNeeded, withPending.length); i++) {
                                proposed.push({
                                    station: station.id,
                                    date: dateStr,
                                    employee_id: withPending[i].id,
                                    name: withPending[i].name,
                                    hasConflict: false,
                                    hasPending: true
                                });
                                tempHours[withPending[i].id] += 8;
                                pendingWarnings.push({
                                    station: station.id,
                                    stationName: station.name,
                                    date: dateStr,
                                    name: withPending[i].name
                                });
                                assigned++;
                            }
                        }

                        // Third: if STILL need more, note approved time-off as conflicts
                        const finallyNeeded = needed - assigned;
                        if (finallyNeeded > 0 && withApproved.length > 0) {
                            for (let i = 0; i < Math.min(finallyNeeded, withApproved.length); i++) {
                                approvedConflicts.push({
                                    station: station.id,
                                    stationName: station.name,
                                    date: dateStr,
                                    employee_id: withApproved[i].id,
                                    name: withApproved[i].name
                                });
                            }
                        }
                    }
                });
            });

            // Store proposed for later application
            pendingAutoFill = proposed;

            // Show appropriate modal/notification
            if (approvedConflicts.length > 0) {
                showConflictModal(approvedConflicts);
            } else if (pendingWarnings.length > 0) {
                // Show pending warnings but apply
                showToast(`Auto-fill complete - ${pendingWarnings.length} with pending requests`, 'warning');
                applyAutoFill(proposed);
                alertDialog('Pending Time-Off Requests', `Employees with PENDING time-off requests were assigned:\n\n${pendingWarnings.map(w => ` ${w.name} - ${w.date}`).join('\n')}\n\nReview their requests before finalizing.`, { type: 'warning' });
            } else {
                applyAutoFill(proposed);
            }
        }

        function showConflictModal(conflicts) {
            const list = document.getElementById('conflictList');
            list.innerHTML = conflicts.map(c => `
                <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-secondary);border-radius:var(--radius-md);margin-bottom:0.5rem;">
                    <div style="width:36px;height:36px;border-radius:50%;background:var(--warning-muted);color:var(--warning);display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;color:var(--text-primary);">${c.name}</div>
                        <div style="font-size:0.8rem;color:var(--text-muted);">${c.stationName} on ${c.date}</div>
                    </div>
                    <span style="font-size:0.7rem;padding:0.25rem 0.5rem;background:var(--warning-muted);color:var(--warning);border-radius:var(--radius-sm);">TIME OFF</span>
                </div>
            `).join('');
            document.getElementById('conflictModal').classList.add('active');
        }

        function closeConflictModal() {
            document.getElementById('conflictModal').classList.remove('active');
        }

        function applyAutoFillWithConflicts() {
            closeConflictModal();
            if (pendingAutoFill) {
                applyAutoFill(pendingAutoFill);
            }
        }

        function applyAutoFill(proposed) {
            proposed.forEach(p => {
                const emp = employees.find(e => e.id === p.employee_id);
                if (emp) {
                    addShift(p.station, p.date, emp);
                    emp.hours = (emp.hours || 0) + 8;
                }
            });
            buildScheduleGrid();
            renderEmployeeList();
            showToast(`Schedule auto-filled! ${proposed.length} shifts added.`);
            pendingAutoFill = null;
        }

        // ============================================
        // TEMPLATE MANAGEMENT
        // ============================================
        function getTemplates() {
            const saved = localStorage.getItem('scheduleTemplates');
            return saved ? JSON.parse(saved) : [];
        }

        function saveTemplates(templates) {
            localStorage.setItem('scheduleTemplates', JSON.stringify(templates));
        }

        function openTemplateModal() {
            renderTemplateList();
            document.getElementById('templateModal').classList.add('active');
            document.getElementById('templateName').value = '';
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        function renderTemplateList() {
            const templates = getTemplates();
            const list = document.getElementById('templateList');

            if (templates.length === 0) {
                list.innerHTML = `<p style="color:var(--text-muted);text-align:center;padding:2rem;">No saved templates</p>`;
                return;
            }

            list.innerHTML = templates.map((t, idx) => `
                <div style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:var(--bg-secondary);border-radius:var(--radius-md);margin-bottom:0.5rem;">
                    <div style="width:36px;height:36px;border-radius:50%;background:var(--primary-muted);color:var(--primary);display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;color:var(--text-primary);">${t.name}</div>
                        <div style="font-size:0.75rem;color:var(--text-muted);">${t.shiftCount} shifts  Saved ${t.createdAt}</div>
                    </div>
                    <button class="modal-btn primary" style="padding:0.4rem 0.75rem;" onclick="loadTemplate(${idx})">
                        <i class="fas fa-download"></i> Load
                    </button>
                    <button class="modal-btn secondary" style="padding:0.4rem 0.5rem;" onclick="deleteTemplate(${idx})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) {
                showToast('Enter a template name', 'error');
                return;
            }

            // Convert schedule to template format (station + day-of-week, not specific dates)
            const templateData = {};
            let shiftCount = 0;

            Object.keys(schedule).forEach(stationId => {
                templateData[stationId] = {};
                Object.keys(schedule[stationId] || {}).forEach(dateStr => {
                    const dayOfWeek = new Date(dateStr).getDay(); // 0-6
                    templateData[stationId][dayOfWeek] = (schedule[stationId][dateStr] || []).map(s => ({
                        employee_id: s.employee_id,
                        name: s.name,
                        start_time: s.start_time,
                        end_time: s.end_time
                    }));
                    shiftCount += (schedule[stationId][dateStr] || []).length;
                });
            });

            const templates = getTemplates();
            templates.push({
                name,
                data: templateData,
                shiftCount,
                createdAt: new Date().toLocaleDateString()
            });
            saveTemplates(templates);

            showToast(`Template "${name}" saved!`);
            renderTemplateList();
            document.getElementById('templateName').value = '';
        }

        function loadTemplate(idx) {
            const templates = getTemplates();
            const template = templates[idx];
            if (!template) return;

            // Track approved (skip) and pending (warn)
            const approvedConflicts = [];
            const pendingWarnings = [];

            // Clear current schedule
            schedule = {};

            // Apply template to current week
            Object.keys(template.data).forEach(stationId => {
                if (!schedule[stationId]) schedule[stationId] = {};

                Object.keys(template.data[stationId]).forEach(dayOfWeek => {
                    const date = new Date(currentWeekStart);
                    date.setDate(date.getDate() + ((parseInt(dayOfWeek) - 1 + 7) % 7));
                    const dateStr = formatDate(date);

                    schedule[stationId][dateStr] = template.data[stationId][dayOfWeek]
                        .map(s => {
                            // Always resolve employee_id by name to ensure valid IDs
                            let searchName = s.name.toLowerCase().trim();
                            // Check nickname mapping (defined at top of script as NICKNAME_MAP)
                            if (NICKNAME_MAP[searchName]) {
                                searchName = NICKNAME_MAP[searchName];
                            }

                            const emp = employees.find(e => {
                                const empName = e.name.toLowerCase().trim();
                                const firstName = empName.split(' ')[0];
                                // Try: exact, contains, first name match, nickname
                                return empName === searchName ||
                                       empName.includes(searchName) ||
                                       searchName.includes(empName) ||
                                       firstName === searchName ||
                                       firstName.includes(searchName) ||
                                       searchName.includes(firstName);
                            });

                            if (!emp) {
                                console.warn(`Template: "${s.name}" not found in employees list (${employees.length} employees loaded)`);
                            }

                            return { ...s, employee_id: emp ? emp.id : null, originalName: s.name };
                        })
                        .filter(s => {
                            // Skip if employee not found in database
                            if (!s.employee_id) {
                                return false;
                            }
                            // Skip employees with APPROVED time-off
                            const hasTimeOff = isEmployeeOnTimeOff(s.employee_id, dateStr);
                            if (hasTimeOff) {
                                approvedConflicts.push({
                                    name: s.name,
                                    station: getStationName(stationId),
                                    date: dateStr
                                });
                                return false; // Don't include
                            }
                            // Warn about PENDING time-off (but still include)
                            if (isEmployeePendingTimeOff(s.employee_id, dateStr)) {
                                pendingWarnings.push({
                                    name: s.name,
                                    station: getStationName(stationId),
                                    date: dateStr
                                });
                            }
                            return true;
                        })
                        .map(s => {
                            const { originalName, ...rest } = s;
                            return rest;
                        });
                });
            });

            closeTemplateModal();
            buildScheduleGrid();
            renderEmployeeList();

            // Mark as unsaved when template applied
            scheduleStatus = 'unsaved';
            updateStatusIndicator();

            // Build notification message
            const hasApproved = approvedConflicts.length > 0;
            const hasPending = pendingWarnings.length > 0;

            if (hasApproved || hasPending) {
                let msg = [];
                if (hasApproved) msg.push(`${approvedConflicts.length} skipped`);
                if (hasPending) msg.push(`${pendingWarnings.length} pending`);
                showToast(`Template loaded - ${msg.join(', ')}`, 'warning');

                let alertMsg = '';
                if (hasApproved) {
                    alertMsg += `SKIPPED (approved time-off):\n${approvedConflicts.map(c => ` ${c.name} - ${c.date}`).join('\n')}\n\n`;
                }
                if (hasPending) {
                    alertMsg += `PENDING REQUESTS:\n${pendingWarnings.map(c => ` ${c.name} - ${c.date}`).join('\n')}\n\nReview before finalizing.`;
                }
                alertDialog('Template Conflicts', alertMsg.trim(), { type: 'warning' });
            } else {
                showToast(`Template "${template.name}" loaded!`);
            }
        }

        async function deleteTemplate(idx) {
            const confirmed = await confirmDialog('Delete Template', 'Are you sure you want to delete this template?', { danger: true, confirmText: 'Delete', type: 'danger' });
            if (!confirmed) return;

            const templates = getTemplates();
            templates.splice(idx, 1);
            saveTemplates(templates);
            renderTemplateList();
            showToast('Template deleted');
        }

        // ============================================
        // PDF EXPORT
        // ============================================
        function exportPDF() {
            // Build employee-based schedule (like the original PDF format)
            const days = [];
            const dayNames = ['MON', 'TUES', 'WED', 'THURS', 'FRI', 'SAT', 'SUN'];
            const dayColors = ['#4CAF50', '#2196F3', '#9C27B0', '#FF9800', '#E91E63', '#00BCD4', '#8BC34A'];

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                days.push({
                    name: dayNames[i],
                    date: date.getDate(),
                    dateStr: formatDate(date),
                    color: dayColors[i]
                });
            }

            // Build employee schedule map: { empId: { '2025-12-16': {time, station}, ... } }
            const empSchedules = {};
            const empNames = {};

            // Collect all scheduled employees
            Object.keys(schedule).forEach(stationId => {
                Object.keys(schedule[stationId] || {}).forEach(dateStr => {
                    (schedule[stationId][dateStr] || []).forEach(shift => {
                        if (!empSchedules[shift.employee_id]) {
                            empSchedules[shift.employee_id] = {};
                            empNames[shift.employee_id] = shift.name;
                        }
                        empSchedules[shift.employee_id][dateStr] = {
                            time: shift.start_time || '6:00AM',
                            station: stationId
                        };
                    });
                });
            });

            // Also add employees from the employee list who might not be scheduled
            employees.forEach(emp => {
                if (!empSchedules[emp.id]) {
                    empSchedules[emp.id] = {};
                    empNames[emp.id] = emp.name;
                }
            });

            // Format time for display (convert 24h to 12h format)
            function formatTimeDisplay(time) {
                if (!time) return '--';
                const [h, m] = time.split(':');
                const hour = parseInt(h);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                return `${displayHour}:${m || '00'}${ampm}-`;
            }

            // Build table rows
            const employeeIds = Object.keys(empSchedules).sort((a, b) =>
                (empNames[a] || '').localeCompare(empNames[b] || '')
            );

            let tableRows = '';
            employeeIds.forEach(empId => {
                const name = empNames[empId];
                let row = `<tr><td class="emp-name">${name}</td>`;

                days.forEach(day => {
                    const shift = empSchedules[empId][day.dateStr];
                    if (shift) {
                        // Check if scheduled but has pending request (warning)
                        if (isEmployeePendingTimeOff(parseInt(empId), day.dateStr)) {
                            row += `<td class="shift-time pending-warn">${formatTimeDisplay(shift.time)}</td>`;
                        } else {
                            row += `<td class="shift-time">${formatTimeDisplay(shift.time)}</td>`;
                        }
                    } else {
                        // Not scheduled - check time-off status
                        if (isEmployeeOnTimeOff(parseInt(empId), day.dateStr)) {
                            row += `<td class="off-approved">OFF</td>`; // Approved time-off
                        } else if (isEmployeePendingTimeOff(parseInt(empId), day.dateStr)) {
                            row += `<td class="off-pending">OFF?</td>`; // Pending request
                        } else {
                            row += `<td class="off-day">OFF</td>`; // Just not scheduled
                        }
                    }
                });

                row += '</tr>';
                tableRows += row;
            });

            // Format week date for title
            const weekDate = `${currentWeekStart.getMonth() + 1}/${currentWeekStart.getDate()}/${currentWeekStart.getFullYear()}`;

            // Create printable HTML
            const printHTML = `
<!DOCTYPE html>
<html>
<head>
    <title>Weekly Schedule - ${weekDate}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: white;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .title {
            font-size: 28px;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 10px;
        }
        .week-info {
            font-size: 14px;
            color: #666;
        }
        .week-date {
            font-size: 24px;
            font-weight: bold;
            color: #f57c00;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th {
            padding: 8px 4px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid #333;
        }
        th.day-header {
            color: white;
        }
        th.emp-header {
            background: #ffcc80;
            color: #333;
            text-align: left;
            padding-left: 10px;
        }
        td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #ccc;
            font-size: 12px;
        }
        td.emp-name {
            text-align: left;
            padding-left: 10px;
            font-weight: bold;
            background: #fff8e1;
            border-left: 2px solid #333;
        }
        td.shift-time {
            background: white;
        }
        td.off-day {
            background: #ffccbc;
            color: #d84315;
            font-weight: bold;
        }
        td.off-approved {
            background: #ffcdd2;
            color: #c62828;
            font-weight: bold;
        }
        td.off-pending {
            background: #fff3e0;
            color: #e65100;
            font-weight: bold;
        }
        td.pending-warn {
            background: #fff8e1;
            border: 2px solid #ff9800;
        }
        .day-num {
            display: block;
            font-size: 16px;
        }
        @media print {
            body { padding: 10px; }
            @page { margin: 0.5in; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">Weekly Schedule</div>
        <div class="week-info">FOR THE WEEK OF:</div>
        <div class="week-date">${weekDate}</div>
    </div>
    <table>
        <thead>
            <tr>
                <th class="emp-header">EMPLOYEE NAME</th>
                ${days.map(d => `<th class="day-header" style="background:${d.color};">${d.name}<span class="day-num">${d.date}</span></th>`).join('')}
            </tr>
        </thead>
        <tbody>
            ${tableRows}
        </tbody>
    </table>
    <scr` + `ipt>
        window.onload = function() {
            window.print();
        };
    </scr` + `ipt>
</body>
</html>`;

            // Open in new window and print
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();

            showToast('PDF export ready - use Print dialog to save as PDF');
        }

        // ============================================
        // SAVE & PUBLISH
        // ============================================
        async function saveSchedule() {
            try {
                // Convert schedule to flat array for API
                const shifts = [];
                Object.keys(schedule).forEach(stationId => {
                    Object.keys(schedule[stationId] || {}).forEach(dateStr => {
                        (schedule[stationId][dateStr] || []).forEach(shift => {
                            shifts.push({
                                station: stationId,
                                date: dateStr,
                                employee_id: shift.employee_id,
                                employee_name: shift.name,
                                start_time: shift.start_time,
                                end_time: shift.end_time
                            });
                        });
                    });
                });

                // For now, save to localStorage
                localStorage.setItem('podFactory_schedule', JSON.stringify(schedule));
                showToast('Schedule saved!');
            } catch (error) {
                showToast('Failed to save schedule', 'error');
            }
        }

        // Schedule status: 'unsaved', 'draft', 'published'
        let scheduleStatus = 'unsaved';

        function updateStatusIndicator() {
            const indicator = document.getElementById('scheduleStatus');
            if (!indicator) return;

            const statusConfig = {
                'unsaved': { text: 'Not Saved', color: 'var(--text-muted)', icon: 'fa-circle' },
                'draft': { text: 'Draft', color: 'var(--warning)', icon: 'fa-file-alt' },
                'published': { text: 'Published', color: 'var(--success)', icon: 'fa-check-circle' }
            };
            const config = statusConfig[scheduleStatus] || statusConfig.unsaved;
            indicator.innerHTML = `<i class="fas ${config.icon}" style="color:${config.color}"></i> ${config.text}`;
        }

        // Clear current week's schedule
        async function clearSchedule() {
            const totalShifts = getShiftCount();

            if (totalShifts === 0) {
                showToast('Schedule is already empty', 'warning');
                return;
            }

            const confirmed = await confirmDialog('Clear Schedule', `Clear all ${totalShifts} shifts from this week?\n\nThis will reset the schedule so you can start fresh.`, { danger: true, confirmText: 'Clear All', type: 'danger' });
            if (!confirmed) return;

            schedule = {};
            scheduleStatus = 'unsaved';
            updateStatusIndicator();
            buildScheduleGrid();
            renderEmployeeList();
            showToast('Schedule cleared');
        }

        // Save as draft (visible to manager only, not employees)
        async function saveDraft() {
            showLoading('Saving draft...');
            try {
                const response = await fetch(`${API_BASE}/schedule/save-draft`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        week_start: formatDate(currentWeekStart),
                        schedule: schedule
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    scheduleStatus = 'draft';
                    updateStatusIndicator();
                    localStorage.removeItem('podFactory_schedule'); // Clear stale localStorage
                    showToast(`Draft saved! ${data.shifts_saved} shifts.`);
                } else {
                    showToast(`Error: ${data.error || data.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Save draft error:', error);
                showToast('Failed to save draft', 'error');
            }
        }

        async function publishSchedule() {
            const totalShifts = getShiftCount();

            const title = totalShifts === 0 ? 'Publish Empty Schedule' : 'Publish Schedule';
            const msg = totalShifts === 0
                ? 'This will clear any existing schedule for this week.'
                : `${totalShifts} shifts will be visible to employees.`;

            const confirmed = await confirmDialog(title, msg, { confirmText: 'Publish', type: 'warning' });
            if (!confirmed) return;

            showLoading('Publishing schedule...');
            try {
                const response = await fetch(`${API_BASE}/schedule/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        week_start: formatDate(currentWeekStart),
                        schedule: schedule
                    })
                });

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    scheduleStatus = 'published';
                    updateStatusIndicator();
                    localStorage.removeItem('podFactory_schedule'); // Clear stale localStorage
                    showToast(`Schedule published! ${data.shifts_saved} shifts saved.`);
                } else {
                    showToast(`Error: ${data.error || data.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Publish error:', error);
                showToast('Failed to publish schedule', 'error');
            }
        }

        // ============================================
        // PREDICTIONS
        // ============================================
        async function loadPredictions() {
            try {
                const response = await fetch(`${API_BASE}/schedule/predictions`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('predictionOrders').textContent =
                        `${data.predicted_orders} orders predicted this week`;
                    document.getElementById('predictionStaff').textContent =
                        `Recommended: ${data.recommended_staff} staff members`;
                }
            } catch (error) {
                // Keep defaults
            }
        }

        // ============================================
        // TIME-OFF
        // ============================================
        async function loadTimeOffRequests() {
            const grid = document.getElementById('timeoffGrid');
            const badge = document.getElementById('timeoffBadge');

            try {
                const response = await fetch(`${API_BASE}/manager/time-off/pending`);
                if (!response.ok) throw new Error();

                const data = await response.json();
                const requests = data.requests || data.pending_requests || [];

                badge.textContent = requests.length;
                badge.style.display = requests.length > 0 ? 'inline' : 'none';

                if (requests.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>No pending time-off requests</p>
                        </div>
                    `;
                    // Still load history even if no pending requests
                    loadTimeOffHistory();
                    return;
                }

                const icons = {
                    vacation: { icon: 'fa-umbrella-beach', class: 'vacation' },
                    sick: { icon: 'fa-briefcase-medical', class: 'sick' },
                    personal: { icon: 'fa-user', class: 'personal' },
                    other: { icon: 'fa-calendar-day', class: 'vacation' }
                };

                grid.innerHTML = requests.map(req => {
                    const reqType = req.request_type || req.type || 'vacation';
                    const typeInfo = icons[reqType] || { icon: 'fa-calendar', class: 'vacation' };
                    const dateDisplay = req.dates && req.dates.length > 0
                        ? req.dates.join(', ')
                        : `${req.start_date} to ${req.end_date}`;
                    return `
                        <div class="timeoff-card">
                            <div class="timeoff-header">
                                <div class="timeoff-icon ${typeInfo.class}">
                                    <i class="fas ${typeInfo.icon}"></i>
                                </div>
                                <div class="timeoff-info">
                                    <h4>${req.employee_name}</h4>
                                    <span>${reqType.charAt(0).toUpperCase() + reqType.slice(1)}</span>
                                </div>
                            </div>
                            <div class="timeoff-dates">
                                <i class="fas fa-calendar"></i>
                                ${dateDisplay}
                            </div>
                            ${req.reason ? `<div class="timeoff-reason" style="font-size:0.8rem;color:var(--text-muted);margin-top:0.5rem;"><i class="fas fa-comment"></i> ${req.reason}</div>` : ''}
                            <div class="timeoff-actions">
                                <button class="btn-approve" onclick="approveTimeOff(${req.id})">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn-reject" onclick="rejectTimeOff(${req.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading pending requests:', error);
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Unable to load requests</p>
                    </div>
                `;
                // Still try to load history
                loadTimeOffHistory();
            }

            // Also load history
            loadTimeOffHistory();
        }

        let allTimeOffHistory = []; // Store for filtering

        async function loadTimeOffHistory() {
            const historyGrid = document.getElementById('timeoffHistory');
            console.log('Loading time-off history...');

            try {
                const response = await fetch(`${API_BASE}/manager/time-off/history`);
                console.log('History response status:', response.status);
                if (!response.ok) throw new Error('Response not OK');

                const data = await response.json();
                allTimeOffHistory = data.history || [];
                console.log('History loaded:', allTimeOffHistory.length, 'records');

                renderHistoryTable(allTimeOffHistory);
            } catch (error) {
                historyGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Unable to load history</p>
                    </div>
                `;
            }
        }

        function filterHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const statusFilter = document.getElementById('historyStatusFilter').value;

            let filtered = allTimeOffHistory;

            // Filter by status
            if (statusFilter !== 'all') {
                filtered = filtered.filter(req => {
                    if (statusFilter === 'approved') return req.status === 'approved';
                    if (statusFilter === 'denied') return req.status === 'denied' || req.status === 'rejected';
                    return true;
                });
            }

            // Filter by name
            if (searchTerm) {
                filtered = filtered.filter(req =>
                    req.employee_name?.toLowerCase().includes(searchTerm)
                );
            }

            renderHistoryTable(filtered);
        }

        function renderHistoryTable(history) {
            const historyGrid = document.getElementById('timeoffHistory');
            const countSpan = document.getElementById('historyCount');

            countSpan.textContent = `${history.length} record${history.length !== 1 ? 's' : ''}`;

            if (history.length === 0) {
                historyGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No decision history${allTimeOffHistory.length > 0 ? ' matching filters' : ' yet'}</p>
                    </div>
                `;
                return;
            }

            historyGrid.innerHTML = `
                <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                    <thead>
                        <tr style="background:var(--bg-elevated);border-bottom:2px solid var(--border-color);">
                            <th style="text-align:left;padding:0.75rem;color:var(--text-muted);width:100px;">Status</th>
                            <th style="text-align:left;padding:0.75rem;color:var(--text-muted);">Employee</th>
                            <th style="text-align:left;padding:0.75rem;color:var(--text-muted);width:80px;">Type</th>
                            <th style="text-align:left;padding:0.75rem;color:var(--text-muted);">Dates</th>
                            <th style="text-align:left;padding:0.75rem;color:var(--text-muted);width:100px;">Requested</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(req => {
                            const reqType = req.request_type || 'vacation';
                            const dateDisplay = req.dates && req.dates.length > 0
                                ? req.dates.join(', ')
                                : `${req.start_date}  ${req.end_date}`;
                            const isApproved = req.status === 'approved';

                            return `
                                <tr style="border-bottom:1px solid var(--border-color);">
                                    <td style="padding:0.5rem 0.75rem;">
                                        <span style="padding:0.2rem 0.5rem;border-radius:var(--radius-sm);font-size:0.7rem;font-weight:600;
                                            background:${isApproved ? 'var(--success-muted)' : 'var(--danger-muted)'};
                                            color:${isApproved ? 'var(--success)' : 'var(--danger)'};">
                                            ${isApproved ? ' APPROVED' : ' DENIED'}
                                        </span>
                                    </td>
                                    <td style="padding:0.5rem 0.75rem;color:var(--text-primary);font-weight:500;">${req.employee_name}</td>
                                    <td style="padding:0.5rem 0.75rem;color:var(--text-muted);text-transform:capitalize;">${reqType}</td>
                                    <td style="padding:0.5rem 0.75rem;color:var(--text-secondary);">${dateDisplay}</td>
                                    <td style="padding:0.5rem 0.75rem;color:var(--text-muted);font-size:0.75rem;">${req.created_at || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        async function approveTimeOff(id) {
            try {
                const response = await fetch(`${API_BASE}/manager/time-off/${id}/approve`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                if (response.ok) {
                    showToast('Time-off approved');
                    loadTimeOffRequests();
                    loadApprovedTimeOff(); // Update schedule with new unavailability
                } else {
                    showToast('Failed to approve', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        async function rejectTimeOff(id) {
            try {
                const response = await fetch(`${API_BASE}/manager/time-off/${id}/reject`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                if (response.ok) {
                    showToast('Time-off rejected');
                    loadTimeOffRequests();
                } else {
                    showToast('Failed to reject', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        }

        // ============================================
        // CREATE DEFAULT TEMPLATE FROM PDF
        // ============================================
        function createDefaultTemplate() {
            const templates = getTemplates();
            // Check if "Regular Schedule" already exists
            if (templates.some(t => t.name === 'Regular Schedule')) return;

            // Employee schedule data from PDF (day 1=Mon, 2=Tue, etc., 6=Sat, 0=Sun)
            // Format: { name: [Mon, Tue, Wed, Thu, Fri, Sat] } - null means OFF
            const pdfSchedule = {
                'Dung': ['04:30', '04:30', '04:30', '04:30', '04:30', '04:30'],
                'Nathan': ['05:00', '05:00', '05:00', '05:00', '05:00', null],
                'Robert': ['06:00', '06:00', '06:00', '06:00', '06:00', null],
                'Brandon': ['06:00', '06:00', '06:00', '06:00', '06:00', null],
                'Andrea': ['08:00', '08:00', '08:00', null, '08:00', '08:00'],
                'Abraham Ramirez': ['08:00', '08:00', '08:00', '08:00', '08:00', '08:00'],
                'Monique': ['09:00', '09:00', '09:00', '09:00', '09:00', null],
                'Gaby': ['06:00', '06:00', '06:00', '06:00', '06:00', '06:00'],
                'Roger': ['06:00', '06:00', '06:00', '06:00', '06:00', '06:00'],
                'Fannie': ['08:00', '08:00', '08:00', '08:00', '08:00', '08:00'],
                'Vincent': [null, '10:30', null, '10:30', '10:30', '09:00'],
                'Nicole': ['09:00', '09:00', '09:00', null, '09:00', '09:00'],
                'Vinnie': ['05:00', null, '05:00', '05:00', '05:00', null],
                'Morgan': ['09:00', '09:00', '09:00', '09:00', '09:00', null],
                'Xsavier': ['08:00', '08:00', '08:00', '08:00', '08:00', '08:00'],
                'Giselle': ['09:00', '09:00', '09:00', '09:00', '09:00', null],
                'Duc': ['07:00', '07:00', '07:00', '07:00', '07:00', '07:00'],
                'La': ['08:00', '08:00', '08:00', '08:00', '08:00', '08:00'],
                'Kieu': ['06:00', '06:00', '06:00', '06:00', '06:00', '06:00'],
                'Hanh': ['06:00', '06:00', '06:00', '06:00', '06:00', '06:00'],
                'Khue': ['07:00', '07:00', '07:00', '07:00', '07:00', '07:00'],
                'Ben': ['10:00', null, '10:00', null, '10:00', '10:00'],
                'Fernando': ['10:00', null, '10:00', null, '10:00', '10:00'],
                'Bryan': ['10:00', null, '10:00', null, '10:00', '10:00'],
                'Ryan': ['07:00', '07:00', null, '07:00', '07:00', '07:00'],
                'Krstal': ['05:00', '05:00', '05:00', '05:00', '05:00', '05:00'],
                'Joshua': ['07:00', '07:00', '07:00', '07:00', '07:00', '07:00'],
                'Thien': ['07:00', '07:00', '07:00', '07:00', '07:00', '07:00'],
                'Stephen': ['07:00', '07:00', null, null, '07:00', null],
                'Toan': ['04:30', '04:30', '04:30', '04:30', '04:30', '04:30'],
                'Hiep': ['09:00', '09:00', '09:00', '09:00', '09:00', '09:00'],
                'Adrianna': ['06:00', '06:00', '06:00', '06:00', '06:00', null]
            };

            // Convert to template format - distribute across stations
            const stationList = ['heat_press', 'qc', 'film', 'picking', 'labeling'];
            const templateData = {};
            let empIdx = 0;
            let shiftCount = 0;

            Object.entries(pdfSchedule).forEach(([name, days]) => {
                const stationId = stationList[empIdx % stationList.length];
                if (!templateData[stationId]) templateData[stationId] = {};

                days.forEach((time, dayIndex) => {
                    if (time) {
                        const dayOfWeek = dayIndex + 1; // 1=Mon, 2=Tue, etc.
                        if (!templateData[stationId][dayOfWeek]) {
                            templateData[stationId][dayOfWeek] = [];
                        }
                        templateData[stationId][dayOfWeek].push({
                            employee_id: empIdx + 1000, // Use high IDs to avoid conflicts
                            name: name,
                            start_time: time,
                            end_time: '14:30'
                        });
                        shiftCount++;
                    }
                });
                empIdx++;
            });

            templates.push({
                name: 'Regular Schedule',
                data: templateData,
                shiftCount: shiftCount,
                createdAt: '12/13/2025',
                isDefault: true
            });

            saveTemplates(templates);
            console.log('Created "Regular Schedule" template with', shiftCount, 'shifts');
        }

        // ============================================
        // INITIALIZE
        // ============================================
        // Load published schedule from database for current week
        async function loadPublishedSchedule() {
            showLoading('Loading schedule...');
            try {
                const weekStart = formatDate(currentWeekStart);
                const response = await fetch(`${API_BASE}/schedule/published/${weekStart}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.has_schedule) {
                        // Filter out employees with approved time-off from loaded schedule
                        const filteredSchedule = {};
                        const removedConflicts = [];

                        for (const [stationId, dates] of Object.entries(data.schedule)) {
                            filteredSchedule[stationId] = {};
                            for (const [dateStr, shifts] of Object.entries(dates)) {
                                filteredSchedule[stationId][dateStr] = shifts.filter(shift => {
                                    const hasTimeOff = isEmployeeOnTimeOff(shift.employee_id, dateStr);
                                    if (shift.employee_id && hasTimeOff) {
                                        removedConflicts.push({ name: shift.name, date: dateStr });
                                        return false; // Remove from schedule
                                    }
                                    return true;
                                });
                            }
                        }

                        schedule = filteredSchedule;
                        buildScheduleGrid();
                        renderEmployeeList();

                        // Set status based on DB status
                        if (data.status === 'published') {
                            scheduleStatus = 'published';
                            showToast('Published schedule loaded');
                        } else if (data.status === 'draft') {
                            scheduleStatus = 'draft';
                            showToast('Draft schedule loaded');
                        } else {
                            scheduleStatus = 'unsaved';
                        }

                        // Notify if any employees were filtered due to time-off
                        if (removedConflicts.length > 0) {
                            scheduleStatus = 'unsaved'; // Mark as unsaved since we modified it
                            updateStatusIndicator();
                            alertDialog('Time-Off Conflicts Removed',
                                `Removed from schedule (approved time-off):\n${removedConflicts.map(c => ` ${c.name} - ${c.date}`).join('\n')}\n\nSave draft to update.`,
                                { type: 'warning' });
                        }

                        updateStatusIndicator();
                        hideLoading();
                        return true;
                    }
                }
            } catch (error) {
                console.log('No published schedule found for this week');
            }
            // No schedule found - reset to unsaved
            scheduleStatus = 'unsaved';
            updateStatusIndicator();
            hideLoading();
            return false;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('Initializing...');

            // Create default template if needed
            createDefaultTemplate();

            updateWeekDisplay();

            // Load employees and time-off in parallel (40% faster startup)
            await Promise.all([loadEmployees(), loadApprovedTimeOff()]);

            // Load schedule from DB (depends on time-off data for filtering)
            await loadPublishedSchedule();

            buildScheduleGrid();

            // Load non-critical data in parallel (non-blocking)
            Promise.all([loadPredictions(), loadTimeOffRequests()]);

            hideLoading();
        });

        // ============================================
        // MOBILE SIDEBAR TOGGLE
        // ============================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            if (overlay) {
                overlay.classList.toggle('active');
            }
        }
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <a href="#" class="mobile-bottom-nav__item active" onclick="document.querySelector('[data-tab=schedule]').click(); return false;">
            <i class="fas fa-calendar-alt"></i>
            <span>Schedule</span>
        </a>
        <a href="#" class="mobile-bottom-nav__item" onclick="document.querySelector('[data-tab=timeoff]').click(); return false;">
            <i class="fas fa-umbrella-beach"></i>
            <span>Time-Off</span>
        </a>
        <a href="#" class="mobile-bottom-nav__item" onclick="toggleSidebar(); return false;">
            <i class="fas fa-users"></i>
            <span>Employees</span>
        </a>
        <a href="manager.html" class="mobile-bottom-nav__item">
            <i class="fas fa-arrow-left"></i>
            <span>Dashboard</span>
        </a>
    </nav>
</body>
</html>
